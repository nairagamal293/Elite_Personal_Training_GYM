using AutoMapper;
using elite.DTOs;
using elite.Models;
using static System.Runtime.InteropServices.JavaScript.JSType;

namespace elite.Configurations
{
    public class AutoMapperProfile : Profile
    {
        public AutoMapperProfile()
        {
            
            AllowNullCollections = true;
            AllowNullDestinationValues = true;

            CreateMap<User, UserResponseDto>();
            CreateMap<Membership, MembershipDto>();
            CreateMap<Booking, BookingResponseDto>();
            CreateMap<Class, ClassDto>();
            CreateMap<Trainer, TrainerDto>();
        }
    }
}
using elite.Data;
using elite.Interfaces;
using elite.Models;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;

namespace elite.Controllers
{
    // Controllers/AdminController.cs
    [ApiController]
    [Route("api/admin")]
    [Authorize(Roles = "Admin")]
    public class AdminController : ControllerBase
    {
        private readonly IAdminService _adminService;
        private readonly ILogger<AdminController> _logger;

        public AdminController(IAdminService adminService, ILogger<AdminController> logger)
        {
            _adminService = adminService;
            _logger = logger;
        }

        [HttpGet("users")]
        public async Task<IActionResult> GetAllUsers([FromQuery] int page = 1, [FromQuery] int pageSize = 10)
        {
            try
            {
                var users = await _adminService.GetAllUsersAsync(page, pageSize);
                return Ok(users);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting all users");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpGet("users/{id}")]
        public async Task<IActionResult> GetUserDetails(int id)
        {
            try
            {
                var user = await _adminService.GetUserDetailsAsync(id);
                return Ok(user);
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting user details");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpGet("dashboard/stats")]
        public async Task<IActionResult> GetDashboardStats()
        {
            try
            {
                var stats = await _adminService.GetDashboardStatsAsync();
                return Ok(stats);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting dashboard stats");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpGet("bookings")]
        public async Task<IActionResult> GetAllBookings([FromQuery] DateTime? startDate, [FromQuery] DateTime? endDate)
        {
            try
            {
                var bookings = await _adminService.GetAllBookingsAsync(startDate, endDate);
                return Ok(bookings);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting all bookings");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }
        [HttpGet("orders")]
        public async Task<IActionResult> GetAllOrders()
        {
            try
            {
                var orders = await _adminService.GetAllOrdersAsync();
                return Ok(orders);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting all orders");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        // Controllers/AdminController.cs
        [HttpGet("bookings/{id}")]
        public async Task<IActionResult> GetBookingDetails(int id)
        {
            try
            {
                var booking = await _adminService.GetBookingDetailsAsync(id);
                return Ok(booking);
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting booking details");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }


        [HttpGet("revenue")]
        public async Task<IActionResult> GetRevenueReport([FromQuery] DateTime startDate, [FromQuery] DateTime endDate)
        {
            try
            {
                var revenue = await _adminService.GetRevenueReportAsync(startDate, endDate);
                return Ok(revenue);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting revenue report");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }
    }
}
// Controllers/AuthController.cs
using Microsoft.AspNetCore.Mvc;
using elite.DTOs;
using elite.Interfaces;

namespace elite.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    public class AuthController : ControllerBase
    {
        private readonly IAuthService _authService;
        private readonly ILogger<AuthController> _logger;

        public AuthController(IAuthService authService, ILogger<AuthController> logger)
        {
            _authService = authService;
            _logger = logger;
        }

        [HttpPost("register")]
        public async Task<ActionResult<AuthResponseDto>> Register([FromBody] UserRegisterDto registerDto)
        {
            try
            {
                var result = await _authService.RegisterAsync(registerDto);
                return Ok(result);
            }
            catch (ArgumentException ex)
            {
                return BadRequest(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error during registration");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpPost("login")]
        public async Task<ActionResult<AuthResponseDto>> Login([FromBody] UserLoginDto loginDto)
        {
            try
            {
                var result = await _authService.LoginAsync(loginDto);
                return Ok(result);
            }
            catch (UnauthorizedAccessException ex)
            {
                return Unauthorized(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error during login");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }



    }
}
// Controllers/BookingsController.cs
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using elite.DTOs;
using elite.Interfaces;
using System.Collections.Generic;
using System.Security.Claims;
using System.Threading.Tasks;

namespace elite.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    [Authorize]
    public class BookingsController : ControllerBase
    {
        private readonly IBookingService _bookingService;
        private readonly ILogger<BookingsController> _logger;

        public BookingsController(IBookingService bookingService, ILogger<BookingsController> logger)
        {
            _bookingService = bookingService;
            _logger = logger;
        }

        [HttpPost]
        public async Task<IActionResult> CreateBooking([FromBody] CreateBookingDto bookingDto)
        {
            try
            {
                // Get user ID from token
                var userId = int.Parse(User.FindFirst(ClaimTypes.NameIdentifier)?.Value);
                bookingDto.UserId = userId;
                var result = await _bookingService.CreateBookingAsync(bookingDto);
                return Ok(result);
            }
            catch (ArgumentException ex)
            {
                return BadRequest(new { message = ex.Message });
            }
            catch (InvalidOperationException ex)
            {
                return BadRequest(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error creating booking");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpDelete("{id}")]
        public async Task<IActionResult> CancelBooking(int id)
        {
            try
            {
                var userId = int.Parse(User.FindFirst(ClaimTypes.NameIdentifier)?.Value);
                var result = await _bookingService.CancelBookingAsync(id, userId);
                if (result)
                    return Ok(new { message = "Booking cancelled successfully" });
                else
                    return BadRequest(new { message = "Cannot cancel booking" });
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (InvalidOperationException ex)
            {
                return BadRequest(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error cancelling booking");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpGet]
        public async Task<IActionResult> GetUserBookings()
        {
            try
            {
                var userId = int.Parse(User.FindFirst(ClaimTypes.NameIdentifier)?.Value);
                var result = await _bookingService.GetUserBookingsAsync(userId);
                return Ok(result);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting user bookings");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        // Add this new endpoint
        [HttpGet("{id}")]
        public async Task<IActionResult> GetBookingById(int id)
        {
            try
            {
                var userId = int.Parse(User.FindFirst(ClaimTypes.NameIdentifier)?.Value);
                var booking = await _bookingService.GetBookingDetailsAsync(id);

                // Check if user owns this booking or is admin
                var isAdmin = User.IsInRole("Admin");
                if (!isAdmin && booking.UserId != userId)
                    return Forbid();

                return Ok(booking);
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting booking by ID");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }
    }
}
using elite.DTOs;
using elite.Interfaces;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;

namespace elite.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    public class ClassesController : ControllerBase
    {
        private readonly IClassService _classService;
        private readonly ILogger<ClassesController> _logger;

        public ClassesController(IClassService classService, ILogger<ClassesController> logger)
        {
            _classService = classService;
            _logger = logger;
        }

        [HttpGet]
        public async Task<IActionResult> GetAllClasses()
        {
            try
            {
                var classes = await _classService.GetAllClassesAsync();
                return Ok(classes);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting all classes");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpGet("{id}")]
        public async Task<IActionResult> GetClassById(int id)
        {
            try
            {
                var classObj = await _classService.GetClassByIdAsync(id);
                return Ok(classObj);
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting class by ID");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpPost]
        [Authorize(Roles = "Admin")]
        public async Task<IActionResult> CreateClass([FromBody] ClassCreateDto classCreateDto)
        {
            try
            {
                var result = await _classService.CreateClassAsync(classCreateDto);
                return CreatedAtAction(nameof(GetClassById), new { id = result.Id }, result);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error creating class");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpPut("{id}")]
        [Authorize(Roles = "Admin")]
        public async Task<IActionResult> UpdateClass(int id, [FromBody] ClassCreateDto classUpdateDto)
        {
            try
            {
                var result = await _classService.UpdateClassAsync(id, classUpdateDto);
                return Ok(result);
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error updating class");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpDelete("{id}")]
        [Authorize(Roles = "Admin")]
        public async Task<IActionResult> DeleteClass(int id)
        {
            try
            {
                var result = await _classService.DeleteClassAsync(id);
                return Ok(new { message = "Class deleted successfully" });
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error deleting class");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpGet("{id}/schedules")]
        public async Task<IActionResult> GetClassSchedules(int id)
        {
            try
            {
                var schedules = await _classService.GetClassSchedulesAsync(id);
                return Ok(schedules);
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting class schedules");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpPost("schedules")]
        [Authorize(Roles = "Admin")]
        public async Task<IActionResult> CreateClassSchedule([FromBody] ClassScheduleCreateDto scheduleCreateDto)
        {
            try
            {
                var result = await _classService.CreateClassScheduleAsync(scheduleCreateDto);
                return CreatedAtAction(nameof(GetClassSchedules), new { id = result.ClassId }, result);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error creating class schedule");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpDelete("schedules/{id}")]
        [Authorize(Roles = "Admin")]
        public async Task<IActionResult> DeleteClassSchedule(int id)
        {
            try
            {
                var result = await _classService.DeleteClassScheduleAsync(id);
                return Ok(new { message = "Class schedule deleted successfully" });
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error deleting class schedule");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }
    }

}
using elite.Data;
using elite.DTOs;
using elite.Interfaces;
using elite.Models;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using System.Security.Claims;

namespace elite.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    [Authorize]
    public class MembershipsController : ControllerBase
    {
        private readonly IMembershipService _membershipService;
        private readonly ILogger<MembershipsController> _logger;

        public MembershipsController(IMembershipService membershipService, ILogger<MembershipsController> logger)
        {
            _membershipService = membershipService;
            _logger = logger;
        }

        [HttpPost]
        public async Task<IActionResult> PurchaseMembership([FromBody] PurchaseMembershipDto purchaseDto)
        {
            try
            {
                var userId = int.Parse(User.FindFirst(ClaimTypes.NameIdentifier)?.Value);
                purchaseDto.UserId = userId;

                var result = await _membershipService.PurchaseMembershipAsync(purchaseDto);
                return Ok(result);
            }
            catch (ArgumentException ex)
            {
                return BadRequest(new { message = ex.Message });
            }
            catch (InvalidOperationException ex)
            {
                return BadRequest(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error purchasing membership");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpGet]
        public async Task<IActionResult> GetUserMembership()
        {
            try
            {
                var userId = int.Parse(User.FindFirst(ClaimTypes.NameIdentifier)?.Value);
                var result = await _membershipService.GetUserMembershipAsync(userId);
                return Ok(result);
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting user membership");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }
    }

    public class PurchaseMembershipRequest
        {
            public int UserId { get; set; }
            public string Type { get; set; }
        }
    }

// Controllers/MembershipTypesController.cs
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using elite.DTOs;
using elite.Interfaces;
using System.Collections.Generic;
using System.Threading.Tasks;

namespace elite.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    [Authorize(Roles = "Admin")]
    public class MembershipTypesController : ControllerBase
    {
        private readonly IMembershipTypeService _membershipTypeService;
        private readonly ILogger<MembershipTypesController> _logger;

        public MembershipTypesController(IMembershipTypeService membershipTypeService, ILogger<MembershipTypesController> logger)
        {
            _membershipTypeService = membershipTypeService;
            _logger = logger;
        }

        [HttpGet]
        [AllowAnonymous] // Allow anyone to see membership types
        public async Task<IActionResult> GetAllMembershipTypes()
        {
            try
            {
                var types = await _membershipTypeService.GetAllMembershipTypesAsync();
                return Ok(types);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting membership types");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        // Add this new endpoint
        [HttpGet("{id}")]
        public async Task<IActionResult> GetMembershipTypeById(int id)
        {
            try
            {
                var membershipType = await _membershipTypeService.GetMembershipTypeByIdAsync(id);
                return Ok(membershipType);
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting membership type by ID");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpPost]
        public async Task<IActionResult> CreateMembershipType([FromBody] MembershipTypeCreateDto createDto)
        {
            try
            {
                var result = await _membershipTypeService.CreateMembershipTypeAsync(createDto);
                return CreatedAtAction(nameof(GetAllMembershipTypes), new { id = result.Id }, result);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error creating membership type");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpPut("{id}")]
        public async Task<IActionResult> UpdateMembershipType(int id, [FromBody] MembershipTypeCreateDto updateDto)
        {
            try
            {
                var result = await _membershipTypeService.UpdateMembershipTypeAsync(id, updateDto);
                return Ok(result);
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error updating membership type");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpPatch("{id}/toggle")]
        public async Task<IActionResult> ToggleMembershipTypeStatus(int id, [FromBody] bool isActive)
        {
            try
            {
                var result = await _membershipTypeService.ToggleMembershipTypeStatusAsync(id, isActive);
                return Ok(new { message = "Membership type status updated successfully" });
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error toggling membership type status");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpDelete("{id}")]
        public async Task<IActionResult> DeleteMembershipType(int id)
        {
            try
            {
                var result = await _membershipTypeService.DeleteMembershipTypeAsync(id);
                return Ok(new { message = "Membership type deleted successfully" });
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error deleting membership type");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }
    }
}
using elite.DTOs;
using elite.Interfaces;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;

namespace elite.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    public class OnlineSessionsController : ControllerBase
    {
        private readonly IOnlineSessionService _sessionService;
        private readonly ILogger<OnlineSessionsController> _logger;

        public OnlineSessionsController(IOnlineSessionService sessionService, ILogger<OnlineSessionsController> logger)
        {
            _sessionService = sessionService;
            _logger = logger;
        }

        [HttpGet]
        public async Task<IActionResult> GetAllSessions()
        {
            try
            {
                var sessions = await _sessionService.GetAllSessionsAsync();
                return Ok(sessions);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting all sessions");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpGet("{id}")]
        public async Task<IActionResult> GetSessionById(int id)
        {
            try
            {
                var session = await _sessionService.GetSessionByIdAsync(id);
                return Ok(session);
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting session by ID");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpPost]
        [Authorize(Roles = "Admin")]
        public async Task<IActionResult> CreateSession([FromBody] OnlineSessionCreateDto sessionCreateDto)
        {
            try
            {
                var result = await _sessionService.CreateSessionAsync(sessionCreateDto);
                return CreatedAtAction(nameof(GetSessionById), new { id = result.Id }, result);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error creating session");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpPut("{id}")]
        [Authorize(Roles = "Admin")]
        public async Task<IActionResult> UpdateSession(int id, [FromBody] OnlineSessionCreateDto sessionUpdateDto)
        {
            try
            {
                var result = await _sessionService.UpdateSessionAsync(id, sessionUpdateDto);
                return Ok(result);
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error updating session");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpDelete("{id}")]
        [Authorize(Roles = "Admin")]
        public async Task<IActionResult> DeleteSession(int id)
        {
            try
            {
                var result = await _sessionService.DeleteSessionAsync(id);
                return Ok(new { message = "Session deleted successfully" });
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error deleting session");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpGet("{id}/schedules")]
        public async Task<IActionResult> GetSessionSchedules(int id)
        {
            try
            {
                var schedules = await _sessionService.GetSessionSchedulesAsync(id);
                return Ok(schedules);
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting session schedules");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpPost("schedules")]
        [Authorize(Roles = "Admin")]
        public async Task<IActionResult> CreateSessionSchedule([FromBody] OnlineSessionScheduleCreateDto scheduleCreateDto)
        {
            try
            {
                var result = await _sessionService.CreateSessionScheduleAsync(scheduleCreateDto);
                return CreatedAtAction(nameof(GetSessionSchedules), new { id = result.OnlineSessionId }, result);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error creating session schedule");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpDelete("schedules/{id}")]
        [Authorize(Roles = "Admin")]
        public async Task<IActionResult> DeleteSessionSchedule(int id)
        {
            try
            {
                var result = await _sessionService.DeleteSessionScheduleAsync(id);
                return Ok(new { message = "Session schedule deleted successfully" });
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error deleting session schedule");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }
    }
}
using elite.DTOs;
using elite.Interfaces;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using System.Security.Claims;

namespace elite.Controllers
{
    // Controllers/OrdersController.cs
    [ApiController]
    [Route("api/[controller]")]
    [Authorize]
    public class OrdersController : ControllerBase
    {
        private readonly IOrderService _orderService;
        private readonly ILogger<OrdersController> _logger;

        public OrdersController(IOrderService orderService, ILogger<OrdersController> logger)
        {
            _orderService = orderService;
            _logger = logger;
        }

        [HttpPost]
        public async Task<IActionResult> CreateOrder([FromBody] OrderCreateDto orderCreateDto)
        {
            try
            {
                var userId = int.Parse(User.FindFirst(ClaimTypes.NameIdentifier)?.Value);
                orderCreateDto.UserId = userId;

                var result = await _orderService.CreateOrderAsync(orderCreateDto);
                return CreatedAtAction(nameof(GetOrderById), new { id = result.Id }, result);
            }
            catch (ArgumentException ex)
            {
                return BadRequest(new { message = ex.Message });
            }
            catch (InvalidOperationException ex)
            {
                return BadRequest(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error creating order");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpGet("{id}")]
        public async Task<IActionResult> GetOrderById(int id)
        {
            try
            {
                var order = await _orderService.GetOrderByIdAsync(id);

                // Check if user owns this order or is admin
                var userId = int.Parse(User.FindFirst(ClaimTypes.NameIdentifier)?.Value);
                var isAdmin = User.IsInRole("Admin");

                if (!isAdmin && order.UserId != userId)
                    return Forbid();

                return Ok(order);
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting order by ID");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpGet("user/{userId}")]
        [Authorize(Roles = "Admin")]
        public async Task<IActionResult> GetUserOrders(int userId)
        {
            try
            {
                var orders = await _orderService.GetUserOrdersAsync(userId);
                return Ok(orders);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting user orders");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpGet]
        [Authorize(Roles = "Admin")]
        public async Task<IActionResult> GetAllOrders()
        {
            try
            {
                var orders = await _orderService.GetAllOrdersAsync();
                return Ok(orders);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting all orders");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpPatch("{id}/status")]
        [Authorize(Roles = "Admin")]
        public async Task<IActionResult> UpdateOrderStatus(int id, [FromBody] string status)
        {
            try
            {
                var result = await _orderService.UpdateOrderStatusAsync(id, status);
                return Ok(new { message = "Order status updated successfully" });
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error updating order status");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpDelete("{id}")]
        public async Task<IActionResult> CancelOrder(int id)
        {
            try
            {
                var userId = int.Parse(User.FindFirst(ClaimTypes.NameIdentifier)?.Value);
                var isAdmin = User.IsInRole("Admin");

                // For non-admin users, check if they own the order
                if (!isAdmin)
                {
                    var order = await _orderService.GetOrderByIdAsync(id);
                    if (order.UserId != userId)
                        return Forbid();
                }

                var result = await _orderService.CancelOrderAsync(id);
                return Ok(new { message = "Order cancelled successfully" });
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error cancelling order");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpPost("apply-promotion")]
        public async Task<IActionResult> ApplyPromotion([FromBody] ApplyPromotionDto applyPromotionDto)
        {
            try
            {
                var discount = await _orderService.ApplyPromotionAsync(applyPromotionDto.Code, applyPromotionDto.OrderAmount);
                return Ok(new { discount, finalAmount = applyPromotionDto.OrderAmount - discount });
            }
            catch (ArgumentException ex)
            {
                return BadRequest(new { message = ex.Message });
            }
            catch (InvalidOperationException ex)
            {
                return BadRequest(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error applying promotion");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }
    }
}
using elite.DTOs;
using elite.Interfaces;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;

namespace elite.Controllers
{
    // Controllers/ProductsController.cs
    [ApiController]
    [Route("api/[controller]")]
    public class ProductsController : ControllerBase
    {
        private readonly IProductService _productService;
        private readonly ILogger<ProductsController> _logger;

        public ProductsController(IProductService productService, ILogger<ProductsController> logger)
        {
            _productService = productService;
            _logger = logger;
        }

        [HttpGet]
        public async Task<IActionResult> GetAllProducts()
        {
            try
            {
                var products = await _productService.GetAllProductsAsync();
                return Ok(products);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting all products");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpGet("category/{category}")]
        public async Task<IActionResult> GetProductsByCategory(string category)
        {
            try
            {
                var products = await _productService.GetProductsByCategoryAsync(category);
                return Ok(products);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting products by category");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpGet("{id}")]
        public async Task<IActionResult> GetProductById(int id)
        {
            try
            {
                var product = await _productService.GetProductByIdAsync(id);
                return Ok(product);
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting product by ID");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpPost]
        [Authorize(Roles = "Admin")]
        public async Task<IActionResult> CreateProduct([FromForm] ProductCreateDto productCreateDto)
        {
            try
            {
                var result = await _productService.CreateProductAsync(productCreateDto);
                return CreatedAtAction(nameof(GetProductById), new { id = result.Id }, result);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error creating product");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        // Controllers/ProductsController.cs
        [HttpPut("{id}")]
        [Authorize(Roles = "Admin")]
        [Consumes("multipart/form-data")]
        public async Task<IActionResult> UpdateProduct(int id, [FromForm] ProductUpdateDto productUpdateDto)
        {
            try
            {
                var result = await _productService.UpdateProductAsync(id, productUpdateDto);
                return Ok(result);
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error updating product");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpDelete("{id}")]
        [Authorize(Roles = "Admin")]
        public async Task<IActionResult> DeleteProduct(int id)
        {
            try
            {
                var result = await _productService.DeleteProductAsync(id);
                return Ok(new { message = "Product deleted successfully" });
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error deleting product");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpPatch("{id}/stock")]
        [Authorize(Roles = "Admin")]
        public async Task<IActionResult> UpdateProductStock(int id, [FromBody] int quantity)
        {
            try
            {
                var result = await _productService.UpdateProductStockAsync(id, quantity);
                return Ok(new { message = "Product stock updated successfully" });
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error updating product stock");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }
    }
}
using elite.DTOs;
using elite.Interfaces;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;

namespace elite.Controllers
{
    // Controllers/PromotionsController.cs
    [ApiController]
    [Route("api/[controller]")]
    [Authorize(Roles = "Admin")]
    public class PromotionsController : ControllerBase
    {
        private readonly IPromotionService _promotionService;
        private readonly ILogger<PromotionsController> _logger;

        public PromotionsController(IPromotionService promotionService, ILogger<PromotionsController> logger)
        {
            _promotionService = promotionService;
            _logger = logger;
        }

        [HttpGet]
        public async Task<IActionResult> GetAllPromotions()
        {
            try
            {
                var promotions = await _promotionService.GetAllPromotionsAsync();
                return Ok(promotions);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting all promotions");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpGet("{id}")]
        public async Task<IActionResult> GetPromotionById(int id)
        {
            try
            {
                var promotion = await _promotionService.GetPromotionByIdAsync(id);
                return Ok(promotion);
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting promotion by ID");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpGet("code/{code}")]
        public async Task<IActionResult> GetPromotionByCode(string code)
        {
            try
            {
                var promotion = await _promotionService.GetPromotionByCodeAsync(code);
                return Ok(promotion);
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting promotion by code");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpPost]
        public async Task<IActionResult> CreatePromotion([FromBody] PromotionCreateDto promotionCreateDto)
        {
            try
            {
                var result = await _promotionService.CreatePromotionAsync(promotionCreateDto);
                return CreatedAtAction(nameof(GetPromotionById), new { id = result.Id }, result);
            }
            catch (ArgumentException ex)
            {
                return BadRequest(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error creating promotion");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpPut("{id}")]
        public async Task<IActionResult> UpdatePromotion(int id, [FromBody] PromotionCreateDto promotionUpdateDto)
        {
            try
            {
                var result = await _promotionService.UpdatePromotionAsync(id, promotionUpdateDto);
                return Ok(result);
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error updating promotion");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpDelete("{id}")]
        public async Task<IActionResult> DeletePromotion(int id)
        {
            try
            {
                var result = await _promotionService.DeletePromotionAsync(id);
                return Ok(new { message = "Promotion deleted successfully" });
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error deleting promotion");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpPost("validate")]
        [AllowAnonymous]
        public async Task<IActionResult> ValidatePromotion([FromBody] ApplyPromotionDto applyPromotionDto)
        {
            try
            {
                var isValid = await _promotionService.ValidatePromotionAsync(applyPromotionDto.Code, applyPromotionDto.OrderAmount);
                return Ok(new { isValid });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error validating promotion");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }
    }
}
using Microsoft.AspNetCore.Mvc;

namespace elite.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    public class TestController : ControllerBase
    {
        [HttpGet]
        [Produces("application/json")]
        public IActionResult Get()
        {
            return Ok(new { message = "API is working!", timestamp = DateTime.UtcNow });
        }

        [HttpGet("hello/{name}")]
        [Produces("application/json")]
        public IActionResult Hello(string name)
        {
            return Ok(new { message = $"Hello, {name}!", timestamp = DateTime.UtcNow });
        }
    }
}
using elite.DTOs;
using elite.Interfaces;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;

namespace elite.Controllers
{
    // Controllers/TrainersController.cs
    [ApiController]
    [Route("api/[controller]")]
    public class TrainersController : ControllerBase
    {
        private readonly ITrainerService _trainerService;
        private readonly ILogger<TrainersController> _logger;

        public TrainersController(ITrainerService trainerService, ILogger<TrainersController> logger)
        {
            _trainerService = trainerService;
            _logger = logger;
        }

        [HttpGet]
        public async Task<IActionResult> GetAllTrainers()
        {
            try
            {
                var trainers = await _trainerService.GetAllTrainersAsync();
                return Ok(trainers);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting all trainers");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpGet("{id}")]
        public async Task<IActionResult> GetTrainerById(int id)
        {
            try
            {
                var trainer = await _trainerService.GetTrainerByIdAsync(id);
                return Ok(trainer);
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting trainer by ID");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpPost]
        [Authorize(Roles = "Admin")]
        [Consumes("multipart/form-data")]
        public async Task<IActionResult> CreateTrainer([FromForm] TrainerCreateDto trainerCreateDto)
        {
            try
            {
                var result = await _trainerService.CreateTrainerAsync(trainerCreateDto);
                return CreatedAtAction(nameof(GetTrainerById), new { id = result.Id }, result);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error creating trainer");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        // Controllers/TrainersController.cs
        [HttpPut("{id}")]
        [Authorize(Roles = "Admin")]
        [Consumes("multipart/form-data")]
        public async Task<IActionResult> UpdateTrainer(int id, [FromForm] TrainerUpdateDto trainerUpdateDto) // Changed parameter type
        {
            try
            {
                var result = await _trainerService.UpdateTrainerAsync(id, trainerUpdateDto);
                return Ok(result);
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error updating trainer");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }




        [HttpDelete("{id}")]
        [Authorize(Roles = "Admin")]
        public async Task<IActionResult> DeleteTrainer(int id)
        {
            try
            {
                var result = await _trainerService.DeleteTrainerAsync(id);
                return Ok(new { message = "Trainer deleted successfully" });
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error deleting trainer");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpGet("{id}/classes")]
        public async Task<IActionResult> GetTrainerClasses(int id)
        {
            try
            {
                var classes = await _trainerService.GetTrainerClassesAsync(id);
                return Ok(classes);
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting trainer classes");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpGet("{id}/sessions")]
        public async Task<IActionResult> GetTrainerSessions(int id)
        {
            try
            {
                var sessions = await _trainerService.GetTrainerSessionsAsync(id);
                return Ok(sessions);
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting trainer sessions");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }
    }
}
using elite.Models;

namespace elite.Data
{
    // Data/DataSeeder.cs
    public class DataSeeder
    {
        private readonly GymDbContext _context;

        public DataSeeder(GymDbContext context)
        {
            _context = context;
        }

        public async Task SeedDataAsync()
        {
            // Seed trainers if none exist
            if (!_context.Trainers.Any())
            {
                var trainers = new List<Trainer>
            {
                new Trainer
    {
        Name = "Sarah Johnson",
        Specialization = "Yoga",
        ExperienceYears = 5,
        Certifications = "RYT 500",
        Bio = "Experienced yoga instructor with 5 years of teaching experience",
        ImageUrl = null // Set to null since we're not seeding images
    },
                new Trainer
                {
                    Name = "Emily Davis",
                    Specialization = "Pilates",
                    ExperienceYears = 7,
                    Certifications = "Pilates Method Alliance",
                    Bio = "Pilates expert with international certification",
                     ImageUrl = null
                },
                new Trainer
                {
                    Name = "Jessica Wilson",
                    Specialization = "HIIT",
                    ExperienceYears = 4,
                    Certifications = "ACE Certified",
                    Bio = "High-intensity interval training specialist",
                     ImageUrl = null
                }
            };

                _context.Trainers.AddRange(trainers);
                await _context.SaveChangesAsync();
            }

            // Seed admin user if none exists
            if (!_context.Admins.Any())
            {
                var admin = new Admin
                {
                    Username = "admin",
                    PasswordHash = BCrypt.Net.BCrypt.HashPassword("admin123"),
                    Email = "admin@gym.com",
                    Role = "Admin"
                };

                _context.Admins.Add(admin);
                await _context.SaveChangesAsync();
            }

            // Seed membership types if none exist
            if (!_context.MembershipTypes.Any())
            {
                var membershipTypes = new List<MembershipType>
{
    new MembershipType
    {
        Name = "Basic",
        Description = "Basic membership with 10 hours",
        DurationMonths = 1,
        TotalHours = 10.0m,      // Use decimal notation
        Price = 49.99m,
        IsActive = true
    },
    new MembershipType
    {
        Name = "Medium",
        Description = "Medium membership with 25 hours",
        DurationMonths = 3,
        TotalHours = 25.0m,      // Use decimal notation
        Price = 99.99m,
        IsActive = true
    },
    new MembershipType
    {
        Name = "VIP",
        Description = "VIP membership with 50 hours",
        DurationMonths = 6,
        TotalHours = 50.0m,      // Use decimal notation
        Price = 199.99m,
        IsActive = true
    }
};

                _context.MembershipTypes.AddRange(membershipTypes);
                await _context.SaveChangesAsync();
            }

            // Seed sample products if none exist
            if (!_context.Products.Any())
            {
                var products = new List<Product>
            {
                new Product
                {
                    Name = "Yoga Mat",
                    Description = "High-quality non-slip yoga mat",
                    Price = 29.99m,
                    ImageUrl = "/images/products/yoga-mat.jpg",
                    Category = "Apparel",
                    StockQuantity = 50
                },
                new Product
                {
                    Name = "Protein Powder",
                    Description = "Whey protein powder for muscle recovery",
                    Price = 39.99m,
                    ImageUrl = "/images/products/protein-powder.jpg",
                    Category = "Supplements",
                    StockQuantity = 30
                },
                new Product
                {
                    Name = "Workout Gloves",
                    Description = "Comfortable gloves for weight training",
                    Price = 19.99m,
                    ImageUrl = "/images/products/workout-gloves.jpg",
                    Category = "Apparel",
                    StockQuantity = 25
                }
            };

                _context.Products.AddRange(products);
                await _context.SaveChangesAsync();
            }
        }
    }
}
using elite.Models;
using Microsoft.EntityFrameworkCore;
using System.Collections.Generic;
using System.Reflection.Emit;

namespace elite.Data
{
    // Data/GymDbContext.cs
    public class GymDbContext : DbContext
    {
        public GymDbContext(DbContextOptions<GymDbContext> options) : base(options) { }

        public DbSet<User> Users { get; set; }
        public DbSet<Membership> Memberships { get; set; }
        public DbSet<Class> Classes { get; set; }
        public DbSet<ClassSchedule> ClassSchedules { get; set; }
        public DbSet<OnlineSession> OnlineSessions { get; set; }
        public DbSet<OnlineSessionSchedule> OnlineSessionSchedules { get; set; }
        public DbSet<Trainer> Trainers { get; set; }
        public DbSet<Booking> Bookings { get; set; }
        public DbSet<Product> Products { get; set; }
        public DbSet<Order> Orders { get; set; }
        public DbSet<OrderItem> OrderItems { get; set; }
        public DbSet<Promotion> Promotions { get; set; }
        public DbSet<Admin> Admins { get; set; }
        public DbSet<MembershipType> MembershipTypes { get; set; }

        protected override void OnModelCreating(ModelBuilder modelBuilder)
        {
            // Configure relationships and constraints
            modelBuilder.Entity<User>()
                .HasIndex(u => u.Email)
                .IsUnique();

            modelBuilder.Entity<Membership>()
                .HasOne(m => m.User)
                .WithOne(u => u.Membership)
                .HasForeignKey<Membership>(m => m.UserId)
                .OnDelete(DeleteBehavior.Cascade);

            modelBuilder.Entity<ClassSchedule>()
                .HasCheckConstraint("CK_ClassSchedule_AvailableSlots", "[AvailableSlots] >= 0");

            // Seed data
            modelBuilder.Entity<Trainer>().HasData(
                new Trainer { Id = 1, Name = "Sarah Johnson", Specialization = "Yoga", ExperienceYears = 5, Certifications = "RYT 500", Bio = "Experienced yoga instructor", ImageUrl = "/images/trainers/sarah.jpg" },
                new Trainer { Id = 2, Name = "Emily Davis", Specialization = "Pilates", ExperienceYears = 7, Certifications = "Pilates Method Alliance", Bio = "Pilates expert", ImageUrl = "/images/trainers/emily.jpg" }
            );
            modelBuilder.Entity<MembershipType>().HasData(
                new MembershipType
                {
                    Id = 1,
                    Name = "Basic",
                    Description = "Basic membership with 10 hours",
                    DurationMonths = 1,
                    TotalHours = 10,
                    Price = 49.99m,
                    IsActive = true
                },
                new MembershipType
                {
                    Id = 2,
                    Name = "Medium",
                    Description = "Medium membership with 25 hours",
                    DurationMonths = 3,
                    TotalHours = 25,
                    Price = 99.99m,
                    IsActive = true
                },
                new MembershipType
                {
                    Id = 3,
                    Name = "VIP",
                    Description = "VIP membership with 50 hours",
                    DurationMonths = 6,
                    TotalHours = 50,
                    Price = 199.99m,
                    IsActive = true
                }
            );

            base.OnModelCreating(modelBuilder);
        }
    }
}
// Data/GymDbContextFactory.cs
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Design;
using Microsoft.Extensions.Configuration;
using System.IO;

namespace elite.Data
{
    public class GymDbContextFactory : IDesignTimeDbContextFactory<GymDbContext>
    {
        public GymDbContext CreateDbContext(string[] args)
        {
            var configuration = new ConfigurationBuilder()
                .SetBasePath(Directory.GetCurrentDirectory())
                .AddJsonFile("appsettings.json")
                .Build();

            var optionsBuilder = new DbContextOptionsBuilder<GymDbContext>();
            var connectionString = configuration.GetConnectionString("DefaultConnection");

            optionsBuilder.UseSqlServer(connectionString);

            return new GymDbContext(optionsBuilder.Options);
        }
    }
}
namespace elite.DTOs
{
    public class DashboardStatsDto
    {
        public int TotalUsers { get; set; }
        public int ActiveMemberships { get; set; }
        public int TotalBookingsToday { get; set; }
        public decimal RevenueThisMonth { get; set; }
        public int LowStockProducts { get; set; }
    }

    public class RevenueReportDto
    {
        public DateTime Date { get; set; }
        public decimal MembershipRevenue { get; set; }
        public decimal ProductRevenue { get; set; }
        public decimal TotalRevenue { get; set; }
        public int BookingsCount { get; set; }
    }
}
namespace elite.DTOs
{
    public class AuthResponseDto
    {
        public string Token { get; set; }
        public UserResponseDto User { get; set; }
    }

}
using System.ComponentModel.DataAnnotations;

namespace elite.DTOs
{
    public class CreateBookingDto
    {
        [Required]
        public int UserId { get; set; }

        [Required]
        public string Type { get; set; }

        [Required]
        public int ScheduleId { get; set; }
    }

    public class BookingResponseDto
    {
        public int Id { get; set; }
        public string Type { get; set; }
        public int ScheduleId { get; set; }
        public DateTime BookingDate { get; set; }
        public string Status { get; set; }
        public decimal HoursConsumed { get; set; }
        public string ClassName { get; set; }
        public string TrainerName { get; set; }
        public DateTime StartTime { get; set; }
        public DateTime EndTime { get; set; }
        public string Location { get; set; }

        // Add these properties for admin view
        public int UserId { get; set; }
        public string UserName { get; set; }
        public string UserEmail { get; set; } // Add this
    }

    public class BookingCancellationDto
    {
        [Required]
        public int BookingId { get; set; }

        [Required]
        public int UserId { get; set; }
    }
}
using System.ComponentModel.DataAnnotations;

namespace elite.DTOs
{
    public class ClassDto
    {
        public int Id { get; set; }
        public string Name { get; set; }
        public string Description { get; set; }
        public decimal Duration { get; set; }
        public int TrainerId { get; set; }
        public string TrainerName { get; set; }
        public int MaxCapacity { get; set; }
        public decimal Price { get; set; }
    }

    public class ClassCreateDto
    {
        [Required, MaxLength(100)]
        public string Name { get; set; }

        [Required]
        public string Description { get; set; }

        [Required, Range(0.5, 5)]
        public decimal Duration { get; set; }

        [Required]
        public int TrainerId { get; set; }

        [Required, Range(1, 50)]
        public int MaxCapacity { get; set; }

        public decimal Price { get; set; }
    }

    public class ClassScheduleDto
    {
        public int Id { get; set; }
        public int ClassId { get; set; }
        public string ClassName { get; set; }
        public DateTime StartTime { get; set; }
        public DateTime EndTime { get; set; }
        public string Location { get; set; }
        public int AvailableSlots { get; set; }
        public int MaxCapacity { get; set; }
    }

    public class ClassScheduleCreateDto
    {
        [Required]
        public int ClassId { get; set; }

        [Required]
        public DateTime StartTime { get; set; }

        [Required]
        public DateTime EndTime { get; set; }

        [Required, MaxLength(200)]
        public string Location { get; set; }
    }
}
using System.ComponentModel.DataAnnotations;

namespace elite.DTOs
{
    public class MembershipDto
    {
        public int Id { get; set; }
        public string Type { get; set; }
        public DateTime StartDate { get; set; }
        public DateTime EndDate { get; set; }
        public decimal TotalHours { get; set; }      // Change to decimal
        public decimal RemainingHours { get; set; }  // Change to decimal
        public string Status { get; set; }
        public decimal PricePaid { get; set; }
    }

    public class PurchaseMembershipDto
    {
        [Required]
        public int UserId { get; set; }

        [Required]
        public string Type { get; set; }
    }

}
using System.ComponentModel.DataAnnotations;

namespace elite.DTOs
{
    public class MembershipTypeDto
    {
        public int Id { get; set; }
        public string Name { get; set; }
        public string Description { get; set; }
        public int DurationMonths { get; set; }
        public decimal TotalHours { get; set; }  // Change from int to decimal
        public decimal Price { get; set; }
        public bool IsActive { get; set; }
    }

    public class MembershipTypeCreateDto
    {
        [Required, MaxLength(100)]
        public string Name { get; set; }

        [Required]
        public string Description { get; set; }

        [Required, Range(1, 12)]
        public int DurationMonths { get; set; }

        [Required, Range(1, 100)]
        public decimal TotalHours { get; set; }  // Change from int to decimal

        [Required, Range(0, 1000)]
        public decimal Price { get; set; }
    }

}
using System.ComponentModel.DataAnnotations;

namespace elite.DTOs
{
    public class OnlineSessionDto
    {
        public int Id { get; set; }
        public string Name { get; set; }
        public string Description { get; set; }
        public decimal Duration { get; set; }
        public int TrainerId { get; set; }
        public string TrainerName { get; set; }
        public decimal Price { get; set; }
    }

    public class OnlineSessionCreateDto
    {
        [Required, MaxLength(100)]
        public string Name { get; set; }

        [Required]
        public string Description { get; set; }

        [Required, Range(0.5, 5)]
        public decimal Duration { get; set; }

        [Required]
        public int TrainerId { get; set; }

        public decimal Price { get; set; }
    }

    public class OnlineSessionScheduleDto
    {
        public int Id { get; set; }
        public int OnlineSessionId { get; set; }
        public string SessionName { get; set; }
        public DateTime StartTime { get; set; }
        public DateTime EndTime { get; set; }
        public int AvailableSlots { get; set; }
        public int MaxSlots { get; set; } = 20;
    }

    public class OnlineSessionScheduleCreateDto
    {
        [Required]
        public int OnlineSessionId { get; set; }

        [Required]
        public DateTime StartTime { get; set; }

        [Required]
        public DateTime EndTime { get; set; }

        [Range(1, 20)]
        public int AvailableSlots { get; set; } = 20;
    }
}
using System.ComponentModel.DataAnnotations;

namespace elite.DTOs
{
    public class OrderDto
    {
        public int Id { get; set; }
        public int UserId { get; set; }
        public string UserName { get; set; }
        public DateTime OrderDate { get; set; }
        public decimal TotalAmount { get; set; }
        public string Status { get; set; }
        public List<OrderItemDto> OrderItems { get; set; }
    }

    public class OrderCreateDto
    {
        [Required]
        public int UserId { get; set; }

        public List<OrderItemCreateDto> Items { get; set; }

        public string PromotionCode { get; set; }
    }

    public class OrderItemDto
    {
        public int Id { get; set; }
        public int ProductId { get; set; }
        public string ProductName { get; set; }
        public int Quantity { get; set; }
        public decimal Price { get; set; }
        public decimal TotalPrice => Quantity * Price;
    }

    public class OrderItemCreateDto
    {
        [Required]
        public int ProductId { get; set; }

        [Required, Range(1, 10)]
        public int Quantity { get; set; }
    }
}
using System.ComponentModel.DataAnnotations;

namespace elite.DTOs
{
    public class ProductDto
    {
        public int Id { get; set; }
        public string Name { get; set; }
        public string Description { get; set; }
        public decimal Price { get; set; }
        public string ImageUrl { get; set; }
        public string Category { get; set; }
        public int StockQuantity { get; set; }
    }

    // From your DTOs/ProductCreateDto.cs
    public class ProductCreateDto
    {
        [Required, MaxLength(100)]
        public string Name { get; set; }
        [Required]
        public string Description { get; set; }
        [Required, Range(0, 1000)]
        public decimal Price { get; set; }
        public IFormFile ImageFile { get; set; } // For file upload
        [Required]
        public string Category { get; set; }
        [Range(0, 1000)]
        public int StockQuantity { get; set; }
    }
}
// DTOs/ProductUpdateDto.cs
using System.ComponentModel.DataAnnotations;

namespace elite.DTOs
{
    public class ProductUpdateDto
    {
        [Required, MaxLength(100)]
        public string Name { get; set; }

        [Required]
        public string Description { get; set; }

        [Required, Range(0, 1000)]
        public decimal Price { get; set; }

        [Required]
        public string Category { get; set; }

        [Range(0, 1000)]
        public int StockQuantity { get; set; }

        public IFormFile? ImageFile { get; set; } // Optional for updates
        public string? ExistingImageUrl { get; set; } // To track existing image
    }
}
using System.ComponentModel.DataAnnotations;

namespace elite.DTOs
{
    public class PromotionDto
    {
        public int Id { get; set; }
        public string Code { get; set; }
        public string Description { get; set; }
        public string DiscountType { get; set; }
        public decimal DiscountValue { get; set; }
        public DateTime StartDate { get; set; }
        public DateTime EndDate { get; set; }
        public int UsageLimit { get; set; }
        public int TimesUsed { get; set; }
    }

    public class PromotionCreateDto
    {
        [Required, MaxLength(20)]
        public string Code { get; set; }

        [Required]
        public string Description { get; set; }

        [Required]
        public string DiscountType { get; set; }

        [Required, Range(0, 100)]
        public decimal DiscountValue { get; set; }

        [Required]
        public DateTime StartDate { get; set; }

        [Required]
        public DateTime EndDate { get; set; }

        [Range(1, 1000)]
        public int UsageLimit { get; set; } = 100;
    }

    public class ApplyPromotionDto
    {
        [Required]
        public string Code { get; set; }

        [Required]
        public decimal OrderAmount { get; set; }
    }
}
using System.ComponentModel.DataAnnotations;

namespace elite.DTOs
{
    public class TrainerDto
    {
        public int Id { get; set; }
        public string Name { get; set; }
        public string Specialization { get; set; }
        public int ExperienceYears { get; set; }
        public string Certifications { get; set; }
        public string Bio { get; set; }
        public string ImageUrl { get; set; }
    }

    public class TrainerCreateDto
    {
        [Required, MaxLength(100)]
        public string Name { get; set; }
        [Required, MaxLength(100)]
        public string Specialization { get; set; }
        [Required, Range(0, 50)]
        public int ExperienceYears { get; set; }
        public string Certifications { get; set; }
        [Required]
        public string Bio { get; set; }
        public IFormFile ImageFile { get; set; } // For file upload
    }
}
using System.ComponentModel.DataAnnotations;

namespace elite.DTOs
{
    public class TrainerUpdateDto
    {
        [Required, MaxLength(100)]
        public string Name { get; set; }

        [Required, MaxLength(100)]
        public string Specialization { get; set; }

        [Required, Range(0, 50)]
        public int ExperienceYears { get; set; }

        public string Certifications { get; set; }

        [Required]
        public string Bio { get; set; }

        public IFormFile? ImageFile { get; set; } // Optional for updates
    }
}
using System.ComponentModel.DataAnnotations;

namespace elite.DTOs
{
    public class UserRegisterDto
    {
        [Required, MaxLength(100)]
        public string Name { get; set; }

        [Required, EmailAddress, MaxLength(100)]
        public string Email { get; set; }

        [Required, MinLength(6)]
        public string Password { get; set; }

        [Phone, MaxLength(20)]
        public string Phone { get; set; }
    }

    public class UserLoginDto
    {
        [Required, EmailAddress]
        public string Email { get; set; }

        [Required]
        public string Password { get; set; }
    }

    public class UserResponseDto
    {
        public int Id { get; set; }
        public string Name { get; set; }
        public string Email { get; set; }
        public string Phone { get; set; }
        public DateTime CreatedAt { get; set; }
        public MembershipDto Membership { get; set; }
    }

    public class UserUpdateDto
    {
        [MaxLength(100)]
        public string Name { get; set; }

        [Phone, MaxLength(20)]
        public string Phone { get; set; }
    }
}
using elite.DTOs;

namespace elite.Interfaces
{
    public interface IAdminService
    {
        Task<IEnumerable<UserResponseDto>> GetAllUsersAsync(int page, int pageSize);
        Task<UserResponseDto> GetUserDetailsAsync(int userId);
        Task<bool> UpdateUserStatusAsync(int userId, bool isActive);
        Task<DashboardStatsDto> GetDashboardStatsAsync();
        Task<IEnumerable<BookingResponseDto>> GetAllBookingsAsync(DateTime? startDate, DateTime? endDate);
        Task<IEnumerable<RevenueReportDto>> GetRevenueReportAsync(DateTime startDate, DateTime endDate);
        // In IAdminService.cs
        Task<IEnumerable<OrderDto>> GetAllOrdersAsync();
        // Interfaces/IAdminService.cs
        Task<BookingResponseDto> GetBookingDetailsAsync(int bookingId);

    }
}
using elite.DTOs;

namespace elite.Interfaces
{
    public interface IAuthService
    {
        Task<AuthResponseDto> RegisterAsync(UserRegisterDto registerDto);
        Task<AuthResponseDto> LoginAsync(UserLoginDto loginDto);
        Task<UserResponseDto> GetUserProfileAsync(int userId);
        Task<bool> UpdateUserProfileAsync(int userId, UserUpdateDto updateDto);
        Task<bool> ChangePasswordAsync(int userId, string currentPassword, string newPassword);
    }
}
// Interfaces/IBookingService.cs
using elite.DTOs;
using System.Collections.Generic;
using System.Threading.Tasks;

namespace elite.Interfaces
{
    public interface IBookingService
    {
        Task<BookingResponseDto> CreateBookingAsync(CreateBookingDto bookingDto);
        Task<bool> CancelBookingAsync(int bookingId, int userId);
        Task<IEnumerable<BookingResponseDto>> GetUserBookingsAsync(int userId);
        Task<BookingResponseDto> GetBookingDetailsAsync(int bookingId);
        Task<IEnumerable<BookingResponseDto>> GetBookingsByDateRangeAsync(DateTime startDate, DateTime endDate);
    }
}
using elite.DTOs;

namespace elite.Interfaces
{
    // Interfaces/IClassService.cs
    public interface IClassService
    {
        Task<IEnumerable<ClassDto>> GetAllClassesAsync();
        Task<ClassDto> GetClassByIdAsync(int id);
        Task<ClassDto> CreateClassAsync(ClassCreateDto classCreateDto);
        Task<ClassDto> UpdateClassAsync(int id, ClassCreateDto classUpdateDto);
        Task<bool> DeleteClassAsync(int id);
        Task<IEnumerable<ClassScheduleDto>> GetClassSchedulesAsync(int classId);
        Task<ClassScheduleDto> CreateClassScheduleAsync(ClassScheduleCreateDto scheduleCreateDto);
        Task<bool> DeleteClassScheduleAsync(int scheduleId);
    }
}
namespace elite.Interfaces
{
    public interface IImageService
    {
        Task<string> UploadImageAsync(IFormFile imageFile, string folderName);
        void DeleteImage(string imagePath);
        bool ImageExists(string imagePath);
    }
}
using elite.DTOs;

namespace elite.Interfaces
{
    public interface IMembershipService
    {
        Task<MembershipDto> PurchaseMembershipAsync(PurchaseMembershipDto purchaseDto);
        Task<MembershipDto> GetUserMembershipAsync(int userId);
        Task<bool> CheckMembershipValidityAsync(int userId);
        Task<bool> ExtendMembershipAsync(int membershipId, int additionalMonths);
        Task<bool> UpgradeMembershipAsync(int membershipId, string newType);
    }
}
// Interfaces/IMembershipTypeService.cs
using elite.DTOs;
using System.Threading.Tasks;

namespace elite.Interfaces
{
    public interface IMembershipTypeService
    {
        Task<IEnumerable<MembershipTypeDto>> GetAllMembershipTypesAsync();
        Task<MembershipTypeDto> GetMembershipTypeByIdAsync(int id);
        Task<MembershipTypeDto> CreateMembershipTypeAsync(MembershipTypeCreateDto createDto);
        Task<MembershipTypeDto> UpdateMembershipTypeAsync(int id, MembershipTypeCreateDto updateDto);
        Task<bool> DeleteMembershipTypeAsync(int id);
        Task<bool> ToggleMembershipTypeStatusAsync(int id, bool isActive);
    }
}
using elite.DTOs;

namespace elite.Interfaces
{
    // Interfaces/IOnlineSessionService.cs
    public interface IOnlineSessionService
    {
        Task<IEnumerable<OnlineSessionDto>> GetAllSessionsAsync();
        Task<OnlineSessionDto> GetSessionByIdAsync(int id);
        Task<OnlineSessionDto> CreateSessionAsync(OnlineSessionCreateDto sessionCreateDto);
        Task<OnlineSessionDto> UpdateSessionAsync(int id, OnlineSessionCreateDto sessionUpdateDto);
        Task<bool> DeleteSessionAsync(int id);
        Task<IEnumerable<OnlineSessionScheduleDto>> GetSessionSchedulesAsync(int sessionId);
        Task<OnlineSessionScheduleDto> CreateSessionScheduleAsync(OnlineSessionScheduleCreateDto scheduleCreateDto);
        Task<bool> DeleteSessionScheduleAsync(int scheduleId);
    }

}
using elite.DTOs;

namespace elite.Interfaces
{
    public interface IOrderService
    {
        Task<OrderDto> CreateOrderAsync(OrderCreateDto orderCreateDto);
        Task<OrderDto> GetOrderByIdAsync(int id);
        Task<IEnumerable<OrderDto>> GetUserOrdersAsync(int userId);
        Task<IEnumerable<OrderDto>> GetAllOrdersAsync();
        Task<bool> UpdateOrderStatusAsync(int id, string status);
        Task<bool> CancelOrderAsync(int id);
        Task<decimal> ApplyPromotionAsync(string code, decimal orderAmount);
    }
}
using elite.DTOs;

namespace elite.Interfaces
{
    public interface IProductService
    {
        Task<IEnumerable<ProductDto>> GetAllProductsAsync();
        Task<IEnumerable<ProductDto>> GetProductsByCategoryAsync(string category);
        Task<ProductDto> GetProductByIdAsync(int id);
        Task<ProductDto> CreateProductAsync(ProductCreateDto productCreateDto);
        Task<ProductDto> UpdateProductAsync(int id, ProductUpdateDto productUpdateDto);
        Task<bool> DeleteProductAsync(int id);
        Task<bool> UpdateProductStockAsync(int id, int quantity);
    }
}
using elite.DTOs;

namespace elite.Interfaces
{
    public interface IPromotionService
    {
        Task<IEnumerable<PromotionDto>> GetAllPromotionsAsync();
        Task<PromotionDto> GetPromotionByIdAsync(int id);
        Task<PromotionDto> GetPromotionByCodeAsync(string code);
        Task<PromotionDto> CreatePromotionAsync(PromotionCreateDto promotionCreateDto);
        Task<PromotionDto> UpdatePromotionAsync(int id, PromotionCreateDto promotionUpdateDto);
        Task<bool> DeletePromotionAsync(int id);
        Task<bool> ValidatePromotionAsync(string code, decimal orderAmount);
        Task<decimal> CalculateDiscountAsync(string code, decimal orderAmount);
    }
}
using elite.DTOs;

namespace elite.Interfaces
{
    public interface ITrainerService
    {
        Task<IEnumerable<TrainerDto>> GetAllTrainersAsync();
        Task<TrainerDto> GetTrainerByIdAsync(int id);
        Task<TrainerDto> CreateTrainerAsync(TrainerCreateDto trainerCreateDto);
        Task<TrainerDto> UpdateTrainerAsync(int id, TrainerUpdateDto trainerUpdateDto); // Changed parameter type
        Task<bool> DeleteTrainerAsync(int id);
        Task<IEnumerable<ClassDto>> GetTrainerClassesAsync(int trainerId);
        Task<IEnumerable<OnlineSessionDto>> GetTrainerSessionsAsync(int trainerId);
    }
}
namespace elite.Middleware
{
    public class CorrelationMiddleware
    {
        private readonly RequestDelegate _next;

        public CorrelationMiddleware(RequestDelegate next)
        {
            _next = next;
        }

        public async Task InvokeAsync(HttpContext context)
        {
            var correlationId = context.Request.Headers["X-Correlation-ID"].FirstOrDefault()
                              ?? Guid.NewGuid().ToString();

            context.Response.Headers["X-Correlation-ID"] = correlationId;
            context.Items["CorrelationId"] = correlationId;

            await _next(context);
        }
    }
}
using System.Text.Json;

namespace elite.Middleware
{
    public class ExceptionMiddleware
    {
        private readonly RequestDelegate _next;
        private readonly ILogger<ExceptionMiddleware> _logger;

        public ExceptionMiddleware(RequestDelegate next, ILogger<ExceptionMiddleware> logger)
        {
            _next = next;
            _logger = logger;
        }

        public async Task InvokeAsync(HttpContext httpContext)
        {
            try
            {
                await _next(httpContext);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "An unhandled exception occurred");
                await HandleExceptionAsync(httpContext, ex);
            }
        }

        private static Task HandleExceptionAsync(HttpContext context, Exception exception)
        {
            context.Response.ContentType = "application/json";
            context.Response.StatusCode = exception switch
            {
                ArgumentException => StatusCodes.Status400BadRequest,
                UnauthorizedAccessException => StatusCodes.Status401Unauthorized,
                InvalidOperationException => StatusCodes.Status400BadRequest,
                _ => StatusCodes.Status500InternalServerError
            };

            return context.Response.WriteAsync(new ErrorDetails
            {
                StatusCode = context.Response.StatusCode,
                Message = exception.Message
            }.ToString());
        }
    }

    public class ErrorDetails
    {
        public int StatusCode { get; set; }
        public string Message { get; set; }

        public override string ToString()
        {
            return JsonSerializer.Serialize(this);
        }
    }
}
namespace elite.Middleware
{
    public class PerformanceMiddleware
    {
        private readonly RequestDelegate _next;
        private readonly ILogger<PerformanceMiddleware> _logger;

        public PerformanceMiddleware(RequestDelegate next, ILogger<PerformanceMiddleware> logger)
        {
            _next = next;
            _logger = logger;
        }

        public async Task InvokeAsync(HttpContext context)
        {
            var stopwatch = System.Diagnostics.Stopwatch.StartNew();

            await _next(context);

            stopwatch.Stop();

            if (stopwatch.ElapsedMilliseconds > 1000) // Log slow requests
            {
                _logger.LogWarning("Slow request: {Method} {Path} took {ElapsedMs}ms",
                    context.Request.Method, context.Request.Path, stopwatch.ElapsedMilliseconds);
            }
        }
    }
}
namespace elite.Middleware
{
    public class RequestLoggingMiddleware
    {
        private readonly RequestDelegate _next;
        private readonly ILogger<RequestLoggingMiddleware> _logger;

        public RequestLoggingMiddleware(RequestDelegate next, ILogger<RequestLoggingMiddleware> logger)
        {
            _next = next;
            _logger = logger;
        }

        public async Task InvokeAsync(HttpContext context)
        {
            var startTime = DateTime.UtcNow;

            _logger.LogInformation("Request started: {Method} {Path}",
                context.Request.Method, context.Request.Path);

            await _next(context);

            var duration = DateTime.UtcNow - startTime;
            _logger.LogInformation("Request completed: {Method} {Path} - {StatusCode} in {Duration}ms",
                context.Request.Method, context.Request.Path, context.Response.StatusCode, duration.TotalMilliseconds);
        }
    }
}
namespace elite.Models
{
    public class Admin
    {
        public int Id { get; set; }
        public string Username { get; set; }
        public string PasswordHash { get; set; }
        public string Email { get; set; }
        public string Role { get; set; } = "Admin";
    }
}
namespace elite.Models
{
    public class Booking
    {
        public int Id { get; set; }
        public int UserId { get; set; }
        public string Type { get; set; } // "Class" or "OnlineSession"
        public int ScheduleId { get; set; }
        public DateTime BookingDate { get; set; }
        public string Status { get; set; } // Confirmed/Cancelled/Completed
        public decimal HoursConsumed { get; set; }

        public virtual User User { get; set; }
    }
}
namespace elite.Models
{
    public class Class
    {
        public int Id { get; set; }
        public string Name { get; set; }
        public string Description { get; set; }
        public decimal Duration { get; set; }
        public int TrainerId { get; set; }
        public int MaxCapacity { get; set; }
        public decimal Price { get; set; }

        public virtual Trainer Trainer { get; set; }
        public virtual ICollection<ClassSchedule> Schedules { get; set; }
    }

}
namespace elite.Models
{
    public class ClassSchedule
    {
        public int Id { get; set; }
        public int ClassId { get; set; }
        public DateTime StartTime { get; set; }
        public DateTime EndTime { get; set; }
        public string Location { get; set; }
        public int AvailableSlots { get; set; }

        public virtual Class Class { get; set; }
        public virtual ICollection<Booking> Bookings { get; set; }
    }
}
using System.ComponentModel.DataAnnotations;

namespace elite.Models
{
    public class Membership
    {
        public int Id { get; set; }
        public int UserId { get; set; }
        public string Type { get; set; }
        public DateTime StartDate { get; set; }
        public DateTime EndDate { get; set; }
        public decimal TotalHours { get; set; }       // Change this to decimal too!
        public decimal RemainingHours { get; set; }   // Changed to decimal
        public string Status { get; set; }
        public decimal PricePaid { get; set; }

        public virtual User User { get; set; }
    }
}
namespace elite.Models
{
    public class MembershipType
    {
        public int Id { get; set; }
        public string Name { get; set; }
        public string Description { get; set; }
        public int DurationMonths { get; set; }
        public decimal TotalHours { get; set; }      
        public decimal Price { get; set; }
        public bool IsActive { get; set; } = true;
    }
}
namespace elite.Models
{
    public class OnlineSession
    {
        public int Id { get; set; }
        public string Name { get; set; }
        public string Description { get; set; }
        public decimal Duration { get; set; }
        public int TrainerId { get; set; }
        public decimal Price { get; set; }

        public virtual Trainer Trainer { get; set; }
        public virtual ICollection<OnlineSessionSchedule> Schedules { get; set; }
    }
}
namespace elite.Models
{
    public class OnlineSessionSchedule
    {
        public int Id { get; set; }
        public int OnlineSessionId { get; set; }
        public DateTime StartTime { get; set; }
        public DateTime EndTime { get; set; }
        public int AvailableSlots { get; set; }

        public virtual OnlineSession OnlineSession { get; set; }
        public virtual ICollection<Booking> Bookings { get; set; }
    }
}
namespace elite.Models
{
    public class Order
    {
        public int Id { get; set; }
        public int UserId { get; set; }
        public DateTime OrderDate { get; set; }
        public decimal TotalAmount { get; set; }
        public string Status { get; set; } // Pending/Completed/Cancelled

        public virtual User User { get; set; }
        public virtual ICollection<OrderItem> OrderItems { get; set; }
    }
}
namespace elite.Models
{
    public class OrderItem
    {
        public int Id { get; set; }
        public int OrderId { get; set; }
        public int ProductId { get; set; }
        public int Quantity { get; set; }
        public decimal Price { get; set; }

        public virtual Order Order { get; set; }
        public virtual Product Product { get; set; }
    }
}
namespace elite.Models
{
    public class Product
    {
        public int Id { get; set; }
        public string Name { get; set; }
        public string Description { get; set; }
        public decimal Price { get; set; }
        public string ImageUrl { get; set; }
        public string Category { get; set; } // Apparel/Supplements

        public int StockQuantity { get; set; }
        public virtual ICollection<OrderItem> OrderItems { get; set; }
    }

}
namespace elite.Models
{
    public class Promotion
    {
        public int Id { get; set; }
        public string Code { get; set; }
        public string Description { get; set; }
        public string DiscountType { get; set; } // Percentage/Fixed
        public decimal DiscountValue { get; set; }
        public DateTime StartDate { get; set; }
        public DateTime EndDate { get; set; }
        public int UsageLimit { get; set; }
        public int TimesUsed { get; set; }
    }
}
namespace elite.Models
{
    public class Trainer
    {
        public int Id { get; set; }
        public string Name { get; set; }
        public string Specialization { get; set; }
        public int ExperienceYears { get; set; }
        public string Certifications { get; set; }
        public string Bio { get; set; }
        public string ImageUrl { get; set; }

        public virtual ICollection<Class> Classes { get; set; }
        public virtual ICollection<OnlineSession> OnlineSessions { get; set; }
    }
}
using System.ComponentModel.DataAnnotations;

namespace elite.Models
{
    public class User
    {
        public int Id { get; set; }

        [Required, MaxLength(100)]
        public string Name { get; set; }

        [Required, EmailAddress, MaxLength(100)]
        public string Email { get; set; }

        [Required, MaxLength(255)]
        public string PasswordHash { get; set; }

        [Phone, MaxLength(20)]
        public string Phone { get; set; }

        public int? MembershipId { get; set; }
        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
        public DateTime? UpdatedAt { get; set; }

        // Navigation properties
        public virtual Membership Membership { get; set; }
        public virtual ICollection<Booking> Bookings { get; set; }
        public virtual ICollection<Order> Orders { get; set; }
    }
}
using elite.Data;
using elite.DTOs;
using elite.Interfaces;
using Microsoft.EntityFrameworkCore;

namespace elite.Services
{
    // Services/AdminService.cs
    public class AdminService : IAdminService
    {
        private readonly GymDbContext _context;
        private readonly ILogger<AdminService> _logger;

        public AdminService(GymDbContext context, ILogger<AdminService> logger)
        {
            _context = context;
            _logger = logger;
        }

        public async Task<IEnumerable<UserResponseDto>> GetAllUsersAsync(int page, int pageSize)
        {
            return await _context.Users
                .Include(u => u.Membership)
                .Include(u => u.Bookings)
                .OrderBy(u => u.Id)
                .Skip((page - 1) * pageSize)
                .Take(pageSize)
                .Select(u => new UserResponseDto
                {
                    Id = u.Id,
                    Name = u.Name,
                    Email = u.Email,
                    Phone = u.Phone,
                    CreatedAt = u.CreatedAt,
                    Membership = u.Membership != null ? new MembershipDto
                    {
                        Id = u.Membership.Id,
                        Type = u.Membership.Type,
                        StartDate = u.Membership.StartDate,
                        EndDate = u.Membership.EndDate,
                        TotalHours = u.Membership.TotalHours,
                        RemainingHours = u.Membership.RemainingHours,
                        Status = u.Membership.Status
                    } : null
                })
                .ToListAsync();
        }

        public async Task<UserResponseDto> GetUserDetailsAsync(int userId)
        {
            var user = await _context.Users
                .Include(u => u.Membership)
                .Include(u => u.Bookings)
                .Include(u => u.Orders)
                .ThenInclude(o => o.OrderItems)
                .FirstOrDefaultAsync(u => u.Id == userId);

            if (user == null) throw new ArgumentException("User not found");

            return new UserResponseDto
            {
                Id = user.Id,
                Name = user.Name,
                Email = user.Email,
                Phone = user.Phone,
                CreatedAt = user.CreatedAt,
                Membership = user.Membership != null ? new MembershipDto
                {
                    Id = user.Membership.Id,
                    Type = user.Membership.Type,
                    StartDate = user.Membership.StartDate,
                    EndDate = user.Membership.EndDate,
                    TotalHours = user.Membership.TotalHours,
                    RemainingHours = user.Membership.RemainingHours,
                    Status = user.Membership.Status
                } : null
            };
        }

        public async Task<bool> UpdateUserStatusAsync(int userId, bool isActive)
        {
            // For this implementation, we'll assume users are always active
            // In a real system, you might have an IsActive property on the User model
            return await Task.FromResult(true);
        }

        public async Task<DashboardStatsDto> GetDashboardStatsAsync()
        {
            var totalUsers = await _context.Users.CountAsync();
            var activeMemberships = await _context.Memberships
                .CountAsync(m => m.Status == "Active" && m.EndDate >= DateTime.UtcNow);

            var totalBookingsToday = await _context.Bookings
                .CountAsync(b => b.BookingDate.Date == DateTime.UtcNow.Date && b.Status == "Confirmed");

            var revenueThisMonth = await _context.Orders
                .Where(o => o.OrderDate.Month == DateTime.UtcNow.Month &&
                           o.OrderDate.Year == DateTime.UtcNow.Year &&
                           o.Status == "Completed")
                .SumAsync(o => o.TotalAmount);

            var lowStockProducts = await _context.Products
                .CountAsync(p => p.StockQuantity <= 5);

            return new DashboardStatsDto
            {
                TotalUsers = totalUsers,
                ActiveMemberships = activeMemberships,
                TotalBookingsToday = totalBookingsToday,
                RevenueThisMonth = revenueThisMonth,
                LowStockProducts = lowStockProducts
            };
        }

        public async Task<IEnumerable<BookingResponseDto>> GetAllBookingsAsync(DateTime? startDate, DateTime? endDate)
        {
            var query = _context.Bookings
                .Include(b => b.User) // Ensure User is included
                .AsQueryable();

            if (startDate.HasValue)
                query = query.Where(b => b.BookingDate >= startDate.Value);

            if (endDate.HasValue)
                query = query.Where(b => b.BookingDate <= endDate.Value);

            return await query
                .OrderByDescending(b => b.BookingDate)
                .Select(b => new BookingResponseDto
                {
                    Id = b.Id,
                    Type = b.Type,
                    ScheduleId = b.ScheduleId,
                    BookingDate = b.BookingDate,
                    Status = b.Status,
                    HoursConsumed = b.HoursConsumed,
                    UserId = b.UserId,
                    UserName = b.User.Name, // Ensure this is set
                    ClassName = b.Type == "Class"
                        ? _context.ClassSchedules
                            .Where(cs => cs.Id == b.ScheduleId)
                            .Select(cs => cs.Class.Name)
                            .FirstOrDefault()
                        : _context.OnlineSessionSchedules
                            .Where(oss => oss.Id == b.ScheduleId)
                            .Select(oss => oss.OnlineSession.Name)
                            .FirstOrDefault(),
                    TrainerName = b.Type == "Class"
                        ? _context.ClassSchedules
                            .Where(cs => cs.Id == b.ScheduleId)
                            .Select(cs => cs.Class.Trainer.Name)
                            .FirstOrDefault()
                        : _context.OnlineSessionSchedules
                            .Where(oss => oss.Id == b.ScheduleId)
                            .Select(oss => oss.OnlineSession.Trainer.Name)
                            .FirstOrDefault(),
                    StartTime = b.Type == "Class"
                        ? _context.ClassSchedules
                            .Where(cs => cs.Id == b.ScheduleId)
                            .Select(cs => cs.StartTime)
                            .FirstOrDefault()
                        : _context.OnlineSessionSchedules
                            .Where(oss => oss.Id == b.ScheduleId)
                            .Select(oss => oss.StartTime)
                            .FirstOrDefault(),
                    EndTime = b.Type == "Class"
                        ? _context.ClassSchedules
                            .Where(cs => cs.Id == b.ScheduleId)
                            .Select(cs => cs.EndTime)
                            .FirstOrDefault()
                        : _context.OnlineSessionSchedules
                            .Where(oss => oss.Id == b.ScheduleId)
                            .Select(oss => oss.EndTime)
                            .FirstOrDefault(),
                    Location = b.Type == "Class"
                        ? _context.ClassSchedules
                            .Where(cs => cs.Id == b.ScheduleId)
                            .Select(cs => cs.Location)
                            .FirstOrDefault()
                        : "Online"
                })
                .ToListAsync();
        }



        // In AdminService.cs
        public async Task<IEnumerable<OrderDto>> GetAllOrdersAsync()
        {
            return await _context.Orders
                .Include(o => o.User)
                .Include(o => o.OrderItems)
                .ThenInclude(oi => oi.Product)
                .OrderByDescending(o => o.OrderDate)
                .Select(o => new OrderDto
                {
                    Id = o.Id,
                    UserId = o.UserId,
                    UserName = o.User.Name,
                    OrderDate = o.OrderDate,
                    TotalAmount = o.TotalAmount,
                    Status = o.Status,
                    OrderItems = o.OrderItems.Select(oi => new OrderItemDto
                    {
                        Id = oi.Id,
                        ProductId = oi.ProductId,
                        ProductName = oi.Product.Name,
                        Quantity = oi.Quantity,
                        Price = oi.Price
                    }).ToList()
                })
                .ToListAsync();
        }

        public async Task<BookingResponseDto> GetBookingDetailsAsync(int bookingId)
        {
            var booking = await _context.Bookings
                .Include(b => b.User) // Include the User navigation property
                .Where(b => b.Id == bookingId)
                .Select(b => new BookingResponseDto
                {
                    Id = b.Id,
                    Type = b.Type,
                    ScheduleId = b.ScheduleId,
                    BookingDate = b.BookingDate,
                    Status = b.Status,
                    HoursConsumed = b.HoursConsumed,
                    UserId = b.UserId,
                    UserName = b.User.Name, // Ensure this is set
                    UserEmail = b.User.Email, // Add this
                    ClassName = b.Type == "Class"
                        ? _context.ClassSchedules
                            .Where(cs => cs.Id == b.ScheduleId)
                            .Select(cs => cs.Class.Name)
                            .FirstOrDefault()
                        : _context.OnlineSessionSchedules
                            .Where(oss => oss.Id == b.ScheduleId)
                            .Select(oss => oss.OnlineSession.Name)
                            .FirstOrDefault(),
                    TrainerName = b.Type == "Class"
                        ? _context.ClassSchedules
                            .Where(cs => cs.Id == b.ScheduleId)
                            .Select(cs => cs.Class.Trainer.Name)
                            .FirstOrDefault()
                        : _context.OnlineSessionSchedules
                            .Where(oss => oss.Id == b.ScheduleId)
                            .Select(oss => oss.OnlineSession.Trainer.Name)
                            .FirstOrDefault(),
                    StartTime = b.Type == "Class"
                        ? _context.ClassSchedules
                            .Where(cs => cs.Id == b.ScheduleId)
                            .Select(cs => cs.StartTime)
                            .FirstOrDefault()
                        : _context.OnlineSessionSchedules
                            .Where(oss => oss.Id == b.ScheduleId)
                            .Select(oss => oss.StartTime)
                            .FirstOrDefault(),
                    EndTime = b.Type == "Class"
                        ? _context.ClassSchedules
                            .Where(cs => cs.Id == b.ScheduleId)
                            .Select(cs => cs.EndTime)
                            .FirstOrDefault()
                        : _context.OnlineSessionSchedules
                            .Where(oss => oss.Id == b.ScheduleId)
                            .Select(oss => oss.EndTime)
                            .FirstOrDefault(),
                    Location = b.Type == "Class"
                        ? _context.ClassSchedules
                            .Where(cs => cs.Id == b.ScheduleId)
                            .Select(cs => cs.Location)
                            .FirstOrDefault()
                        : "Online"
                })
                .FirstOrDefaultAsync();

            if (booking == null) throw new ArgumentException("Booking not found");
            return booking;
        }

        public async Task<IEnumerable<RevenueReportDto>> GetRevenueReportAsync(DateTime startDate, DateTime endDate)
        {
            var orders = await _context.Orders
                .Where(o => o.OrderDate >= startDate && o.OrderDate <= endDate && o.Status == "Completed")
                .ToListAsync();

            var memberships = await _context.Memberships
                .Where(m => m.StartDate >= startDate && m.StartDate <= endDate && m.Status == "Active")
                .ToListAsync();

            var revenueByDate = new Dictionary<DateTime, RevenueReportDto>();

            // Initialize all dates in range
            for (var date = startDate.Date; date <= endDate.Date; date = date.AddDays(1))
            {
                revenueByDate[date] = new RevenueReportDto
                {
                    Date = date,
                    MembershipRevenue = 0,
                    ProductRevenue = 0,
                    TotalRevenue = 0,
                    BookingsCount = 0
                };
            }

            // Calculate product revenue from orders
            foreach (var order in orders)
            {
                var date = order.OrderDate.Date;
                if (revenueByDate.ContainsKey(date))
                {
                    revenueByDate[date].ProductRevenue += order.TotalAmount;
                    revenueByDate[date].TotalRevenue += order.TotalAmount;
                }
            }

            // Calculate membership revenue (simplified - assuming fixed prices)
            foreach (var membership in memberships)
            {
                var date = membership.StartDate.Date;
                if (revenueByDate.ContainsKey(date))
                {
                    decimal membershipPrice = membership.Type switch
                    {
                        "Basic" => 49.99m,
                        "Medium" => 99.99m,
                        "VIP" => 199.99m,
                        _ => 0
                    };

                    revenueByDate[date].MembershipRevenue += membershipPrice;
                    revenueByDate[date].TotalRevenue += membershipPrice;
                }
            }

            // Calculate bookings count
            var bookings = await _context.Bookings
                .Where(b => b.BookingDate >= startDate && b.BookingDate <= endDate && b.Status == "Confirmed")
                .ToListAsync();

            foreach (var booking in bookings)
            {
                var date = booking.BookingDate.Date;
                if (revenueByDate.ContainsKey(date))
                {
                    revenueByDate[date].BookingsCount++;
                }
            }

            return revenueByDate.Values.OrderBy(r => r.Date).ToList();
        }
    }
}
using elite.Data;
using elite.DTOs;
using elite.Interfaces;
using elite.Models;
using elite.Utilities;
using Microsoft.EntityFrameworkCore;

namespace elite.Services
{


    public class AuthService : IAuthService
    {
        private readonly GymDbContext _context;
        private readonly IJwtService _jwtService;
        private readonly ILogger<AuthService> _logger;

        public AuthService(GymDbContext context, IJwtService jwtService, ILogger<AuthService> logger)
        {
            _context = context;
            _jwtService = jwtService;
            _logger = logger;
        }

        public async Task<AuthResponseDto> RegisterAsync(UserRegisterDto registerDto)
        {
            if (await _context.Users.AnyAsync(u => u.Email == registerDto.Email))
                throw new ArgumentException("Email already exists");

            var passwordHash = BCrypt.Net.BCrypt.HashPassword(registerDto.Password);

            var user = new User
            {
                Name = registerDto.Name,
                Email = registerDto.Email,
                PasswordHash = passwordHash,
                Phone = registerDto.Phone,
                CreatedAt = DateTime.UtcNow
            };

            _context.Users.Add(user);
            await _context.SaveChangesAsync();

            var token = _jwtService.GenerateToken(user);

            return new AuthResponseDto
            {
                Token = token,
                User = new UserResponseDto
                {
                    Id = user.Id,
                    Name = user.Name,
                    Email = user.Email,
                    Phone = user.Phone,
                    CreatedAt = user.CreatedAt
                }
            };
        }

        public async Task<AuthResponseDto> LoginAsync(UserLoginDto loginDto)
        {
            // First try to find a user
            var user = await _context.Users
                .Include(u => u.Membership)
                .FirstOrDefaultAsync(u => u.Email == loginDto.Email);

            // If not found, try to find an admin
            if (user == null)
            {
                var admin = await _context.Admins
                    .FirstOrDefaultAsync(a => a.Email == loginDto.Email);

                if (admin != null && BCrypt.Net.BCrypt.Verify(loginDto.Password, admin.PasswordHash))
                {
                    // Generate token for admin
                    var token = _jwtService.GenerateAdminToken(admin);

                    return new AuthResponseDto
                    {
                        Token = token,
                        User = new UserResponseDto
                        {
                            Id = admin.Id,
                            Name = admin.Username,
                            Email = admin.Email,
                            CreatedAt = DateTime.UtcNow,
                            // Admins don't have memberships
                            Membership = null
                        }
                    };
                }
            }

            // Original user login logic
            if (user == null || !BCrypt.Net.BCrypt.Verify(loginDto.Password, user.PasswordHash))
                throw new UnauthorizedAccessException("Invalid credentials");

            var userToken = _jwtService.GenerateToken(user);

            return new AuthResponseDto
            {
                Token = userToken,
                User = new UserResponseDto
                {
                    Id = user.Id,
                    Name = user.Name,
                    Email = user.Email,
                    Phone = user.Phone,
                    CreatedAt = user.CreatedAt,
                    Membership = user.Membership != null ? new MembershipDto
                    {
                        Id = user.Membership.Id,
                        Type = user.Membership.Type,
                        StartDate = user.Membership.StartDate,
                        EndDate = user.Membership.EndDate,
                        TotalHours = user.Membership.TotalHours,
                        RemainingHours = user.Membership.RemainingHours,
                        Status = user.Membership.Status
                    } : null
                }
            };
        }

        public async Task<UserResponseDto> GetUserProfileAsync(int userId)
        {
            var user = await _context.Users
                .Include(u => u.Membership)
                .FirstOrDefaultAsync(u => u.Id == userId);

            if (user == null) throw new ArgumentException("User not found");

            return new UserResponseDto
            {
                Id = user.Id,
                Name = user.Name,
                Email = user.Email,
                Phone = user.Phone,
                CreatedAt = user.CreatedAt,
                Membership = user.Membership != null ? new MembershipDto
                {
                    Id = user.Membership.Id,
                    Type = user.Membership.Type,
                    StartDate = user.Membership.StartDate,
                    EndDate = user.Membership.EndDate,
                    TotalHours = user.Membership.TotalHours,
                    RemainingHours = user.Membership.RemainingHours,
                    Status = user.Membership.Status
                } : null
            };
        }

        public async Task<bool> UpdateUserProfileAsync(int userId, UserUpdateDto updateDto)
        {
            var user = await _context.Users.FindAsync(userId);
            if (user == null) throw new ArgumentException("User not found");

            if (!string.IsNullOrEmpty(updateDto.Name))
                user.Name = updateDto.Name;

            if (!string.IsNullOrEmpty(updateDto.Phone))
                user.Phone = updateDto.Phone;

            user.UpdatedAt = DateTime.UtcNow;

            _context.Users.Update(user);
            return await _context.SaveChangesAsync() > 0;
        }

        public async Task<bool> ChangePasswordAsync(int userId, string currentPassword, string newPassword)
        {
            var user = await _context.Users.FindAsync(userId);
            if (user == null) throw new ArgumentException("User not found");

            if (!BCrypt.Net.BCrypt.Verify(currentPassword, user.PasswordHash))
                throw new UnauthorizedAccessException("Current password is incorrect");

            user.PasswordHash = BCrypt.Net.BCrypt.HashPassword(newPassword);
            user.UpdatedAt = DateTime.UtcNow;

            _context.Users.Update(user);
            return await _context.SaveChangesAsync() > 0;
        }
    }

}
using elite.Data;
using elite.DTOs;
using elite.Interfaces;
using elite.Models;
using Microsoft.EntityFrameworkCore;

namespace elite.Services
{
    public class BookingService : IBookingService
    {
        private readonly GymDbContext _context;
        private readonly ILogger<BookingService> _logger;

        public BookingService(GymDbContext context, ILogger<BookingService> logger)
        {
            _context = context;
            _logger = logger;
        }

        public async Task<BookingResponseDto> CreateBookingAsync(CreateBookingDto bookingDto)
        {
            using var transaction = await _context.Database.BeginTransactionAsync();

            try
            {
                var user = await _context.Users
                    .Include(u => u.Membership)
                    .FirstOrDefaultAsync(u => u.Id == bookingDto.UserId);

                if (user == null) throw new ArgumentException("User not found");

                if (user.Membership == null || user.Membership.Status != "Active")
                    throw new InvalidOperationException("User does not have an active membership");

                if (user.Membership.EndDate < DateTime.UtcNow.Date)
                {
                    user.Membership.Status = "Expired";
                    await _context.SaveChangesAsync();
                    throw new InvalidOperationException("Membership has expired");
                }

                decimal duration = 0;
                string className = string.Empty;
                string trainerName = string.Empty;
                DateTime startTime, endTime;
                string location = string.Empty;

                if (bookingDto.Type == "Class")
                {
                    var schedule = await _context.ClassSchedules
                        .Include(cs => cs.Class)
                        .ThenInclude(c => c.Trainer)
                        .FirstOrDefaultAsync(cs => cs.Id == bookingDto.ScheduleId);

                    if (schedule == null) throw new ArgumentException("Class schedule not found");
                    if (schedule.AvailableSlots <= 0) throw new InvalidOperationException("No available slots");
                    if (schedule.StartTime <= DateTime.UtcNow) throw new InvalidOperationException("Class has already started");

                    // FIX: Convert minutes to hours
                    duration = schedule.Class.Duration / 60.0m;
                    className = schedule.Class.Name;
                    trainerName = schedule.Class.Trainer.Name;
                    startTime = schedule.StartTime;
                    endTime = schedule.EndTime;
                    location = schedule.Location;

                    var existingBooking = await _context.Bookings
                        .FirstOrDefaultAsync(b => b.UserId == bookingDto.UserId &&
                                                 b.Type == "Class" &&
                                                 b.ScheduleId == bookingDto.ScheduleId &&
                                                 b.Status == "Confirmed");

                    if (existingBooking != null) throw new InvalidOperationException("User already booked this class");

                    schedule.AvailableSlots--;
                    _context.ClassSchedules.Update(schedule);
                }
                else if (bookingDto.Type == "OnlineSession")
                {
                    var schedule = await _context.OnlineSessionSchedules
                        .Include(oss => oss.OnlineSession)
                        .ThenInclude(os => os.Trainer)
                        .FirstOrDefaultAsync(oss => oss.Id == bookingDto.ScheduleId);

                    if (schedule == null) throw new ArgumentException("Online session schedule not found");
                    if (schedule.AvailableSlots <= 0) throw new InvalidOperationException("No available slots");
                    if (schedule.StartTime <= DateTime.UtcNow) throw new InvalidOperationException("Session has already started");

                    // FIX: Convert minutes to hours
                    duration = schedule.OnlineSession.Duration / 60.0m;
                    className = schedule.OnlineSession.Name;
                    trainerName = schedule.OnlineSession.Trainer.Name;
                    startTime = schedule.StartTime;
                    endTime = schedule.EndTime;

                    schedule.AvailableSlots--;
                    _context.OnlineSessionSchedules.Update(schedule);
                }
                else
                {
                    throw new ArgumentException("Invalid booking type");
                }

                if (user.Membership.RemainingHours < duration)
                    throw new InvalidOperationException("Insufficient hours in membership");

                user.Membership.RemainingHours -= duration;
                _context.Memberships.Update(user.Membership);

                var booking = new Booking
                {
                    UserId = bookingDto.UserId,
                    Type = bookingDto.Type,
                    ScheduleId = bookingDto.ScheduleId,
                    BookingDate = DateTime.UtcNow,
                    Status = "Confirmed",
                    HoursConsumed = duration
                };

                _context.Bookings.Add(booking);
                await _context.SaveChangesAsync();
                await transaction.CommitAsync();

                return new BookingResponseDto
                {
                    Id = booking.Id,
                    Type = booking.Type,
                    ScheduleId = booking.ScheduleId,
                    BookingDate = booking.BookingDate,
                    Status = booking.Status,
                    HoursConsumed = booking.HoursConsumed,
                    ClassName = className,
                    TrainerName = trainerName,
                    StartTime = startTime,
                    EndTime = endTime,
                    Location = location
                };
            }
            catch (Exception ex)
            {
                await transaction.RollbackAsync();
                _logger.LogError(ex, "Error creating booking");
                throw;
            }
        }

        public async Task<bool> CancelBookingAsync(int bookingId, int userId)
        {
            using var transaction = await _context.Database.BeginTransactionAsync();

            try
            {
                var booking = await _context.Bookings
                    .Include(b => b.User)
                    .ThenInclude(u => u.Membership)
                    .FirstOrDefaultAsync(b => b.Id == bookingId && b.UserId == userId);

                if (booking == null) throw new ArgumentException("Booking not found");
                if (booking.Status != "Confirmed") throw new InvalidOperationException("Booking cannot be cancelled");

                DateTime scheduleTime;
                decimal duration = booking.HoursConsumed;

                if (booking.Type == "Class")
                {
                    var schedule = await _context.ClassSchedules.FindAsync(booking.ScheduleId);
                    if (schedule == null) throw new ArgumentException("Class schedule not found");

                    scheduleTime = schedule.StartTime;

                    // Check cancellation policy (>24 hours)
                    if ((scheduleTime - DateTime.UtcNow).TotalHours > 24)
                    {
                        // Refund hours
                        booking.User.Membership.RemainingHours += duration; // FIX: Removed (int) cast
                        _context.Memberships.Update(booking.User.Membership);

                        // Increment available slots
                        schedule.AvailableSlots++;
                        _context.ClassSchedules.Update(schedule);
                    }
                }
                else
                {
                    var schedule = await _context.OnlineSessionSchedules.FindAsync(booking.ScheduleId);
                    if (schedule == null) throw new ArgumentException("Online session schedule not found");

                    scheduleTime = schedule.StartTime;

                    // Check cancellation policy (>24 hours)
                    if ((scheduleTime - DateTime.UtcNow).TotalHours > 24)
                    {
                        // Refund hours
                        booking.User.Membership.RemainingHours += duration; // FIX: Removed (int) cast
                        _context.Memberships.Update(booking.User.Membership);

                        // Increment available slots
                        schedule.AvailableSlots++;
                        _context.OnlineSessionSchedules.Update(schedule);
                    }
                }

                booking.Status = "Cancelled";
                _context.Bookings.Update(booking);

                await _context.SaveChangesAsync();
                await transaction.CommitAsync();

                return true;
            }
            catch (Exception ex)
            {
                await transaction.RollbackAsync();
                _logger.LogError(ex, "Error cancelling booking");
                throw;
            }
        }

        public async Task<IEnumerable<BookingResponseDto>> GetUserBookingsAsync(int userId)
        {
            var bookings = await _context.Bookings
                .Where(b => b.UserId == userId)
                .OrderByDescending(b => b.BookingDate)
                .Select(b => new BookingResponseDto
                {
                    Id = b.Id,
                    Type = b.Type,
                    ScheduleId = b.ScheduleId,
                    BookingDate = b.BookingDate,
                    Status = b.Status,
                    HoursConsumed = b.HoursConsumed,
                    ClassName = b.Type == "Class"
                        ? _context.ClassSchedules
                            .Where(cs => cs.Id == b.ScheduleId)
                            .Select(cs => cs.Class.Name)
                            .FirstOrDefault()
                        : _context.OnlineSessionSchedules
                            .Where(oss => oss.Id == b.ScheduleId)
                            .Select(oss => oss.OnlineSession.Name)
                            .FirstOrDefault(),
                    TrainerName = b.Type == "Class"
                        ? _context.ClassSchedules
                            .Where(cs => cs.Id == b.ScheduleId)
                            .Select(cs => cs.Class.Trainer.Name)
                            .FirstOrDefault()
                        : _context.OnlineSessionSchedules
                            .Where(oss => oss.Id == b.ScheduleId)
                            .Select(oss => oss.OnlineSession.Trainer.Name)
                            .FirstOrDefault(),
                    StartTime = b.Type == "Class"
                        ? _context.ClassSchedules
                            .Where(cs => cs.Id == b.ScheduleId)
                            .Select(cs => cs.StartTime)
                            .FirstOrDefault()
                        : _context.OnlineSessionSchedules
                            .Where(oss => oss.Id == b.ScheduleId)
                            .Select(oss => oss.StartTime)
                            .FirstOrDefault(),
                    EndTime = b.Type == "Class"
                        ? _context.ClassSchedules
                            .Where(cs => cs.Id == b.ScheduleId)
                            .Select(cs => cs.EndTime)
                            .FirstOrDefault()
                        : _context.OnlineSessionSchedules
                            .Where(oss => oss.Id == b.ScheduleId)
                            .Select(oss => oss.EndTime)
                            .FirstOrDefault(),
                    Location = b.Type == "Class"
                        ? _context.ClassSchedules
                            .Where(cs => cs.Id == b.ScheduleId)
                            .Select(cs => cs.Location)
                            .FirstOrDefault()
                        : "Online"
                })
                .ToListAsync();

            return bookings;
        }

        // Services/BookingService.cs
        public async Task<BookingResponseDto> GetBookingDetailsAsync(int bookingId)
        {
            var booking = await _context.Bookings
                .Include(b => b.User) // Include the User navigation property
                .Where(b => b.Id == bookingId)
                .Select(b => new BookingResponseDto
                {
                    Id = b.Id,
                    Type = b.Type,
                    ScheduleId = b.ScheduleId,
                    BookingDate = b.BookingDate,
                    Status = b.Status,
                    HoursConsumed = b.HoursConsumed,
                    UserId = b.UserId,
                    UserName = b.User.Name,
                    ClassName = b.Type == "Class"
                        ? _context.ClassSchedules
                            .Where(cs => cs.Id == b.ScheduleId)
                            .Select(cs => cs.Class.Name)
                            .FirstOrDefault()
                        : _context.OnlineSessionSchedules
                            .Where(oss => oss.Id == b.ScheduleId)
                            .Select(oss => oss.OnlineSession.Name)
                            .FirstOrDefault(),
                    TrainerName = b.Type == "Class"
                        ? _context.ClassSchedules
                            .Where(cs => cs.Id == b.ScheduleId)
                            .Select(cs => cs.Class.Trainer.Name)
                            .FirstOrDefault()
                        : _context.OnlineSessionSchedules
                            .Where(oss => oss.Id == b.ScheduleId)
                            .Select(oss => oss.OnlineSession.Trainer.Name)
                            .FirstOrDefault(),
                    StartTime = b.Type == "Class"
                        ? _context.ClassSchedules
                            .Where(cs => cs.Id == b.ScheduleId)
                            .Select(cs => cs.StartTime)
                            .FirstOrDefault()
                        : _context.OnlineSessionSchedules
                            .Where(oss => oss.Id == b.ScheduleId)
                            .Select(oss => oss.StartTime)
                            .FirstOrDefault(),
                    EndTime = b.Type == "Class"
                        ? _context.ClassSchedules
                            .Where(cs => cs.Id == b.ScheduleId)
                            .Select(cs => cs.EndTime)
                            .FirstOrDefault()
                        : _context.OnlineSessionSchedules
                            .Where(oss => oss.Id == b.ScheduleId)
                            .Select(oss => oss.EndTime)
                            .FirstOrDefault(),
                    Location = b.Type == "Class"
                        ? _context.ClassSchedules
                            .Where(cs => cs.Id == b.ScheduleId)
                            .Select(cs => cs.Location)
                            .FirstOrDefault()
                        : "Online"
                })
                .FirstOrDefaultAsync();

            if (booking == null) throw new ArgumentException("Booking not found");
            return booking;
        }




        public async Task<IEnumerable<BookingResponseDto>> GetBookingsByDateRangeAsync(DateTime startDate, DateTime endDate)
        {
            var bookings = await _context.Bookings
                .Where(b => b.BookingDate >= startDate && b.BookingDate <= endDate)
                .OrderByDescending(b => b.BookingDate)
                .Select(b => new BookingResponseDto
                {
                    Id = b.Id,
                    Type = b.Type,
                    ScheduleId = b.ScheduleId,
                    BookingDate = b.BookingDate,
                    Status = b.Status,
                    HoursConsumed = b.HoursConsumed,
                    ClassName = b.Type == "Class"
                        ? _context.ClassSchedules
                            .Where(cs => cs.Id == b.ScheduleId)
                            .Select(cs => cs.Class.Name)
                            .FirstOrDefault()
                        : _context.OnlineSessionSchedules
                            .Where(oss => oss.Id == b.ScheduleId)
                            .Select(oss => oss.OnlineSession.Name)
                            .FirstOrDefault(),
                    TrainerName = b.Type == "Class"
                        ? _context.ClassSchedules
                            .Where(cs => cs.Id == b.ScheduleId)
                            .Select(cs => cs.Class.Trainer.Name)
                            .FirstOrDefault()
                        : _context.OnlineSessionSchedules
                            .Where(oss => oss.Id == b.ScheduleId)
                            .Select(oss => oss.OnlineSession.Trainer.Name)
                            .FirstOrDefault(),
                    StartTime = b.Type == "Class"
                        ? _context.ClassSchedules
                            .Where(cs => cs.Id == b.ScheduleId)
                            .Select(cs => cs.StartTime)
                            .FirstOrDefault()
                        : _context.OnlineSessionSchedules
                            .Where(oss => oss.Id == b.ScheduleId)
                            .Select(oss => oss.StartTime)
                            .FirstOrDefault(),
                    EndTime = b.Type == "Class"
                        ? _context.ClassSchedules
                            .Where(cs => cs.Id == b.ScheduleId)
                            .Select(cs => cs.EndTime)
                            .FirstOrDefault()
                        : _context.OnlineSessionSchedules
                            .Where(oss => oss.Id == b.ScheduleId)
                            .Select(oss => oss.EndTime)
                            .FirstOrDefault(),
                    Location = b.Type == "Class"
                        ? _context.ClassSchedules
                            .Where(cs => cs.Id == b.ScheduleId)
                            .Select(cs => cs.Location)
                            .FirstOrDefault()
                        : "Online"
                })
                .ToListAsync();

            return bookings;
        }
    }
}
using elite.Data;
using elite.DTOs;
using elite.Interfaces;
using elite.Models;
using Microsoft.EntityFrameworkCore;

namespace elite.Services
{
    // Services/ClassService.cs
    public class ClassService : IClassService
    {
        private readonly GymDbContext _context;
        private readonly ILogger<ClassService> _logger;

        public ClassService(GymDbContext context, ILogger<ClassService> logger)
        {
            _context = context;
            _logger = logger;
        }

        public async Task<IEnumerable<ClassDto>> GetAllClassesAsync()
        {
            return await _context.Classes
                .Include(c => c.Trainer)
                .Select(c => new ClassDto
                {
                    Id = c.Id,
                    Name = c.Name,
                    Description = c.Description,
                    Duration = c.Duration,
                    TrainerId = c.TrainerId,
                    TrainerName = c.Trainer.Name,
                    MaxCapacity = c.MaxCapacity,
                    Price = c.Price
                })
                .ToListAsync();
        }

        public async Task<ClassDto> GetClassByIdAsync(int id)
        {
            var classObj = await _context.Classes
                .Include(c => c.Trainer)
                .FirstOrDefaultAsync(c => c.Id == id);

            if (classObj == null) throw new ArgumentException("Class not found");

            return new ClassDto
            {
                Id = classObj.Id,
                Name = classObj.Name,
                Description = classObj.Description,
                Duration = classObj.Duration,
                TrainerId = classObj.TrainerId,
                TrainerName = classObj.Trainer.Name,
                MaxCapacity = classObj.MaxCapacity,
                Price = classObj.Price
            };
        }

        public async Task<ClassDto> CreateClassAsync(ClassCreateDto classCreateDto)
        {
            // Check if trainer exists
            var trainer = await _context.Trainers.FindAsync(classCreateDto.TrainerId);
            if (trainer == null) throw new ArgumentException("Trainer not found");

            var classObj = new Class
            {
                Name = classCreateDto.Name,
                Description = classCreateDto.Description,
                Duration = classCreateDto.Duration,
                TrainerId = classCreateDto.TrainerId,
                MaxCapacity = classCreateDto.MaxCapacity,
                Price = classCreateDto.Price
            };

            _context.Classes.Add(classObj);
            await _context.SaveChangesAsync();

            return new ClassDto
            {
                Id = classObj.Id,
                Name = classObj.Name,
                Description = classObj.Description,
                Duration = classObj.Duration,
                TrainerId = classObj.TrainerId,
                TrainerName = trainer.Name,
                MaxCapacity = classObj.MaxCapacity,
                Price = classObj.Price
            };
        }

        public async Task<ClassDto> UpdateClassAsync(int id, ClassCreateDto classUpdateDto)
        {
            var classObj = await _context.Classes.FindAsync(id);
            if (classObj == null) throw new ArgumentException("Class not found");

            // Check if trainer exists
            var trainer = await _context.Trainers.FindAsync(classUpdateDto.TrainerId);
            if (trainer == null) throw new ArgumentException("Trainer not found");

            classObj.Name = classUpdateDto.Name;
            classObj.Description = classUpdateDto.Description;
            classObj.Duration = classUpdateDto.Duration;
            classObj.TrainerId = classUpdateDto.TrainerId;
            classObj.MaxCapacity = classUpdateDto.MaxCapacity;
            classObj.Price = classUpdateDto.Price;

            _context.Classes.Update(classObj);
            await _context.SaveChangesAsync();

            return new ClassDto
            {
                Id = classObj.Id,
                Name = classObj.Name,
                Description = classObj.Description,
                Duration = classObj.Duration,
                TrainerId = classObj.TrainerId,
                TrainerName = trainer.Name,
                MaxCapacity = classObj.MaxCapacity,
                Price = classObj.Price
            };
        }

        public async Task<bool> DeleteClassAsync(int id)
        {
            var classObj = await _context.Classes.FindAsync(id);
            if (classObj == null) throw new ArgumentException("Class not found");

            // Check if class has any schedules
            var hasSchedules = await _context.ClassSchedules.AnyAsync(cs => cs.ClassId == id);
            if (hasSchedules) throw new InvalidOperationException("Cannot delete class with existing schedules");

            _context.Classes.Remove(classObj);
            return await _context.SaveChangesAsync() > 0;
        }

        public async Task<IEnumerable<ClassScheduleDto>> GetClassSchedulesAsync(int classId)
        {
            return await _context.ClassSchedules
                .Where(cs => cs.ClassId == classId)
                .Include(cs => cs.Class)
                .Select(cs => new ClassScheduleDto
                {
                    Id = cs.Id,
                    ClassId = cs.ClassId,
                    ClassName = cs.Class.Name,
                    StartTime = cs.StartTime,
                    EndTime = cs.EndTime,
                    Location = cs.Location,
                    AvailableSlots = cs.AvailableSlots,
                    MaxCapacity = cs.Class.MaxCapacity
                })
                .ToListAsync();
        }

        public async Task<ClassScheduleDto> CreateClassScheduleAsync(ClassScheduleCreateDto scheduleCreateDto)
        {
            var classObj = await _context.Classes.FindAsync(scheduleCreateDto.ClassId);
            if (classObj == null) throw new ArgumentException("Class not found");

            // Check if the schedule overlaps with existing schedules
            var overlappingSchedule = await _context.ClassSchedules
                .Where(cs => cs.ClassId == scheduleCreateDto.ClassId)
                .Where(cs => cs.StartTime < scheduleCreateDto.EndTime && cs.EndTime > scheduleCreateDto.StartTime)
                .FirstOrDefaultAsync();

            if (overlappingSchedule != null)
                throw new InvalidOperationException("Schedule overlaps with existing class schedule");

            var schedule = new ClassSchedule
            {
                ClassId = scheduleCreateDto.ClassId,
                StartTime = scheduleCreateDto.StartTime,
                EndTime = scheduleCreateDto.EndTime,
                Location = scheduleCreateDto.Location,
                AvailableSlots = classObj.MaxCapacity
            };

            _context.ClassSchedules.Add(schedule);
            await _context.SaveChangesAsync();

            return new ClassScheduleDto
            {
                Id = schedule.Id,
                ClassId = schedule.ClassId,
                ClassName = classObj.Name,
                StartTime = schedule.StartTime,
                EndTime = schedule.EndTime,
                Location = schedule.Location,
                AvailableSlots = schedule.AvailableSlots,
                MaxCapacity = classObj.MaxCapacity
            };
        }

        public async Task<bool> DeleteClassScheduleAsync(int scheduleId)
        {
            var schedule = await _context.ClassSchedules.FindAsync(scheduleId);
            if (schedule == null) throw new ArgumentException("Class schedule not found");

            // Check if schedule has any bookings
            var hasBookings = await _context.Bookings.AnyAsync(b => b.ScheduleId == scheduleId && b.Type == "Class");
            if (hasBookings) throw new InvalidOperationException("Cannot delete schedule with existing bookings");

            _context.ClassSchedules.Remove(schedule);
            return await _context.SaveChangesAsync() > 0;
        }
    }
}
using elite.Interfaces;

namespace elite.Services
{
    public class ImageService : IImageService
    {
        private readonly IWebHostEnvironment _environment;
        private readonly ILogger<ImageService> _logger;

        public ImageService(IWebHostEnvironment environment, ILogger<ImageService> logger)
        {
            _environment = environment;
            _logger = logger;
        }

        // Services/ImageService.cs
        public async Task<string> UploadImageAsync(IFormFile imageFile, string folderName)
        {
            if (imageFile == null || imageFile.Length == 0)
                throw new ArgumentException("No file uploaded.");

            // Validate file type
            var allowedExtensions = new[] { ".jpg", ".jpeg", ".png", ".gif" };
            var fileExtension = Path.GetExtension(imageFile.FileName).ToLowerInvariant();

            if (!allowedExtensions.Contains(fileExtension))
                throw new ArgumentException("Invalid file type. Only JPG, JPEG, PNG, and GIF are allowed.");

            // Check if WebRootPath is set
            if (string.IsNullOrEmpty(_environment.WebRootPath))
            {
                _logger.LogError("WebRootPath is not set");
                throw new InvalidOperationException("WebRootPath is not configured");
            }

            // Create directory if it doesn't exist
            string uploadsFolder = Path.Combine(_environment.WebRootPath, "images", folderName);
            if (!Directory.Exists(uploadsFolder))
                Directory.CreateDirectory(uploadsFolder);

            // Generate unique filename
            string uniqueFileName = Guid.NewGuid().ToString() + fileExtension;
            string filePath = Path.Combine(uploadsFolder, uniqueFileName);

            // Save file
            using (var fileStream = new FileStream(filePath, FileMode.Create))
            {
                await imageFile.CopyToAsync(fileStream);
            }

            // Return relative path
            return Path.Combine("images", folderName, uniqueFileName).Replace("\\", "/");
        }

        public void DeleteImage(string imagePath)
        {
            if (string.IsNullOrEmpty(imagePath))
                return;

            if (string.IsNullOrEmpty(_environment.WebRootPath))
            {
                _logger.LogError("WebRootPath is not set");
                return;
            }

            try
            {
                string fullPath = Path.Combine(_environment.WebRootPath, imagePath);
                if (File.Exists(fullPath))
                {
                    File.Delete(fullPath);
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error deleting image: {ImagePath}", imagePath);
            }
        }

        public bool ImageExists(string imagePath)
        {
            if (string.IsNullOrEmpty(imagePath))
                return false;

            string fullPath = Path.Combine(_environment.WebRootPath, imagePath);
            return File.Exists(fullPath);
        }
    }
}
using elite.Data;
using elite.DTOs;
using elite.Interfaces;
using elite.Models;
using Microsoft.EntityFrameworkCore;

namespace elite.Services
{
    public class MembershipService : IMembershipService
    {
        private readonly GymDbContext _context;
        private readonly ILogger<MembershipService> _logger;

        public MembershipService(GymDbContext context, ILogger<MembershipService> logger)
        {
            _context = context;
            _logger = logger;
        }

        public async Task<MembershipDto> PurchaseMembershipAsync(PurchaseMembershipDto purchaseDto)
        {
            var user = await _context.Users.FindAsync(purchaseDto.UserId);
            if (user == null) throw new ArgumentException("User not found");

            // Check if user already has active membership
            var existingMembership = await _context.Memberships
                .FirstOrDefaultAsync(m => m.UserId == purchaseDto.UserId && m.Status == "Active");

            if (existingMembership != null)
                throw new InvalidOperationException("User already has an active membership");

            // Get membership type details
            var membershipType = await _context.MembershipTypes
                .FirstOrDefaultAsync(mt => mt.Name == purchaseDto.Type && mt.IsActive);

            if (membershipType == null)
                throw new ArgumentException("Invalid membership type or type not available");

            var membership = new Membership
            {
                UserId = purchaseDto.UserId,
                Type = membershipType.Name,
                StartDate = DateTime.UtcNow,
                EndDate = DateTime.UtcNow.AddMonths(membershipType.DurationMonths),
                TotalHours = membershipType.TotalHours,
                RemainingHours = membershipType.TotalHours,
                Status = "Active",
                PricePaid = membershipType.Price
            };

            _context.Memberships.Add(membership);
            await _context.SaveChangesAsync();

            return new MembershipDto
            {
                Id = membership.Id,
                Type = membership.Type,
                StartDate = membership.StartDate,
                EndDate = membership.EndDate,
                TotalHours = membership.TotalHours,
                RemainingHours = membership.RemainingHours,
                Status = membership.Status,
                PricePaid = membership.PricePaid // Add this line
            };
        }

        public async Task<MembershipDto> GetUserMembershipAsync(int userId)
        {
            var membership = await _context.Memberships
                .FirstOrDefaultAsync(m => m.UserId == userId);

            if (membership == null) throw new ArgumentException("Membership not found");

            return new MembershipDto
            {
                Id = membership.Id,
                Type = membership.Type,
                StartDate = membership.StartDate,
                EndDate = membership.EndDate,
                TotalHours = membership.TotalHours,
                RemainingHours = membership.RemainingHours,
                Status = membership.Status
            };
        }

        public async Task<bool> CheckMembershipValidityAsync(int userId)
        {
            var membership = await _context.Memberships
                .FirstOrDefaultAsync(m => m.UserId == userId);

            if (membership == null) return false;
            if (membership.Status != "Active") return false;
            if (membership.EndDate < DateTime.UtcNow.Date)
            {
                membership.Status = "Expired";
                await _context.SaveChangesAsync();
                return false;
            }

            return true;
        }

        public async Task<bool> ExtendMembershipAsync(int membershipId, int additionalMonths)
        {
            var membership = await _context.Memberships.FindAsync(membershipId);
            if (membership == null) throw new ArgumentException("Membership not found");

            membership.EndDate = membership.EndDate.AddMonths(additionalMonths);
            _context.Memberships.Update(membership);

            return await _context.SaveChangesAsync() > 0;
        }

        public async Task<bool> UpgradeMembershipAsync(int membershipId, string newType)
        {
            var membership = await _context.Memberships.FindAsync(membershipId);
            if (membership == null) throw new ArgumentException("Membership not found");

            // FIX THIS PART - use decimal for hours
            decimal totalHours = newType switch
            {
                "Basic" => 10.0m,
                "Medium" => 25.0m,
                "VIP" => 50.0m,
                _ => throw new ArgumentException("Invalid membership type")
            };

            // Calculate prorated hours - use decimal for all calculations
            decimal daysUsed = (decimal)(DateTime.UtcNow - membership.StartDate).TotalDays;
            decimal totalDays = (decimal)(membership.EndDate - membership.StartDate).TotalDays;
            decimal hoursUsed = membership.TotalHours - membership.RemainingHours;
            decimal hoursPerDay = membership.TotalHours / totalDays;
            decimal hoursToDeduct = hoursPerDay * daysUsed;

            decimal newRemainingHours = totalHours - hoursToDeduct;
            if (newRemainingHours < 0) newRemainingHours = 0;

            membership.Type = newType;
            membership.TotalHours = totalHours;
            membership.RemainingHours = newRemainingHours;

            _context.Memberships.Update(membership);
            return await _context.SaveChangesAsync() > 0;
        }
    }
}
// Services/MembershipTypeService.cs
using elite.Data;
using elite.DTOs;
using elite.Interfaces;
using elite.Models;
using Microsoft.EntityFrameworkCore;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace elite.Services
{
    public class MembershipTypeService : IMembershipTypeService
    {
        private readonly GymDbContext _context;
        private readonly ILogger<MembershipTypeService> _logger;

        public MembershipTypeService(GymDbContext context, ILogger<MembershipTypeService> logger)
        {
            _context = context;
            _logger = logger;
        }

        public async Task<IEnumerable<MembershipTypeDto>> GetAllMembershipTypesAsync()
        {
            return await _context.MembershipTypes
                .Where(mt => mt.IsActive)
                .Select(mt => new MembershipTypeDto
                {
                    Id = mt.Id,
                    Name = mt.Name,
                    Description = mt.Description,
                    DurationMonths = mt.DurationMonths,
                    TotalHours = mt.TotalHours,
                    Price = mt.Price,
                    IsActive = mt.IsActive
                })
                .ToListAsync();
        }

        public async Task<MembershipTypeDto> GetMembershipTypeByIdAsync(int id)
        {
            var membershipType = await _context.MembershipTypes.FindAsync(id);
            if (membershipType == null) throw new ArgumentException("Membership type not found");

            return new MembershipTypeDto
            {
                Id = membershipType.Id,
                Name = membershipType.Name,
                Description = membershipType.Description,
                DurationMonths = membershipType.DurationMonths,
                TotalHours = membershipType.TotalHours,
                Price = membershipType.Price,
                IsActive = membershipType.IsActive
            };
        }

        public async Task<MembershipTypeDto> CreateMembershipTypeAsync(MembershipTypeCreateDto createDto)
        {
            if (await _context.MembershipTypes.AnyAsync(mt => mt.Name == createDto.Name))
                throw new ArgumentException("Membership type with this name already exists");

            var membershipType = new MembershipType
            {
                Name = createDto.Name,
                Description = createDto.Description,
                DurationMonths = createDto.DurationMonths,
                TotalHours = createDto.TotalHours,
                Price = createDto.Price,
                IsActive = true
            };

            _context.MembershipTypes.Add(membershipType);
            await _context.SaveChangesAsync();

            return new MembershipTypeDto
            {
                Id = membershipType.Id,
                Name = membershipType.Name,
                Description = membershipType.Description,
                DurationMonths = membershipType.DurationMonths,
                TotalHours = membershipType.TotalHours,
                Price = membershipType.Price,
                IsActive = membershipType.IsActive
            };
        }

        public async Task<MembershipTypeDto> UpdateMembershipTypeAsync(int id, MembershipTypeCreateDto updateDto)
        {
            var membershipType = await _context.MembershipTypes.FindAsync(id);
            if (membershipType == null) throw new ArgumentException("Membership type not found");

            // Check if name is being changed and if it conflicts with another type
            if (membershipType.Name != updateDto.Name &&
                await _context.MembershipTypes.AnyAsync(mt => mt.Name == updateDto.Name))
                throw new ArgumentException("Membership type with this name already exists");

            membershipType.Name = updateDto.Name;
            membershipType.Description = updateDto.Description;
            membershipType.DurationMonths = updateDto.DurationMonths;
            membershipType.TotalHours = updateDto.TotalHours;
            membershipType.Price = updateDto.Price;

            _context.MembershipTypes.Update(membershipType);
            await _context.SaveChangesAsync();

            return new MembershipTypeDto
            {
                Id = membershipType.Id,
                Name = membershipType.Name,
                Description = membershipType.Description,
                DurationMonths = membershipType.DurationMonths,
                TotalHours = membershipType.TotalHours,
                Price = membershipType.Price,
                IsActive = membershipType.IsActive
            };
        }

        public async Task<bool> DeleteMembershipTypeAsync(int id)
        {
            var membershipType = await _context.MembershipTypes.FindAsync(id);
            if (membershipType == null) throw new ArgumentException("Membership type not found");

            // Check if this membership type is being used by any active memberships
            var hasActiveMemberships = await _context.Memberships
                .AnyAsync(m => m.Type == membershipType.Name && m.Status == "Active");

            if (hasActiveMemberships)
                throw new InvalidOperationException("Cannot delete membership type with active memberships");

            _context.MembershipTypes.Remove(membershipType);
            return await _context.SaveChangesAsync() > 0;
        }

        public async Task<bool> ToggleMembershipTypeStatusAsync(int id, bool isActive)
        {
            var membershipType = await _context.MembershipTypes.FindAsync(id);
            if (membershipType == null) throw new ArgumentException("Membership type not found");

            membershipType.IsActive = isActive;
            _context.MembershipTypes.Update(membershipType);
            return await _context.SaveChangesAsync() > 0;
        }
    }
}
using elite.Data;
using elite.DTOs;
using elite.Interfaces;
using elite.Models;
using Microsoft.EntityFrameworkCore;

namespace elite.Services
{
    // Services/OnlineSessionService.cs
    public class OnlineSessionService : IOnlineSessionService
    {
        private readonly GymDbContext _context;
        private readonly ILogger<OnlineSessionService> _logger;

        public OnlineSessionService(GymDbContext context, ILogger<OnlineSessionService> logger)
        {
            _context = context;
            _logger = logger;
        }

        public async Task<IEnumerable<OnlineSessionDto>> GetAllSessionsAsync()
        {
            return await _context.OnlineSessions
                .Include(os => os.Trainer)
                .Select(os => new OnlineSessionDto
                {
                    Id = os.Id,
                    Name = os.Name,
                    Description = os.Description,
                    Duration = os.Duration,
                    TrainerId = os.TrainerId,
                    TrainerName = os.Trainer.Name,
                    Price = os.Price
                })
                .ToListAsync();
        }

        public async Task<OnlineSessionDto> GetSessionByIdAsync(int id)
        {
            var session = await _context.OnlineSessions
                .Include(os => os.Trainer)
                .FirstOrDefaultAsync(os => os.Id == id);

            if (session == null) throw new ArgumentException("Online session not found");

            return new OnlineSessionDto
            {
                Id = session.Id,
                Name = session.Name,
                Description = session.Description,
                Duration = session.Duration,
                TrainerId = session.TrainerId,
                TrainerName = session.Trainer.Name,
                Price = session.Price
            };
        }

        public async Task<OnlineSessionDto> CreateSessionAsync(OnlineSessionCreateDto sessionCreateDto)
        {
            // Check if trainer exists
            var trainer = await _context.Trainers.FindAsync(sessionCreateDto.TrainerId);
            if (trainer == null) throw new ArgumentException("Trainer not found");

            var session = new OnlineSession
            {
                Name = sessionCreateDto.Name,
                Description = sessionCreateDto.Description,
                Duration = sessionCreateDto.Duration,
                TrainerId = sessionCreateDto.TrainerId,
                Price = sessionCreateDto.Price
            };

            _context.OnlineSessions.Add(session);
            await _context.SaveChangesAsync();

            return new OnlineSessionDto
            {
                Id = session.Id,
                Name = session.Name,
                Description = session.Description,
                Duration = session.Duration,
                TrainerId = session.TrainerId,
                TrainerName = trainer.Name,
                Price = session.Price
            };
        }

        public async Task<OnlineSessionDto> UpdateSessionAsync(int id, OnlineSessionCreateDto sessionUpdateDto)
        {
            var session = await _context.OnlineSessions.FindAsync(id);
            if (session == null) throw new ArgumentException("Online session not found");

            // Check if trainer exists
            var trainer = await _context.Trainers.FindAsync(sessionUpdateDto.TrainerId);
            if (trainer == null) throw new ArgumentException("Trainer not found");

            session.Name = sessionUpdateDto.Name;
            session.Description = sessionUpdateDto.Description;
            session.Duration = sessionUpdateDto.Duration;
            session.TrainerId = sessionUpdateDto.TrainerId;
            session.Price = sessionUpdateDto.Price;

            _context.OnlineSessions.Update(session);
            await _context.SaveChangesAsync();

            return new OnlineSessionDto
            {
                Id = session.Id,
                Name = session.Name,
                Description = session.Description,
                Duration = session.Duration,
                TrainerId = session.TrainerId,
                TrainerName = trainer.Name,
                Price = session.Price
            };
        }

        public async Task<bool> DeleteSessionAsync(int id)
        {
            var session = await _context.OnlineSessions.FindAsync(id);
            if (session == null) throw new ArgumentException("Online session not found");

            // Check if session has any schedules
            var hasSchedules = await _context.OnlineSessionSchedules.AnyAsync(oss => oss.OnlineSessionId == id);
            if (hasSchedules) throw new InvalidOperationException("Cannot delete session with existing schedules");

            _context.OnlineSessions.Remove(session);
            return await _context.SaveChangesAsync() > 0;
        }

        public async Task<IEnumerable<OnlineSessionScheduleDto>> GetSessionSchedulesAsync(int sessionId)
        {
            return await _context.OnlineSessionSchedules
                .Where(oss => oss.OnlineSessionId == sessionId)
                .Include(oss => oss.OnlineSession)
                .Select(oss => new OnlineSessionScheduleDto
                {
                    Id = oss.Id,
                    OnlineSessionId = oss.OnlineSessionId,
                    SessionName = oss.OnlineSession.Name,
                    StartTime = oss.StartTime,
                    EndTime = oss.EndTime,
                    AvailableSlots = oss.AvailableSlots,
                    MaxSlots = 20 // Fixed maximum for online sessions
                })
                .ToListAsync();
        }

        public async Task<OnlineSessionScheduleDto> CreateSessionScheduleAsync(OnlineSessionScheduleCreateDto scheduleCreateDto)
        {
            var session = await _context.OnlineSessions.FindAsync(scheduleCreateDto.OnlineSessionId);
            if (session == null) throw new ArgumentException("Online session not found");

            // Check if the schedule overlaps with existing schedules for the same trainer
            var overlappingSchedule = await _context.OnlineSessionSchedules
                .Where(oss => oss.OnlineSession.TrainerId == session.TrainerId)
                .Where(oss => oss.StartTime < scheduleCreateDto.EndTime && oss.EndTime > scheduleCreateDto.StartTime)
                .FirstOrDefaultAsync();

            if (overlappingSchedule != null)
                throw new InvalidOperationException("Schedule overlaps with existing session for this trainer");

            var schedule = new OnlineSessionSchedule
            {
                OnlineSessionId = scheduleCreateDto.OnlineSessionId,
                StartTime = scheduleCreateDto.StartTime,
                EndTime = scheduleCreateDto.EndTime,
                AvailableSlots = scheduleCreateDto.AvailableSlots
            };

            _context.OnlineSessionSchedules.Add(schedule);
            await _context.SaveChangesAsync();

            return new OnlineSessionScheduleDto
            {
                Id = schedule.Id,
                OnlineSessionId = schedule.OnlineSessionId,
                SessionName = session.Name,
                StartTime = schedule.StartTime,
                EndTime = schedule.EndTime,
                AvailableSlots = schedule.AvailableSlots,
                MaxSlots = 20
            };
        }

        public async Task<bool> DeleteSessionScheduleAsync(int scheduleId)
        {
            var schedule = await _context.OnlineSessionSchedules.FindAsync(scheduleId);
            if (schedule == null) throw new ArgumentException("Online session schedule not found");

            // Check if schedule has any bookings
            var hasBookings = await _context.Bookings.AnyAsync(b => b.ScheduleId == scheduleId && b.Type == "OnlineSession");
            if (hasBookings) throw new InvalidOperationException("Cannot delete schedule with existing bookings");

            _context.OnlineSessionSchedules.Remove(schedule);
            return await _context.SaveChangesAsync() > 0;
        }
    }
}
using elite.Data;
using elite.DTOs;
using elite.Interfaces;
using elite.Models;
using Microsoft.EntityFrameworkCore;

namespace elite.Services
{
    // Services/OrderService.cs
    public class OrderService : IOrderService
    {
        private readonly GymDbContext _context;
        private readonly IPromotionService _promotionService;
        private readonly ILogger<OrderService> _logger;

        public OrderService(GymDbContext context, IPromotionService promotionService, ILogger<OrderService> logger)
        {
            _context = context;
            _promotionService = promotionService;
            _logger = logger;
        }

        public async Task<OrderDto> CreateOrderAsync(OrderCreateDto orderCreateDto)
        {
            using var transaction = await _context.Database.BeginTransactionAsync();

            try
            {
                var user = await _context.Users.FindAsync(orderCreateDto.UserId);
                if (user == null) throw new ArgumentException("User not found");

                decimal totalAmount = 0;
                var orderItems = new List<OrderItem>();

                foreach (var item in orderCreateDto.Items)
                {
                    var product = await _context.Products.FindAsync(item.ProductId);
                    if (product == null) throw new ArgumentException($"Product with ID {item.ProductId} not found");

                    if (product.StockQuantity < item.Quantity)
                        throw new InvalidOperationException($"Insufficient stock for product: {product.Name}");

                    var orderItem = new OrderItem
                    {
                        ProductId = item.ProductId,
                        Quantity = item.Quantity,
                        Price = product.Price
                    };

                    totalAmount += product.Price * item.Quantity;
                    orderItems.Add(orderItem);

                    // Update product stock
                    product.StockQuantity -= item.Quantity;
                    _context.Products.Update(product);
                }

                // Apply promotion if provided
                decimal discount = 0;
                if (!string.IsNullOrEmpty(orderCreateDto.PromotionCode))
                {
                    try
                    {
                        discount = await _promotionService.CalculateDiscountAsync(orderCreateDto.PromotionCode, totalAmount);
                        totalAmount -= discount;
                    }
                    catch (Exception ex)
                    {
                        _logger.LogWarning(ex, "Failed to apply promotion code: {Code}", orderCreateDto.PromotionCode);
                    }
                }

                var order = new Order
                {
                    UserId = orderCreateDto.UserId,
                    OrderDate = DateTime.UtcNow,
                    TotalAmount = totalAmount,
                    Status = "Completed"
                };

                _context.Orders.Add(order);
                await _context.SaveChangesAsync();

                // Add order items with order ID
                foreach (var item in orderItems)
                {
                    item.OrderId = order.Id;
                    _context.OrderItems.Add(item);
                }

                await _context.SaveChangesAsync();
                await transaction.CommitAsync();

                return await GetOrderByIdAsync(order.Id);
            }
            catch (Exception ex)
            {
                await transaction.RollbackAsync();
                _logger.LogError(ex, "Error creating order");
                throw;
            }
        }

        public async Task<OrderDto> GetOrderByIdAsync(int id)
        {
            var order = await _context.Orders
                .Include(o => o.User)
                .Include(o => o.OrderItems)
                .ThenInclude(oi => oi.Product)
                .FirstOrDefaultAsync(o => o.Id == id);

            if (order == null) throw new ArgumentException("Order not found");

            return new OrderDto
            {
                Id = order.Id,
                UserId = order.UserId,
                UserName = order.User.Name,
                OrderDate = order.OrderDate,
                TotalAmount = order.TotalAmount,
                Status = order.Status,
                OrderItems = order.OrderItems.Select(oi => new OrderItemDto
                {
                    Id = oi.Id,
                    ProductId = oi.ProductId,
                    ProductName = oi.Product.Name,
                    Quantity = oi.Quantity,
                    Price = oi.Price
                }).ToList()
            };
        }

        public async Task<IEnumerable<OrderDto>> GetUserOrdersAsync(int userId)
        {
            return await _context.Orders
                .Where(o => o.UserId == userId)
                .Include(o => o.User)
                .Include(o => o.OrderItems)
                .ThenInclude(oi => oi.Product)
                .OrderByDescending(o => o.OrderDate)
                .Select(o => new OrderDto
                {
                    Id = o.Id,
                    UserId = o.UserId,
                    UserName = o.User.Name,
                    OrderDate = o.OrderDate,
                    TotalAmount = o.TotalAmount,
                    Status = o.Status,
                    OrderItems = o.OrderItems.Select(oi => new OrderItemDto
                    {
                        Id = oi.Id,
                        ProductId = oi.ProductId,
                        ProductName = oi.Product.Name,
                        Quantity = oi.Quantity,
                        Price = oi.Price
                    }).ToList()
                })
                .ToListAsync();
        }

        public async Task<IEnumerable<OrderDto>> GetAllOrdersAsync()
        {
            return await _context.Orders
                .Include(o => o.User)
                .Include(o => o.OrderItems)
                .ThenInclude(oi => oi.Product)
                .OrderByDescending(o => o.OrderDate)
                .Select(o => new OrderDto
                {
                    Id = o.Id,
                    UserId = o.UserId,
                    UserName = o.User.Name,
                    OrderDate = o.OrderDate,
                    TotalAmount = o.TotalAmount,
                    Status = o.Status,
                    OrderItems = o.OrderItems.Select(oi => new OrderItemDto
                    {
                        Id = oi.Id,
                        ProductId = oi.ProductId,
                        ProductName = oi.Product.Name,
                        Quantity = oi.Quantity,
                        Price = oi.Price
                    }).ToList()
                })
                .ToListAsync();
        }

        public async Task<bool> UpdateOrderStatusAsync(int id, string status)
        {
            var order = await _context.Orders.FindAsync(id);
            if (order == null) throw new ArgumentException("Order not found");

            order.Status = status;
            _context.Orders.Update(order);
            return await _context.SaveChangesAsync() > 0;
        }

        public async Task<bool> CancelOrderAsync(int id)
        {
            using var transaction = await _context.Database.BeginTransactionAsync();

            try
            {
                var order = await _context.Orders
                    .Include(o => o.OrderItems)
                    .FirstOrDefaultAsync(o => o.Id == id);

                if (order == null) throw new ArgumentException("Order not found");

                // Restore product stock
                foreach (var item in order.OrderItems)
                {
                    var product = await _context.Products.FindAsync(item.ProductId);
                    if (product != null)
                    {
                        product.StockQuantity += item.Quantity;
                        _context.Products.Update(product);
                    }
                }

                order.Status = "Cancelled";
                _context.Orders.Update(order);
                await _context.SaveChangesAsync();
                await transaction.CommitAsync();

                return true;
            }
            catch (Exception ex)
            {
                await transaction.RollbackAsync();
                _logger.LogError(ex, "Error cancelling order");
                throw;
            }
        }

        public async Task<decimal> ApplyPromotionAsync(string code, decimal orderAmount)
        {
            return await _promotionService.CalculateDiscountAsync(code, orderAmount);
        }
    }
}
using elite.Data;
using elite.DTOs;
using elite.Interfaces;
using elite.Models;
using Microsoft.EntityFrameworkCore;

namespace elite.Services
{
    // Services/ProductService.cs
    public class ProductService : IProductService
    {
        private readonly GymDbContext _context;
        private readonly ILogger<ProductService> _logger;
        private readonly IImageService _imageService;

        public ProductService(GymDbContext context, ILogger<ProductService> logger, IImageService imageService)
        {
            _context = context;
            _logger = logger;
            _imageService = imageService;
        }

        public async Task<IEnumerable<ProductDto>> GetAllProductsAsync()
        {
            return await _context.Products
                .Select(p => new ProductDto
                {
                    Id = p.Id,
                    Name = p.Name,
                    Description = p.Description,
                    Price = p.Price,
                    ImageUrl = p.ImageUrl,
                    Category = p.Category,
                    StockQuantity = p.StockQuantity
                })
                .ToListAsync();
        }

        public async Task<IEnumerable<ProductDto>> GetProductsByCategoryAsync(string category)
        {
            return await _context.Products
                .Where(p => p.Category == category)
                .Select(p => new ProductDto
                {
                    Id = p.Id,
                    Name = p.Name,
                    Description = p.Description,
                    Price = p.Price,
                    ImageUrl = p.ImageUrl,
                    Category = p.Category,
                    StockQuantity = p.StockQuantity
                })
                .ToListAsync();
        }

        public async Task<ProductDto> GetProductByIdAsync(int id)
        {
            var product = await _context.Products.FindAsync(id);
            if (product == null) throw new ArgumentException("Product not found");

            return new ProductDto
            {
                Id = product.Id,
                Name = product.Name,
                Description = product.Description,
                Price = product.Price,
                ImageUrl = product.ImageUrl,
                Category = product.Category,
                StockQuantity = product.StockQuantity
            };
        }

        public async Task<ProductDto> CreateProductAsync(ProductCreateDto productCreateDto)
        {
            string imageUrl = null;

            // Handle image upload if provided
            if (productCreateDto.ImageFile != null)
            {
                imageUrl = await _imageService.UploadImageAsync(productCreateDto.ImageFile, "products");
            }

            var product = new Product
            {
                Name = productCreateDto.Name,
                Description = productCreateDto.Description,
                Price = productCreateDto.Price,
                ImageUrl = imageUrl, // Use the uploaded image URL
                Category = productCreateDto.Category,
                StockQuantity = productCreateDto.StockQuantity
            };

            _context.Products.Add(product);
            await _context.SaveChangesAsync();

            return new ProductDto
            {
                Id = product.Id,
                Name = product.Name,
                Description = product.Description,
                Price = product.Price,
                ImageUrl = product.ImageUrl,
                Category = product.Category,
                StockQuantity = product.StockQuantity
            };
        }

        public async Task<ProductDto> UpdateProductAsync(int id, ProductUpdateDto productUpdateDto)
        {
            var product = await _context.Products.FindAsync(id);
            if (product == null) throw new ArgumentException("Product not found");

            // Handle image update ONLY if a new image is provided
            if (productUpdateDto.ImageFile != null && productUpdateDto.ImageFile.Length > 0)
            {
                try
                {
                    // Delete old image if exists
                    if (!string.IsNullOrEmpty(product.ImageUrl))
                    {
                        _imageService.DeleteImage(product.ImageUrl);
                    }

                    // Upload new image
                    product.ImageUrl = await _imageService.UploadImageAsync(productUpdateDto.ImageFile, "products");
                }
                catch (Exception ex)
                {
                    _logger.LogError(ex, "Error updating image for product");
                    // Keep existing image if upload fails
                }
            }
            // If no new image is provided, keep the existing image URL

            // Update other properties
            product.Name = productUpdateDto.Name;
            product.Description = productUpdateDto.Description;
            product.Price = productUpdateDto.Price;
            product.Category = productUpdateDto.Category;
            product.StockQuantity = productUpdateDto.StockQuantity;

            _context.Products.Update(product);
            await _context.SaveChangesAsync();

            return new ProductDto
            {
                Id = product.Id,
                Name = product.Name,
                Description = product.Description,
                Price = product.Price,
                ImageUrl = product.ImageUrl,
                Category = product.Category,
                StockQuantity = product.StockQuantity
            };
        }

        public async Task<bool> DeleteProductAsync(int id)
        {
            var product = await _context.Products.FindAsync(id);
            if (product == null) throw new ArgumentException("Product not found");

            _context.Products.Remove(product);
            return await _context.SaveChangesAsync() > 0;
        }

        // Services/ProductService.cs
        public async Task<bool> UpdateProductStockAsync(int id, int quantity)
        {
            var product = await _context.Products.FindAsync(id);
            if (product == null) throw new ArgumentException("Product not found");

            product.StockQuantity = quantity;
            _context.Products.Update(product);
            return await _context.SaveChangesAsync() > 0;
        }
    }
}
using elite.Data;
using elite.DTOs;
using elite.Interfaces;
using elite.Models;
using Microsoft.EntityFrameworkCore;

namespace elite.Services
{
    // Services/PromotionService.cs
    public class PromotionService : IPromotionService
    {
        private readonly GymDbContext _context;
        private readonly ILogger<PromotionService> _logger;

        public PromotionService(GymDbContext context, ILogger<PromotionService> logger)
        {
            _context = context;
            _logger = logger;
        }

        public async Task<IEnumerable<PromotionDto>> GetAllPromotionsAsync()
        {
            return await _context.Promotions
                .Select(p => new PromotionDto
                {
                    Id = p.Id,
                    Code = p.Code,
                    Description = p.Description,
                    DiscountType = p.DiscountType,
                    DiscountValue = p.DiscountValue,
                    StartDate = p.StartDate,
                    EndDate = p.EndDate,
                    UsageLimit = p.UsageLimit,
                    TimesUsed = p.TimesUsed
                })
                .ToListAsync();
        }

        public async Task<PromotionDto> GetPromotionByIdAsync(int id)
        {
            var promotion = await _context.Promotions.FindAsync(id);
            if (promotion == null) throw new ArgumentException("Promotion not found");

            return new PromotionDto
            {
                Id = promotion.Id,
                Code = promotion.Code,
                Description = promotion.Description,
                DiscountType = promotion.DiscountType,
                DiscountValue = promotion.DiscountValue,
                StartDate = promotion.StartDate,
                EndDate = promotion.EndDate,
                UsageLimit = promotion.UsageLimit,
                TimesUsed = promotion.TimesUsed
            };
        }

        public async Task<PromotionDto> GetPromotionByCodeAsync(string code)
        {
            var promotion = await _context.Promotions
                .FirstOrDefaultAsync(p => p.Code == code);

            if (promotion == null) throw new ArgumentException("Promotion not found");

            return new PromotionDto
            {
                Id = promotion.Id,
                Code = promotion.Code,
                Description = promotion.Description,
                DiscountType = promotion.DiscountType,
                DiscountValue = promotion.DiscountValue,
                StartDate = promotion.StartDate,
                EndDate = promotion.EndDate,
                UsageLimit = promotion.UsageLimit,
                TimesUsed = promotion.TimesUsed
            };
        }

        public async Task<PromotionDto> CreatePromotionAsync(PromotionCreateDto promotionCreateDto)
        {
            if (await _context.Promotions.AnyAsync(p => p.Code == promotionCreateDto.Code))
                throw new ArgumentException("Promotion code already exists");

            var promotion = new Promotion
            {
                Code = promotionCreateDto.Code,
                Description = promotionCreateDto.Description,
                DiscountType = promotionCreateDto.DiscountType,
                DiscountValue = promotionCreateDto.DiscountValue,
                StartDate = promotionCreateDto.StartDate,
                EndDate = promotionCreateDto.EndDate,
                UsageLimit = promotionCreateDto.UsageLimit,
                TimesUsed = 0
            };

            _context.Promotions.Add(promotion);
            await _context.SaveChangesAsync();

            return new PromotionDto
            {
                Id = promotion.Id,
                Code = promotion.Code,
                Description = promotion.Description,
                DiscountType = promotion.DiscountType,
                DiscountValue = promotion.DiscountValue,
                StartDate = promotion.StartDate,
                EndDate = promotion.EndDate,
                UsageLimit = promotion.UsageLimit,
                TimesUsed = promotion.TimesUsed
            };
        }

        public async Task<PromotionDto> UpdatePromotionAsync(int id, PromotionCreateDto promotionUpdateDto)
        {
            var promotion = await _context.Promotions.FindAsync(id);
            if (promotion == null) throw new ArgumentException("Promotion not found");

            // Check if code is being changed and if it already exists
            if (promotion.Code != promotionUpdateDto.Code &&
                await _context.Promotions.AnyAsync(p => p.Code == promotionUpdateDto.Code && p.Id != id))
                throw new ArgumentException("Promotion code already exists");

            promotion.Code = promotionUpdateDto.Code;
            promotion.Description = promotionUpdateDto.Description;
            promotion.DiscountType = promotionUpdateDto.DiscountType;
            promotion.DiscountValue = promotionUpdateDto.DiscountValue;
            promotion.StartDate = promotionUpdateDto.StartDate;
            promotion.EndDate = promotionUpdateDto.EndDate;
            promotion.UsageLimit = promotionUpdateDto.UsageLimit;

            _context.Promotions.Update(promotion);
            await _context.SaveChangesAsync();

            return new PromotionDto
            {
                Id = promotion.Id,
                Code = promotion.Code,
                Description = promotion.Description,
                DiscountType = promotion.DiscountType,
                DiscountValue = promotion.DiscountValue,
                StartDate = promotion.StartDate,
                EndDate = promotion.EndDate,
                UsageLimit = promotion.UsageLimit,
                TimesUsed = promotion.TimesUsed
            };
        }

        public async Task<bool> DeletePromotionAsync(int id)
        {
            var promotion = await _context.Promotions.FindAsync(id);
            if (promotion == null) throw new ArgumentException("Promotion not found");

            _context.Promotions.Remove(promotion);
            return await _context.SaveChangesAsync() > 0;
        }

        public async Task<bool> ValidatePromotionAsync(string code, decimal orderAmount)
        {
            var promotion = await _context.Promotions
                .FirstOrDefaultAsync(p => p.Code == code);

            if (promotion == null) return false;
            if (DateTime.UtcNow < promotion.StartDate || DateTime.UtcNow > promotion.EndDate) return false;
            if (promotion.UsageLimit > 0 && promotion.TimesUsed >= promotion.UsageLimit) return false;

            return true;
        }

        public async Task<decimal> CalculateDiscountAsync(string code, decimal orderAmount)
        {
            var promotion = await _context.Promotions
                .FirstOrDefaultAsync(p => p.Code == code);

            if (promotion == null) throw new ArgumentException("Promotion not found");
            if (!await ValidatePromotionAsync(code, orderAmount))
                throw new InvalidOperationException("Promotion is not valid");

            decimal discount = 0;
            if (promotion.DiscountType == "Percentage")
            {
                discount = orderAmount * (promotion.DiscountValue / 100);
            }
            else if (promotion.DiscountType == "Fixed")
            {
                discount = promotion.DiscountValue;
            }

            // Update usage count
            promotion.TimesUsed++;
            _context.Promotions.Update(promotion);
            await _context.SaveChangesAsync();

            return discount;
        }
    }
}
// Services/TrainerService.cs
using elite.Data;
using elite.DTOs;
using elite.Interfaces;
using elite.Models;
using Microsoft.EntityFrameworkCore;

namespace elite.Services
{
    public class TrainerService : ITrainerService
    {
        private readonly GymDbContext _context;
        private readonly ILogger<TrainerService> _logger;
        private readonly IImageService _imageService;

        public TrainerService(GymDbContext context, ILogger<TrainerService> logger, IImageService imageService)
        {
            _context = context;
            _logger = logger;
            _imageService = imageService;
        }

        public async Task<IEnumerable<TrainerDto>> GetAllTrainersAsync()
        {
            return await _context.Trainers
                .Select(t => new TrainerDto
                {
                    Id = t.Id,
                    Name = t.Name,
                    Specialization = t.Specialization,
                    ExperienceYears = t.ExperienceYears,
                    Certifications = t.Certifications,
                    Bio = t.Bio,
                    ImageUrl = t.ImageUrl
                })
                .ToListAsync();
        }

        public async Task<TrainerDto> GetTrainerByIdAsync(int id)
        {
            var trainer = await _context.Trainers.FindAsync(id);
            if (trainer == null) throw new ArgumentException("Trainer not found");

            return new TrainerDto
            {
                Id = trainer.Id,
                Name = trainer.Name,
                Specialization = trainer.Specialization,
                ExperienceYears = trainer.ExperienceYears,
                Certifications = trainer.Certifications,
                Bio = trainer.Bio,
                ImageUrl = trainer.ImageUrl
            };
        }

        public async Task<TrainerDto> CreateTrainerAsync(TrainerCreateDto trainerCreateDto)
        {
            try
            {
                string imageUrl = null;

                if (trainerCreateDto.ImageFile != null)
                {
                    try
                    {
                        imageUrl = await _imageService.UploadImageAsync(trainerCreateDto.ImageFile, "trainers");
                    }
                    catch (Exception ex)
                    {
                        _logger.LogError(ex, "Error uploading image for trainer");
                        // Continue without image if upload fails
                    }
                }

                var trainer = new Trainer
                {
                    Name = trainerCreateDto.Name,
                    Specialization = trainerCreateDto.Specialization,
                    ExperienceYears = trainerCreateDto.ExperienceYears,
                    Certifications = trainerCreateDto.Certifications,
                    Bio = trainerCreateDto.Bio,
                    ImageUrl = imageUrl
                };

                _context.Trainers.Add(trainer);
                await _context.SaveChangesAsync();

                return new TrainerDto
                {
                    Id = trainer.Id,
                    Name = trainer.Name,
                    Specialization = trainer.Specialization,
                    ExperienceYears = trainer.ExperienceYears,
                    Certifications = trainer.Certifications,
                    Bio = trainer.Bio,
                    ImageUrl = trainer.ImageUrl
                };
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error creating trainer");
                throw;
            }
        }

        // Updated method with TrainerUpdateDto
        public async Task<TrainerDto> UpdateTrainerAsync(int id, TrainerUpdateDto trainerUpdateDto)
        {
            try
            {
                var trainer = await _context.Trainers.FindAsync(id);
                if (trainer == null) throw new ArgumentException("Trainer not found");

                // Handle image update ONLY if a new image is provided
                if (trainerUpdateDto.ImageFile != null && trainerUpdateDto.ImageFile.Length > 0)
                {
                    try
                    {
                        // Delete old image if exists
                        if (!string.IsNullOrEmpty(trainer.ImageUrl))
                        {
                            _imageService.DeleteImage(trainer.ImageUrl);
                        }

                        // Upload new image
                        trainer.ImageUrl = await _imageService.UploadImageAsync(trainerUpdateDto.ImageFile, "trainers");
                    }
                    catch (Exception ex)
                    {
                        _logger.LogError(ex, "Error updating image for trainer");
                        // Keep existing image if upload fails
                    }
                }
                // If no new image is provided, keep the existing image URL

                // Update other properties
                trainer.Name = trainerUpdateDto.Name;
                trainer.Specialization = trainerUpdateDto.Specialization;
                trainer.ExperienceYears = trainerUpdateDto.ExperienceYears;
                trainer.Certifications = trainerUpdateDto.Certifications;
                trainer.Bio = trainerUpdateDto.Bio;

                await _context.SaveChangesAsync();

                return new TrainerDto
                {
                    Id = trainer.Id,
                    Name = trainer.Name,
                    Specialization = trainer.Specialization,
                    ExperienceYears = trainer.ExperienceYears,
                    Certifications = trainer.Certifications,
                    Bio = trainer.Bio,
                    ImageUrl = trainer.ImageUrl
                };
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error updating trainer");
                throw;
            }
        }

        public async Task<bool> DeleteTrainerAsync(int id)
        {
            var trainer = await _context.Trainers.FindAsync(id);
            if (trainer == null) throw new ArgumentException("Trainer not found");

            // Delete associated image
            if (!string.IsNullOrEmpty(trainer.ImageUrl))
            {
                _imageService.DeleteImage(trainer.ImageUrl);
            }

            _context.Trainers.Remove(trainer);
            return await _context.SaveChangesAsync() > 0;
        }

        public async Task<IEnumerable<ClassDto>> GetTrainerClassesAsync(int trainerId)
        {
            return await _context.Classes
                .Where(c => c.TrainerId == trainerId)
                .Select(c => new ClassDto
                {
                    Id = c.Id,
                    Name = c.Name,
                    Description = c.Description,
                    Duration = c.Duration,
                    TrainerId = c.TrainerId,
                    TrainerName = c.Trainer.Name,
                    MaxCapacity = c.MaxCapacity,
                    Price = c.Price
                })
                .ToListAsync();
        }

        public async Task<IEnumerable<OnlineSessionDto>> GetTrainerSessionsAsync(int trainerId)
        {
            return await _context.OnlineSessions
                .Where(os => os.TrainerId == trainerId)
                .Select(os => new OnlineSessionDto
                {
                    Id = os.Id,
                    Name = os.Name,
                    Description = os.Description,
                    Duration = os.Duration,
                    TrainerId = os.TrainerId,
                    TrainerName = os.Trainer.Name,
                    Price = os.Price
                })
                .ToListAsync();
        }
    }
}
using elite.Models;
using Microsoft.IdentityModel.Tokens;
using System.IdentityModel.Tokens.Jwt;
using System.Security.Claims;
using System.Text;

namespace elite.Utilities
{
    public interface IJwtService
    {
        string GenerateToken(User user);
        string GenerateAdminToken(Admin admin);
    }

    public class JwtService : IJwtService
    {
        private readonly IConfiguration _configuration;

        public JwtService(IConfiguration configuration)
        {
            _configuration = configuration;
        }
        // In elite/Utilities/JwtService.cs
        public string GenerateAdminToken(Admin admin)
        {
            var tokenHandler = new JwtSecurityTokenHandler();
            var key = Encoding.ASCII.GetBytes(_configuration["Jwt:Secret"]);
            var issuer = _configuration["Jwt:Issuer"]; // Add this line

            var tokenDescriptor = new SecurityTokenDescriptor
            {
                Subject = new ClaimsIdentity(new[]
                {
            new Claim(ClaimTypes.NameIdentifier, admin.Id.ToString()),
            new Claim(ClaimTypes.Email, admin.Email),
            new Claim(ClaimTypes.Name, admin.Username),
            new Claim(ClaimTypes.Role, "Admin")
        }),
                Expires = DateTime.UtcNow.AddDays(7),
                Issuer = issuer, // Add this line
                SigningCredentials = new SigningCredentials(new SymmetricSecurityKey(key), SecurityAlgorithms.HmacSha256Signature)
            };
            var token = tokenHandler.CreateToken(tokenDescriptor);
            return tokenHandler.WriteToken(token);
        }

        public string GenerateToken(User user)
        {
            var tokenHandler = new JwtSecurityTokenHandler();
            var key = Encoding.ASCII.GetBytes(_configuration["Jwt:Secret"]);
            var issuer = _configuration["Jwt:Issuer"];
            var audience = _configuration["Jwt:Audience"];

            var tokenDescriptor = new SecurityTokenDescriptor
            {
                Subject = new ClaimsIdentity(new[]
                {
            new Claim(ClaimTypes.NameIdentifier, user.Id.ToString()),
            new Claim(ClaimTypes.Email, user.Email),
            new Claim(ClaimTypes.Name, user.Name),
            new Claim(ClaimTypes.Role, "User")
        }),
                Expires = DateTime.UtcNow.AddDays(7),
                Issuer = issuer,
                Audience = audience,
                SigningCredentials = new SigningCredentials(new SymmetricSecurityKey(key), SecurityAlgorithms.HmacSha256Signature)
            };

            var token = tokenHandler.CreateToken(tokenDescriptor);
            return tokenHandler.WriteToken(token);
        }
    }
}
namespace elite.Utilities
{
    // Utilities/PasswordHasher.cs
    public interface IPasswordHasher
    {
        string HashPassword(string password);
        bool VerifyPassword(string hashedPassword, string providedPassword);
    }

    public class PasswordHasher : IPasswordHasher
    {
        public string HashPassword(string password)
        {
            return BCrypt.Net.BCrypt.HashPassword(password);
        }

        public bool VerifyPassword(string hashedPassword, string providedPassword)
        {
            return BCrypt.Net.BCrypt.Verify(providedPassword, hashedPassword);
        }
    }
}
using elite.Data;
using elite.Interfaces;
using elite.Middleware;
using elite.Services;
using elite.Utilities;
using Microsoft.AspNetCore.Authentication.JwtBearer;
using Microsoft.EntityFrameworkCore;
using Microsoft.IdentityModel.Tokens;
using Microsoft.OpenApi.Models;
using System.Text;

var builder = WebApplication.CreateBuilder(new WebApplicationOptions
{
    Args = args,
    WebRootPath = "wwwroot" // Set web root path here
});

// Add services to the container.
builder.Services.AddControllers();

// Add DbContext
builder.Services.AddDbContext<GymDbContext>(options =>
    options.UseSqlServer(builder.Configuration.GetConnectionString("DefaultConnection")));

// Add AutoMapper
builder.Services.AddAutoMapper(AppDomain.CurrentDomain.GetAssemblies());

// Add services
builder.Services.AddScoped<IAuthService, AuthService>();
builder.Services.AddScoped<IAdminService, AdminService>();
builder.Services.AddScoped<IBookingService, BookingService>();
builder.Services.AddScoped<IClassService, ClassService>();
builder.Services.AddScoped<IMembershipService, MembershipService>();
builder.Services.AddScoped<IOnlineSessionService, OnlineSessionService>();
builder.Services.AddScoped<IOrderService, OrderService>();
builder.Services.AddScoped<IProductService, ProductService>();
builder.Services.AddScoped<IPromotionService, PromotionService>();
builder.Services.AddScoped<ITrainerService, TrainerService>();
builder.Services.AddScoped<IJwtService, JwtService>();
builder.Services.AddScoped<IPasswordHasher, PasswordHasher>();
builder.Services.AddScoped<IMembershipTypeService, MembershipTypeService>();
builder.Services.AddScoped<IImageService, ImageService>();

// Configure JWT Authentication
var jwtSettings = builder.Configuration.GetSection("Jwt");
var key = Encoding.ASCII.GetBytes(jwtSettings["Secret"]);
builder.Services.AddAuthentication(options =>
{
    options.DefaultAuthenticateScheme = JwtBearerDefaults.AuthenticationScheme;
    options.DefaultChallengeScheme = JwtBearerDefaults.AuthenticationScheme;
})
.AddJwtBearer(options =>
{
    options.TokenValidationParameters = new TokenValidationParameters
    {
        ValidateIssuerSigningKey = true,
        IssuerSigningKey = new SymmetricSecurityKey(key),
        ValidateIssuer = true,
        ValidateAudience = false,
        ValidIssuer = jwtSettings["Issuer"],
        ValidateLifetime = true
    };
});

// Add Authorization
builder.Services.AddAuthorization();

// Configure Swagger/OpenAPI
builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen(options =>
{
    options.SwaggerDoc("v1", new OpenApiInfo
    {
        Title = "Gym Booking API",
        Version = "v1",
        Description = "Women's Gym Booking System API",
        Contact = new OpenApiContact
        {
            Name = "API Support",
            Email = "support@gymbooking.com",
            Url = new Uri("https://gymbooking.com/support")
        },
        License = new OpenApiLicense
        {
            Name = "Use under LICX",
            Url = new Uri("https://example.com/license")
        }
    });

    // Use full name as Schema ID to avoid naming conflicts
    options.CustomSchemaIds(type => type.FullName);

    // Add JWT authentication
    options.AddSecurityDefinition("Bearer", new OpenApiSecurityScheme
    {
        Description = "JWT Authorization header using the Bearer scheme. Example: \"Authorization: Bearer {token}\"",
        Name = "Authorization",
        In = ParameterLocation.Header,
        Type = SecuritySchemeType.ApiKey,
        Scheme = "Bearer"
    });

    options.AddSecurityRequirement(new OpenApiSecurityRequirement
    {
        {
            new OpenApiSecurityScheme
            {
                Reference = new OpenApiReference
                {
                    Type = ReferenceType.SecurityScheme,
                    Id = "Bearer"
                }
            },
            new string[] {}
        }
    });

    // Include XML comments if they exist
    var xmlFile = $"{System.Reflection.Assembly.GetExecutingAssembly().GetName().Name}.xml";
    var xmlPath = Path.Combine(AppContext.BaseDirectory, xmlFile);
    if (File.Exists(xmlPath))
    {
        options.IncludeXmlComments(xmlPath);
    }
});

// Add CORS
builder.Services.AddCors(options =>
{
    options.AddPolicy("AllowAll", builder =>
    {
        builder.AllowAnyOrigin()
               .AllowAnyMethod()
               .AllowAnyHeader();
    });
});

// Add detailed logging
builder.Services.AddLogging(loggingBuilder =>
{
    loggingBuilder.AddConsole();
    loggingBuilder.AddDebug();
});

var app = builder.Build();

// Configure the HTTP request pipeline.
if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI(c =>
    {
        c.SwaggerEndpoint("/swagger/v1/swagger.json", "Gym Booking API v1");
        c.RoutePrefix = "swagger";
    });
}

// Serve static files (including uploaded images)
app.UseStaticFiles();

app.UseHttpsRedirection();

app.UseCors("AllowAll");
app.UseAuthentication();
app.UseAuthorization();

// Use custom exception middleware
app.UseMiddleware<ExceptionMiddleware>();

// Check database connectivity
using (var scope = app.Services.CreateScope())
{
    var context = scope.ServiceProvider.GetRequiredService<GymDbContext>();
    var logger = scope.ServiceProvider.GetRequiredService<ILogger<Program>>();

    try
    {
        // Try to connect to the database
        await context.Database.CanConnectAsync();
        logger.LogInformation("Database connection successful");

        // Ensure database is created
        context.Database.EnsureCreated();

        // Apply any pending migrations
        await context.Database.MigrateAsync();

        // Seed data
        var seeder = new DataSeeder(context);
        await seeder.SeedDataAsync();
    }
    catch (Exception ex)
    {
        logger.LogError(ex, "Database connection or migration failed");
    }
}

app.MapControllers();

app.Run();
{
  "ConnectionStrings": {
    "DefaultConnection": "Server=.\\SQLEXPRESS;Database=GYMBookingDB;Trusted_Connection=True;TrustServerCertificate=True;"
  },
  "Jwt": {
    "Secret": "YourSuperSecretKeyHereAtLeast32CharactersLong",
    "Issuer": "GymBookingAPI",
    "Audience": "GymBookingClients",
    "ExpiryInDays": 7
  },
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*"
}


