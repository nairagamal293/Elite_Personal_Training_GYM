using AutoMapper;
using elite.DTOs;
using elite.Models;
using static System.Runtime.InteropServices.JavaScript.JSType;

namespace elite.Configurations
{
    public class AutoMapperProfile : Profile
    {
        public AutoMapperProfile()
        {
            
            AllowNullCollections = true;
            AllowNullDestinationValues = true;

            CreateMap<User, UserResponseDto>();
            CreateMap<Membership, MembershipDto>();
            CreateMap<Booking, BookingResponseDto>();
            CreateMap<Class, ClassDto>();
            CreateMap<Trainer, TrainerDto>();
        }
    }
}
using elite.Data;
using elite.Interfaces;
using elite.Models;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;

namespace elite.Controllers
{
    // Controllers/AdminController.cs
    [ApiController]
    [Route("api/admin")]
    [Authorize(Roles = "Admin")]
    public class AdminController : ControllerBase
    {
        private readonly IAdminService _adminService;
        private readonly ILogger<AdminController> _logger;

        public AdminController(IAdminService adminService, ILogger<AdminController> logger)
        {
            _adminService = adminService;
            _logger = logger;
        }

        [HttpGet("users")]
        public async Task<IActionResult> GetAllUsers([FromQuery] int page = 1, [FromQuery] int pageSize = 10)
        {
            try
            {
                var users = await _adminService.GetAllUsersAsync(page, pageSize);
                return Ok(users);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting all users");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpGet("users/{id}")]
        public async Task<IActionResult> GetUserDetails(int id)
        {
            try
            {
                var user = await _adminService.GetUserDetailsAsync(id);
                return Ok(user);
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting user details");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpGet("dashboard/stats")]
        public async Task<IActionResult> GetDashboardStats()
        {
            try
            {
                var stats = await _adminService.GetDashboardStatsAsync();
                return Ok(stats);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting dashboard stats");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpGet("bookings")]
        public async Task<IActionResult> GetAllBookings([FromQuery] DateTime? startDate, [FromQuery] DateTime? endDate)
        {
            try
            {
                var bookings = await _adminService.GetAllBookingsAsync(startDate, endDate);
                return Ok(bookings);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting all bookings");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }
        [HttpGet("orders")]
        public async Task<IActionResult> GetAllOrders()
        {
            try
            {
                var orders = await _adminService.GetAllOrdersAsync();
                return Ok(orders);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting all orders");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        // Controllers/AdminController.cs
        [HttpGet("bookings/{id}")]
        public async Task<IActionResult> GetBookingDetails(int id)
        {
            try
            {
                var booking = await _adminService.GetBookingDetailsAsync(id);
                return Ok(booking);
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting booking details");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }


        [HttpGet("revenue")]
        public async Task<IActionResult> GetRevenueReport([FromQuery] DateTime startDate, [FromQuery] DateTime endDate)
        {
            try
            {
                var revenue = await _adminService.GetRevenueReportAsync(startDate, endDate);
                return Ok(revenue);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting revenue report");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }
    }
}
// Controllers/AuthController.cs
using Microsoft.AspNetCore.Mvc;
using elite.DTOs;
using elite.Interfaces;

namespace elite.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    public class AuthController : ControllerBase
    {
        private readonly IAuthService _authService;
        private readonly ILogger<AuthController> _logger;

        public AuthController(IAuthService authService, ILogger<AuthController> logger)
        {
            _authService = authService;
            _logger = logger;
        }

        [HttpPost("register")]
        public async Task<ActionResult<AuthResponseDto>> Register([FromBody] UserRegisterDto registerDto)
        {
            try
            {
                var result = await _authService.RegisterAsync(registerDto);
                return Ok(result);
            }
            catch (ArgumentException ex)
            {
                return BadRequest(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error during registration");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpPost("login")]
        public async Task<ActionResult<AuthResponseDto>> Login([FromBody] UserLoginDto loginDto)
        {
            try
            {
                var result = await _authService.LoginAsync(loginDto);
                return Ok(result);
            }
            catch (UnauthorizedAccessException ex)
            {
                return Unauthorized(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error during login");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }



    }
}
// Controllers/BookingsController.cs
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using elite.DTOs;
using elite.Interfaces;
using System.Collections.Generic;
using System.Security.Claims;
using System.Threading.Tasks;

namespace elite.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    [Authorize]
    public class BookingsController : ControllerBase
    {
        private readonly IBookingService _bookingService;
        private readonly ILogger<BookingsController> _logger;

        public BookingsController(IBookingService bookingService, ILogger<BookingsController> logger)
        {
            _bookingService = bookingService;
            _logger = logger;
        }

        [HttpPost]
        public async Task<IActionResult> CreateBooking([FromBody] CreateBookingDto bookingDto)
        {
            try
            {
                // Get user ID from token
                var userId = int.Parse(User.FindFirst(ClaimTypes.NameIdentifier)?.Value);
                bookingDto.UserId = userId;
                var result = await _bookingService.CreateBookingAsync(bookingDto);
                return Ok(result);
            }
            catch (ArgumentException ex)
            {
                return BadRequest(new { message = ex.Message });
            }
            catch (InvalidOperationException ex)
            {
                return BadRequest(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error creating booking");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpDelete("{id}")]
        public async Task<IActionResult> CancelBooking(int id)
        {
            try
            {
                var userId = int.Parse(User.FindFirst(ClaimTypes.NameIdentifier)?.Value);
                var result = await _bookingService.CancelBookingAsync(id, userId);
                if (result)
                    return Ok(new { message = "Booking cancelled successfully" });
                else
                    return BadRequest(new { message = "Cannot cancel booking" });
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (InvalidOperationException ex)
            {
                return BadRequest(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error cancelling booking");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpGet]
        public async Task<IActionResult> GetUserBookings()
        {
            try
            {
                var userId = int.Parse(User.FindFirst(ClaimTypes.NameIdentifier)?.Value);
                var result = await _bookingService.GetUserBookingsAsync(userId);
                return Ok(result);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting user bookings");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        // Add this new endpoint
        [HttpGet("{id}")]
        public async Task<IActionResult> GetBookingById(int id)
        {
            try
            {
                var userId = int.Parse(User.FindFirst(ClaimTypes.NameIdentifier)?.Value);
                var booking = await _bookingService.GetBookingDetailsAsync(id);

                // Check if user owns this booking or is admin
                var isAdmin = User.IsInRole("Admin");
                if (!isAdmin && booking.UserId != userId)
                    return Forbid();

                return Ok(booking);
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting booking by ID");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }
    }
}
using elite.DTOs;
using elite.Interfaces;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;

namespace elite.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    public class ClassesController : ControllerBase
    {
        private readonly IClassService _classService;
        private readonly ILogger<ClassesController> _logger;

        public ClassesController(IClassService classService, ILogger<ClassesController> logger)
        {
            _classService = classService;
            _logger = logger;
        }

        [HttpGet]
        public async Task<IActionResult> GetAllClasses()
        {
            try
            {
                var classes = await _classService.GetAllClassesAsync();
                return Ok(classes);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting all classes");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpGet("{id}")]
        public async Task<IActionResult> GetClassById(int id)
        {
            try
            {
                var classObj = await _classService.GetClassByIdAsync(id);
                return Ok(classObj);
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting class by ID");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpPost]
        [Authorize(Roles = "Admin")]
        public async Task<IActionResult> CreateClass([FromBody] ClassCreateDto classCreateDto)
        {
            try
            {
                var result = await _classService.CreateClassAsync(classCreateDto);
                return CreatedAtAction(nameof(GetClassById), new { id = result.Id }, result);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error creating class");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpPut("{id}")]
        [Authorize(Roles = "Admin")]
        public async Task<IActionResult> UpdateClass(int id, [FromBody] ClassCreateDto classUpdateDto)
        {
            try
            {
                var result = await _classService.UpdateClassAsync(id, classUpdateDto);
                return Ok(result);
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error updating class");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpDelete("{id}")]
        [Authorize(Roles = "Admin")]
        public async Task<IActionResult> DeleteClass(int id)
        {
            try
            {
                var result = await _classService.DeleteClassAsync(id);
                return Ok(new { message = "Class deleted successfully" });
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error deleting class");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpGet("{id}/schedules")]
        public async Task<IActionResult> GetClassSchedules(int id)
        {
            try
            {
                var schedules = await _classService.GetClassSchedulesAsync(id);
                return Ok(schedules);
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting class schedules");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpPost("schedules")]
        [Authorize(Roles = "Admin")]
        public async Task<IActionResult> CreateClassSchedule([FromBody] ClassScheduleCreateDto scheduleCreateDto)
        {
            try
            {
                var result = await _classService.CreateClassScheduleAsync(scheduleCreateDto);
                return CreatedAtAction(nameof(GetClassSchedules), new { id = result.ClassId }, result);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error creating class schedule");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpDelete("schedules/{id}")]
        [Authorize(Roles = "Admin")]
        public async Task<IActionResult> DeleteClassSchedule(int id)
        {
            try
            {
                var result = await _classService.DeleteClassScheduleAsync(id);
                return Ok(new { message = "Class schedule deleted successfully" });
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error deleting class schedule");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }
    }

}

using elite.Data;
using elite.DTOs;
using elite.Interfaces;
using elite.Models;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using System.Security.Claims;

namespace elite.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    [Authorize]
    public class MembershipsController : ControllerBase
    {
        private readonly IMembershipService _membershipService;
        private readonly ILogger<MembershipsController> _logger;

        public MembershipsController(IMembershipService membershipService, ILogger<MembershipsController> logger)
        {
            _membershipService = membershipService;
            _logger = logger;
        }

        [HttpPost]
        public async Task<IActionResult> PurchaseMembership([FromBody] PurchaseMembershipDto purchaseDto)
        {
            try
            {
                var userId = int.Parse(User.FindFirst(ClaimTypes.NameIdentifier)?.Value);
                purchaseDto.UserId = userId;

                var result = await _membershipService.PurchaseMembershipAsync(purchaseDto);
                return Ok(result);
            }
            catch (ArgumentException ex)
            {
                return BadRequest(new { message = ex.Message });
            }
            catch (InvalidOperationException ex)
            {
                return BadRequest(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error purchasing membership");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpGet]
        public async Task<IActionResult> GetUserMembership()
        {
            try
            {
                var userId = int.Parse(User.FindFirst(ClaimTypes.NameIdentifier)?.Value);
                var result = await _membershipService.GetUserMembershipAsync(userId);
                return Ok(result);
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting user membership");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }
    }

    public class PurchaseMembershipRequest
        {
            public int UserId { get; set; }
            public string Type { get; set; }
        }
    }

// Controllers/MembershipTypesController.cs
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using elite.DTOs;
using elite.Interfaces;
using System.Collections.Generic;
using System.Threading.Tasks;

namespace elite.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    [Authorize(Roles = "Admin")]
    public class MembershipTypesController : ControllerBase
    {
        private readonly IMembershipTypeService _membershipTypeService;
        private readonly ILogger<MembershipTypesController> _logger;

        public MembershipTypesController(IMembershipTypeService membershipTypeService, ILogger<MembershipTypesController> logger)
        {
            _membershipTypeService = membershipTypeService;
            _logger = logger;
        }

        [HttpGet]
        [AllowAnonymous] // Allow anyone to see membership types
        public async Task<IActionResult> GetAllMembershipTypes()
        {
            try
            {
                var types = await _membershipTypeService.GetAllMembershipTypesAsync();
                return Ok(types);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting membership types");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        // Add this new endpoint
        [HttpGet("{id}")]
        public async Task<IActionResult> GetMembershipTypeById(int id)
        {
            try
            {
                var membershipType = await _membershipTypeService.GetMembershipTypeByIdAsync(id);
                return Ok(membershipType);
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting membership type by ID");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpPost]
        public async Task<IActionResult> CreateMembershipType([FromBody] MembershipTypeCreateDto createDto)
        {
            try
            {
                var result = await _membershipTypeService.CreateMembershipTypeAsync(createDto);
                return CreatedAtAction(nameof(GetAllMembershipTypes), new { id = result.Id }, result);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error creating membership type");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpPut("{id}")]
        public async Task<IActionResult> UpdateMembershipType(int id, [FromBody] MembershipTypeCreateDto updateDto)
        {
            try
            {
                var result = await _membershipTypeService.UpdateMembershipTypeAsync(id, updateDto);
                return Ok(result);
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error updating membership type");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpPatch("{id}/toggle")]
        public async Task<IActionResult> ToggleMembershipTypeStatus(int id, [FromBody] bool isActive)
        {
            try
            {
                var result = await _membershipTypeService.ToggleMembershipTypeStatusAsync(id, isActive);
                return Ok(new { message = "Membership type status updated successfully" });
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error toggling membership type status");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpDelete("{id}")]
        public async Task<IActionResult> DeleteMembershipType(int id)
        {
            try
            {
                var result = await _membershipTypeService.DeleteMembershipTypeAsync(id);
                return Ok(new { message = "Membership type deleted successfully" });
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error deleting membership type");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }
    }
}
using elite.DTOs;
using elite.Interfaces;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;

namespace elite.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    public class OnlineSessionsController : ControllerBase
    {
        private readonly IOnlineSessionService _sessionService;
        private readonly ILogger<OnlineSessionsController> _logger;

        public OnlineSessionsController(IOnlineSessionService sessionService, ILogger<OnlineSessionsController> logger)
        {
            _sessionService = sessionService;
            _logger = logger;
        }

        [HttpGet]
        public async Task<IActionResult> GetAllSessions()
        {
            try
            {
                var sessions = await _sessionService.GetAllSessionsAsync();
                return Ok(sessions);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting all sessions");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpGet("{id}")]
        public async Task<IActionResult> GetSessionById(int id)
        {
            try
            {
                var session = await _sessionService.GetSessionByIdAsync(id);
                return Ok(session);
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting session by ID");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpPost]
        [Authorize(Roles = "Admin")]
        public async Task<IActionResult> CreateSession([FromBody] OnlineSessionCreateDto sessionCreateDto)
        {
            try
            {
                var result = await _sessionService.CreateSessionAsync(sessionCreateDto);
                return CreatedAtAction(nameof(GetSessionById), new { id = result.Id }, result);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error creating session");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpPut("{id}")]
        [Authorize(Roles = "Admin")]
        public async Task<IActionResult> UpdateSession(int id, [FromBody] OnlineSessionCreateDto sessionUpdateDto)
        {
            try
            {
                var result = await _sessionService.UpdateSessionAsync(id, sessionUpdateDto);
                return Ok(result);
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error updating session");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpDelete("{id}")]
        [Authorize(Roles = "Admin")]
        public async Task<IActionResult> DeleteSession(int id)
        {
            try
            {
                var result = await _sessionService.DeleteSessionAsync(id);
                return Ok(new { message = "Session deleted successfully" });
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error deleting session");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpGet("{id}/schedules")]
        public async Task<IActionResult> GetSessionSchedules(int id)
        {
            try
            {
                var schedules = await _sessionService.GetSessionSchedulesAsync(id);
                return Ok(schedules);
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting session schedules");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpPost("schedules")]
        [Authorize(Roles = "Admin")]
        public async Task<IActionResult> CreateSessionSchedule([FromBody] OnlineSessionScheduleCreateDto scheduleCreateDto)
        {
            try
            {
                var result = await _sessionService.CreateSessionScheduleAsync(scheduleCreateDto);
                return CreatedAtAction(nameof(GetSessionSchedules), new { id = result.OnlineSessionId }, result);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error creating session schedule");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpDelete("schedules/{id}")]
        [Authorize(Roles = "Admin")]
        public async Task<IActionResult> DeleteSessionSchedule(int id)
        {
            try
            {
                var result = await _sessionService.DeleteSessionScheduleAsync(id);
                return Ok(new { message = "Session schedule deleted successfully" });
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error deleting session schedule");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }
    }
}
using elite.DTOs;
using elite.Interfaces;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using System.Security.Claims;

namespace elite.Controllers
{
    // Controllers/OrdersController.cs
    [ApiController]
    [Route("api/[controller]")]
    [Authorize]
    public class OrdersController : ControllerBase
    {
        private readonly IOrderService _orderService;
        private readonly ILogger<OrdersController> _logger;

        public OrdersController(IOrderService orderService, ILogger<OrdersController> logger)
        {
            _orderService = orderService;
            _logger = logger;
        }

        [HttpPost]
        public async Task<IActionResult> CreateOrder([FromBody] OrderCreateDto orderCreateDto)
        {
            try
            {
                var userId = int.Parse(User.FindFirst(ClaimTypes.NameIdentifier)?.Value);
                orderCreateDto.UserId = userId;

                var result = await _orderService.CreateOrderAsync(orderCreateDto);
                return CreatedAtAction(nameof(GetOrderById), new { id = result.Id }, result);
            }
            catch (ArgumentException ex)
            {
                return BadRequest(new { message = ex.Message });
            }
            catch (InvalidOperationException ex)
            {
                return BadRequest(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error creating order");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpGet("{id}")]
        public async Task<IActionResult> GetOrderById(int id)
        {
            try
            {
                var order = await _orderService.GetOrderByIdAsync(id);

                // Check if user owns this order or is admin
                var userId = int.Parse(User.FindFirst(ClaimTypes.NameIdentifier)?.Value);
                var isAdmin = User.IsInRole("Admin");

                if (!isAdmin && order.UserId != userId)
                    return Forbid();

                return Ok(order);
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting order by ID");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpGet("user/{userId}")]
        [Authorize(Roles = "Admin")]
        public async Task<IActionResult> GetUserOrders(int userId)
        {
            try
            {
                var orders = await _orderService.GetUserOrdersAsync(userId);
                return Ok(orders);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting user orders");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpGet]
        [Authorize(Roles = "Admin")]
        public async Task<IActionResult> GetAllOrders()
        {
            try
            {
                var orders = await _orderService.GetAllOrdersAsync();
                return Ok(orders);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting all orders");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpPatch("{id}/status")]
        [Authorize(Roles = "Admin")]
        public async Task<IActionResult> UpdateOrderStatus(int id, [FromBody] string status)
        {
            try
            {
                var result = await _orderService.UpdateOrderStatusAsync(id, status);
                return Ok(new { message = "Order status updated successfully" });
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error updating order status");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpDelete("{id}")]
        public async Task<IActionResult> CancelOrder(int id)
        {
            try
            {
                var userId = int.Parse(User.FindFirst(ClaimTypes.NameIdentifier)?.Value);
                var isAdmin = User.IsInRole("Admin");

                // For non-admin users, check if they own the order
                if (!isAdmin)
                {
                    var order = await _orderService.GetOrderByIdAsync(id);
                    if (order.UserId != userId)
                        return Forbid();
                }

                var result = await _orderService.CancelOrderAsync(id);
                return Ok(new { message = "Order cancelled successfully" });
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error cancelling order");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpPost("apply-promotion")]
        public async Task<IActionResult> ApplyPromotion([FromBody] ApplyPromotionDto applyPromotionDto)
        {
            try
            {
                var discount = await _orderService.ApplyPromotionAsync(applyPromotionDto.Code, applyPromotionDto.OrderAmount);
                return Ok(new { discount, finalAmount = applyPromotionDto.OrderAmount - discount });
            }
            catch (ArgumentException ex)
            {
                return BadRequest(new { message = ex.Message });
            }
            catch (InvalidOperationException ex)
            {
                return BadRequest(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error applying promotion");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }
    }
}
using elite.DTOs;
using elite.Interfaces;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;

namespace elite.Controllers
{
    // Controllers/ProductsController.cs
    [ApiController]
    [Route("api/[controller]")]
    public class ProductsController : ControllerBase
    {
        private readonly IProductService _productService;
        private readonly ILogger<ProductsController> _logger;

        public ProductsController(IProductService productService, ILogger<ProductsController> logger)
        {
            _productService = productService;
            _logger = logger;
        }

        [HttpGet]
        public async Task<IActionResult> GetAllProducts()
        {
            try
            {
                var products = await _productService.GetAllProductsAsync();
                return Ok(products);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting all products");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpGet("category/{category}")]
        public async Task<IActionResult> GetProductsByCategory(string category)
        {
            try
            {
                var products = await _productService.GetProductsByCategoryAsync(category);
                return Ok(products);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting products by category");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpGet("{id}")]
        public async Task<IActionResult> GetProductById(int id)
        {
            try
            {
                var product = await _productService.GetProductByIdAsync(id);
                return Ok(product);
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting product by ID");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpPost]
        [Authorize(Roles = "Admin")]
        public async Task<IActionResult> CreateProduct([FromForm] ProductCreateDto productCreateDto)
        {
            try
            {
                var result = await _productService.CreateProductAsync(productCreateDto);
                return CreatedAtAction(nameof(GetProductById), new { id = result.Id }, result);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error creating product");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpDelete("{id}")]
        [Authorize(Roles = "Admin")]
        public async Task<IActionResult> DeleteProduct(int id)
        {
            try
            {
                var result = await _productService.DeleteProductAsync(id);
                return Ok(new { message = "Product deleted successfully" });
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error deleting product");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpPatch("{id}/stock")]
        [Authorize(Roles = "Admin")]
        public async Task<IActionResult> UpdateProductStock(int id, [FromBody] int quantity)
        {
            try
            {
                var result = await _productService.UpdateProductStockAsync(id, quantity);
                return Ok(new { message = "Product stock updated successfully" });
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error updating product stock");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }
    }
}
using elite.DTOs;
using elite.Interfaces;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;

namespace elite.Controllers
{
    // Controllers/PromotionsController.cs
    [ApiController]
    [Route("api/[controller]")]
    [Authorize(Roles = "Admin")]
    public class PromotionsController : ControllerBase
    {
        private readonly IPromotionService _promotionService;
        private readonly ILogger<PromotionsController> _logger;

        public PromotionsController(IPromotionService promotionService, ILogger<PromotionsController> logger)
        {
            _promotionService = promotionService;
            _logger = logger;
        }

        [HttpGet]
        public async Task<IActionResult> GetAllPromotions()
        {
            try
            {
                var promotions = await _promotionService.GetAllPromotionsAsync();
                return Ok(promotions);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting all promotions");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpGet("{id}")]
        public async Task<IActionResult> GetPromotionById(int id)
        {
            try
            {
                var promotion = await _promotionService.GetPromotionByIdAsync(id);
                return Ok(promotion);
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting promotion by ID");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpGet("code/{code}")]
        public async Task<IActionResult> GetPromotionByCode(string code)
        {
            try
            {
                var promotion = await _promotionService.GetPromotionByCodeAsync(code);
                return Ok(promotion);
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting promotion by code");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpPost]
        public async Task<IActionResult> CreatePromotion([FromBody] PromotionCreateDto promotionCreateDto)
        {
            try
            {
                var result = await _promotionService.CreatePromotionAsync(promotionCreateDto);
                return CreatedAtAction(nameof(GetPromotionById), new { id = result.Id }, result);
            }
            catch (ArgumentException ex)
            {
                return BadRequest(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error creating promotion");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpPut("{id}")]
        public async Task<IActionResult> UpdatePromotion(int id, [FromBody] PromotionCreateDto promotionUpdateDto)
        {
            try
            {
                var result = await _promotionService.UpdatePromotionAsync(id, promotionUpdateDto);
                return Ok(result);
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error updating promotion");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpDelete("{id}")]
        public async Task<IActionResult> DeletePromotion(int id)
        {
            try
            {
                var result = await _promotionService.DeletePromotionAsync(id);
                return Ok(new { message = "Promotion deleted successfully" });
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error deleting promotion");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpPost("validate")]
        [AllowAnonymous]
        public async Task<IActionResult> ValidatePromotion([FromBody] ApplyPromotionDto applyPromotionDto)
        {
            try
            {
                var isValid = await _promotionService.ValidatePromotionAsync(applyPromotionDto.Code, applyPromotionDto.OrderAmount);
                return Ok(new { isValid });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error validating promotion");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }
    }
}
using Microsoft.AspNetCore.Mvc;

namespace elite.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    public class TestController : ControllerBase
    {
        [HttpGet]
        [Produces("application/json")]
        public IActionResult Get()
        {
            return Ok(new { message = "API is working!", timestamp = DateTime.UtcNow });
        }

        [HttpGet("hello/{name}")]
        [Produces("application/json")]
        public IActionResult Hello(string name)
        {
            return Ok(new { message = $"Hello, {name}!", timestamp = DateTime.UtcNow });
        }
    }
}
using elite.DTOs;
using elite.Interfaces;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;

namespace elite.Controllers
{
    // Controllers/TrainersController.cs
    [ApiController]
    [Route("api/[controller]")]
    public class TrainersController : ControllerBase
    {
        private readonly ITrainerService _trainerService;
        private readonly ILogger<TrainersController> _logger;

        public TrainersController(ITrainerService trainerService, ILogger<TrainersController> logger)
        {
            _trainerService = trainerService;
            _logger = logger;
        }

        [HttpGet]
        public async Task<IActionResult> GetAllTrainers()
        {
            try
            {
                var trainers = await _trainerService.GetAllTrainersAsync();
                return Ok(trainers);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting all trainers");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpGet("{id}")]
        public async Task<IActionResult> GetTrainerById(int id)
        {
            try
            {
                var trainer = await _trainerService.GetTrainerByIdAsync(id);
                return Ok(trainer);
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting trainer by ID");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpPost]
        [Authorize(Roles = "Admin")]
        [Consumes("multipart/form-data")]
        public async Task<IActionResult> CreateTrainer([FromForm] TrainerCreateDto trainerCreateDto)
        {
            try
            {
                var result = await _trainerService.CreateTrainerAsync(trainerCreateDto);
                return CreatedAtAction(nameof(GetTrainerById), new { id = result.Id }, result);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error creating trainer");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        // Controllers/TrainersController.cs
        [HttpPut("{id}")]
        [Authorize(Roles = "Admin")]
        [Consumes("multipart/form-data")]
        public async Task<IActionResult> UpdateTrainer(int id, [FromForm] TrainerCreateDto trainerUpdateDto)
        {
            try
            {
                var result = await _trainerService.UpdateTrainerAsync(id, trainerUpdateDto);
                return Ok(result);
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error updating trainer");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        


        [HttpDelete("{id}")]
        [Authorize(Roles = "Admin")]
        public async Task<IActionResult> DeleteTrainer(int id)
        {
            try
            {
                var result = await _trainerService.DeleteTrainerAsync(id);
                return Ok(new { message = "Trainer deleted successfully" });
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error deleting trainer");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpGet("{id}/classes")]
        public async Task<IActionResult> GetTrainerClasses(int id)
        {
            try
            {
                var classes = await _trainerService.GetTrainerClassesAsync(id);
                return Ok(classes);
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting trainer classes");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpGet("{id}/sessions")]
        public async Task<IActionResult> GetTrainerSessions(int id)
        {
            try
            {
                var sessions = await _trainerService.GetTrainerSessionsAsync(id);
                return Ok(sessions);
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting trainer sessions");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }
    }
}
using elite.Models;

namespace elite.Data
{
    // Data/DataSeeder.cs
    public class DataSeeder
    {
        private readonly GymDbContext _context;

        public DataSeeder(GymDbContext context)
        {
            _context = context;
        }

        public async Task SeedDataAsync()
        {
            // Seed trainers if none exist
            if (!_context.Trainers.Any())
            {
                var trainers = new List<Trainer>
            {
                new Trainer
    {
        Name = "Sarah Johnson",
        Specialization = "Yoga",
        ExperienceYears = 5,
        Certifications = "RYT 500",
        Bio = "Experienced yoga instructor with 5 years of teaching experience",
        ImageUrl = null // Set to null since we're not seeding images
    },
                new Trainer
                {
                    Name = "Emily Davis",
                    Specialization = "Pilates",
                    ExperienceYears = 7,
                    Certifications = "Pilates Method Alliance",
                    Bio = "Pilates expert with international certification",
                     ImageUrl = null
                },
                new Trainer
                {
                    Name = "Jessica Wilson",
                    Specialization = "HIIT",
                    ExperienceYears = 4,
                    Certifications = "ACE Certified",
                    Bio = "High-intensity interval training specialist",
                     ImageUrl = null
                }
            };

                _context.Trainers.AddRange(trainers);
                await _context.SaveChangesAsync();
            }

            // Seed admin user if none exists
            if (!_context.Admins.Any())
            {
                var admin = new Admin
                {
                    Username = "admin",
                    PasswordHash = BCrypt.Net.BCrypt.HashPassword("admin123"),
                    Email = "admin@gym.com",
                    Role = "Admin"
                };

                _context.Admins.Add(admin);
                await _context.SaveChangesAsync();
            }

            // Seed membership types if none exist
            if (!_context.MembershipTypes.Any())
            {
                var membershipTypes = new List<MembershipType>
{
    new MembershipType
    {
        Name = "Basic",
        Description = "Basic membership with 10 hours",
        DurationMonths = 1,
        TotalHours = 10.0m,      // Use decimal notation
        Price = 49.99m,
        IsActive = true
    },
    new MembershipType
    {
        Name = "Medium",
        Description = "Medium membership with 25 hours",
        DurationMonths = 3,
        TotalHours = 25.0m,      // Use decimal notation
        Price = 99.99m,
        IsActive = true
    },
    new MembershipType
    {
        Name = "VIP",
        Description = "VIP membership with 50 hours",
        DurationMonths = 6,
        TotalHours = 50.0m,      // Use decimal notation
        Price = 199.99m,
        IsActive = true
    }
};

                _context.MembershipTypes.AddRange(membershipTypes);
                await _context.SaveChangesAsync();
            }

            // Seed sample products if none exist
            if (!_context.Products.Any())
            {
                var products = new List<Product>
            {
                new Product
                {
                    Name = "Yoga Mat",
                    Description = "High-quality non-slip yoga mat",
                    Price = 29.99m,
                    ImageUrl = "/images/products/yoga-mat.jpg",
                    Category = "Apparel",
                    StockQuantity = 50
                },
                new Product
                {
                    Name = "Protein Powder",
                    Description = "Whey protein powder for muscle recovery",
                    Price = 39.99m,
                    ImageUrl = "/images/products/protein-powder.jpg",
                    Category = "Supplements",
                    StockQuantity = 30
                },
                new Product
                {
                    Name = "Workout Gloves",
                    Description = "Comfortable gloves for weight training",
                    Price = 19.99m,
                    ImageUrl = "/images/products/workout-gloves.jpg",
                    Category = "Apparel",
                    StockQuantity = 25
                }
            };

                _context.Products.AddRange(products);
                await _context.SaveChangesAsync();
            }
        }
    }
}
using elite.Models;
using Microsoft.EntityFrameworkCore;
using System.Collections.Generic;
using System.Reflection.Emit;

namespace elite.Data
{
    // Data/GymDbContext.cs
    public class GymDbContext : DbContext
    {
        public GymDbContext(DbContextOptions<GymDbContext> options) : base(options) { }

        public DbSet<User> Users { get; set; }
        public DbSet<Membership> Memberships { get; set; }
        public DbSet<Class> Classes { get; set; }
        public DbSet<ClassSchedule> ClassSchedules { get; set; }
        public DbSet<OnlineSession> OnlineSessions { get; set; }
        public DbSet<OnlineSessionSchedule> OnlineSessionSchedules { get; set; }
        public DbSet<Trainer> Trainers { get; set; }
        public DbSet<Booking> Bookings { get; set; }
        public DbSet<Product> Products { get; set; }
        public DbSet<Order> Orders { get; set; }
        public DbSet<OrderItem> OrderItems { get; set; }
        public DbSet<Promotion> Promotions { get; set; }
        public DbSet<Admin> Admins { get; set; }
        public DbSet<MembershipType> MembershipTypes { get; set; }

        protected override void OnModelCreating(ModelBuilder modelBuilder)
        {
            // Configure relationships and constraints
            modelBuilder.Entity<User>()
                .HasIndex(u => u.Email)
                .IsUnique();

            modelBuilder.Entity<Membership>()
                .HasOne(m => m.User)
                .WithOne(u => u.Membership)
                .HasForeignKey<Membership>(m => m.UserId)
                .OnDelete(DeleteBehavior.Cascade);

            modelBuilder.Entity<ClassSchedule>()
                .HasCheckConstraint("CK_ClassSchedule_AvailableSlots", "[AvailableSlots] >= 0");

            // Seed data
            modelBuilder.Entity<Trainer>().HasData(
                new Trainer { Id = 1, Name = "Sarah Johnson", Specialization = "Yoga", ExperienceYears = 5, Certifications = "RYT 500", Bio = "Experienced yoga instructor", ImageUrl = "/images/trainers/sarah.jpg" },
                new Trainer { Id = 2, Name = "Emily Davis", Specialization = "Pilates", ExperienceYears = 7, Certifications = "Pilates Method Alliance", Bio = "Pilates expert", ImageUrl = "/images/trainers/emily.jpg" }
            );
            modelBuilder.Entity<MembershipType>().HasData(
                new MembershipType
                {
                    Id = 1,
                    Name = "Basic",
                    Description = "Basic membership with 10 hours",
                    DurationMonths = 1,
                    TotalHours = 10,
                    Price = 49.99m,
                    IsActive = true
                },
                new MembershipType
                {
                    Id = 2,
                    Name = "Medium",
                    Description = "Medium membership with 25 hours",
                    DurationMonths = 3,
                    TotalHours = 25,
                    Price = 99.99m,
                    IsActive = true
                },
                new MembershipType
                {
                    Id = 3,
                    Name = "VIP",
                    Description = "VIP membership with 50 hours",
                    DurationMonths = 6,
                    TotalHours = 50,
                    Price = 199.99m,
                    IsActive = true
                }
            );

            base.OnModelCreating(modelBuilder);
        }
    }
}
// Data/GymDbContextFactory.cs
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Design;
using Microsoft.Extensions.Configuration;
using System.IO;

namespace elite.Data
{
    public class GymDbContextFactory : IDesignTimeDbContextFactory<GymDbContext>
    {
        public GymDbContext CreateDbContext(string[] args)
        {
            var configuration = new ConfigurationBuilder()
                .SetBasePath(Directory.GetCurrentDirectory())
                .AddJsonFile("appsettings.json")
                .Build();

            var optionsBuilder = new DbContextOptionsBuilder<GymDbContext>();
            var connectionString = configuration.GetConnectionString("DefaultConnection");

            optionsBuilder.UseSqlServer(connectionString);

            return new GymDbContext(optionsBuilder.Options);
        }
    }
}
namespace elite.DTOs
{
    public class DashboardStatsDto
    {
        public int TotalUsers { get; set; }
        public int ActiveMemberships { get; set; }
        public int TotalBookingsToday { get; set; }
        public decimal RevenueThisMonth { get; set; }
        public int LowStockProducts { get; set; }
    }

    public class RevenueReportDto
    {
        public DateTime Date { get; set; }
        public decimal MembershipRevenue { get; set; }
        public decimal ProductRevenue { get; set; }
        public decimal TotalRevenue { get; set; }
        public int BookingsCount { get; set; }
    }
}
namespace elite.DTOs
{
    public class AuthResponseDto
    {
        public string Token { get; set; }
        public UserResponseDto User { get; set; }
    }

}
using System.ComponentModel.DataAnnotations;

namespace elite.DTOs
{
    public class CreateBookingDto
    {
        [Required]
        public int UserId { get; set; }

        [Required]
        public string Type { get; set; }

        [Required]
        public int ScheduleId { get; set; }
    }

    public class BookingResponseDto
    {
        public int Id { get; set; }
        public string Type { get; set; }
        public int ScheduleId { get; set; }
        public DateTime BookingDate { get; set; }
        public string Status { get; set; }
        public decimal HoursConsumed { get; set; }
        public string ClassName { get; set; }
        public string TrainerName { get; set; }
        public DateTime StartTime { get; set; }
        public DateTime EndTime { get; set; }
        public string Location { get; set; }

        // Add these properties for admin view
        public int UserId { get; set; }
        public string UserName { get; set; }
    }

    public class BookingCancellationDto
    {
        [Required]
        public int BookingId { get; set; }

        [Required]
        public int UserId { get; set; }
    }
}
using System.ComponentModel.DataAnnotations;

namespace elite.DTOs
{
    public class ClassDto
    {
        public int Id { get; set; }
        public string Name { get; set; }
        public string Description { get; set; }
        public decimal Duration { get; set; }
        public int TrainerId { get; set; }
        public string TrainerName { get; set; }
        public int MaxCapacity { get; set; }
        public decimal Price { get; set; }
    }

    public class ClassCreateDto
    {
        [Required, MaxLength(100)]
        public string Name { get; set; }

        [Required]
        public string Description { get; set; }

        [Required, Range(0.5, 5)]
        public decimal Duration { get; set; }

        [Required]
        public int TrainerId { get; set; }

        [Required, Range(1, 50)]
        public int MaxCapacity { get; set; }

        public decimal Price { get; set; }
    }

    public class ClassScheduleDto
    {
        public int Id { get; set; }
        public int ClassId { get; set; }
        public string ClassName { get; set; }
        public DateTime StartTime { get; set; }
        public DateTime EndTime { get; set; }
        public string Location { get; set; }
        public int AvailableSlots { get; set; }
        public int MaxCapacity { get; set; }
    }

    public class ClassScheduleCreateDto
    {
        [Required]
        public int ClassId { get; set; }

        [Required]
        public DateTime StartTime { get; set; }

        [Required]
        public DateTime EndTime { get; set; }

        [Required, MaxLength(200)]
        public string Location { get; set; }
    }
}
using System.ComponentModel.DataAnnotations;

namespace elite.DTOs
{
    public class MembershipDto
    {
        public int Id { get; set; }
        public string Type { get; set; }
        public DateTime StartDate { get; set; }
        public DateTime EndDate { get; set; }
        public decimal TotalHours { get; set; }      // Change to decimal
        public decimal RemainingHours { get; set; }  // Change to decimal
        public string Status { get; set; }
        public decimal PricePaid { get; set; }
    }

    public class PurchaseMembershipDto
    {
        [Required]
        public int UserId { get; set; }

        [Required]
        public string Type { get; set; }
    }

}
using System.ComponentModel.DataAnnotations;

namespace elite.DTOs
{
    public class MembershipTypeDto
    {
        public int Id { get; set; }
        public string Name { get; set; }
        public string Description { get; set; }
        public int DurationMonths { get; set; }
        public decimal TotalHours { get; set; }  // Change from int to decimal
        public decimal Price { get; set; }
        public bool IsActive { get; set; }
    }

    public class MembershipTypeCreateDto
    {
        [Required, MaxLength(20)]
        public string Name { get; set; }

        [Required]
        public string Description { get; set; }

        [Required, Range(1, 12)]
        public int DurationMonths { get; set; }

        [Required, Range(1, 100)]
        public decimal TotalHours { get; set; }  // Change from int to decimal

        [Required, Range(0, 1000)]
        public decimal Price { get; set; }
    }

}
using System.ComponentModel.DataAnnotations;

namespace elite.DTOs
{
    public class OnlineSessionDto
    {
        public int Id { get; set; }
        public string Name { get; set; }
        public string Description { get; set; }
        public decimal Duration { get; set; }
        public int TrainerId { get; set; }
        public string TrainerName { get; set; }
        public decimal Price { get; set; }
    }

    public class OnlineSessionCreateDto
    {
        [Required, MaxLength(100)]
        public string Name { get; set; }

        [Required]
        public string Description { get; set; }

        [Required, Range(0.5, 5)]
        public decimal Duration { get; set; }

        [Required]
        public int TrainerId { get; set; }

        public decimal Price { get; set; }
    }

    public class OnlineSessionScheduleDto
    {
        public int Id { get; set; }
        public int OnlineSessionId { get; set; }
        public string SessionName { get; set; }
        public DateTime StartTime { get; set; }
        public DateTime EndTime { get; set; }
        public int AvailableSlots { get; set; }
        public int MaxSlots { get; set; } = 20;
    }

    public class OnlineSessionScheduleCreateDto
    {
        [Required]
        public int OnlineSessionId { get; set; }

        [Required]
        public DateTime StartTime { get; set; }

        [Required]
        public DateTime EndTime { get; set; }

        [Range(1, 20)]
        public int AvailableSlots { get; set; } = 20;
    }
}
using System.ComponentModel.DataAnnotations;

namespace elite.DTOs
{
    public class OrderDto
    {
        public int Id { get; set; }
        public int UserId { get; set; }
        public string UserName { get; set; }
        public DateTime OrderDate { get; set; }
        public decimal TotalAmount { get; set; }
        public string Status { get; set; }
        public List<OrderItemDto> OrderItems { get; set; }
    }

    public class OrderCreateDto
    {
        [Required]
        public int UserId { get; set; }

        public List<OrderItemCreateDto> Items { get; set; }

        public string PromotionCode { get; set; }
    }

    public class OrderItemDto
    {
        public int Id { get; set; }
        public int ProductId { get; set; }
        public string ProductName { get; set; }
        public int Quantity { get; set; }
        public decimal Price { get; set; }
        public decimal TotalPrice => Quantity * Price;
    }

    public class OrderItemCreateDto
    {
        [Required]
        public int ProductId { get; set; }

        [Required, Range(1, 10)]
        public int Quantity { get; set; }
    }
}
using System.ComponentModel.DataAnnotations;

namespace elite.DTOs
{
    public class ProductDto
    {
        public int Id { get; set; }
        public string Name { get; set; }
        public string Description { get; set; }
        public decimal Price { get; set; }
        public string ImageUrl { get; set; }
        public string Category { get; set; }
        public int StockQuantity { get; set; }
    }

    // From your DTOs/ProductCreateDto.cs
    public class ProductCreateDto
    {
        [Required, MaxLength(100)]
        public string Name { get; set; }
        [Required]
        public string Description { get; set; }
        [Required, Range(0, 1000)]
        public decimal Price { get; set; }
        public IFormFile ImageFile { get; set; } // For file upload
        [Required]
        public string Category { get; set; }
        [Range(0, 1000)]
        public int StockQuantity { get; set; }
    }
}
using System.ComponentModel.DataAnnotations;

namespace elite.DTOs
{
    public class PromotionDto
    {
        public int Id { get; set; }
        public string Code { get; set; }
        public string Description { get; set; }
        public string DiscountType { get; set; }
        public decimal DiscountValue { get; set; }
        public DateTime StartDate { get; set; }
        public DateTime EndDate { get; set; }
        public int UsageLimit { get; set; }
        public int TimesUsed { get; set; }
    }

    public class PromotionCreateDto
    {
        [Required, MaxLength(20)]
        public string Code { get; set; }

        [Required]
        public string Description { get; set; }

        [Required]
        public string DiscountType { get; set; }

        [Required, Range(0, 100)]
        public decimal DiscountValue { get; set; }

        [Required]
        public DateTime StartDate { get; set; }

        [Required]
        public DateTime EndDate { get; set; }

        [Range(1, 1000)]
        public int UsageLimit { get; set; } = 100;
    }

    public class ApplyPromotionDto
    {
        [Required]
        public string Code { get; set; }

        [Required]
        public decimal OrderAmount { get; set; }
    }
}
using System.ComponentModel.DataAnnotations;

namespace elite.DTOs
{
    public class TrainerDto
    {
        public int Id { get; set; }
        public string Name { get; set; }
        public string Specialization { get; set; }
        public int ExperienceYears { get; set; }
        public string Certifications { get; set; }
        public string Bio { get; set; }
        public string ImageUrl { get; set; }
    }

    public class TrainerCreateDto
    {
        [Required, MaxLength(100)]
        public string Name { get; set; }
        [Required, MaxLength(100)]
        public string Specialization { get; set; }
        [Required, Range(0, 50)]
        public int ExperienceYears { get; set; }
        public string Certifications { get; set; }
        [Required]
        public string Bio { get; set; }
        public IFormFile ImageFile { get; set; } // For file upload
    }
}
using System.ComponentModel.DataAnnotations;

namespace elite.DTOs
{
    public class UserRegisterDto
    {
        [Required, MaxLength(100)]
        public string Name { get; set; }

        [Required, EmailAddress, MaxLength(100)]
        public string Email { get; set; }

        [Required, MinLength(6)]
        public string Password { get; set; }

        [Phone, MaxLength(20)]
        public string Phone { get; set; }
    }

    public class UserLoginDto
    {
        [Required, EmailAddress]
        public string Email { get; set; }

        [Required]
        public string Password { get; set; }
    }

    public class UserResponseDto
    {
        public int Id { get; set; }
        public string Name { get; set; }
        public string Email { get; set; }
        public string Phone { get; set; }
        public DateTime CreatedAt { get; set; }
        public MembershipDto Membership { get; set; }
    }

    public class UserUpdateDto
    {
        [MaxLength(100)]
        public string Name { get; set; }

        [Phone, MaxLength(20)]
        public string Phone { get; set; }
    }
}
using elite.DTOs;

namespace elite.Interfaces
{
    public interface IAdminService
    {
        Task<IEnumerable<UserResponseDto>> GetAllUsersAsync(int page, int pageSize);
        Task<UserResponseDto> GetUserDetailsAsync(int userId);
        Task<bool> UpdateUserStatusAsync(int userId, bool isActive);
        Task<DashboardStatsDto> GetDashboardStatsAsync();
        Task<IEnumerable<BookingResponseDto>> GetAllBookingsAsync(DateTime? startDate, DateTime? endDate);
        Task<IEnumerable<RevenueReportDto>> GetRevenueReportAsync(DateTime startDate, DateTime endDate);
        // In IAdminService.cs
        Task<IEnumerable<OrderDto>> GetAllOrdersAsync();
        // Interfaces/IAdminService.cs
        Task<BookingResponseDto> GetBookingDetailsAsync(int bookingId);

    }
}
using elite.DTOs;

namespace elite.Interfaces
{
    public interface IAuthService
    {
        Task<AuthResponseDto> RegisterAsync(UserRegisterDto registerDto);
        Task<AuthResponseDto> LoginAsync(UserLoginDto loginDto);
        Task<UserResponseDto> GetUserProfileAsync(int userId);
        Task<bool> UpdateUserProfileAsync(int userId, UserUpdateDto updateDto);
        Task<bool> ChangePasswordAsync(int userId, string currentPassword, string newPassword);
    }
}
// Interfaces/IBookingService.cs
using elite.DTOs;
using System.Collections.Generic;
using System.Threading.Tasks;

namespace elite.Interfaces
{
    public interface IBookingService
    {
        Task<BookingResponseDto> CreateBookingAsync(CreateBookingDto bookingDto);
        Task<bool> CancelBookingAsync(int bookingId, int userId);
        Task<IEnumerable<BookingResponseDto>> GetUserBookingsAsync(int userId);
        Task<BookingResponseDto> GetBookingDetailsAsync(int bookingId);
        Task<IEnumerable<BookingResponseDto>> GetBookingsByDateRangeAsync(DateTime startDate, DateTime endDate);
    }
}
using elite.DTOs;

namespace elite.Interfaces
{
    // Interfaces/IClassService.cs
    public interface IClassService
    {
        Task<IEnumerable<ClassDto>> GetAllClassesAsync();
        Task<ClassDto> GetClassByIdAsync(int id);
        Task<ClassDto> CreateClassAsync(ClassCreateDto classCreateDto);
        Task<ClassDto> UpdateClassAsync(int id, ClassCreateDto classUpdateDto);
        Task<bool> DeleteClassAsync(int id);
        Task<IEnumerable<ClassScheduleDto>> GetClassSchedulesAsync(int classId);
        Task<ClassScheduleDto> CreateClassScheduleAsync(ClassScheduleCreateDto scheduleCreateDto);
        Task<bool> DeleteClassScheduleAsync(int scheduleId);
    }
}
namespace elite.Interfaces
{
    public interface IImageService
    {
        Task<string> UploadImageAsync(IFormFile imageFile, string folderName);
        void DeleteImage(string imagePath);
        bool ImageExists(string imagePath);
    }
}
using elite.DTOs;

namespace elite.Interfaces
{
    public interface IMembershipService
    {
        Task<MembershipDto> PurchaseMembershipAsync(PurchaseMembershipDto purchaseDto);
        Task<MembershipDto> GetUserMembershipAsync(int userId);
        Task<bool> CheckMembershipValidityAsync(int userId);
        Task<bool> ExtendMembershipAsync(int membershipId, int additionalMonths);
        Task<bool> UpgradeMembershipAsync(int membershipId, string newType);
    }
}
// Interfaces/IMembershipTypeService.cs
using elite.DTOs;
using System.Threading.Tasks;

namespace elite.Interfaces
{
    public interface IMembershipTypeService
    {
        Task<IEnumerable<MembershipTypeDto>> GetAllMembershipTypesAsync();
        Task<MembershipTypeDto> GetMembershipTypeByIdAsync(int id);
        Task<MembershipTypeDto> CreateMembershipTypeAsync(MembershipTypeCreateDto createDto);
        Task<MembershipTypeDto> UpdateMembershipTypeAsync(int id, MembershipTypeCreateDto updateDto);
        Task<bool> DeleteMembershipTypeAsync(int id);
        Task<bool> ToggleMembershipTypeStatusAsync(int id, bool isActive);
    }
}
using elite.DTOs;

namespace elite.Interfaces
{
    // Interfaces/IOnlineSessionService.cs
    public interface IOnlineSessionService
    {
        Task<IEnumerable<OnlineSessionDto>> GetAllSessionsAsync();
        Task<OnlineSessionDto> GetSessionByIdAsync(int id);
        Task<OnlineSessionDto> CreateSessionAsync(OnlineSessionCreateDto sessionCreateDto);
        Task<OnlineSessionDto> UpdateSessionAsync(int id, OnlineSessionCreateDto sessionUpdateDto);
        Task<bool> DeleteSessionAsync(int id);
        Task<IEnumerable<OnlineSessionScheduleDto>> GetSessionSchedulesAsync(int sessionId);
        Task<OnlineSessionScheduleDto> CreateSessionScheduleAsync(OnlineSessionScheduleCreateDto scheduleCreateDto);
        Task<bool> DeleteSessionScheduleAsync(int scheduleId);
    }

}
using elite.DTOs;

namespace elite.Interfaces
{
    public interface IOrderService
    {
        Task<OrderDto> CreateOrderAsync(OrderCreateDto orderCreateDto);
        Task<OrderDto> GetOrderByIdAsync(int id);
        Task<IEnumerable<OrderDto>> GetUserOrdersAsync(int userId);
        Task<IEnumerable<OrderDto>> GetAllOrdersAsync();
        Task<bool> UpdateOrderStatusAsync(int id, string status);
        Task<bool> CancelOrderAsync(int id);
        Task<decimal> ApplyPromotionAsync(string code, decimal orderAmount);
    }
}
using elite.DTOs;

namespace elite.Interfaces
{
    public interface IProductService
    {
        Task<IEnumerable<ProductDto>> GetAllProductsAsync();
        Task<IEnumerable<ProductDto>> GetProductsByCategoryAsync(string category);
        Task<ProductDto> GetProductByIdAsync(int id);
        Task<ProductDto> CreateProductAsync(ProductCreateDto productCreateDto);
        Task<ProductDto> UpdateProductAsync(int id, ProductCreateDto productUpdateDto);
        Task<bool> DeleteProductAsync(int id);
        Task<bool> UpdateProductStockAsync(int id, int quantity);
    }
}
using elite.DTOs;

namespace elite.Interfaces
{
    public interface IPromotionService
    {
        Task<IEnumerable<PromotionDto>> GetAllPromotionsAsync();
        Task<PromotionDto> GetPromotionByIdAsync(int id);
        Task<PromotionDto> GetPromotionByCodeAsync(string code);
        Task<PromotionDto> CreatePromotionAsync(PromotionCreateDto promotionCreateDto);
        Task<PromotionDto> UpdatePromotionAsync(int id, PromotionCreateDto promotionUpdateDto);
        Task<bool> DeletePromotionAsync(int id);
        Task<bool> ValidatePromotionAsync(string code, decimal orderAmount);
        Task<decimal> CalculateDiscountAsync(string code, decimal orderAmount);
    }
}
using elite.DTOs;

namespace elite.Interfaces
{
    public interface ITrainerService
    {
        Task<IEnumerable<TrainerDto>> GetAllTrainersAsync();
        Task<TrainerDto> GetTrainerByIdAsync(int id);
        Task<TrainerDto> CreateTrainerAsync(TrainerCreateDto trainerCreateDto);
        Task<TrainerDto> UpdateTrainerAsync(int id, TrainerCreateDto trainerUpdateDto);
        Task<bool> DeleteTrainerAsync(int id);
        Task<IEnumerable<ClassDto>> GetTrainerClassesAsync(int trainerId);
        Task<IEnumerable<OnlineSessionDto>> GetTrainerSessionsAsync(int trainerId);
    }
}
namespace elite.Middleware
{
    public class CorrelationMiddleware
    {
        private readonly RequestDelegate _next;

        public CorrelationMiddleware(RequestDelegate next)
        {
            _next = next;
        }

        public async Task InvokeAsync(HttpContext context)
        {
            var correlationId = context.Request.Headers["X-Correlation-ID"].FirstOrDefault()
                              ?? Guid.NewGuid().ToString();

            context.Response.Headers["X-Correlation-ID"] = correlationId;
            context.Items["CorrelationId"] = correlationId;

            await _next(context);
        }
    }
}
using System.Text.Json;

namespace elite.Middleware
{
    public class ExceptionMiddleware
    {
        private readonly RequestDelegate _next;
        private readonly ILogger<ExceptionMiddleware> _logger;

        public ExceptionMiddleware(RequestDelegate next, ILogger<ExceptionMiddleware> logger)
        {
            _next = next;
            _logger = logger;
        }

        public async Task InvokeAsync(HttpContext httpContext)
        {
            try
            {
                await _next(httpContext);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "An unhandled exception occurred");
                await HandleExceptionAsync(httpContext, ex);
            }
        }

        private static Task HandleExceptionAsync(HttpContext context, Exception exception)
        {
            context.Response.ContentType = "application/json";
            context.Response.StatusCode = exception switch
            {
                ArgumentException => StatusCodes.Status400BadRequest,
                UnauthorizedAccessException => StatusCodes.Status401Unauthorized,
                InvalidOperationException => StatusCodes.Status400BadRequest,
                _ => StatusCodes.Status500InternalServerError
            };

            return context.Response.WriteAsync(new ErrorDetails
            {
                StatusCode = context.Response.StatusCode,
                Message = exception.Message
            }.ToString());
        }
    }

    public class ErrorDetails
    {
        public int StatusCode { get; set; }
        public string Message { get; set; }

        public override string ToString()
        {
            return JsonSerializer.Serialize(this);
        }
    }
}
namespace elite.Middleware
{
    public class PerformanceMiddleware
    {
        private readonly RequestDelegate _next;
        private readonly ILogger<PerformanceMiddleware> _logger;

        public PerformanceMiddleware(RequestDelegate next, ILogger<PerformanceMiddleware> logger)
        {
            _next = next;
            _logger = logger;
        }

        public async Task InvokeAsync(HttpContext context)
        {
            var stopwatch = System.Diagnostics.Stopwatch.StartNew();

            await _next(context);

            stopwatch.Stop();

            if (stopwatch.ElapsedMilliseconds > 1000) // Log slow requests
            {
                _logger.LogWarning("Slow request: {Method} {Path} took {ElapsedMs}ms",
                    context.Request.Method, context.Request.Path, stopwatch.ElapsedMilliseconds);
            }
        }
    }
}
namespace elite.Middleware
{
    public class RequestLoggingMiddleware
    {
        private readonly RequestDelegate _next;
        private readonly ILogger<RequestLoggingMiddleware> _logger;

        public RequestLoggingMiddleware(RequestDelegate next, ILogger<RequestLoggingMiddleware> logger)
        {
            _next = next;
            _logger = logger;
        }

        public async Task InvokeAsync(HttpContext context)
        {
            var startTime = DateTime.UtcNow;

            _logger.LogInformation("Request started: {Method} {Path}",
                context.Request.Method, context.Request.Path);

            await _next(context);

            var duration = DateTime.UtcNow - startTime;
            _logger.LogInformation("Request completed: {Method} {Path} - {StatusCode} in {Duration}ms",
                context.Request.Method, context.Request.Path, context.Response.StatusCode, duration.TotalMilliseconds);
        }
    }
}
namespace elite.Models
{
    public class Admin
    {
        public int Id { get; set; }
        public string Username { get; set; }
        public string PasswordHash { get; set; }
        public string Email { get; set; }
        public string Role { get; set; } = "Admin";
    }
}
namespace elite.Models
{
    public class Booking
    {
        public int Id { get; set; }
        public int UserId { get; set; }
        public string Type { get; set; } // "Class" or "OnlineSession"
        public int ScheduleId { get; set; }
        public DateTime BookingDate { get; set; }
        public string Status { get; set; } // Confirmed/Cancelled/Completed
        public decimal HoursConsumed { get; set; }

        public virtual User User { get; set; }
    }
}
namespace elite.Models
{
    public class Class
    {
        public int Id { get; set; }
        public string Name { get; set; }
        public string Description { get; set; }
        public decimal Duration { get; set; }
        public int TrainerId { get; set; }
        public int MaxCapacity { get; set; }
        public decimal Price { get; set; }

        public virtual Trainer Trainer { get; set; }
        public virtual ICollection<ClassSchedule> Schedules { get; set; }
    }

}
namespace elite.Models
{
    public class ClassSchedule
    {
        public int Id { get; set; }
        public int ClassId { get; set; }
        public DateTime StartTime { get; set; }
        public DateTime EndTime { get; set; }
        public string Location { get; set; }
        public int AvailableSlots { get; set; }

        public virtual Class Class { get; set; }
        public virtual ICollection<Booking> Bookings { get; set; }
    }
}
using System.ComponentModel.DataAnnotations;

namespace elite.Models
{
    public class Membership
    {
        public int Id { get; set; }
        public int UserId { get; set; }
        public string Type { get; set; }
        public DateTime StartDate { get; set; }
        public DateTime EndDate { get; set; }
        public decimal TotalHours { get; set; }       // Change this to decimal too!
        public decimal RemainingHours { get; set; }   // Changed to decimal
        public string Status { get; set; }
        public decimal PricePaid { get; set; }

        public virtual User User { get; set; }
    }
}
namespace elite.Models
{
    public class MembershipType
    {
        public int Id { get; set; }
        public string Name { get; set; }
        public string Description { get; set; }
        public int DurationMonths { get; set; }
        public decimal TotalHours { get; set; }      
        public decimal Price { get; set; }
        public bool IsActive { get; set; } = true;
    }
}
namespace elite.Models
{
    public class OnlineSession
    {
        public int Id { get; set; }
        public string Name { get; set; }
        public string Description { get; set; }
        public decimal Duration { get; set; }
        public int TrainerId { get; set; }
        public decimal Price { get; set; }

        public virtual Trainer Trainer { get; set; }
        public virtual ICollection<OnlineSessionSchedule> Schedules { get; set; }
    }
}
namespace elite.Models
{
    public class OnlineSessionSchedule
    {
        public int Id { get; set; }
        public int OnlineSessionId { get; set; }
        public DateTime StartTime { get; set; }
        public DateTime EndTime { get; set; }
        public int AvailableSlots { get; set; }

        public virtual OnlineSession OnlineSession { get; set; }
        public virtual ICollection<Booking> Bookings { get; set; }
    }
}
namespace elite.Models
{
    public class Order
    {
        public int Id { get; set; }
        public int UserId { get; set; }
        public DateTime OrderDate { get; set; }
        public decimal TotalAmount { get; set; }
        public string Status { get; set; } // Pending/Completed/Cancelled

        public virtual User User { get; set; }
        public virtual ICollection<OrderItem> OrderItems { get; set; }
    }
}
namespace elite.Models
{
    public class OrderItem
    {
        public int Id { get; set; }
        public int OrderId { get; set; }
        public int ProductId { get; set; }
        public int Quantity { get; set; }
        public decimal Price { get; set; }

        public virtual Order Order { get; set; }
        public virtual Product Product { get; set; }
    }
}
namespace elite.Models
{
    public class Product
    {
        public int Id { get; set; }
        public string Name { get; set; }
        public string Description { get; set; }
        public decimal Price { get; set; }
        public string ImageUrl { get; set; }
        public string Category { get; set; } // Apparel/Supplements

        public int StockQuantity { get; set; }
        public virtual ICollection<OrderItem> OrderItems { get; set; }
    }

}
namespace elite.Models
{
    public class Promotion
    {
        public int Id { get; set; }
        public string Code { get; set; }
        public string Description { get; set; }
        public string DiscountType { get; set; } // Percentage/Fixed
        public decimal DiscountValue { get; set; }
        public DateTime StartDate { get; set; }
        public DateTime EndDate { get; set; }
        public int UsageLimit { get; set; }
        public int TimesUsed { get; set; }
    }
}
namespace elite.Models
{
    public class Trainer
    {
        public int Id { get; set; }
        public string Name { get; set; }
        public string Specialization { get; set; }
        public int ExperienceYears { get; set; }
        public string Certifications { get; set; }
        public string Bio { get; set; }
        public string ImageUrl { get; set; }

        public virtual ICollection<Class> Classes { get; set; }
        public virtual ICollection<OnlineSession> OnlineSessions { get; set; }
    }
}
using System.ComponentModel.DataAnnotations;

namespace elite.Models
{
    public class User
    {
        public int Id { get; set; }

        [Required, MaxLength(100)]
        public string Name { get; set; }

        [Required, EmailAddress, MaxLength(100)]
        public string Email { get; set; }

        [Required, MaxLength(255)]
        public string PasswordHash { get; set; }

        [Phone, MaxLength(20)]
        public string Phone { get; set; }

        public int? MembershipId { get; set; }
        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
        public DateTime? UpdatedAt { get; set; }

        // Navigation properties
        public virtual Membership Membership { get; set; }
        public virtual ICollection<Booking> Bookings { get; set; }
        public virtual ICollection<Order> Orders { get; set; }
    }
}
using elite.Data;
using elite.DTOs;
using elite.Interfaces;
using Microsoft.EntityFrameworkCore;

namespace elite.Services
{
    // Services/AdminService.cs
    public class AdminService : IAdminService
    {
        private readonly GymDbContext _context;
        private readonly ILogger<AdminService> _logger;

        public AdminService(GymDbContext context, ILogger<AdminService> logger)
        {
            _context = context;
            _logger = logger;
        }

        public async Task<IEnumerable<UserResponseDto>> GetAllUsersAsync(int page, int pageSize)
        {
            return await _context.Users
                .Include(u => u.Membership)
                .Include(u => u.Bookings)
                .OrderBy(u => u.Id)
                .Skip((page - 1) * pageSize)
                .Take(pageSize)
                .Select(u => new UserResponseDto
                {
                    Id = u.Id,
                    Name = u.Name,
                    Email = u.Email,
                    Phone = u.Phone,
                    CreatedAt = u.CreatedAt,
                    Membership = u.Membership != null ? new MembershipDto
                    {
                        Id = u.Membership.Id,
                        Type = u.Membership.Type,
                        StartDate = u.Membership.StartDate,
                        EndDate = u.Membership.EndDate,
                        TotalHours = u.Membership.TotalHours,
                        RemainingHours = u.Membership.RemainingHours,
                        Status = u.Membership.Status
                    } : null
                })
                .ToListAsync();
        }

        public async Task<UserResponseDto> GetUserDetailsAsync(int userId)
        {
            var user = await _context.Users
                .Include(u => u.Membership)
                .Include(u => u.Bookings)
                .Include(u => u.Orders)
                .ThenInclude(o => o.OrderItems)
                .FirstOrDefaultAsync(u => u.Id == userId);

            if (user == null) throw new ArgumentException("User not found");

            return new UserResponseDto
            {
                Id = user.Id,
                Name = user.Name,
                Email = user.Email,
                Phone = user.Phone,
                CreatedAt = user.CreatedAt,
                Membership = user.Membership != null ? new MembershipDto
                {
                    Id = user.Membership.Id,
                    Type = user.Membership.Type,
                    StartDate = user.Membership.StartDate,
                    EndDate = user.Membership.EndDate,
                    TotalHours = user.Membership.TotalHours,
                    RemainingHours = user.Membership.RemainingHours,
                    Status = user.Membership.Status
                } : null
            };
        }

        public async Task<bool> UpdateUserStatusAsync(int userId, bool isActive)
        {
            // For this implementation, we'll assume users are always active
            // In a real system, you might have an IsActive property on the User model
            return await Task.FromResult(true);
        }

        public async Task<DashboardStatsDto> GetDashboardStatsAsync()
        {
            var totalUsers = await _context.Users.CountAsync();
            var activeMemberships = await _context.Memberships
                .CountAsync(m => m.Status == "Active" && m.EndDate >= DateTime.UtcNow);

            var totalBookingsToday = await _context.Bookings
                .CountAsync(b => b.BookingDate.Date == DateTime.UtcNow.Date && b.Status == "Confirmed");

            var revenueThisMonth = await _context.Orders
                .Where(o => o.OrderDate.Month == DateTime.UtcNow.Month &&
                           o.OrderDate.Year == DateTime.UtcNow.Year &&
                           o.Status == "Completed")
                .SumAsync(o => o.TotalAmount);

            var lowStockProducts = await _context.Products
                .CountAsync(p => p.StockQuantity <= 5);

            return new DashboardStatsDto
            {
                TotalUsers = totalUsers,
                ActiveMemberships = activeMemberships,
                TotalBookingsToday = totalBookingsToday,
                RevenueThisMonth = revenueThisMonth,
                LowStockProducts = lowStockProducts
            };
        }

        public async Task<IEnumerable<BookingResponseDto>> GetAllBookingsAsync(DateTime? startDate, DateTime? endDate)
        {
            var query = _context.Bookings
                .Include(b => b.User)
                .AsQueryable();

            if (startDate.HasValue)
                query = query.Where(b => b.BookingDate >= startDate.Value);

            if (endDate.HasValue)
                query = query.Where(b => b.BookingDate <= endDate.Value);

            return await query
                .OrderByDescending(b => b.BookingDate)
                .Select(b => new BookingResponseDto
                {
                    Id = b.Id,
                    Type = b.Type,
                    ScheduleId = b.ScheduleId,
                    BookingDate = b.BookingDate,
                    Status = b.Status,
                    HoursConsumed = b.HoursConsumed,
                    ClassName = b.Type == "Class"
                        ? _context.ClassSchedules
                            .Where(cs => cs.Id == b.ScheduleId)
                            .Select(cs => cs.Class.Name)
                            .FirstOrDefault()
                        : _context.OnlineSessionSchedules
                            .Where(oss => oss.Id == b.ScheduleId)
                            .Select(oss => oss.OnlineSession.Name)
                            .FirstOrDefault(),
                    TrainerName = b.Type == "Class"
                        ? _context.ClassSchedules
                            .Where(cs => cs.Id == b.ScheduleId)
                            .Select(cs => cs.Class.Trainer.Name)
                            .FirstOrDefault()
                        : _context.OnlineSessionSchedules
                            .Where(oss => oss.Id == b.ScheduleId)
                            .Select(oss => oss.OnlineSession.Trainer.Name)
                            .FirstOrDefault(),
                    StartTime = b.Type == "Class"
                        ? _context.ClassSchedules
                            .Where(cs => cs.Id == b.ScheduleId)
                            .Select(cs => cs.StartTime)
                            .FirstOrDefault()
                        : _context.OnlineSessionSchedules
                            .Where(oss => oss.Id == b.ScheduleId)
                            .Select(oss => oss.StartTime)
                            .FirstOrDefault(),
                    EndTime = b.Type == "Class"
                        ? _context.ClassSchedules
                            .Where(cs => cs.Id == b.ScheduleId)
                            .Select(cs => cs.EndTime)
                            .FirstOrDefault()
                        : _context.OnlineSessionSchedules
                            .Where(oss => oss.Id == b.ScheduleId)
                            .Select(oss => oss.EndTime)
                            .FirstOrDefault(),
                    Location = b.Type == "Class"
                        ? _context.ClassSchedules
                            .Where(cs => cs.Id == b.ScheduleId)
                            .Select(cs => cs.Location)
                            .FirstOrDefault()
                        : "Online"
                })
                .ToListAsync();
        }



        // In AdminService.cs
        public async Task<IEnumerable<OrderDto>> GetAllOrdersAsync()
        {
            return await _context.Orders
                .Include(o => o.User)
                .Include(o => o.OrderItems)
                .ThenInclude(oi => oi.Product)
                .OrderByDescending(o => o.OrderDate)
                .Select(o => new OrderDto
                {
                    Id = o.Id,
                    UserId = o.UserId,
                    UserName = o.User.Name,
                    OrderDate = o.OrderDate,
                    TotalAmount = o.TotalAmount,
                    Status = o.Status,
                    OrderItems = o.OrderItems.Select(oi => new OrderItemDto
                    {
                        Id = oi.Id,
                        ProductId = oi.ProductId,
                        ProductName = oi.Product.Name,
                        Quantity = oi.Quantity,
                        Price = oi.Price
                    }).ToList()
                })
                .ToListAsync();
        }

        // Services/AdminService.cs
        // Services/AdminService.cs
        public async Task<BookingResponseDto> GetBookingDetailsAsync(int bookingId)
        {
            var booking = await _context.Bookings
                .Include(b => b.User) // Include the User navigation property
                .Where(b => b.Id == bookingId)
                .Select(b => new BookingResponseDto
                {
                    Id = b.Id,
                    Type = b.Type,
                    ScheduleId = b.ScheduleId,
                    BookingDate = b.BookingDate,
                    Status = b.Status,
                    HoursConsumed = b.HoursConsumed,
                    UserId = b.UserId,
                    UserName = b.User.Name,
                    ClassName = b.Type == "Class"
                        ? _context.ClassSchedules
                            .Where(cs => cs.Id == b.ScheduleId)
                            .Select(cs => cs.Class.Name)
                            .FirstOrDefault()
                        : _context.OnlineSessionSchedules
                            .Where(oss => oss.Id == b.ScheduleId)
                            .Select(oss => oss.OnlineSession.Name)
                            .FirstOrDefault(),
                    TrainerName = b.Type == "Class"
                        ? _context.ClassSchedules
                            .Where(cs => cs.Id == b.ScheduleId)
                            .Select(cs => cs.Class.Trainer.Name)
                            .FirstOrDefault()
                        : _context.OnlineSessionSchedules
                            .Where(oss => oss.Id == b.ScheduleId)
                            .Select(oss => oss.OnlineSession.Trainer.Name)
                            .FirstOrDefault(),
                    StartTime = b.Type == "Class"
                        ? _context.ClassSchedules
                            .Where(cs => cs.Id == b.ScheduleId)
                            .Select(cs => cs.StartTime)
                            .FirstOrDefault()
                        : _context.OnlineSessionSchedules
                            .Where(oss => oss.Id == b.ScheduleId)
                            .Select(oss => oss.StartTime)
                            .FirstOrDefault(),
                    EndTime = b.Type == "Class"
                        ? _context.ClassSchedules
                            .Where(cs => cs.Id == b.ScheduleId)
                            .Select(cs => cs.EndTime)
                            .FirstOrDefault()
                        : _context.OnlineSessionSchedules
                            .Where(oss => oss.Id == b.ScheduleId)
                            .Select(oss => oss.EndTime)
                            .FirstOrDefault(),
                    Location = b.Type == "Class"
                        ? _context.ClassSchedules
                            .Where(cs => cs.Id == b.ScheduleId)
                            .Select(cs => cs.Location)
                            .FirstOrDefault()
                        : "Online"
                })
                .FirstOrDefaultAsync();

            if (booking == null) throw new ArgumentException("Booking not found");
            return booking;
        }

        public async Task<IEnumerable<RevenueReportDto>> GetRevenueReportAsync(DateTime startDate, DateTime endDate)
        {
            var orders = await _context.Orders
                .Where(o => o.OrderDate >= startDate && o.OrderDate <= endDate && o.Status == "Completed")
                .ToListAsync();

            var memberships = await _context.Memberships
                .Where(m => m.StartDate >= startDate && m.StartDate <= endDate && m.Status == "Active")
                .ToListAsync();

            var revenueByDate = new Dictionary<DateTime, RevenueReportDto>();

            // Initialize all dates in range
            for (var date = startDate.Date; date <= endDate.Date; date = date.AddDays(1))
            {
                revenueByDate[date] = new RevenueReportDto
                {
                    Date = date,
                    MembershipRevenue = 0,
                    ProductRevenue = 0,
                    TotalRevenue = 0,
                    BookingsCount = 0
                };
            }

            // Calculate product revenue from orders
            foreach (var order in orders)
            {
                var date = order.OrderDate.Date;
                if (revenueByDate.ContainsKey(date))
                {
                    revenueByDate[date].ProductRevenue += order.TotalAmount;
                    revenueByDate[date].TotalRevenue += order.TotalAmount;
                }
            }

            // Calculate membership revenue (simplified - assuming fixed prices)
            foreach (var membership in memberships)
            {
                var date = membership.StartDate.Date;
                if (revenueByDate.ContainsKey(date))
                {
                    decimal membershipPrice = membership.Type switch
                    {
                        "Basic" => 49.99m,
                        "Medium" => 99.99m,
                        "VIP" => 199.99m,
                        _ => 0
                    };

                    revenueByDate[date].MembershipRevenue += membershipPrice;
                    revenueByDate[date].TotalRevenue += membershipPrice;
                }
            }

            // Calculate bookings count
            var bookings = await _context.Bookings
                .Where(b => b.BookingDate >= startDate && b.BookingDate <= endDate && b.Status == "Confirmed")
                .ToListAsync();

            foreach (var booking in bookings)
            {
                var date = booking.BookingDate.Date;
                if (revenueByDate.ContainsKey(date))
                {
                    revenueByDate[date].BookingsCount++;
                }
            }

            return revenueByDate.Values.OrderBy(r => r.Date).ToList();
        }
    }
}
using elite.Data;
using elite.DTOs;
using elite.Interfaces;
using elite.Models;
using elite.Utilities;
using Microsoft.EntityFrameworkCore;

namespace elite.Services
{


    public class AuthService : IAuthService
    {
        private readonly GymDbContext _context;
        private readonly IJwtService _jwtService;
        private readonly ILogger<AuthService> _logger;

        public AuthService(GymDbContext context, IJwtService jwtService, ILogger<AuthService> logger)
        {
            _context = context;
            _jwtService = jwtService;
            _logger = logger;
        }

        public async Task<AuthResponseDto> RegisterAsync(UserRegisterDto registerDto)
        {
            if (await _context.Users.AnyAsync(u => u.Email == registerDto.Email))
                throw new ArgumentException("Email already exists");

            var passwordHash = BCrypt.Net.BCrypt.HashPassword(registerDto.Password);

            var user = new User
            {
                Name = registerDto.Name,
                Email = registerDto.Email,
                PasswordHash = passwordHash,
                Phone = registerDto.Phone,
                CreatedAt = DateTime.UtcNow
            };

            _context.Users.Add(user);
            await _context.SaveChangesAsync();

            var token = _jwtService.GenerateToken(user);

            return new AuthResponseDto
            {
                Token = token,
                User = new UserResponseDto
                {
                    Id = user.Id,
                    Name = user.Name,
                    Email = user.Email,
                    Phone = user.Phone,
                    CreatedAt = user.CreatedAt
                }
            };
        }

        public async Task<AuthResponseDto> LoginAsync(UserLoginDto loginDto)
        {
            // First try to find a user
            var user = await _context.Users
                .Include(u => u.Membership)
                .FirstOrDefaultAsync(u => u.Email == loginDto.Email);

            // If not found, try to find an admin
            if (user == null)
            {
                var admin = await _context.Admins
                    .FirstOrDefaultAsync(a => a.Email == loginDto.Email);

                if (admin != null && BCrypt.Net.BCrypt.Verify(loginDto.Password, admin.PasswordHash))
                {
                    // Generate token for admin
                    var token = _jwtService.GenerateAdminToken(admin);

                    return new AuthResponseDto
                    {
                        Token = token,
                        User = new UserResponseDto
                        {
                            Id = admin.Id,
                            Name = admin.Username,
                            Email = admin.Email,
                            CreatedAt = DateTime.UtcNow,
                            // Admins don't have memberships
                            Membership = null
                        }
                    };
                }
            }

            // Original user login logic
            if (user == null || !BCrypt.Net.BCrypt.Verify(loginDto.Password, user.PasswordHash))
                throw new UnauthorizedAccessException("Invalid credentials");

            var userToken = _jwtService.GenerateToken(user);

            return new AuthResponseDto
            {
                Token = userToken,
                User = new UserResponseDto
                {
                    Id = user.Id,
                    Name = user.Name,
                    Email = user.Email,
                    Phone = user.Phone,
                    CreatedAt = user.CreatedAt,
                    Membership = user.Membership != null ? new MembershipDto
                    {
                        Id = user.Membership.Id,
                        Type = user.Membership.Type,
                        StartDate = user.Membership.StartDate,
                        EndDate = user.Membership.EndDate,
                        TotalHours = user.Membership.TotalHours,
                        RemainingHours = user.Membership.RemainingHours,
                        Status = user.Membership.Status
                    } : null
                }
            };
        }

        public async Task<UserResponseDto> GetUserProfileAsync(int userId)
        {
            var user = await _context.Users
                .Include(u => u.Membership)
                .FirstOrDefaultAsync(u => u.Id == userId);

            if (user == null) throw new ArgumentException("User not found");

            return new UserResponseDto
            {
                Id = user.Id,
                Name = user.Name,
                Email = user.Email,
                Phone = user.Phone,
                CreatedAt = user.CreatedAt,
                Membership = user.Membership != null ? new MembershipDto
                {
                    Id = user.Membership.Id,
                    Type = user.Membership.Type,
                    StartDate = user.Membership.StartDate,
                    EndDate = user.Membership.EndDate,
                    TotalHours = user.Membership.TotalHours,
                    RemainingHours = user.Membership.RemainingHours,
                    Status = user.Membership.Status
                } : null
            };
        }

        public async Task<bool> UpdateUserProfileAsync(int userId, UserUpdateDto updateDto)
        {
            var user = await _context.Users.FindAsync(userId);
            if (user == null) throw new ArgumentException("User not found");

            if (!string.IsNullOrEmpty(updateDto.Name))
                user.Name = updateDto.Name;

            if (!string.IsNullOrEmpty(updateDto.Phone))
                user.Phone = updateDto.Phone;

            user.UpdatedAt = DateTime.UtcNow;

            _context.Users.Update(user);
            return await _context.SaveChangesAsync() > 0;
        }

        public async Task<bool> ChangePasswordAsync(int userId, string currentPassword, string newPassword)
        {
            var user = await _context.Users.FindAsync(userId);
            if (user == null) throw new ArgumentException("User not found");

            if (!BCrypt.Net.BCrypt.Verify(currentPassword, user.PasswordHash))
                throw new UnauthorizedAccessException("Current password is incorrect");

            user.PasswordHash = BCrypt.Net.BCrypt.HashPassword(newPassword);
            user.UpdatedAt = DateTime.UtcNow;

            _context.Users.Update(user);
            return await _context.SaveChangesAsync() > 0;
        }
    }

}
using elite.Data;
using elite.DTOs;
using elite.Interfaces;
using elite.Models;
using Microsoft.EntityFrameworkCore;

namespace elite.Services
{
    public class BookingService : IBookingService
    {
        private readonly GymDbContext _context;
        private readonly ILogger<BookingService> _logger;

        public BookingService(GymDbContext context, ILogger<BookingService> logger)
        {
            _context = context;
            _logger = logger;
        }

        public async Task<BookingResponseDto> CreateBookingAsync(CreateBookingDto bookingDto)
        {
            using var transaction = await _context.Database.BeginTransactionAsync();

            try
            {
                var user = await _context.Users
                    .Include(u => u.Membership)
                    .FirstOrDefaultAsync(u => u.Id == bookingDto.UserId);

                if (user == null) throw new ArgumentException("User not found");

                if (user.Membership == null || user.Membership.Status != "Active")
                    throw new InvalidOperationException("User does not have an active membership");

                if (user.Membership.EndDate < DateTime.UtcNow.Date)
                {
                    user.Membership.Status = "Expired";
                    await _context.SaveChangesAsync();
                    throw new InvalidOperationException("Membership has expired");
                }

                decimal duration = 0;
                string className = string.Empty;
                string trainerName = string.Empty;
                DateTime startTime, endTime;
                string location = string.Empty;

                if (bookingDto.Type == "Class")
                {
                    var schedule = await _context.ClassSchedules
                        .Include(cs => cs.Class)
                        .ThenInclude(c => c.Trainer)
                        .FirstOrDefaultAsync(cs => cs.Id == bookingDto.ScheduleId);

                    if (schedule == null) throw new ArgumentException("Class schedule not found");
                    if (schedule.AvailableSlots <= 0) throw new InvalidOperationException("No available slots");
                    if (schedule.StartTime <= DateTime.UtcNow) throw new InvalidOperationException("Class has already started");

                    // FIX: Convert minutes to hours
                    duration = schedule.Class.Duration / 60.0m;
                    className = schedule.Class.Name;
                    trainerName = schedule.Class.Trainer.Name;
                    startTime = schedule.StartTime;
                    endTime = schedule.EndTime;
                    location = schedule.Location;

                    var existingBooking = await _context.Bookings
                        .FirstOrDefaultAsync(b => b.UserId == bookingDto.UserId &&
                                                 b.Type == "Class" &&
                                                 b.ScheduleId == bookingDto.ScheduleId &&
                                                 b.Status == "Confirmed");

                    if (existingBooking != null) throw new InvalidOperationException("User already booked this class");

                    schedule.AvailableSlots--;
                    _context.ClassSchedules.Update(schedule);
                }
                else if (bookingDto.Type == "OnlineSession")
                {
                    var schedule = await _context.OnlineSessionSchedules
                        .Include(oss => oss.OnlineSession)
                        .ThenInclude(os => os.Trainer)
                        .FirstOrDefaultAsync(oss => oss.Id == bookingDto.ScheduleId);

                    if (schedule == null) throw new ArgumentException("Online session schedule not found");
                    if (schedule.AvailableSlots <= 0) throw new InvalidOperationException("No available slots");
                    if (schedule.StartTime <= DateTime.UtcNow) throw new InvalidOperationException("Session has already started");

                    // FIX: Convert minutes to hours
                    duration = schedule.OnlineSession.Duration / 60.0m;
                    className = schedule.OnlineSession.Name;
                    trainerName = schedule.OnlineSession.Trainer.Name;
                    startTime = schedule.StartTime;
                    endTime = schedule.EndTime;

                    schedule.AvailableSlots--;
                    _context.OnlineSessionSchedules.Update(schedule);
                }
                else
                {
                    throw new ArgumentException("Invalid booking type");
                }

                if (user.Membership.RemainingHours < duration)
                    throw new InvalidOperationException("Insufficient hours in membership");

                user.Membership.RemainingHours -= duration;
                _context.Memberships.Update(user.Membership);

                var booking = new Booking
                {
                    UserId = bookingDto.UserId,
                    Type = bookingDto.Type,
                    ScheduleId = bookingDto.ScheduleId,
                    BookingDate = DateTime.UtcNow,
                    Status = "Confirmed",
                    HoursConsumed = duration
                };

                _context.Bookings.Add(booking);
                await _context.SaveChangesAsync();
                await transaction.CommitAsync();

                return new BookingResponseDto
                {
                    Id = booking.Id,
                    Type = booking.Type,
                    ScheduleId = booking.ScheduleId,
                    BookingDate = booking.BookingDate,
                    Status = booking.Status,
                    HoursConsumed = booking.HoursConsumed,
                    ClassName = className,
                    TrainerName = trainerName,
                    StartTime = startTime,
                    EndTime = endTime,
                    Location = location
                };
            }
            catch (Exception ex)
            {
                await transaction.RollbackAsync();
                _logger.LogError(ex, "Error creating booking");
                throw;
            }
        }

        public async Task<bool> CancelBookingAsync(int bookingId, int userId)
        {
            using var transaction = await _context.Database.BeginTransactionAsync();

            try
            {
                var booking = await _context.Bookings
                    .Include(b => b.User)
                    .ThenInclude(u => u.Membership)
                    .FirstOrDefaultAsync(b => b.Id == bookingId && b.UserId == userId);

                if (booking == null) throw new ArgumentException("Booking not found");
                if (booking.Status != "Confirmed") throw new InvalidOperationException("Booking cannot be cancelled");

                DateTime scheduleTime;
                decimal duration = booking.HoursConsumed;

                if (booking.Type == "Class")
                {
                    var schedule = await _context.ClassSchedules.FindAsync(booking.ScheduleId);
                    if (schedule == null) throw new ArgumentException("Class schedule not found");

                    scheduleTime = schedule.StartTime;

                    // Check cancellation policy (>24 hours)
                    if ((scheduleTime - DateTime.UtcNow).TotalHours > 24)
                    {
                        // Refund hours
                        booking.User.Membership.RemainingHours += duration; // FIX: Removed (int) cast
                        _context.Memberships.Update(booking.User.Membership);

                        // Increment available slots
                        schedule.AvailableSlots++;
                        _context.ClassSchedules.Update(schedule);
                    }
                }
                else
                {
                    var schedule = await _context.OnlineSessionSchedules.FindAsync(booking.ScheduleId);
                    if (schedule == null) throw new ArgumentException("Online session schedule not found");

                    scheduleTime = schedule.StartTime;

                    // Check cancellation policy (>24 hours)
                    if ((scheduleTime - DateTime.UtcNow).TotalHours > 24)
                    {
                        // Refund hours
                        booking.User.Membership.RemainingHours += duration; // FIX: Removed (int) cast
                        _context.Memberships.Update(booking.User.Membership);

                        // Increment available slots
                        schedule.AvailableSlots++;
                        _context.OnlineSessionSchedules.Update(schedule);
                    }
                }

                booking.Status = "Cancelled";
                _context.Bookings.Update(booking);

                await _context.SaveChangesAsync();
                await transaction.CommitAsync();

                return true;
            }
            catch (Exception ex)
            {
                await transaction.RollbackAsync();
                _logger.LogError(ex, "Error cancelling booking");
                throw;
            }
        }

        public async Task<IEnumerable<BookingResponseDto>> GetUserBookingsAsync(int userId)
        {
            var bookings = await _context.Bookings
                .Where(b => b.UserId == userId)
                .OrderByDescending(b => b.BookingDate)
                .Select(b => new BookingResponseDto
                {
                    Id = b.Id,
                    Type = b.Type,
                    ScheduleId = b.ScheduleId,
                    BookingDate = b.BookingDate,
                    Status = b.Status,
                    HoursConsumed = b.HoursConsumed,
                    ClassName = b.Type == "Class"
                        ? _context.ClassSchedules
                            .Where(cs => cs.Id == b.ScheduleId)
                            .Select(cs => cs.Class.Name)
                            .FirstOrDefault()
                        : _context.OnlineSessionSchedules
                            .Where(oss => oss.Id == b.ScheduleId)
                            .Select(oss => oss.OnlineSession.Name)
                            .FirstOrDefault(),
                    TrainerName = b.Type == "Class"
                        ? _context.ClassSchedules
                            .Where(cs => cs.Id == b.ScheduleId)
                            .Select(cs => cs.Class.Trainer.Name)
                            .FirstOrDefault()
                        : _context.OnlineSessionSchedules
                            .Where(oss => oss.Id == b.ScheduleId)
                            .Select(oss => oss.OnlineSession.Trainer.Name)
                            .FirstOrDefault(),
                    StartTime = b.Type == "Class"
                        ? _context.ClassSchedules
                            .Where(cs => cs.Id == b.ScheduleId)
                            .Select(cs => cs.StartTime)
                            .FirstOrDefault()
                        : _context.OnlineSessionSchedules
                            .Where(oss => oss.Id == b.ScheduleId)
                            .Select(oss => oss.StartTime)
                            .FirstOrDefault(),
                    EndTime = b.Type == "Class"
                        ? _context.ClassSchedules
                            .Where(cs => cs.Id == b.ScheduleId)
                            .Select(cs => cs.EndTime)
                            .FirstOrDefault()
                        : _context.OnlineSessionSchedules
                            .Where(oss => oss.Id == b.ScheduleId)
                            .Select(oss => oss.EndTime)
                            .FirstOrDefault(),
                    Location = b.Type == "Class"
                        ? _context.ClassSchedules
                            .Where(cs => cs.Id == b.ScheduleId)
                            .Select(cs => cs.Location)
                            .FirstOrDefault()
                        : "Online"
                })
                .ToListAsync();

            return bookings;
        }

        // Services/BookingService.cs
        public async Task<BookingResponseDto> GetBookingDetailsAsync(int bookingId)
        {
            var booking = await _context.Bookings
                .Include(b => b.User) // Include the User navigation property
                .Where(b => b.Id == bookingId)
                .Select(b => new BookingResponseDto
                {
                    Id = b.Id,
                    Type = b.Type,
                    ScheduleId = b.ScheduleId,
                    BookingDate = b.BookingDate,
                    Status = b.Status,
                    HoursConsumed = b.HoursConsumed,
                    UserId = b.UserId,
                    UserName = b.User.Name,
                    ClassName = b.Type == "Class"
                        ? _context.ClassSchedules
                            .Where(cs => cs.Id == b.ScheduleId)
                            .Select(cs => cs.Class.Name)
                            .FirstOrDefault()
                        : _context.OnlineSessionSchedules
                            .Where(oss => oss.Id == b.ScheduleId)
                            .Select(oss => oss.OnlineSession.Name)
                            .FirstOrDefault(),
                    TrainerName = b.Type == "Class"
                        ? _context.ClassSchedules
                            .Where(cs => cs.Id == b.ScheduleId)
                            .Select(cs => cs.Class.Trainer.Name)
                            .FirstOrDefault()
                        : _context.OnlineSessionSchedules
                            .Where(oss => oss.Id == b.ScheduleId)
                            .Select(oss => oss.OnlineSession.Trainer.Name)
                            .FirstOrDefault(),
                    StartTime = b.Type == "Class"
                        ? _context.ClassSchedules
                            .Where(cs => cs.Id == b.ScheduleId)
                            .Select(cs => cs.StartTime)
                            .FirstOrDefault()
                        : _context.OnlineSessionSchedules
                            .Where(oss => oss.Id == b.ScheduleId)
                            .Select(oss => oss.StartTime)
                            .FirstOrDefault(),
                    EndTime = b.Type == "Class"
                        ? _context.ClassSchedules
                            .Where(cs => cs.Id == b.ScheduleId)
                            .Select(cs => cs.EndTime)
                            .FirstOrDefault()
                        : _context.OnlineSessionSchedules
                            .Where(oss => oss.Id == b.ScheduleId)
                            .Select(oss => oss.EndTime)
                            .FirstOrDefault(),
                    Location = b.Type == "Class"
                        ? _context.ClassSchedules
                            .Where(cs => cs.Id == b.ScheduleId)
                            .Select(cs => cs.Location)
                            .FirstOrDefault()
                        : "Online"
                })
                .FirstOrDefaultAsync();

            if (booking == null) throw new ArgumentException("Booking not found");
            return booking;
        }




        public async Task<IEnumerable<BookingResponseDto>> GetBookingsByDateRangeAsync(DateTime startDate, DateTime endDate)
        {
            var bookings = await _context.Bookings
                .Where(b => b.BookingDate >= startDate && b.BookingDate <= endDate)
                .OrderByDescending(b => b.BookingDate)
                .Select(b => new BookingResponseDto
                {
                    Id = b.Id,
                    Type = b.Type,
                    ScheduleId = b.ScheduleId,
                    BookingDate = b.BookingDate,
                    Status = b.Status,
                    HoursConsumed = b.HoursConsumed,
                    ClassName = b.Type == "Class"
                        ? _context.ClassSchedules
                            .Where(cs => cs.Id == b.ScheduleId)
                            .Select(cs => cs.Class.Name)
                            .FirstOrDefault()
                        : _context.OnlineSessionSchedules
                            .Where(oss => oss.Id == b.ScheduleId)
                            .Select(oss => oss.OnlineSession.Name)
                            .FirstOrDefault(),
                    TrainerName = b.Type == "Class"
                        ? _context.ClassSchedules
                            .Where(cs => cs.Id == b.ScheduleId)
                            .Select(cs => cs.Class.Trainer.Name)
                            .FirstOrDefault()
                        : _context.OnlineSessionSchedules
                            .Where(oss => oss.Id == b.ScheduleId)
                            .Select(oss => oss.OnlineSession.Trainer.Name)
                            .FirstOrDefault(),
                    StartTime = b.Type == "Class"
                        ? _context.ClassSchedules
                            .Where(cs => cs.Id == b.ScheduleId)
                            .Select(cs => cs.StartTime)
                            .FirstOrDefault()
                        : _context.OnlineSessionSchedules
                            .Where(oss => oss.Id == b.ScheduleId)
                            .Select(oss => oss.StartTime)
                            .FirstOrDefault(),
                    EndTime = b.Type == "Class"
                        ? _context.ClassSchedules
                            .Where(cs => cs.Id == b.ScheduleId)
                            .Select(cs => cs.EndTime)
                            .FirstOrDefault()
                        : _context.OnlineSessionSchedules
                            .Where(oss => oss.Id == b.ScheduleId)
                            .Select(oss => oss.EndTime)
                            .FirstOrDefault(),
                    Location = b.Type == "Class"
                        ? _context.ClassSchedules
                            .Where(cs => cs.Id == b.ScheduleId)
                            .Select(cs => cs.Location)
                            .FirstOrDefault()
                        : "Online"
                })
                .ToListAsync();

            return bookings;
        }
    }
}
using elite.Data;
using elite.DTOs;
using elite.Interfaces;
using elite.Models;
using Microsoft.EntityFrameworkCore;

namespace elite.Services
{
    // Services/ClassService.cs
    public class ClassService : IClassService
    {
        private readonly GymDbContext _context;
        private readonly ILogger<ClassService> _logger;

        public ClassService(GymDbContext context, ILogger<ClassService> logger)
        {
            _context = context;
            _logger = logger;
        }

        public async Task<IEnumerable<ClassDto>> GetAllClassesAsync()
        {
            return await _context.Classes
                .Include(c => c.Trainer)
                .Select(c => new ClassDto
                {
                    Id = c.Id,
                    Name = c.Name,
                    Description = c.Description,
                    Duration = c.Duration,
                    TrainerId = c.TrainerId,
                    TrainerName = c.Trainer.Name,
                    MaxCapacity = c.MaxCapacity,
                    Price = c.Price
                })
                .ToListAsync();
        }

        public async Task<ClassDto> GetClassByIdAsync(int id)
        {
            var classObj = await _context.Classes
                .Include(c => c.Trainer)
                .FirstOrDefaultAsync(c => c.Id == id);

            if (classObj == null) throw new ArgumentException("Class not found");

            return new ClassDto
            {
                Id = classObj.Id,
                Name = classObj.Name,
                Description = classObj.Description,
                Duration = classObj.Duration,
                TrainerId = classObj.TrainerId,
                TrainerName = classObj.Trainer.Name,
                MaxCapacity = classObj.MaxCapacity,
                Price = classObj.Price
            };
        }

        public async Task<ClassDto> CreateClassAsync(ClassCreateDto classCreateDto)
        {
            // Check if trainer exists
            var trainer = await _context.Trainers.FindAsync(classCreateDto.TrainerId);
            if (trainer == null) throw new ArgumentException("Trainer not found");

            var classObj = new Class
            {
                Name = classCreateDto.Name,
                Description = classCreateDto.Description,
                Duration = classCreateDto.Duration,
                TrainerId = classCreateDto.TrainerId,
                MaxCapacity = classCreateDto.MaxCapacity,
                Price = classCreateDto.Price
            };

            _context.Classes.Add(classObj);
            await _context.SaveChangesAsync();

            return new ClassDto
            {
                Id = classObj.Id,
                Name = classObj.Name,
                Description = classObj.Description,
                Duration = classObj.Duration,
                TrainerId = classObj.TrainerId,
                TrainerName = trainer.Name,
                MaxCapacity = classObj.MaxCapacity,
                Price = classObj.Price
            };
        }

        public async Task<ClassDto> UpdateClassAsync(int id, ClassCreateDto classUpdateDto)
        {
            var classObj = await _context.Classes.FindAsync(id);
            if (classObj == null) throw new ArgumentException("Class not found");

            // Check if trainer exists
            var trainer = await _context.Trainers.FindAsync(classUpdateDto.TrainerId);
            if (trainer == null) throw new ArgumentException("Trainer not found");

            classObj.Name = classUpdateDto.Name;
            classObj.Description = classUpdateDto.Description;
            classObj.Duration = classUpdateDto.Duration;
            classObj.TrainerId = classUpdateDto.TrainerId;
            classObj.MaxCapacity = classUpdateDto.MaxCapacity;
            classObj.Price = classUpdateDto.Price;

            _context.Classes.Update(classObj);
            await _context.SaveChangesAsync();

            return new ClassDto
            {
                Id = classObj.Id,
                Name = classObj.Name,
                Description = classObj.Description,
                Duration = classObj.Duration,
                TrainerId = classObj.TrainerId,
                TrainerName = trainer.Name,
                MaxCapacity = classObj.MaxCapacity,
                Price = classObj.Price
            };
        }

        public async Task<bool> DeleteClassAsync(int id)
        {
            var classObj = await _context.Classes.FindAsync(id);
            if (classObj == null) throw new ArgumentException("Class not found");

            // Check if class has any schedules
            var hasSchedules = await _context.ClassSchedules.AnyAsync(cs => cs.ClassId == id);
            if (hasSchedules) throw new InvalidOperationException("Cannot delete class with existing schedules");

            _context.Classes.Remove(classObj);
            return await _context.SaveChangesAsync() > 0;
        }

        public async Task<IEnumerable<ClassScheduleDto>> GetClassSchedulesAsync(int classId)
        {
            return await _context.ClassSchedules
                .Where(cs => cs.ClassId == classId)
                .Include(cs => cs.Class)
                .Select(cs => new ClassScheduleDto
                {
                    Id = cs.Id,
                    ClassId = cs.ClassId,
                    ClassName = cs.Class.Name,
                    StartTime = cs.StartTime,
                    EndTime = cs.EndTime,
                    Location = cs.Location,
                    AvailableSlots = cs.AvailableSlots,
                    MaxCapacity = cs.Class.MaxCapacity
                })
                .ToListAsync();
        }

        public async Task<ClassScheduleDto> CreateClassScheduleAsync(ClassScheduleCreateDto scheduleCreateDto)
        {
            var classObj = await _context.Classes.FindAsync(scheduleCreateDto.ClassId);
            if (classObj == null) throw new ArgumentException("Class not found");

            // Check if the schedule overlaps with existing schedules
            var overlappingSchedule = await _context.ClassSchedules
                .Where(cs => cs.ClassId == scheduleCreateDto.ClassId)
                .Where(cs => cs.StartTime < scheduleCreateDto.EndTime && cs.EndTime > scheduleCreateDto.StartTime)
                .FirstOrDefaultAsync();

            if (overlappingSchedule != null)
                throw new InvalidOperationException("Schedule overlaps with existing class schedule");

            var schedule = new ClassSchedule
            {
                ClassId = scheduleCreateDto.ClassId,
                StartTime = scheduleCreateDto.StartTime,
                EndTime = scheduleCreateDto.EndTime,
                Location = scheduleCreateDto.Location,
                AvailableSlots = classObj.MaxCapacity
            };

            _context.ClassSchedules.Add(schedule);
            await _context.SaveChangesAsync();

            return new ClassScheduleDto
            {
                Id = schedule.Id,
                ClassId = schedule.ClassId,
                ClassName = classObj.Name,
                StartTime = schedule.StartTime,
                EndTime = schedule.EndTime,
                Location = schedule.Location,
                AvailableSlots = schedule.AvailableSlots,
                MaxCapacity = classObj.MaxCapacity
            };
        }

        public async Task<bool> DeleteClassScheduleAsync(int scheduleId)
        {
            var schedule = await _context.ClassSchedules.FindAsync(scheduleId);
            if (schedule == null) throw new ArgumentException("Class schedule not found");

            // Check if schedule has any bookings
            var hasBookings = await _context.Bookings.AnyAsync(b => b.ScheduleId == scheduleId && b.Type == "Class");
            if (hasBookings) throw new InvalidOperationException("Cannot delete schedule with existing bookings");

            _context.ClassSchedules.Remove(schedule);
            return await _context.SaveChangesAsync() > 0;
        }
    }
}
using elite.Interfaces;

namespace elite.Services
{
    public class ImageService : IImageService
    {
        private readonly IWebHostEnvironment _environment;
        private readonly ILogger<ImageService> _logger;

        public ImageService(IWebHostEnvironment environment, ILogger<ImageService> logger)
        {
            _environment = environment;
            _logger = logger;
        }

        // Services/ImageService.cs
        public async Task<string> UploadImageAsync(IFormFile imageFile, string folderName)
        {
            if (imageFile == null || imageFile.Length == 0)
                throw new ArgumentException("No file uploaded.");

            // Validate file type
            var allowedExtensions = new[] { ".jpg", ".jpeg", ".png", ".gif" };
            var fileExtension = Path.GetExtension(imageFile.FileName).ToLowerInvariant();

            if (!allowedExtensions.Contains(fileExtension))
                throw new ArgumentException("Invalid file type. Only JPG, JPEG, PNG, and GIF are allowed.");

            // Check if WebRootPath is set
            if (string.IsNullOrEmpty(_environment.WebRootPath))
            {
                _logger.LogError("WebRootPath is not set");
                throw new InvalidOperationException("WebRootPath is not configured");
            }

            // Create directory if it doesn't exist
            string uploadsFolder = Path.Combine(_environment.WebRootPath, "images", folderName);
            if (!Directory.Exists(uploadsFolder))
                Directory.CreateDirectory(uploadsFolder);

            // Generate unique filename
            string uniqueFileName = Guid.NewGuid().ToString() + fileExtension;
            string filePath = Path.Combine(uploadsFolder, uniqueFileName);

            // Save file
            using (var fileStream = new FileStream(filePath, FileMode.Create))
            {
                await imageFile.CopyToAsync(fileStream);
            }

            // Return relative path
            return Path.Combine("images", folderName, uniqueFileName).Replace("\\", "/");
        }

        public void DeleteImage(string imagePath)
        {
            if (string.IsNullOrEmpty(imagePath))
                return;

            if (string.IsNullOrEmpty(_environment.WebRootPath))
            {
                _logger.LogError("WebRootPath is not set");
                return;
            }

            try
            {
                string fullPath = Path.Combine(_environment.WebRootPath, imagePath);
                if (File.Exists(fullPath))
                {
                    File.Delete(fullPath);
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error deleting image: {ImagePath}", imagePath);
            }
        }

        public bool ImageExists(string imagePath)
        {
            if (string.IsNullOrEmpty(imagePath))
                return false;

            string fullPath = Path.Combine(_environment.WebRootPath, imagePath);
            return File.Exists(fullPath);
        }
    }
}
using elite.Data;
using elite.DTOs;
using elite.Interfaces;
using elite.Models;
using Microsoft.EntityFrameworkCore;

namespace elite.Services
{
    public class MembershipService : IMembershipService
    {
        private readonly GymDbContext _context;
        private readonly ILogger<MembershipService> _logger;

        public MembershipService(GymDbContext context, ILogger<MembershipService> logger)
        {
            _context = context;
            _logger = logger;
        }

        public async Task<MembershipDto> PurchaseMembershipAsync(PurchaseMembershipDto purchaseDto)
        {
            var user = await _context.Users.FindAsync(purchaseDto.UserId);
            if (user == null) throw new ArgumentException("User not found");

            // Check if user already has active membership
            var existingMembership = await _context.Memberships
                .FirstOrDefaultAsync(m => m.UserId == purchaseDto.UserId && m.Status == "Active");

            if (existingMembership != null)
                throw new InvalidOperationException("User already has an active membership");

            // Get membership type details
            var membershipType = await _context.MembershipTypes
                .FirstOrDefaultAsync(mt => mt.Name == purchaseDto.Type && mt.IsActive);

            if (membershipType == null)
                throw new ArgumentException("Invalid membership type or type not available");

            var membership = new Membership
            {
                UserId = purchaseDto.UserId,
                Type = membershipType.Name,
                StartDate = DateTime.UtcNow,
                EndDate = DateTime.UtcNow.AddMonths(membershipType.DurationMonths),
                TotalHours = membershipType.TotalHours,
                RemainingHours = membershipType.TotalHours,
                Status = "Active",
                PricePaid = membershipType.Price
            };

            _context.Memberships.Add(membership);
            await _context.SaveChangesAsync();

            return new MembershipDto
            {
                Id = membership.Id,
                Type = membership.Type,
                StartDate = membership.StartDate,
                EndDate = membership.EndDate,
                TotalHours = membership.TotalHours,
                RemainingHours = membership.RemainingHours,
                Status = membership.Status,
                PricePaid = membership.PricePaid // Add this line
            };
        }

        public async Task<MembershipDto> GetUserMembershipAsync(int userId)
        {
            var membership = await _context.Memberships
                .FirstOrDefaultAsync(m => m.UserId == userId);

            if (membership == null) throw new ArgumentException("Membership not found");

            return new MembershipDto
            {
                Id = membership.Id,
                Type = membership.Type,
                StartDate = membership.StartDate,
                EndDate = membership.EndDate,
                TotalHours = membership.TotalHours,
                RemainingHours = membership.RemainingHours,
                Status = membership.Status
            };
        }

        public async Task<bool> CheckMembershipValidityAsync(int userId)
        {
            var membership = await _context.Memberships
                .FirstOrDefaultAsync(m => m.UserId == userId);

            if (membership == null) return false;
            if (membership.Status != "Active") return false;
            if (membership.EndDate < DateTime.UtcNow.Date)
            {
                membership.Status = "Expired";
                await _context.SaveChangesAsync();
                return false;
            }

            return true;
        }

        public async Task<bool> ExtendMembershipAsync(int membershipId, int additionalMonths)
        {
            var membership = await _context.Memberships.FindAsync(membershipId);
            if (membership == null) throw new ArgumentException("Membership not found");

            membership.EndDate = membership.EndDate.AddMonths(additionalMonths);
            _context.Memberships.Update(membership);

            return await _context.SaveChangesAsync() > 0;
        }

        public async Task<bool> UpgradeMembershipAsync(int membershipId, string newType)
        {
            var membership = await _context.Memberships.FindAsync(membershipId);
            if (membership == null) throw new ArgumentException("Membership not found");

            // FIX THIS PART - use decimal for hours
            decimal totalHours = newType switch
            {
                "Basic" => 10.0m,
                "Medium" => 25.0m,
                "VIP" => 50.0m,
                _ => throw new ArgumentException("Invalid membership type")
            };

            // Calculate prorated hours - use decimal for all calculations
            decimal daysUsed = (decimal)(DateTime.UtcNow - membership.StartDate).TotalDays;
            decimal totalDays = (decimal)(membership.EndDate - membership.StartDate).TotalDays;
            decimal hoursUsed = membership.TotalHours - membership.RemainingHours;
            decimal hoursPerDay = membership.TotalHours / totalDays;
            decimal hoursToDeduct = hoursPerDay * daysUsed;

            decimal newRemainingHours = totalHours - hoursToDeduct;
            if (newRemainingHours < 0) newRemainingHours = 0;

            membership.Type = newType;
            membership.TotalHours = totalHours;
            membership.RemainingHours = newRemainingHours;

            _context.Memberships.Update(membership);
            return await _context.SaveChangesAsync() > 0;
        }
    }
}
// Services/MembershipTypeService.cs
using elite.Data;
using elite.DTOs;
using elite.Interfaces;
using elite.Models;
using Microsoft.EntityFrameworkCore;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace elite.Services
{
    public class MembershipTypeService : IMembershipTypeService
    {
        private readonly GymDbContext _context;
        private readonly ILogger<MembershipTypeService> _logger;

        public MembershipTypeService(GymDbContext context, ILogger<MembershipTypeService> logger)
        {
            _context = context;
            _logger = logger;
        }

        public async Task<IEnumerable<MembershipTypeDto>> GetAllMembershipTypesAsync()
        {
            return await _context.MembershipTypes
                .Where(mt => mt.IsActive)
                .Select(mt => new MembershipTypeDto
                {
                    Id = mt.Id,
                    Name = mt.Name,
                    Description = mt.Description,
                    DurationMonths = mt.DurationMonths,
                    TotalHours = mt.TotalHours,
                    Price = mt.Price,
                    IsActive = mt.IsActive
                })
                .ToListAsync();
        }

        public async Task<MembershipTypeDto> GetMembershipTypeByIdAsync(int id)
        {
            var membershipType = await _context.MembershipTypes.FindAsync(id);
            if (membershipType == null) throw new ArgumentException("Membership type not found");

            return new MembershipTypeDto
            {
                Id = membershipType.Id,
                Name = membershipType.Name,
                Description = membershipType.Description,
                DurationMonths = membershipType.DurationMonths,
                TotalHours = membershipType.TotalHours,
                Price = membershipType.Price,
                IsActive = membershipType.IsActive
            };
        }

        public async Task<MembershipTypeDto> CreateMembershipTypeAsync(MembershipTypeCreateDto createDto)
        {
            if (await _context.MembershipTypes.AnyAsync(mt => mt.Name == createDto.Name))
                throw new ArgumentException("Membership type with this name already exists");

            var membershipType = new MembershipType
            {
                Name = createDto.Name,
                Description = createDto.Description,
                DurationMonths = createDto.DurationMonths,
                TotalHours = createDto.TotalHours,
                Price = createDto.Price,
                IsActive = true
            };

            _context.MembershipTypes.Add(membershipType);
            await _context.SaveChangesAsync();

            return new MembershipTypeDto
            {
                Id = membershipType.Id,
                Name = membershipType.Name,
                Description = membershipType.Description,
                DurationMonths = membershipType.DurationMonths,
                TotalHours = membershipType.TotalHours,
                Price = membershipType.Price,
                IsActive = membershipType.IsActive
            };
        }

        public async Task<MembershipTypeDto> UpdateMembershipTypeAsync(int id, MembershipTypeCreateDto updateDto)
        {
            var membershipType = await _context.MembershipTypes.FindAsync(id);
            if (membershipType == null) throw new ArgumentException("Membership type not found");

            // Check if name is being changed and if it conflicts with another type
            if (membershipType.Name != updateDto.Name &&
                await _context.MembershipTypes.AnyAsync(mt => mt.Name == updateDto.Name))
                throw new ArgumentException("Membership type with this name already exists");

            membershipType.Name = updateDto.Name;
            membershipType.Description = updateDto.Description;
            membershipType.DurationMonths = updateDto.DurationMonths;
            membershipType.TotalHours = updateDto.TotalHours;
            membershipType.Price = updateDto.Price;

            _context.MembershipTypes.Update(membershipType);
            await _context.SaveChangesAsync();

            return new MembershipTypeDto
            {
                Id = membershipType.Id,
                Name = membershipType.Name,
                Description = membershipType.Description,
                DurationMonths = membershipType.DurationMonths,
                TotalHours = membershipType.TotalHours,
                Price = membershipType.Price,
                IsActive = membershipType.IsActive
            };
        }

        public async Task<bool> DeleteMembershipTypeAsync(int id)
        {
            var membershipType = await _context.MembershipTypes.FindAsync(id);
            if (membershipType == null) throw new ArgumentException("Membership type not found");

            // Check if this membership type is being used by any active memberships
            var hasActiveMemberships = await _context.Memberships
                .AnyAsync(m => m.Type == membershipType.Name && m.Status == "Active");

            if (hasActiveMemberships)
                throw new InvalidOperationException("Cannot delete membership type with active memberships");

            _context.MembershipTypes.Remove(membershipType);
            return await _context.SaveChangesAsync() > 0;
        }

        public async Task<bool> ToggleMembershipTypeStatusAsync(int id, bool isActive)
        {
            var membershipType = await _context.MembershipTypes.FindAsync(id);
            if (membershipType == null) throw new ArgumentException("Membership type not found");

            membershipType.IsActive = isActive;
            _context.MembershipTypes.Update(membershipType);
            return await _context.SaveChangesAsync() > 0;
        }
    }
}
using elite.Data;
using elite.DTOs;
using elite.Interfaces;
using elite.Models;
using Microsoft.EntityFrameworkCore;

namespace elite.Services
{
    // Services/OnlineSessionService.cs
    public class OnlineSessionService : IOnlineSessionService
    {
        private readonly GymDbContext _context;
        private readonly ILogger<OnlineSessionService> _logger;

        public OnlineSessionService(GymDbContext context, ILogger<OnlineSessionService> logger)
        {
            _context = context;
            _logger = logger;
        }

        public async Task<IEnumerable<OnlineSessionDto>> GetAllSessionsAsync()
        {
            return await _context.OnlineSessions
                .Include(os => os.Trainer)
                .Select(os => new OnlineSessionDto
                {
                    Id = os.Id,
                    Name = os.Name,
                    Description = os.Description,
                    Duration = os.Duration,
                    TrainerId = os.TrainerId,
                    TrainerName = os.Trainer.Name,
                    Price = os.Price
                })
                .ToListAsync();
        }

        public async Task<OnlineSessionDto> GetSessionByIdAsync(int id)
        {
            var session = await _context.OnlineSessions
                .Include(os => os.Trainer)
                .FirstOrDefaultAsync(os => os.Id == id);

            if (session == null) throw new ArgumentException("Online session not found");

            return new OnlineSessionDto
            {
                Id = session.Id,
                Name = session.Name,
                Description = session.Description,
                Duration = session.Duration,
                TrainerId = session.TrainerId,
                TrainerName = session.Trainer.Name,
                Price = session.Price
            };
        }

        public async Task<OnlineSessionDto> CreateSessionAsync(OnlineSessionCreateDto sessionCreateDto)
        {
            // Check if trainer exists
            var trainer = await _context.Trainers.FindAsync(sessionCreateDto.TrainerId);
            if (trainer == null) throw new ArgumentException("Trainer not found");

            var session = new OnlineSession
            {
                Name = sessionCreateDto.Name,
                Description = sessionCreateDto.Description,
                Duration = sessionCreateDto.Duration,
                TrainerId = sessionCreateDto.TrainerId,
                Price = sessionCreateDto.Price
            };

            _context.OnlineSessions.Add(session);
            await _context.SaveChangesAsync();

            return new OnlineSessionDto
            {
                Id = session.Id,
                Name = session.Name,
                Description = session.Description,
                Duration = session.Duration,
                TrainerId = session.TrainerId,
                TrainerName = trainer.Name,
                Price = session.Price
            };
        }

        public async Task<OnlineSessionDto> UpdateSessionAsync(int id, OnlineSessionCreateDto sessionUpdateDto)
        {
            var session = await _context.OnlineSessions.FindAsync(id);
            if (session == null) throw new ArgumentException("Online session not found");

            // Check if trainer exists
            var trainer = await _context.Trainers.FindAsync(sessionUpdateDto.TrainerId);
            if (trainer == null) throw new ArgumentException("Trainer not found");

            session.Name = sessionUpdateDto.Name;
            session.Description = sessionUpdateDto.Description;
            session.Duration = sessionUpdateDto.Duration;
            session.TrainerId = sessionUpdateDto.TrainerId;
            session.Price = sessionUpdateDto.Price;

            _context.OnlineSessions.Update(session);
            await _context.SaveChangesAsync();

            return new OnlineSessionDto
            {
                Id = session.Id,
                Name = session.Name,
                Description = session.Description,
                Duration = session.Duration,
                TrainerId = session.TrainerId,
                TrainerName = trainer.Name,
                Price = session.Price
            };
        }

        public async Task<bool> DeleteSessionAsync(int id)
        {
            var session = await _context.OnlineSessions.FindAsync(id);
            if (session == null) throw new ArgumentException("Online session not found");

            // Check if session has any schedules
            var hasSchedules = await _context.OnlineSessionSchedules.AnyAsync(oss => oss.OnlineSessionId == id);
            if (hasSchedules) throw new InvalidOperationException("Cannot delete session with existing schedules");

            _context.OnlineSessions.Remove(session);
            return await _context.SaveChangesAsync() > 0;
        }

        public async Task<IEnumerable<OnlineSessionScheduleDto>> GetSessionSchedulesAsync(int sessionId)
        {
            return await _context.OnlineSessionSchedules
                .Where(oss => oss.OnlineSessionId == sessionId)
                .Include(oss => oss.OnlineSession)
                .Select(oss => new OnlineSessionScheduleDto
                {
                    Id = oss.Id,
                    OnlineSessionId = oss.OnlineSessionId,
                    SessionName = oss.OnlineSession.Name,
                    StartTime = oss.StartTime,
                    EndTime = oss.EndTime,
                    AvailableSlots = oss.AvailableSlots,
                    MaxSlots = 20 // Fixed maximum for online sessions
                })
                .ToListAsync();
        }

        public async Task<OnlineSessionScheduleDto> CreateSessionScheduleAsync(OnlineSessionScheduleCreateDto scheduleCreateDto)
        {
            var session = await _context.OnlineSessions.FindAsync(scheduleCreateDto.OnlineSessionId);
            if (session == null) throw new ArgumentException("Online session not found");

            // Check if the schedule overlaps with existing schedules for the same trainer
            var overlappingSchedule = await _context.OnlineSessionSchedules
                .Where(oss => oss.OnlineSession.TrainerId == session.TrainerId)
                .Where(oss => oss.StartTime < scheduleCreateDto.EndTime && oss.EndTime > scheduleCreateDto.StartTime)
                .FirstOrDefaultAsync();

            if (overlappingSchedule != null)
                throw new InvalidOperationException("Schedule overlaps with existing session for this trainer");

            var schedule = new OnlineSessionSchedule
            {
                OnlineSessionId = scheduleCreateDto.OnlineSessionId,
                StartTime = scheduleCreateDto.StartTime,
                EndTime = scheduleCreateDto.EndTime,
                AvailableSlots = scheduleCreateDto.AvailableSlots
            };

            _context.OnlineSessionSchedules.Add(schedule);
            await _context.SaveChangesAsync();

            return new OnlineSessionScheduleDto
            {
                Id = schedule.Id,
                OnlineSessionId = schedule.OnlineSessionId,
                SessionName = session.Name,
                StartTime = schedule.StartTime,
                EndTime = schedule.EndTime,
                AvailableSlots = schedule.AvailableSlots,
                MaxSlots = 20
            };
        }

        public async Task<bool> DeleteSessionScheduleAsync(int scheduleId)
        {
            var schedule = await _context.OnlineSessionSchedules.FindAsync(scheduleId);
            if (schedule == null) throw new ArgumentException("Online session schedule not found");

            // Check if schedule has any bookings
            var hasBookings = await _context.Bookings.AnyAsync(b => b.ScheduleId == scheduleId && b.Type == "OnlineSession");
            if (hasBookings) throw new InvalidOperationException("Cannot delete schedule with existing bookings");

            _context.OnlineSessionSchedules.Remove(schedule);
            return await _context.SaveChangesAsync() > 0;
        }
    }
}
using elite.Data;
using elite.DTOs;
using elite.Interfaces;
using elite.Models;
using Microsoft.EntityFrameworkCore;

namespace elite.Services
{
    // Services/OrderService.cs
    public class OrderService : IOrderService
    {
        private readonly GymDbContext _context;
        private readonly IPromotionService _promotionService;
        private readonly ILogger<OrderService> _logger;

        public OrderService(GymDbContext context, IPromotionService promotionService, ILogger<OrderService> logger)
        {
            _context = context;
            _promotionService = promotionService;
            _logger = logger;
        }

        public async Task<OrderDto> CreateOrderAsync(OrderCreateDto orderCreateDto)
        {
            using var transaction = await _context.Database.BeginTransactionAsync();

            try
            {
                var user = await _context.Users.FindAsync(orderCreateDto.UserId);
                if (user == null) throw new ArgumentException("User not found");

                decimal totalAmount = 0;
                var orderItems = new List<OrderItem>();

                foreach (var item in orderCreateDto.Items)
                {
                    var product = await _context.Products.FindAsync(item.ProductId);
                    if (product == null) throw new ArgumentException($"Product with ID {item.ProductId} not found");

                    if (product.StockQuantity < item.Quantity)
                        throw new InvalidOperationException($"Insufficient stock for product: {product.Name}");

                    var orderItem = new OrderItem
                    {
                        ProductId = item.ProductId,
                        Quantity = item.Quantity,
                        Price = product.Price
                    };

                    totalAmount += product.Price * item.Quantity;
                    orderItems.Add(orderItem);

                    // Update product stock
                    product.StockQuantity -= item.Quantity;
                    _context.Products.Update(product);
                }

                // Apply promotion if provided
                decimal discount = 0;
                if (!string.IsNullOrEmpty(orderCreateDto.PromotionCode))
                {
                    try
                    {
                        discount = await _promotionService.CalculateDiscountAsync(orderCreateDto.PromotionCode, totalAmount);
                        totalAmount -= discount;
                    }
                    catch (Exception ex)
                    {
                        _logger.LogWarning(ex, "Failed to apply promotion code: {Code}", orderCreateDto.PromotionCode);
                    }
                }

                var order = new Order
                {
                    UserId = orderCreateDto.UserId,
                    OrderDate = DateTime.UtcNow,
                    TotalAmount = totalAmount,
                    Status = "Completed"
                };

                _context.Orders.Add(order);
                await _context.SaveChangesAsync();

                // Add order items with order ID
                foreach (var item in orderItems)
                {
                    item.OrderId = order.Id;
                    _context.OrderItems.Add(item);
                }

                await _context.SaveChangesAsync();
                await transaction.CommitAsync();

                return await GetOrderByIdAsync(order.Id);
            }
            catch (Exception ex)
            {
                await transaction.RollbackAsync();
                _logger.LogError(ex, "Error creating order");
                throw;
            }
        }

        public async Task<OrderDto> GetOrderByIdAsync(int id)
        {
            var order = await _context.Orders
                .Include(o => o.User)
                .Include(o => o.OrderItems)
                .ThenInclude(oi => oi.Product)
                .FirstOrDefaultAsync(o => o.Id == id);

            if (order == null) throw new ArgumentException("Order not found");

            return new OrderDto
            {
                Id = order.Id,
                UserId = order.UserId,
                UserName = order.User.Name,
                OrderDate = order.OrderDate,
                TotalAmount = order.TotalAmount,
                Status = order.Status,
                OrderItems = order.OrderItems.Select(oi => new OrderItemDto
                {
                    Id = oi.Id,
                    ProductId = oi.ProductId,
                    ProductName = oi.Product.Name,
                    Quantity = oi.Quantity,
                    Price = oi.Price
                }).ToList()
            };
        }

        public async Task<IEnumerable<OrderDto>> GetUserOrdersAsync(int userId)
        {
            return await _context.Orders
                .Where(o => o.UserId == userId)
                .Include(o => o.User)
                .Include(o => o.OrderItems)
                .ThenInclude(oi => oi.Product)
                .OrderByDescending(o => o.OrderDate)
                .Select(o => new OrderDto
                {
                    Id = o.Id,
                    UserId = o.UserId,
                    UserName = o.User.Name,
                    OrderDate = o.OrderDate,
                    TotalAmount = o.TotalAmount,
                    Status = o.Status,
                    OrderItems = o.OrderItems.Select(oi => new OrderItemDto
                    {
                        Id = oi.Id,
                        ProductId = oi.ProductId,
                        ProductName = oi.Product.Name,
                        Quantity = oi.Quantity,
                        Price = oi.Price
                    }).ToList()
                })
                .ToListAsync();
        }

        public async Task<IEnumerable<OrderDto>> GetAllOrdersAsync()
        {
            return await _context.Orders
                .Include(o => o.User)
                .Include(o => o.OrderItems)
                .ThenInclude(oi => oi.Product)
                .OrderByDescending(o => o.OrderDate)
                .Select(o => new OrderDto
                {
                    Id = o.Id,
                    UserId = o.UserId,
                    UserName = o.User.Name,
                    OrderDate = o.OrderDate,
                    TotalAmount = o.TotalAmount,
                    Status = o.Status,
                    OrderItems = o.OrderItems.Select(oi => new OrderItemDto
                    {
                        Id = oi.Id,
                        ProductId = oi.ProductId,
                        ProductName = oi.Product.Name,
                        Quantity = oi.Quantity,
                        Price = oi.Price
                    }).ToList()
                })
                .ToListAsync();
        }

        public async Task<bool> UpdateOrderStatusAsync(int id, string status)
        {
            var order = await _context.Orders.FindAsync(id);
            if (order == null) throw new ArgumentException("Order not found");

            order.Status = status;
            _context.Orders.Update(order);
            return await _context.SaveChangesAsync() > 0;
        }

        public async Task<bool> CancelOrderAsync(int id)
        {
            using var transaction = await _context.Database.BeginTransactionAsync();

            try
            {
                var order = await _context.Orders
                    .Include(o => o.OrderItems)
                    .FirstOrDefaultAsync(o => o.Id == id);

                if (order == null) throw new ArgumentException("Order not found");

                // Restore product stock
                foreach (var item in order.OrderItems)
                {
                    var product = await _context.Products.FindAsync(item.ProductId);
                    if (product != null)
                    {
                        product.StockQuantity += item.Quantity;
                        _context.Products.Update(product);
                    }
                }

                order.Status = "Cancelled";
                _context.Orders.Update(order);
                await _context.SaveChangesAsync();
                await transaction.CommitAsync();

                return true;
            }
            catch (Exception ex)
            {
                await transaction.RollbackAsync();
                _logger.LogError(ex, "Error cancelling order");
                throw;
            }
        }

        public async Task<decimal> ApplyPromotionAsync(string code, decimal orderAmount)
        {
            return await _promotionService.CalculateDiscountAsync(code, orderAmount);
        }
    }
}
using elite.Data;
using elite.DTOs;
using elite.Interfaces;
using elite.Models;
using Microsoft.EntityFrameworkCore;

namespace elite.Services
{
    // Services/ProductService.cs
    public class ProductService : IProductService
    {
        private readonly GymDbContext _context;
        private readonly ILogger<ProductService> _logger;
        private readonly IImageService _imageService;

        public ProductService(GymDbContext context, ILogger<ProductService> logger, IImageService imageService)
        {
            _context = context;
            _logger = logger;
            _imageService = imageService;
        }

        public async Task<IEnumerable<ProductDto>> GetAllProductsAsync()
        {
            return await _context.Products
                .Select(p => new ProductDto
                {
                    Id = p.Id,
                    Name = p.Name,
                    Description = p.Description,
                    Price = p.Price,
                    ImageUrl = p.ImageUrl,
                    Category = p.Category,
                    StockQuantity = p.StockQuantity
                })
                .ToListAsync();
        }

        public async Task<IEnumerable<ProductDto>> GetProductsByCategoryAsync(string category)
        {
            return await _context.Products
                .Where(p => p.Category == category)
                .Select(p => new ProductDto
                {
                    Id = p.Id,
                    Name = p.Name,
                    Description = p.Description,
                    Price = p.Price,
                    ImageUrl = p.ImageUrl,
                    Category = p.Category,
                    StockQuantity = p.StockQuantity
                })
                .ToListAsync();
        }

        public async Task<ProductDto> GetProductByIdAsync(int id)
        {
            var product = await _context.Products.FindAsync(id);
            if (product == null) throw new ArgumentException("Product not found");

            return new ProductDto
            {
                Id = product.Id,
                Name = product.Name,
                Description = product.Description,
                Price = product.Price,
                ImageUrl = product.ImageUrl,
                Category = product.Category,
                StockQuantity = product.StockQuantity
            };
        }

        public async Task<ProductDto> CreateProductAsync(ProductCreateDto productCreateDto)
        {
            string imageUrl = null;

            // Handle image upload if provided
            if (productCreateDto.ImageFile != null)
            {
                imageUrl = await _imageService.UploadImageAsync(productCreateDto.ImageFile, "products");
            }

            var product = new Product
            {
                Name = productCreateDto.Name,
                Description = productCreateDto.Description,
                Price = productCreateDto.Price,
                ImageUrl = imageUrl, // Use the uploaded image URL
                Category = productCreateDto.Category,
                StockQuantity = productCreateDto.StockQuantity
            };

            _context.Products.Add(product);
            await _context.SaveChangesAsync();

            return new ProductDto
            {
                Id = product.Id,
                Name = product.Name,
                Description = product.Description,
                Price = product.Price,
                ImageUrl = product.ImageUrl,
                Category = product.Category,
                StockQuantity = product.StockQuantity
            };
        }

        public async Task<ProductDto> UpdateProductAsync(int id, ProductCreateDto productUpdateDto)
        {
            var product = await _context.Products.FindAsync(id);
            if (product == null) throw new ArgumentException("Product not found");

            // Handle image update if provided
            if (productUpdateDto.ImageFile != null)
            {
                // Delete old image if exists
                if (!string.IsNullOrEmpty(product.ImageUrl))
                {
                    _imageService.DeleteImage(product.ImageUrl);
                }

                // Upload new image
                product.ImageUrl = await _imageService.UploadImageAsync(productUpdateDto.ImageFile, "products");
            }

            product.Name = productUpdateDto.Name;
            product.Description = productUpdateDto.Description;
            product.Price = productUpdateDto.Price;
            product.Category = productUpdateDto.Category;
            product.StockQuantity = productUpdateDto.StockQuantity;

            _context.Products.Update(product);
            await _context.SaveChangesAsync();

            return new ProductDto
            {
                Id = product.Id,
                Name = product.Name,
                Description = product.Description,
                Price = product.Price,
                ImageUrl = product.ImageUrl,
                Category = product.Category,
                StockQuantity = product.StockQuantity
            };
        }

        public async Task<bool> DeleteProductAsync(int id)
        {
            var product = await _context.Products.FindAsync(id);
            if (product == null) throw new ArgumentException("Product not found");

            _context.Products.Remove(product);
            return await _context.SaveChangesAsync() > 0;
        }

        // Services/ProductService.cs
        public async Task<bool> UpdateProductStockAsync(int id, int quantity)
        {
            var product = await _context.Products.FindAsync(id);
            if (product == null) throw new ArgumentException("Product not found");

            product.StockQuantity = quantity;
            _context.Products.Update(product);
            return await _context.SaveChangesAsync() > 0;
        }
    }
}
using elite.Data;
using elite.DTOs;
using elite.Interfaces;
using elite.Models;
using Microsoft.EntityFrameworkCore;

namespace elite.Services
{
    // Services/PromotionService.cs
    public class PromotionService : IPromotionService
    {
        private readonly GymDbContext _context;
        private readonly ILogger<PromotionService> _logger;

        public PromotionService(GymDbContext context, ILogger<PromotionService> logger)
        {
            _context = context;
            _logger = logger;
        }

        public async Task<IEnumerable<PromotionDto>> GetAllPromotionsAsync()
        {
            return await _context.Promotions
                .Select(p => new PromotionDto
                {
                    Id = p.Id,
                    Code = p.Code,
                    Description = p.Description,
                    DiscountType = p.DiscountType,
                    DiscountValue = p.DiscountValue,
                    StartDate = p.StartDate,
                    EndDate = p.EndDate,
                    UsageLimit = p.UsageLimit,
                    TimesUsed = p.TimesUsed
                })
                .ToListAsync();
        }

        public async Task<PromotionDto> GetPromotionByIdAsync(int id)
        {
            var promotion = await _context.Promotions.FindAsync(id);
            if (promotion == null) throw new ArgumentException("Promotion not found");

            return new PromotionDto
            {
                Id = promotion.Id,
                Code = promotion.Code,
                Description = promotion.Description,
                DiscountType = promotion.DiscountType,
                DiscountValue = promotion.DiscountValue,
                StartDate = promotion.StartDate,
                EndDate = promotion.EndDate,
                UsageLimit = promotion.UsageLimit,
                TimesUsed = promotion.TimesUsed
            };
        }

        public async Task<PromotionDto> GetPromotionByCodeAsync(string code)
        {
            var promotion = await _context.Promotions
                .FirstOrDefaultAsync(p => p.Code == code);

            if (promotion == null) throw new ArgumentException("Promotion not found");

            return new PromotionDto
            {
                Id = promotion.Id,
                Code = promotion.Code,
                Description = promotion.Description,
                DiscountType = promotion.DiscountType,
                DiscountValue = promotion.DiscountValue,
                StartDate = promotion.StartDate,
                EndDate = promotion.EndDate,
                UsageLimit = promotion.UsageLimit,
                TimesUsed = promotion.TimesUsed
            };
        }

        public async Task<PromotionDto> CreatePromotionAsync(PromotionCreateDto promotionCreateDto)
        {
            if (await _context.Promotions.AnyAsync(p => p.Code == promotionCreateDto.Code))
                throw new ArgumentException("Promotion code already exists");

            var promotion = new Promotion
            {
                Code = promotionCreateDto.Code,
                Description = promotionCreateDto.Description,
                DiscountType = promotionCreateDto.DiscountType,
                DiscountValue = promotionCreateDto.DiscountValue,
                StartDate = promotionCreateDto.StartDate,
                EndDate = promotionCreateDto.EndDate,
                UsageLimit = promotionCreateDto.UsageLimit,
                TimesUsed = 0
            };

            _context.Promotions.Add(promotion);
            await _context.SaveChangesAsync();

            return new PromotionDto
            {
                Id = promotion.Id,
                Code = promotion.Code,
                Description = promotion.Description,
                DiscountType = promotion.DiscountType,
                DiscountValue = promotion.DiscountValue,
                StartDate = promotion.StartDate,
                EndDate = promotion.EndDate,
                UsageLimit = promotion.UsageLimit,
                TimesUsed = promotion.TimesUsed
            };
        }

        public async Task<PromotionDto> UpdatePromotionAsync(int id, PromotionCreateDto promotionUpdateDto)
        {
            var promotion = await _context.Promotions.FindAsync(id);
            if (promotion == null) throw new ArgumentException("Promotion not found");

            // Check if code is being changed and if it already exists
            if (promotion.Code != promotionUpdateDto.Code &&
                await _context.Promotions.AnyAsync(p => p.Code == promotionUpdateDto.Code && p.Id != id))
                throw new ArgumentException("Promotion code already exists");

            promotion.Code = promotionUpdateDto.Code;
            promotion.Description = promotionUpdateDto.Description;
            promotion.DiscountType = promotionUpdateDto.DiscountType;
            promotion.DiscountValue = promotionUpdateDto.DiscountValue;
            promotion.StartDate = promotionUpdateDto.StartDate;
            promotion.EndDate = promotionUpdateDto.EndDate;
            promotion.UsageLimit = promotionUpdateDto.UsageLimit;

            _context.Promotions.Update(promotion);
            await _context.SaveChangesAsync();

            return new PromotionDto
            {
                Id = promotion.Id,
                Code = promotion.Code,
                Description = promotion.Description,
                DiscountType = promotion.DiscountType,
                DiscountValue = promotion.DiscountValue,
                StartDate = promotion.StartDate,
                EndDate = promotion.EndDate,
                UsageLimit = promotion.UsageLimit,
                TimesUsed = promotion.TimesUsed
            };
        }

        public async Task<bool> DeletePromotionAsync(int id)
        {
            var promotion = await _context.Promotions.FindAsync(id);
            if (promotion == null) throw new ArgumentException("Promotion not found");

            _context.Promotions.Remove(promotion);
            return await _context.SaveChangesAsync() > 0;
        }

        public async Task<bool> ValidatePromotionAsync(string code, decimal orderAmount)
        {
            var promotion = await _context.Promotions
                .FirstOrDefaultAsync(p => p.Code == code);

            if (promotion == null) return false;
            if (DateTime.UtcNow < promotion.StartDate || DateTime.UtcNow > promotion.EndDate) return false;
            if (promotion.UsageLimit > 0 && promotion.TimesUsed >= promotion.UsageLimit) return false;

            return true;
        }

        public async Task<decimal> CalculateDiscountAsync(string code, decimal orderAmount)
        {
            var promotion = await _context.Promotions
                .FirstOrDefaultAsync(p => p.Code == code);

            if (promotion == null) throw new ArgumentException("Promotion not found");
            if (!await ValidatePromotionAsync(code, orderAmount))
                throw new InvalidOperationException("Promotion is not valid");

            decimal discount = 0;
            if (promotion.DiscountType == "Percentage")
            {
                discount = orderAmount * (promotion.DiscountValue / 100);
            }
            else if (promotion.DiscountType == "Fixed")
            {
                discount = promotion.DiscountValue;
            }

            // Update usage count
            promotion.TimesUsed++;
            _context.Promotions.Update(promotion);
            await _context.SaveChangesAsync();

            return discount;
        }
    }
}
using elite.Data;
using elite.DTOs;
using elite.Interfaces;
using elite.Models;
using Microsoft.EntityFrameworkCore;

namespace elite.Services
{
    // Services/TrainerService.cs
    public class TrainerService : ITrainerService
    {
        private readonly GymDbContext _context;
        private readonly ILogger<TrainerService> _logger;
        private readonly IImageService _imageService;

        public TrainerService(GymDbContext context, ILogger<TrainerService> logger, IImageService imageService)
        {
            _context = context;
            _logger = logger;
            _imageService = imageService;
        }

        public async Task<IEnumerable<TrainerDto>> GetAllTrainersAsync()
        {
            return await _context.Trainers
                .Select(t => new TrainerDto
                {
                    Id = t.Id,
                    Name = t.Name,
                    Specialization = t.Specialization,
                    ExperienceYears = t.ExperienceYears,
                    Certifications = t.Certifications,
                    Bio = t.Bio,
                    ImageUrl = t.ImageUrl
                })
                .ToListAsync();
        }

        public async Task<TrainerDto> GetTrainerByIdAsync(int id)
        {
            var trainer = await _context.Trainers.FindAsync(id);
            if (trainer == null) throw new ArgumentException("Trainer not found");

            return new TrainerDto
            {
                Id = trainer.Id,
                Name = trainer.Name,
                Specialization = trainer.Specialization,
                ExperienceYears = trainer.ExperienceYears,
                Certifications = trainer.Certifications,
                Bio = trainer.Bio,
                ImageUrl = trainer.ImageUrl
            };
        }

        // Services/TrainerService.cs
        public async Task<TrainerDto> CreateTrainerAsync(TrainerCreateDto trainerCreateDto)
        {
            try
            {
                string imageUrl = null;

                if (trainerCreateDto.ImageFile != null)
                {
                    try
                    {
                        imageUrl = await _imageService.UploadImageAsync(trainerCreateDto.ImageFile, "trainers");
                    }
                    catch (Exception ex)
                    {
                        _logger.LogError(ex, "Error uploading image for trainer");
                        // Continue without image if upload fails
                    }
                }

                var trainer = new Trainer
                {
                    Name = trainerCreateDto.Name,
                    Specialization = trainerCreateDto.Specialization,
                    ExperienceYears = trainerCreateDto.ExperienceYears,
                    Certifications = trainerCreateDto.Certifications,
                    Bio = trainerCreateDto.Bio,
                    ImageUrl = imageUrl
                };

                _context.Trainers.Add(trainer);
                await _context.SaveChangesAsync();

                return new TrainerDto
                {
                    Id = trainer.Id,
                    Name = trainer.Name,
                    Specialization = trainer.Specialization,
                    ExperienceYears = trainer.ExperienceYears,
                    Certifications = trainer.Certifications,
                    Bio = trainer.Bio,
                    ImageUrl = trainer.ImageUrl
                };
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error creating trainer");
                throw;
            }
        }

        public async Task<TrainerDto> UpdateTrainerAsync(int id, TrainerCreateDto trainerUpdateDto)
        {
            try
            {
                var trainer = await _context.Trainers.FindAsync(id);
                if (trainer == null) throw new ArgumentException("Trainer not found");

                // Handle image update if provided
                if (trainerUpdateDto.ImageFile != null)
                {
                    try
                    {
                        // Delete old image if exists
                        if (!string.IsNullOrEmpty(trainer.ImageUrl))
                        {
                            _imageService.DeleteImage(trainer.ImageUrl);
                        }

                        // Upload new image
                        trainer.ImageUrl = await _imageService.UploadImageAsync(trainerUpdateDto.ImageFile, "trainers");
                    }
                    catch (Exception ex)
                    {
                        _logger.LogError(ex, "Error updating image for trainer");
                        // Keep existing image if upload fails
                    }
                }

                trainer.Name = trainerUpdateDto.Name;
                trainer.Specialization = trainerUpdateDto.Specialization;
                trainer.ExperienceYears = trainerUpdateDto.ExperienceYears;
                trainer.Certifications = trainerUpdateDto.Certifications;
                trainer.Bio = trainerUpdateDto.Bio;

                _context.Trainers.Update(trainer);
                await _context.SaveChangesAsync();

                return new TrainerDto
                {
                    Id = trainer.Id,
                    Name = trainer.Name,
                    Specialization = trainer.Specialization,
                    ExperienceYears = trainer.ExperienceYears,
                    Certifications = trainer.Certifications,
                    Bio = trainer.Bio,
                    ImageUrl = trainer.ImageUrl
                };
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error updating trainer");
                throw;
            }
        }

        public async Task<bool> DeleteTrainerAsync(int id)
        {
            var trainer = await _context.Trainers.FindAsync(id);
            if (trainer == null) throw new ArgumentException("Trainer not found");

            // Delete associated image
            if (!string.IsNullOrEmpty(trainer.ImageUrl))
            {
                _imageService.DeleteImage(trainer.ImageUrl);
            }

            _context.Trainers.Remove(trainer);
            return await _context.SaveChangesAsync() > 0;
        }

        public async Task<IEnumerable<ClassDto>> GetTrainerClassesAsync(int trainerId)
        {
            return await _context.Classes
                .Where(c => c.TrainerId == trainerId)
                .Select(c => new ClassDto
                {
                    Id = c.Id,
                    Name = c.Name,
                    Description = c.Description,
                    Duration = c.Duration,
                    TrainerId = c.TrainerId,
                    TrainerName = c.Trainer.Name,
                    MaxCapacity = c.MaxCapacity,
                    Price = c.Price
                })
                .ToListAsync();
        }

        public async Task<IEnumerable<OnlineSessionDto>> GetTrainerSessionsAsync(int trainerId)
        {
            return await _context.OnlineSessions
                .Where(os => os.TrainerId == trainerId)
                .Select(os => new OnlineSessionDto
                {
                    Id = os.Id,
                    Name = os.Name,
                    Description = os.Description,
                    Duration = os.Duration,
                    TrainerId = os.TrainerId,
                    TrainerName = os.Trainer.Name,
                    Price = os.Price
                })
                .ToListAsync();
        }
    }
}
using elite.Models;
using Microsoft.IdentityModel.Tokens;
using System.IdentityModel.Tokens.Jwt;
using System.Security.Claims;
using System.Text;

namespace elite.Utilities
{
    public interface IJwtService
    {
        string GenerateToken(User user);
        string GenerateAdminToken(Admin admin);
    }

    public class JwtService : IJwtService
    {
        private readonly IConfiguration _configuration;

        public JwtService(IConfiguration configuration)
        {
            _configuration = configuration;
        }
        // In elite/Utilities/JwtService.cs
        public string GenerateAdminToken(Admin admin)
        {
            var tokenHandler = new JwtSecurityTokenHandler();
            var key = Encoding.ASCII.GetBytes(_configuration["Jwt:Secret"]);
            var issuer = _configuration["Jwt:Issuer"]; // Add this line

            var tokenDescriptor = new SecurityTokenDescriptor
            {
                Subject = new ClaimsIdentity(new[]
                {
            new Claim(ClaimTypes.NameIdentifier, admin.Id.ToString()),
            new Claim(ClaimTypes.Email, admin.Email),
            new Claim(ClaimTypes.Name, admin.Username),
            new Claim(ClaimTypes.Role, "Admin")
        }),
                Expires = DateTime.UtcNow.AddDays(7),
                Issuer = issuer, // Add this line
                SigningCredentials = new SigningCredentials(new SymmetricSecurityKey(key), SecurityAlgorithms.HmacSha256Signature)
            };
            var token = tokenHandler.CreateToken(tokenDescriptor);
            return tokenHandler.WriteToken(token);
        }

        public string GenerateToken(User user)
        {
            var tokenHandler = new JwtSecurityTokenHandler();
            var key = Encoding.ASCII.GetBytes(_configuration["Jwt:Secret"]);
            var issuer = _configuration["Jwt:Issuer"];
            var audience = _configuration["Jwt:Audience"];

            var tokenDescriptor = new SecurityTokenDescriptor
            {
                Subject = new ClaimsIdentity(new[]
                {
            new Claim(ClaimTypes.NameIdentifier, user.Id.ToString()),
            new Claim(ClaimTypes.Email, user.Email),
            new Claim(ClaimTypes.Name, user.Name),
            new Claim(ClaimTypes.Role, "User")
        }),
                Expires = DateTime.UtcNow.AddDays(7),
                Issuer = issuer,
                Audience = audience,
                SigningCredentials = new SigningCredentials(new SymmetricSecurityKey(key), SecurityAlgorithms.HmacSha256Signature)
            };

            var token = tokenHandler.CreateToken(tokenDescriptor);
            return tokenHandler.WriteToken(token);
        }
    }
}
namespace elite.Utilities
{
    // Utilities/PasswordHasher.cs
    public interface IPasswordHasher
    {
        string HashPassword(string password);
        bool VerifyPassword(string hashedPassword, string providedPassword);
    }

    public class PasswordHasher : IPasswordHasher
    {
        public string HashPassword(string password)
        {
            return BCrypt.Net.BCrypt.HashPassword(password);
        }

        public bool VerifyPassword(string hashedPassword, string providedPassword)
        {
            return BCrypt.Net.BCrypt.Verify(providedPassword, hashedPassword);
        }
    }
}
using elite.Data;
using elite.Interfaces;
using elite.Middleware;
using elite.Services;
using elite.Utilities;
using Microsoft.AspNetCore.Authentication.JwtBearer;
using Microsoft.EntityFrameworkCore;
using Microsoft.IdentityModel.Tokens;
using Microsoft.OpenApi.Models;
using System.Text;

var builder = WebApplication.CreateBuilder(new WebApplicationOptions
{
    Args = args,
    WebRootPath = "wwwroot" // Set web root path here
});

// Add services to the container.
builder.Services.AddControllers();

// Add DbContext
builder.Services.AddDbContext<GymDbContext>(options =>
    options.UseSqlServer(builder.Configuration.GetConnectionString("DefaultConnection")));

// Add AutoMapper
builder.Services.AddAutoMapper(AppDomain.CurrentDomain.GetAssemblies());

// Add services
builder.Services.AddScoped<IAuthService, AuthService>();
builder.Services.AddScoped<IAdminService, AdminService>();
builder.Services.AddScoped<IBookingService, BookingService>();
builder.Services.AddScoped<IClassService, ClassService>();
builder.Services.AddScoped<IMembershipService, MembershipService>();
builder.Services.AddScoped<IOnlineSessionService, OnlineSessionService>();
builder.Services.AddScoped<IOrderService, OrderService>();
builder.Services.AddScoped<IProductService, ProductService>();
builder.Services.AddScoped<IPromotionService, PromotionService>();
builder.Services.AddScoped<ITrainerService, TrainerService>();
builder.Services.AddScoped<IJwtService, JwtService>();
builder.Services.AddScoped<IPasswordHasher, PasswordHasher>();
builder.Services.AddScoped<IMembershipTypeService, MembershipTypeService>();
builder.Services.AddScoped<IImageService, ImageService>();

// Configure JWT Authentication
var jwtSettings = builder.Configuration.GetSection("Jwt");
var key = Encoding.ASCII.GetBytes(jwtSettings["Secret"]);
builder.Services.AddAuthentication(options =>
{
    options.DefaultAuthenticateScheme = JwtBearerDefaults.AuthenticationScheme;
    options.DefaultChallengeScheme = JwtBearerDefaults.AuthenticationScheme;
})
.AddJwtBearer(options =>
{
    options.TokenValidationParameters = new TokenValidationParameters
    {
        ValidateIssuerSigningKey = true,
        IssuerSigningKey = new SymmetricSecurityKey(key),
        ValidateIssuer = true,
        ValidateAudience = false,
        ValidIssuer = jwtSettings["Issuer"],
        ValidateLifetime = true
    };
});

// Add Authorization
builder.Services.AddAuthorization();

// Configure Swagger/OpenAPI
builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen(options =>
{
    options.SwaggerDoc("v1", new OpenApiInfo
    {
        Title = "Gym Booking API",
        Version = "v1",
        Description = "Women's Gym Booking System API",
        Contact = new OpenApiContact
        {
            Name = "API Support",
            Email = "support@gymbooking.com",
            Url = new Uri("https://gymbooking.com/support")
        },
        License = new OpenApiLicense
        {
            Name = "Use under LICX",
            Url = new Uri("https://example.com/license")
        }
    });

    // Use full name as Schema ID to avoid naming conflicts
    options.CustomSchemaIds(type => type.FullName);

    // Add JWT authentication
    options.AddSecurityDefinition("Bearer", new OpenApiSecurityScheme
    {
        Description = "JWT Authorization header using the Bearer scheme. Example: \"Authorization: Bearer {token}\"",
        Name = "Authorization",
        In = ParameterLocation.Header,
        Type = SecuritySchemeType.ApiKey,
        Scheme = "Bearer"
    });

    options.AddSecurityRequirement(new OpenApiSecurityRequirement
    {
        {
            new OpenApiSecurityScheme
            {
                Reference = new OpenApiReference
                {
                    Type = ReferenceType.SecurityScheme,
                    Id = "Bearer"
                }
            },
            new string[] {}
        }
    });

    // Include XML comments if they exist
    var xmlFile = $"{System.Reflection.Assembly.GetExecutingAssembly().GetName().Name}.xml";
    var xmlPath = Path.Combine(AppContext.BaseDirectory, xmlFile);
    if (File.Exists(xmlPath))
    {
        options.IncludeXmlComments(xmlPath);
    }
});

// Add CORS
builder.Services.AddCors(options =>
{
    options.AddPolicy("AllowAll", builder =>
    {
        builder.AllowAnyOrigin()
               .AllowAnyMethod()
               .AllowAnyHeader();
    });
});

// Add detailed logging
builder.Services.AddLogging(loggingBuilder =>
{
    loggingBuilder.AddConsole();
    loggingBuilder.AddDebug();
});

var app = builder.Build();

// Configure the HTTP request pipeline.
if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI(c =>
    {
        c.SwaggerEndpoint("/swagger/v1/swagger.json", "Gym Booking API v1");
        c.RoutePrefix = "swagger";
    });
}

// Serve static files (including uploaded images)
app.UseStaticFiles();

app.UseHttpsRedirection();

app.UseCors("AllowAll");
app.UseAuthentication();
app.UseAuthorization();

// Use custom exception middleware
app.UseMiddleware<ExceptionMiddleware>();

// Check database connectivity
using (var scope = app.Services.CreateScope())
{
    var context = scope.ServiceProvider.GetRequiredService<GymDbContext>();
    var logger = scope.ServiceProvider.GetRequiredService<ILogger<Program>>();

    try
    {
        // Try to connect to the database
        await context.Database.CanConnectAsync();
        logger.LogInformation("Database connection successful");

        // Ensure database is created
        context.Database.EnsureCreated();

        // Apply any pending migrations
        await context.Database.MigrateAsync();

        // Seed data
        var seeder = new DataSeeder(context);
        await seeder.SeedDataAsync();
    }
    catch (Exception ex)
    {
        logger.LogError(ex, "Database connection or migration failed");
    }
}

app.MapControllers();

app.Run();
{
  "ConnectionStrings": {
    "DefaultConnection": "Server=.\\SQLEXPRESS;Database=GYMBookingDB;Trusted_Connection=True;TrustServerCertificate=True;"
  },
  "Jwt": {
    "Secret": "YourSuperSecretKeyHereAtLeast32CharactersLong",
    "Issuer": "GymBookingAPI",
    "Audience": "GymBookingClients",
    "ExpiryInDays": 7
  },
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*"
} 
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Elite Gym</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
    <!-- Custom CSS -->
     <link rel="stylesheet" href="admin.css">

</head>
<body class="bg-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="../index.html">
                <i class="bi bi-lightning-charge-fill"></i> Elite Gym
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-person-circle"></i> <span id="user-name">Admin</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                            <li><a class="dropdown-item" href="#" id="logout-btn">Logout</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <!-- Main Content -->
    <main class="py-4">
        <div class="container-fluid">
            <!-- Page Header -->
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 page-header">
                <h1 class="h2">Admin Dashboard</h1>
                <div class="btn-toolbar mb-2 mb-md-0">
                    <div class="btn-group me-2">
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="refresh-btn">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                    </div>
                </div>
            </div>
            <!-- Dashboard Stats -->
            <div class="row mb-4">
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card stats-card border-left-primary shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Total Users</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800" id="total-users">0</div>
                                </div>
                                <div class="col-auto">
                                    <i class="bi bi-people-fill fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card stats-card border-left-success shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Active Memberships</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800" id="active-memberships">0</div>
                                </div>
                                <div class="col-auto">
                                    <i class="bi bi-card-checklist fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card stats-card border-left-info shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Bookings Today</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800" id="bookings-today">0</div>
                                </div>
                                <div class="col-auto">
                                    <i class="bi bi-calendar-check fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card stats-card border-left-warning shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Revenue This Month</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800" id="revenue-month">$0.00</div>
                                </div>
                                <div class="col-auto">
                                    <i class="bi bi-currency-dollar fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Tab Navigation -->
            <ul class="nav nav-tabs" id="adminTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard-pane" type="button" role="tab" aria-controls="dashboard-pane" aria-selected="true">Dashboard</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="users-tab" data-bs-toggle="tab" data-bs-target="#users-pane" type="button" role="tab" aria-controls="users-pane" aria-selected="false">Users</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="bookings-tab" data-bs-toggle="tab" data-bs-target="#bookings-pane" type="button" role="tab" aria-controls="bookings-pane" aria-selected="false">Bookings</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="classes-tab" data-bs-toggle="tab" data-bs-target="#classes-pane" type="button" role="tab" aria-controls="classes-pane" aria-selected="false">Classes</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="sessions-tab" data-bs-toggle="tab" data-bs-target="#sessions-pane" type="button" role="tab" aria-controls="sessions-pane" aria-selected="false">Online Sessions</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="trainers-tab" data-bs-toggle="tab" data-bs-target="#trainers-pane" type="button" role="tab" aria-controls="trainers-pane" aria-selected="false">Trainers</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="memberships-tab" data-bs-toggle="tab" data-bs-target="#memberships-pane" type="button" role="tab" aria-controls="memberships-pane" aria-selected="false">Memberships</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="products-tab" data-bs-toggle="tab" data-bs-target="#products-pane" type="button" role="tab" aria-controls="products-pane" aria-selected="false">Products</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="promotions-tab" data-bs-toggle="tab" data-bs-target="#promotions-pane" type="button" role="tab" aria-controls="promotions-pane" aria-selected="false">Promotions</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="orders-tab" data-bs-toggle="tab" data-bs-target="#orders-pane" type="button" role="tab" aria-controls="orders-pane" aria-selected="false">Orders</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="reports-tab" data-bs-toggle="tab" data-bs-target="#reports-pane" type="button" role="tab" aria-controls="reports-pane" aria-selected="false">Reports</button>
                </li>
            </ul>
            <!-- Tab Content -->
            <div class="tab-content" id="adminTabContent">
                <!-- Dashboard Tab (existing content) -->
                <div class="tab-pane fade show active" id="dashboard-pane" role="tabpanel" aria-labelledby="dashboard-tab">
                    <!-- Charts Row -->
                    <div class="row">
                        <!-- Revenue Chart -->
                        <div class="col-xl-8 col-lg-7">
                            <div class="card shadow mb-4">
                                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                                    <h6 class="m-0 font-weight-bold text-primary">Revenue Overview</h6>
                                    <div class="dropdown no-arrow">
                                        <a class="dropdown-toggle" href="#" role="button" id="dropdownMenuLink" data-bs-toggle="dropdown" aria-expanded="false">
                                            <i class="bi bi-three-dots-vertical"></i>
                                        </a>
                                        <div class="dropdown-menu dropdown-menu-right shadow animated--fade-in" aria-labelledby="dropdownMenuLink">
                                            <div class="dropdown-header">Select Period:</div>
                                            <a class="dropdown-item" href="#" id="revenue-week">This Week</a>
                                            <a class="dropdown-item" href="#" id="revenue-month">This Month</a>
                                            <a class="dropdown-item" href="#" id="revenue-year">This Year</a>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="chart-area">
                                        <canvas id="revenueChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Recent Activity -->
                        <div class="col-xl-4 col-lg-5">
                            <div class="card shadow mb-4">
                                <div class="card-header py-3">
                                    <h6 class="m-0 font-weight-bold text-primary">Recent Activity</h6>
                                </div>
                                <div class="card-body">
                                    <div class="list-group" id="recent-activity">
                                        <!-- Recent activity items will be loaded here -->
                                        <div class="text-center py-3">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Low Stock Products Alert -->
                    <div class="row">
                        <div class="col-lg-12 mb-4">
                            <div class="card shadow">
                                <div class="card-header py-3">
                                    <h6 class="m-0 font-weight-bold text-primary">Low Stock Products</h6>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-bordered" id="low-stock-products" width="100%" cellspacing="0">
                                            <thead>
                                                <tr>
                                                    <th>Product Name</th>
                                                    <th>Category</th>
                                                    <th>Current Stock</th>
                                                    <th>Price</th>
                                                    <th>Action</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Low stock products will be loaded here -->
                                                <tr>
                                                    <td colspan="5" class="text-center">Loading...</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Users Tab -->
                <div class="tab-pane fade" id="users-pane" role="tabpanel" aria-labelledby="users-tab">
                    <div class="card shadow mb-4">
                        <div class="card-header py-3 d-flex justify-content-between align-items-center">
                            <h6 class="m-0 font-weight-bold text-primary">Users Management</h6>
                            <div class="d-flex">
                                <div class="input-group me-2" style="width: 250px;">
                                    <input type="text" class="form-control" id="users-search" placeholder="Search users...">
                                    <button class="btn btn-primary" id="users-search-btn">
                                        <i class="bi bi-search"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered" id="users-table" width="100%" cellspacing="0">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Name</th>
                                            <th>Email</th>
                                            <th>Phone</th>
                                            <th>Membership</th>
                                            <th>Status</th>
                                            <th>Created</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Users will be loaded here -->
                                        <tr>
                                            <td colspan="8" class="text-center">Loading...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <!-- Pagination -->
                            <nav aria-label="Users pagination" class="mt-3">
                                <ul class="pagination justify-content-center" id="users-pagination">
                                    <!-- Pagination will be loaded here -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
                <!-- Bookings Tab -->
                <div class="tab-pane fade" id="bookings-pane" role="tabpanel" aria-labelledby="bookings-tab">
                    <div class="card shadow mb-4">
                        <div class="card-header py-3 d-flex justify-content-between align-items-center">
                            <h6 class="m-0 font-weight-bold text-primary">Bookings Management</h6>
                            <div class="d-flex">
                                <div class="input-group me-2" style="width: 200px;">
                                    <input type="date" class="form-control" id="bookings-start-date">
                                    <input type="date" class="form-control" id="bookings-end-date">
                                    <button class="btn btn-primary" id="bookings-filter-btn">
                                        <i class="bi bi-funnel"></i>
                                    </button>
                                </div>
                                <select class="form-select me-2" id="bookings-status-filter" style="width: 150px;">
                                    <option value="">All Status</option>
                                    <option value="Confirmed">Confirmed</option>
                                    <option value="Cancelled">Cancelled</option>
                                    <option value="Completed">Completed</option>
                                </select>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered" id="bookings-table" width="100%" cellspacing="0">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>User</th>
                                            <th>Type</th>
                                            <th>Class/Session</th>
                                            <th>Trainer</th>
                                            <th>Date</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Bookings will be loaded here -->
                                        <tr>
                                            <td colspan="8" class="text-center">Loading...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Classes Tab -->
                <div class="tab-pane fade" id="classes-pane" role="tabpanel" aria-labelledby="classes-tab">
                    <div class="card shadow mb-4">
                        <div class="card-header py-3 d-flex justify-content-between align-items-center">
                            <h6 class="m-0 font-weight-bold text-primary">Classes Management</h6>
                            <button class="btn btn-primary" id="create-class-btn">
                                <i class="bi bi-plus-circle"></i> Create New Class
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered" id="classes-table" width="100%" cellspacing="0">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Name</th>
                                            <th>Description</th>
                                            <th>Trainer</th>
                                            <th>Duration</th>
                                            <th>Capacity</th>
                                            <th>Price</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Classes will be loaded here -->
                                        <tr>
                                            <td colspan="8" class="text-center">Loading...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Online Sessions Tab -->
                <div class="tab-pane fade" id="sessions-pane" role="tabpanel" aria-labelledby="sessions-tab">
                    <div class="card shadow mb-4">
                        <div class="card-header py-3 d-flex justify-content-between align-items-center">
                            <h6 class="m-0 font-weight-bold text-primary">Online Sessions Management</h6>
                            <button class="btn btn-primary" id="create-session-btn">
                                <i class="bi bi-plus-circle"></i> Create New Session
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered" id="sessions-table" width="100%" cellspacing="0">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Name</th>
                                            <th>Description</th>
                                            <th>Trainer</th>
                                            <th>Duration</th>
                                            <th>Price</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Sessions will be loaded here -->
                                        <tr>
                                            <td colspan="7" class="text-center">Loading...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Trainers Tab -->
                <div class="tab-pane fade" id="trainers-pane" role="tabpanel" aria-labelledby="trainers-tab">
                    <div class="card shadow mb-4">
                        <div class="card-header py-3 d-flex justify-content-between align-items-center">
                            <h6 class="m-0 font-weight-bold text-primary">Trainers Management</h6>
                            <button class="btn btn-primary" id="create-trainer-btn">
                                <i class="bi bi-plus-circle"></i> Create New Trainer
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered" id="trainers-table" width="100%" cellspacing="0">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Name</th>
                                            <th>Specialization</th>
                                            <th>Experience</th>
                                            <th>Certifications</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Trainers will be loaded here -->
                                        <tr>
                                            <td colspan="6" class="text-center">Loading...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Memberships Tab -->
                <div class="tab-pane fade" id="memberships-pane" role="tabpanel" aria-labelledby="memberships-tab">
                    <div class="card shadow mb-4">
                        <div class="card-header py-3 d-flex justify-content-between align-items-center">
                            <h6 class="m-0 font-weight-bold text-primary">Membership Types Management</h6>
                            <button class="btn btn-primary" id="create-membership-btn">
                                <i class="bi bi-plus-circle"></i> Create New Type
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered" id="memberships-table" width="100%" cellspacing="0">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Name</th>
                                            <th>Description</th>
                                            <th>Duration</th>
                                            <th>Hours</th>
                                            <th>Price</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Memberships will be loaded here -->
                                        <tr>
                                            <td colspan="8" class="text-center">Loading...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Products Tab -->
                <div class="tab-pane fade" id="products-pane" role="tabpanel" aria-labelledby="products-tab">
                    <div class="card shadow mb-4">
                        <div class="card-header py-3 d-flex justify-content-between align-items-center">
                            <h6 class="m-0 font-weight-bold text-primary">Products Management</h6>
                            <button class="btn btn-primary" id="create-product-btn">
                                <i class="bi bi-plus-circle"></i> Create New Product
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered" id="products-table" width="100%" cellspacing="0">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Name</th>
                                            <th>Description</th>
                                            <th>Category</th>
                                            <th>Price</th>
                                            <th>Stock</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Products will be loaded here -->
                                        <tr>
                                            <td colspan="7" class="text-center">Loading...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Promotions Tab -->
                <div class="tab-pane fade" id="promotions-pane" role="tabpanel" aria-labelledby="promotions-tab">
                    <div class="card shadow mb-4">
                        <div class="card-header py-3 d-flex justify-content-between align-items-center">
                            <h6 class="m-0 font-weight-bold text-primary">Promotions Management</h6>
                            <button class="btn btn-primary" id="create-promotion-btn">
                                <i class="bi bi-plus-circle"></i> Create New Promotion
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered" id="promotions-table" width="100%" cellspacing="0">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Code</th>
                                            <th>Description</th>
                                            <th>Discount</th>
                                            <th>Start Date</th>
                                            <th>End Date</th>
                                            <th>Usage</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Promotions will be loaded here -->
                                        <tr>
                                            <td colspan="8" class="text-center">Loading...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Orders Tab -->
                <div class="tab-pane fade" id="orders-pane" role="tabpanel" aria-labelledby="orders-tab">
                    <div class="card shadow mb-4">
                        <div class="card-header py-3 d-flex justify-content-between align-items-center">
                            <h6 class="m-0 font-weight-bold text-primary">Orders Management</h6>
                            <select class="form-select" id="orders-status-filter" style="width: 150px;">
                                <option value="">All Status</option>
                                <option value="Pending">Pending</option>
                                <option value="Completed">Completed</option>
                                <option value="Cancelled">Cancelled</option>
                            </select>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered" id="orders-table" width="100%" cellspacing="0">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>User</th>
                                            <th>Date</th>
                                            <th>Total</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Orders will be loaded here -->
                                        <tr>
                                            <td colspan="6" class="text-center">Loading...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Reports Tab -->
                <div class="tab-pane fade" id="reports-pane" role="tabpanel" aria-labelledby="reports-tab">
                    <div class="card shadow mb-4">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">Revenue Report</h6>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-5">
                                    <label for="report-start-date" class="form-label">Start Date</label>
                                    <input type="date" class="form-control" id="report-start-date">
                                </div>
                                <div class="col-md-5">
                                    <label for="report-end-date" class="form-label">End Date</label>
                                    <input type="date" class="form-control" id="report-end-date">
                                </div>
                                <div class="col-md-2 d-flex align-items-end">
                                    <button class="btn btn-primary w-100" id="generate-report-btn">Generate</button>
                                </div>
                            </div>
                            <div class="chart-area">
                                <canvas id="reportChart"></canvas>
                            </div>
                            <div class="table-responsive mt-4">
                                <table class="table table-bordered" id="report-table" width="100%" cellspacing="0">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Membership Revenue</th>
                                            <th>Product Revenue</th>
                                            <th>Total Revenue</th>
                                            <th>Bookings Count</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Report data will be loaded here -->
                                        <tr>
                                            <td colspan="5" class="text-center">Generate a report to see data</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <!-- Modals -->
    <!-- Create/Edit Class Modal -->
    <div class="modal fade" id="classModal" tabindex="-1" aria-labelledby="classModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="classModalLabel">Create New Class</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="class-form">
                        <input type="hidden" id="class-id">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="class-name" class="form-label">Name</label>
                                <input type="text" class="form-control" id="class-name" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="class-trainer" class="form-label">Trainer</label>
                                <select class="form-select" id="class-trainer" required>
                                    <option value="">Select Trainer</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="class-description" class="form-label">Description</label>
                            <textarea class="form-control" id="class-description" rows="3" required></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="class-duration" class="form-label">Duration (hours)</label>
                                <input type="number" class="form-control" id="class-duration" min="15" step="15" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="class-capacity" class="form-label">Max Capacity</label>
                                <input type="number" class="form-control" id="class-capacity" min="1" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="class-price" class="form-label">Price</label>
                                <input type="number" class="form-control" id="class-price" min="0" step="0.01" required>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="save-class-btn">Save Class</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Create/Edit Online Session Modal -->
    <div class="modal fade" id="sessionModal" tabindex="-1" aria-labelledby="sessionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="sessionModalLabel">Create New Online Session</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="session-form">
                        <input type="hidden" id="session-id">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="session-name" class="form-label">Name</label>
                                <input type="text" class="form-control" id="session-name" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="session-trainer" class="form-label">Trainer</label>
                                <select class="form-select" id="session-trainer" required>
                                    <option value="">Select Trainer</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="session-description" class="form-label">Description</label>
                            <textarea class="form-control" id="session-description" rows="3" required></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="session-duration" class="form-label">Duration (minutes)</label>
                                <input type="number" class="form-control" id="session-duration" min="15" step="15" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="session-price" class="form-label">Price</label>
                                <input type="number" class="form-control" id="session-price" min="0" step="0.01" required>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="save-session-btn">Save Session</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Create/Edit Trainer Modal -->
    <div class="modal fade" id="trainerModal" tabindex="-1" aria-labelledby="trainerModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="trainerModalLabel">Create New Trainer</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="trainer-form">
                        <input type="hidden" id="trainer-id">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="trainer-name" class="form-label">Name</label>
                                <input type="text" class="form-control" id="trainer-name" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="trainer-specialization" class="form-label">Specialization</label>
                                <input type="text" class="form-control" id="trainer-specialization" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="trainer-experience" class="form-label">Experience (years)</label>
                                <input type="number" class="form-control" id="trainer-experience" min="0" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="trainer-certifications" class="form-label">Certifications</label>
                                <input type="text" class="form-control" id="trainer-certifications">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="trainer-bio" class="form-label">Bio</label>
                            <textarea class="form-control" id="trainer-bio" rows="3" required></textarea>
                        </div>
                        <!-- In trainerModal -->
<div class="mb-3">
    <label for="trainer-image-file" class="form-label">Image</label>
    <input type="file" class="form-control" id="trainer-image-file" accept="image/*">
    <div id="trainer-image-preview" class="mt-2"></div>
</div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="save-trainer-btn">Save Trainer</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Create/Edit Membership Type Modal -->
    <div class="modal fade" id="membershipModal" tabindex="-1" aria-labelledby="membershipModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="membershipModalLabel">Create New Membership Type</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="membership-form">
                        <input type="hidden" id="membership-id">
                        <div class="mb-3">
                            <label for="membership-name" class="form-label">Name</label>
                            <input type="text" class="form-control" id="membership-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="membership-description" class="form-label">Description</label>
                            <textarea class="form-control" id="membership-description" rows="2" required></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="membership-duration" class="form-label">Duration (months)</label>
                                <input type="number" class="form-control" id="membership-duration" min="1" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="membership-hours" class="form-label">Total Hours</label>
                                <input type="number" class="form-control" id="membership-hours" min="1" step="0.5" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="membership-price" class="form-label">Price</label>
                            <input type="number" class="form-control" id="membership-price" min="0" step="0.01" required>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="membership-active" checked>
                            <label class="form-check-label" for="membership-active">
                                Active
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="save-membership-btn">Save Membership Type</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Create/Edit Product Modal -->
    <div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productModalLabel">Create New Product</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="product-form">
                        <input type="hidden" id="product-id">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="product-name" class="form-label">Name</label>
                                <input type="text" class="form-control" id="product-name" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="product-category" class="form-label">Category</label>
                                <select class="form-select" id="product-category" required>
                                    <option value="">Select Category</option>
                                    <option value="Apparel">Apparel</option>
                                    <option value="Supplements">Supplements</option>
                                    <option value="Equipment">Equipment</option>
                                    <option value="Accessories">Accessories</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="product-description" class="form-label">Description</label>
                            <textarea class="form-control" id="product-description" rows="3" required></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="product-price" class="form-label">Price</label>
                                <input type="number" class="form-control" id="product-price" min="0" step="0.01" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="product-stock" class="form-label">Stock Quantity</label>
                                <input type="number" class="form-control" id="product-stock" min="0" required>
                            </div>
                        </div>
                       <!-- In productModal -->
<div class="mb-3">
    <label for="product-image-file" class="form-label">Image</label>
    <input type="file" class="form-control" id="product-image-file" accept="image/*">
    <div id="product-image-preview" class="mt-2"></div>
</div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="save-product-btn">Save Product</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Create/Edit Promotion Modal -->
    <div class="modal fade" id="promotionModal" tabindex="-1" aria-labelledby="promotionModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="promotionModalLabel">Create New Promotion</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="promotion-form">
                        <input type="hidden" id="promotion-id">
                        <div class="mb-3">
                            <label for="promotion-code" class="form-label">Code</label>
                            <input type="text" class="form-control" id="promotion-code" required>
                        </div>
                        <div class="mb-3">
                            <label for="promotion-description" class="form-label">Description</label>
                            <textarea class="form-control" id="promotion-description" rows="2" required></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="promotion-type" class="form-label">Discount Type</label>
                                <select class="form-select" id="promotion-type" required>
                                    <option value="">Select Type</option>
                                    <option value="Percentage">Percentage</option>
                                    <option value="Fixed">Fixed Amount</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="promotion-value" class="form-label">Discount Value</label>
                                <input type="number" class="form-control" id="promotion-value" min="0" step="0.01" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="promotion-start" class="form-label">Start Date</label>
                                <input type="date" class="form-control" id="promotion-start" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="promotion-end" class="form-label">End Date</label>
                                <input type="date" class="form-control" id="promotion-end" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="promotion-limit" class="form-label">Usage Limit</label>
                            <input type="number" class="form-control" id="promotion-limit" min="1" value="100">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="save-promotion-btn">Save Promotion</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Bootstrap 5 JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <!-- Custom JS -->
    <script src="../assets/js/main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is admin
            if (!authService.isAdmin()) {
                window.location.href = '../login.html';
                return;
            }
            // Set user name in navbar
            const user = authService.getCurrentUser();
            if (user) {
                const userNameElement = document.getElementById('user-name');
                if (userNameElement) {
                    userNameElement.textContent = user.name;
                }
            }
            // Logout functionality
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    authService.logout();
                });
            }
            // Trainer image preview
    const trainerImageInput = document.getElementById('trainer-image-file');
    if (trainerImageInput) {
        trainerImageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const preview = document.getElementById('trainer-image-preview');
                    preview.innerHTML = `<img src="${event.target.result}" class="img-thumbnail" style="max-width: 200px;">`;
                };
                reader.readAsDataURL(file);
            } else {
                document.getElementById('trainer-image-preview').innerHTML = '';
            }
        });
    }
    
    // Product image preview
    const productImageInput = document.getElementById('product-image-file');
    if (productImageInput) {
        productImageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const preview = document.getElementById('product-image-preview');
                    preview.innerHTML = `<img src="${event.target.result}" class="img-thumbnail" style="max-width: 200px;">`;
                };
                reader.readAsDataURL(file);
            } else {
                document.getElementById('product-image-preview').innerHTML = '';
            }
        });
    }
            // Initialize tabs
            const triggerTabList = [].slice.call(document.querySelectorAll('#adminTabs button'));
            triggerTabList.forEach(function(triggerEl) {
                const tabTrigger = new bootstrap.Tab(triggerEl);
                triggerEl.addEventListener('click', function(event) {
                    event.preventDefault();
                    tabTrigger.show();
                    
                    // Load data for the active tab
                    const tabId = triggerEl.getAttribute('data-bs-target').substring(1);
                    loadTabData(tabId);
                });
            });
            // Load dashboard stats
            loadDashboardStats();
            // Load revenue chart
            loadRevenueChart('month');
            // Load recent activity
            loadRecentActivity();
            // Load low stock products
            loadLowStockProducts();
            // Refresh button
            const refreshBtn = document.getElementById('refresh-btn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', function() {
                    const activeTab = document.querySelector('#adminTabs .nav-link.active');
                    if (activeTab) {
                        const tabId = activeTab.getAttribute('data-bs-target').substring(1);
                        if (tabId === 'dashboard-pane') {
                            loadDashboardStats();
                            loadRevenueChart(currentRevenuePeriod);
                            loadRecentActivity();
                            loadLowStockProducts();
                        } else {
                            loadTabData(tabId);
                        }
                    }
                });
            }
            // Revenue period buttons
            let currentRevenuePeriod = 'month';
            const revenueWeekBtn = document.getElementById('revenue-week');
            const revenueMonthBtn = document.getElementById('revenue-month');
            const revenueYearBtn = document.getElementById('revenue-year');
            if (revenueWeekBtn) {
                revenueWeekBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    currentRevenuePeriod = 'week';
                    loadRevenueChart('week');
                });
            }
            if (revenueMonthBtn) {
                revenueMonthBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    currentRevenuePeriod = 'month';
                    loadRevenueChart('month');
                });
            }
            if (revenueYearBtn) {
                revenueYearBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    currentRevenuePeriod = 'year';
                    loadRevenueChart('year');
                });
            }
            // Users tab functionality
            const usersSearchBtn = document.getElementById('users-search-btn');
            if (usersSearchBtn) {
                usersSearchBtn.addEventListener('click', function() {
                    loadUsers(1);
                });
            }
            // Bookings tab functionality
            const bookingsFilterBtn = document.getElementById('bookings-filter-btn');
            const bookingsStatusFilter = document.getElementById('bookings-status-filter');
            if (bookingsFilterBtn) {
                bookingsFilterBtn.addEventListener('click', function() {
                    loadBookings();
                });
            }
            if (bookingsStatusFilter) {
                bookingsStatusFilter.addEventListener('change', function() {
                    loadBookings();
                });
            }
            // Classes tab functionality
            const createClassBtn = document.getElementById('create-class-btn');
            if (createClassBtn) {
                createClassBtn.addEventListener('click', function() {
                    openClassModal();
                });
            }
            // Sessions tab functionality
            const createSessionBtn = document.getElementById('create-session-btn');
            if (createSessionBtn) {
                createSessionBtn.addEventListener('click', function() {
                    openSessionModal();
                });
            }
            // Trainers tab functionality
            const createTrainerBtn = document.getElementById('create-trainer-btn');
            if (createTrainerBtn) {
                createTrainerBtn.addEventListener('click', function() {
                    openTrainerModal();
                });
            }
            // Memberships tab functionality
            const createMembershipBtn = document.getElementById('create-membership-btn');
            if (createMembershipBtn) {
                createMembershipBtn.addEventListener('click', function() {
                    openMembershipModal();
                });
            }
            // Products tab functionality
            const createProductBtn = document.getElementById('create-product-btn');
            if (createProductBtn) {
                createProductBtn.addEventListener('click', function() {
                    openProductModal();
                });
            }
            // Promotions tab functionality
            const createPromotionBtn = document.getElementById('create-promotion-btn');
            if (createPromotionBtn) {
                createPromotionBtn.addEventListener('click', function() {
                    openPromotionModal();
                });
            }
            // Orders tab functionality
            const ordersStatusFilter = document.getElementById('orders-status-filter');
            if (ordersStatusFilter) {
                ordersStatusFilter.addEventListener('change', function() {
                    loadOrders();
                });
            }
            // Reports tab functionality
            const generateReportBtn = document.getElementById('generate-report-btn');
            if (generateReportBtn) {
                generateReportBtn.addEventListener('click', function() {
                    generateRevenueReport();
                });
            }
            // Modal save buttons
            const saveClassBtn = document.getElementById('save-class-btn');
            const saveSessionBtn = document.getElementById('save-session-btn');
            const saveTrainerBtn = document.getElementById('save-trainer-btn');
            const saveMembershipBtn = document.getElementById('save-membership-btn');
            const saveProductBtn = document.getElementById('save-product-btn');
            const savePromotionBtn = document.getElementById('save-promotion-btn');
            if (saveClassBtn) saveClassBtn.addEventListener('click', saveClass);
            if (saveSessionBtn) saveSessionBtn.addEventListener('click', saveSession);
            if (saveTrainerBtn) saveTrainerBtn.addEventListener('click', saveTrainer);
            if (saveMembershipBtn) saveMembershipBtn.addEventListener('click', saveMembership);
            if (saveProductBtn) saveProductBtn.addEventListener('click', saveProduct);
            if (savePromotionBtn) savePromotionBtn.addEventListener('click', savePromotion);
            // Initialize form validation
            initializeFormValidation();
        });
        // Load data for the active tab
        function loadTabData(tabId) {
            switch(tabId) {
                case 'users-pane':
                    loadUsers(1);
                    break;
                case 'bookings-pane':
                    loadBookings();
                    break;
                case 'classes-pane':
                    loadClasses();
                    break;
                case 'sessions-pane':
                    loadSessions();
                    break;
                case 'trainers-pane':
                    loadTrainers();
                    break;
                case 'memberships-pane':
                    loadMemberships();
                    break;
                case 'products-pane':
                    loadProducts();
                    break;
                case 'promotions-pane':
                    loadPromotions();
                    break;
                case 'orders-pane':
                    loadOrders();
                    break;
                case 'reports-pane':
                    // Initialize report date range
                    const today = new Date();
                    const lastMonth = new Date();
                    lastMonth.setMonth(today.getMonth() - 1);
                    
                    const reportStartDate = document.getElementById('report-start-date');
                    const reportEndDate = document.getElementById('report-end-date');
                    
                    if (reportStartDate) reportStartDate.value = utils.formatDateForInput(lastMonth);
                    if (reportEndDate) reportEndDate.value = utils.formatDateForInput(today);
                    break;
            }
        }
        // Load dashboard statistics
        async function loadDashboardStats() {
            try {
                const stats = await apiService.getDashboardStats();
                
                const totalUsersElement = document.getElementById('total-users');
                const activeMembershipsElement = document.getElementById('active-memberships');
                const bookingsTodayElement = document.getElementById('bookings-today');
                const revenueMonthElement = document.getElementById('revenue-month');
                
                if (totalUsersElement) totalUsersElement.textContent = stats.totalUsers;
                if (activeMembershipsElement) activeMembershipsElement.textContent = stats.activeMemberships;
                if (bookingsTodayElement) bookingsTodayElement.textContent = stats.totalBookingsToday;
                if (revenueMonthElement) revenueMonthElement.textContent = uiHelper.formatCurrency(stats.revenueThisMonth);
            } catch (error) {
                console.error('Error loading dashboard stats:', error);
                uiHelper.showAlert('Error loading dashboard statistics', 'danger');
            }
        }
        // Load revenue chart
        let revenueChart = null;
        async function loadRevenueChart(period) {
            try {
                // Calculate date range based on period
                const endDate = new Date();
                let startDate = new Date();
                
                if (period === 'week') {
                    startDate.setDate(endDate.getDate() - 7);
                } else if (period === 'month') {
                    startDate.setMonth(endDate.getMonth() - 1);
                } else if (period === 'year') {
                    startDate.setFullYear(endDate.getFullYear() - 1);
                }
                
                // Format dates for API
                const startDateStr = startDate.toISOString().split('T')[0];
                const endDateStr = endDate.toISOString().split('T')[0];
                
                // Get revenue data
                const revenueData = await apiService.getRevenueReport(startDateStr, endDateStr);
                
                // Prepare data for chart
                const labels = revenueData.map(item => utils.formatDateForInput(item.date));
                const membershipRevenue = revenueData.map(item => item.membershipRevenue);
                const productRevenue = revenueData.map(item => item.productRevenue);
                
                // Get chart context
                const ctx = document.getElementById('revenueChart');
                if (!ctx) return;
                
                const chartCtx = ctx.getContext('2d');
                
                // Destroy existing chart if it exists
                if (revenueChart) {
                    revenueChart.destroy();
                }
                
                // Create new chart
                revenueChart = new Chart(chartCtx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Membership Revenue',
                                data: membershipRevenue,
                                lineTension: 0.3,
                                backgroundColor: 'rgba(78, 115, 223, 0.05)',
                                borderColor: 'rgba(78, 115, 223, 1)',
                                pointRadius: 3,
                                pointBackgroundColor: 'rgba(78, 115, 223, 1)',
                                pointBorderColor: '#fff',
                                pointHoverRadius: 5,
                                pointHoverBackgroundColor: 'rgba(78, 115, 223, 1)',
                                pointHoverBorderColor: 'rgba(78, 115, 223, 1)',
                                pointHitRadius: 10,
                                pointBorderWidth: 2,
                                fill: true
                            },
                            {
                                label: 'Product Revenue',
                                data: productRevenue,
                                lineTension: 0.3,
                                backgroundColor: 'rgba(28, 200, 138, 0.05)',
                                borderColor: 'rgba(28, 200, 138, 1)',
                                pointRadius: 3,
                                pointBackgroundColor: 'rgba(28, 200, 138, 1)',
                                pointBorderColor: '#fff',
                                pointHoverRadius: 5,
                                pointHoverBackgroundColor: 'rgba(28, 200, 138, 1)',
                                pointHoverBorderColor: 'rgba(28, 200, 138, 1)',
                                pointHitRadius: 10,
                                pointBorderWidth: 2,
                                fill: true
                            }
                        ]
                    },
                    options: {
                        maintainAspectRatio: false,
                        layout: {
                            padding: {
                                left: 10,
                                right: 25,
                                top: 25,
                                bottom: 0
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    display: false,
                                    drawBorder: false
                                },
                                ticks: {
                                    maxTicksLimit: 7
                                }
                            },
                            y: {
                                ticks: {
                                    maxTicksLimit: 5,
                                    padding: 10,
                                    callback: function(value) {
                                        return '$' + value.toLocaleString();
                                    }
                                },
                                grid: {
                                    color: 'rgb(234, 236, 244)',
                                    zeroLineColor: 'rgb(234, 236, 244)',
                                    drawBorder: false,
                                    borderDash: [2],
                                    zeroLineBorderDash: [2]
                                }
                            }
                        },
                        legend: {
                            display: true,
                            position: 'bottom'
                        },
                        tooltips: {
                            backgroundColor: 'rgb(255, 255, 255)',
                            bodyFontColor: '#858796',
                            titleMarginBottom: 10,
                            titleFontColor: '#6e707e',
                            titleFontSize: 14,
                            borderColor: '#dddfeb',
                            borderWidth: 1,
                            xPadding: 15,
                            yPadding: 15,
                            displayColors: false,
                            intersect: false,
                            mode: 'index',
                            caretPadding: 10,
                            callbacks: {
                                label: function(tooltipItem, chart) {
                                    var label = chart.datasets[tooltipItem.datasetIndex].label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += '$' + tooltipItem.yLabel.toLocaleString();
                                    return label;
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading revenue chart:', error);
                uiHelper.showAlert('Error loading revenue chart', 'danger');
            }
        }
        // Load recent activity
        async function loadRecentActivity() {
            try {
                // Get recent bookings
                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(endDate.getDate() - 7);
                
                const startDateStr = startDate.toISOString().split('T')[0];
                const endDateStr = endDate.toISOString().split('T')[0];
                
                const bookings = await apiService.getAllBookings(startDateStr, endDateStr);
                
                // Get recent orders
                const orders = await apiService.getAllOrders();
                
                // Combine and sort by date
                const activities = [];
                
                // Add bookings
                bookings.forEach(booking => {
                    activities.push({
                        type: 'booking',
                        date: new Date(booking.bookingDate),
                        description: `${booking.type === 'Class' ? 'Class' : 'Online Session'} booking by ${booking.trainerName}`,
                        status: booking.status,
                        icon: booking.type === 'Class' ? 'bi-calendar-event' : 'bi-laptop',
                        color: booking.status === 'Confirmed' ? 'success' : 'danger'
                    });
                });
                
                // Add orders
                orders.slice(0, 10).forEach(order => {
                    activities.push({
                        type: 'order',
                        date: new Date(order.orderDate),
                        description: `Order #${order.id} by ${order.userName}`,
                        status: order.status,
                        icon: 'bi-cart-check',
                        color: order.status === 'Completed' ? 'success' : 'warning'
                    });
                });
                
                // Sort by date (newest first)
                activities.sort((a, b) => b.date - a.date);
                
                // Take the top 10
                const recentActivities = activities.slice(0, 10);
                
                // Display activities
                const activityContainer = document.getElementById('recent-activity');
                if (!activityContainer) return;
                
                activityContainer.innerHTML = '';
                
                if (recentActivities.length === 0) {
                    activityContainer.innerHTML = '<div class="text-center py-3">No recent activity</div>';
                    return;
                }
                
                recentActivities.forEach(activity => {
                    const activityItem = document.createElement('a');
                    activityItem.href = '#';
                    activityItem.className = 'list-group-item list-group-item-action';
                    
                    activityItem.innerHTML = `
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">
                                <i class="bi ${activity.icon} text-${activity.color}"></i>
                                ${activity.description}
                            </h6>
                            <small>${uiHelper.formatDate(activity.date)}</small>
                        </div>
                        <p class="mb-1">Status: <span class="badge bg-${activity.color}">${activity.status}</span></p>
                    `;
                    
                    activityContainer.appendChild(activityItem);
                });
            } catch (error) {
                console.error('Error loading recent activity:', error);
                const activityContainer = document.getElementById('recent-activity');
                if (activityContainer) {
                    activityContainer.innerHTML = '<div class="text-center py-3 text-danger">Error loading recent activity</div>';
                }
            }
        }
        // Load low stock products
        async function loadLowStockProducts() {
            try {
                const products = await apiService.getProducts();
                const lowStockProducts = products.filter(product => product.stockQuantity <= 5);
                
                const tableBody = document.querySelector('#low-stock-products tbody');
                if (!tableBody) return;
                
                tableBody.innerHTML = '';
                
                if (lowStockProducts.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="text-center">No low stock products</td></tr>';
                    return;
                }
                
                lowStockProducts.forEach(product => {
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${product.name}</td>
                        <td>${product.category}</td>
                        <td><span class="badge bg-danger">${product.stockQuantity}</span></td>
                        <td>${uiHelper.formatCurrency(product.price)}</td>
                        <td>
                            <button class="btn btn-sm btn-primary update-stock-btn" data-id="${product.id}">
                                <i class="bi bi-pencil"></i> Update Stock
                            </button>
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                // Add event listeners to update stock buttons
                document.querySelectorAll('.update-stock-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const productId = this.getAttribute('data-id');
                        const newStock = prompt('Enter new stock quantity:');
                        if (newStock !== null && !isNaN(newStock) && newStock >= 0) {
                            updateProductStock(productId, parseInt(newStock));
                        }
                    });
                });
            } catch (error) {
                console.error('Error loading low stock products:', error);
                const tableBody = document.querySelector('#low-stock-products tbody');
                if (tableBody) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error loading products</td></tr>';
                }
            }
        }
        // Update product stock
      async function updateProductStock(productId, quantity) {
    try {
        await apiService.updateProductStock(productId, quantity);
        uiHelper.showAlert('Product stock updated successfully', 'success');
        loadLowStockProducts();
        loadProducts(); // Refresh products tab if active
    } catch (error) {
        console.error('Error updating product stock:', error);
        uiHelper.showAlert('Error updating product stock: ' + error.message, 'danger');
    }
}
        // Load users with pagination
        let usersCurrentPage = 1;
        const usersPageSize = 10;
        
        async function loadUsers(page = 1) {
            try {
                usersCurrentPage = page;
                const usersSearch = document.getElementById('users-search');
                const searchTerm = usersSearch ? usersSearch.value : '';
                
                let users;
                if (searchTerm) {
                    // If search term is provided, get all users and filter on client side
                    const allUsers = await apiService.getAllUsers(1, 1000); // Get a large number
                    users = allUsers.filter(user => 
                        user.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
                        user.email.toLowerCase().includes(searchTerm.toLowerCase())
                    );
                } else {
                    users = await apiService.getAllUsers(page, usersPageSize);
                }
                
                const tableBody = document.querySelector('#users-table tbody');
                if (!tableBody) return;
                
                tableBody.innerHTML = '';
                
                if (users.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="8" class="text-center">No users found</td></tr>';
                    return;
                }
                
                users.forEach(user => {
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${user.id}</td>
                        <td>${user.name}</td>
                        <td>${user.email}</td>
                        <td>${user.phone || 'N/A'}</td>
                        <td>${user.membership ? user.membership.type : 'None'}</td>
                        <td>
                            <span class="badge ${user.membership && user.membership.status === 'Active' ? 'bg-success' : 'bg-secondary'}">
                                ${user.membership ? user.membership.status : 'Inactive'}
                            </span>
                        </td>
                        <td>${uiHelper.formatDate(user.createdAt)}</td>
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-primary view-user-btn" data-id="${user.id}">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger delete-user-btn" data-id="${user.id}">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                // Add event listeners
                document.querySelectorAll('.view-user-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const userId = this.getAttribute('data-id');
                        viewUserDetails(userId);
                    });
                });
                document.querySelectorAll('.delete-user-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const userId = this.getAttribute('data-id');
                        deleteUser(userId);
                    });
                });
                // Render pagination
                renderUsersPagination(users.length);
            } catch (error) {
                console.error('Error loading users:', error);
                const tableBody = document.querySelector('#users-table tbody');
                if (tableBody) {
                    tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error loading users</td></tr>';
                }
            }
        }
        // Render users pagination
        function renderUsersPagination(totalItems) {
            const pagination = document.getElementById('users-pagination');
            if (!pagination) return;
            
            pagination.innerHTML = '';
            
            const totalPages = Math.ceil(totalItems / usersPageSize);
            
            if (totalPages <= 1) return;
            
            // Previous button
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${usersCurrentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" data-page="${usersCurrentPage - 1}">Previous</a>`;
            pagination.appendChild(prevLi);
            
            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === usersCurrentPage ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
                pagination.appendChild(li);
            }
            
            // Next button
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${usersCurrentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" data-page="${usersCurrentPage + 1}">Next</a>`;
            pagination.appendChild(nextLi);
            
            // Add event listeners
            pagination.querySelectorAll('.page-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const page = parseInt(this.getAttribute('data-page'));
                    if (page > 0 && page <= totalPages) {
                        loadUsers(page);
                    }
                });
            });
        }
        // View user details
        async function viewUserDetails(userId) {
            try {
                const user = await apiService.getUserDetails(userId);
                
                // Create a modal to show user details
                const modalHtml = `
                    <div class="modal fade" id="userDetailsModal" tabindex="-1" aria-labelledby="userDetailsModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="userDetailsModalLabel">User Details</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <strong>ID:</strong> ${user.id}
                                    </div>
                                    <div class="mb-3">
                                        <strong>Name:</strong> ${user.name}
                                    </div>
                                    <div class="mb-3">
                                        <strong>Email:</strong> ${user.email}
                                    </div>
                                    <div class="mb-3">
                                        <strong>Phone:</strong> ${user.phone || 'N/A'}
                                    </div>
                                    <div class="mb-3">
                                        <strong>Member Since:</strong> ${uiHelper.formatDate(user.createdAt)}
                                    </div>
                                    ${user.membership ? `
                                        <div class="mb-3">
                                            <strong>Membership Type:</strong> ${user.membership.type}
                                        </div>
                                        <div class="mb-3">
                                            <strong>Membership Status:</strong> 
                                            <span class="badge ${user.membership.status === 'Active' ? 'bg-success' : 'bg-secondary'}">
                                                ${user.membership.status}
                                            </span>
                                        </div>
                                        <div class="mb-3">
                                            <strong>Start Date:</strong> ${uiHelper.formatDate(user.membership.startDate)}
                                        </div>
                                        <div class="mb-3">
                                            <strong>End Date:</strong> ${uiHelper.formatDate(user.membership.endDate)}
                                        </div>
                                        <div class="mb-3">
                                            <strong>Total Hours:</strong> ${user.membership.totalHours}
                                        </div>
                                        <div class="mb-3">
                                            <strong>Remaining Hours:</strong> ${user.membership.remainingHours}
                                        </div>
                                    ` : '<div class="mb-3"><strong>Membership:</strong> None</div>'}
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add modal to DOM
                const modalContainer = document.createElement('div');
                modalContainer.innerHTML = modalHtml;
                document.body.appendChild(modalContainer);
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('userDetailsModal'));
                modal.show();
                
                // Remove modal from DOM when hidden
                document.getElementById('userDetailsModal').addEventListener('hidden.bs.modal', function() {
                    document.body.removeChild(modalContainer);
                });
            } catch (error) {
                console.error('Error loading user details:', error);
                uiHelper.showAlert('Error loading user details', 'danger');
            }
        }
        // Delete user
        function deleteUser(userId) {
            uiHelper.confirm('Are you sure you want to delete this user? This action cannot be undone.', async function() {
                try {
                    // Note: This would require an API endpoint to delete users
                    // For now, we'll just show a success message
                    uiHelper.showAlert('User deleted successfully', 'success');
                    loadUsers(usersCurrentPage);
                } catch (error) {
                    console.error('Error deleting user:', error);
                    uiHelper.showAlert('Error deleting user', 'danger');
                }
            });
        }
        // Load bookings
        async function loadBookings() {
            try {
                const bookingsStartDate = document.getElementById('bookings-start-date');
                const bookingsEndDate = document.getElementById('bookings-end-date');
                const bookingsStatusFilter = document.getElementById('bookings-status-filter');
                
                const startDate = bookingsStartDate ? bookingsStartDate.value : null;
                const endDate = bookingsEndDate ? bookingsEndDate.value : null;
                const status = bookingsStatusFilter ? bookingsStatusFilter.value : null;
                
                let bookings = await apiService.getAllBookings(
                    startDate ? new Date(startDate) : null,
                    endDate ? new Date(endDate) : null
                );
                
                // Filter by status if selected
                if (status) {
                    bookings = bookings.filter(booking => booking.status === status);
                }
                
                const tableBody = document.querySelector('#bookings-table tbody');
                if (!tableBody) return;
                
                tableBody.innerHTML = '';
                
                if (bookings.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="8" class="text-center">No bookings found</td></tr>';
                    return;
                }
                
                bookings.forEach(booking => {
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${booking.id}</td>
                        <td>${booking.className ? booking.className : booking.sessionName}</td>
                        <td>${booking.type}</td>
                        <td>${booking.className ? booking.className : booking.sessionName}</td>
                        <td>${booking.trainerName}</td>
                        <td>${uiHelper.formatDate(booking.startTime)}</td>
                        <td>
                            <span class="badge ${
                                booking.status === 'Confirmed' ? 'bg-success' : 
                                booking.status === 'Cancelled' ? 'bg-danger' : 'bg-info'
                            }">
                                ${booking.status}
                            </span>
                        </td>
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-primary view-booking-btn" data-id="${booking.id}">
                                    <i class="bi bi-eye"></i>
                                </button>
                                ${booking.status === 'Confirmed' ? `
                                    <button class="btn btn-sm btn-outline-danger cancel-booking-btn" data-id="${booking.id}">
                                        <i class="bi bi-x-circle"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                // Add event listeners
                document.querySelectorAll('.view-booking-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const bookingId = this.getAttribute('data-id');
                        viewBookingDetails(bookingId);
                    });
                });
                document.querySelectorAll('.cancel-booking-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const bookingId = this.getAttribute('data-id');
                        cancelBooking(bookingId);
                    });
                });
            } catch (error) {
                console.error('Error loading bookings:', error);
                const tableBody = document.querySelector('#bookings-table tbody');
                if (tableBody) {
                    tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error loading bookings</td></tr>';
                }
            }
        }
        // View booking details
        async function viewBookingDetails(bookingId) {
            try {
                const booking = await apiService.getBookingDetails(bookingId);
                
                // Create a modal to show booking details
                const modalHtml = `
                    <div class="modal fade" id="bookingDetailsModal" tabindex="-1" aria-labelledby="bookingDetailsModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="bookingDetailsModalLabel">Booking Details</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <strong>Booking ID:</strong> ${booking.id}
                                    </div>
                                    <div class="mb-3">
                                        <strong>Type:</strong> ${booking.type}
                                    </div>
                                    <div class="mb-3">
                                        <strong>${booking.type === 'Class' ? 'Class' : 'Session'}:</strong> ${booking.className || booking.sessionName}
                                    </div>
                                    <div class="mb-3">
                                        <strong>Trainer:</strong> ${booking.trainerName}
                                    </div>
                                    <div class="mb-3">
                                        <strong>Date & Time:</strong> ${uiHelper.formatDate(booking.startTime)} - ${uiHelper.formatDate(booking.endTime)}
                                    </div>
                                    <div class="mb-3">
                                        <strong>Location:</strong> ${booking.location}
                                    </div>
                                    <div class="mb-3">
                                        <strong>Booking Date:</strong> ${uiHelper.formatDate(booking.bookingDate)}
                                    </div>
                                    <div class="mb-3">
                                        <strong>Status:</strong> 
                                        <span class="badge ${
                                            booking.status === 'Confirmed' ? 'bg-success' : 
                                            booking.status === 'Cancelled' ? 'bg-danger' : 'bg-info'
                                        }">
                                            ${booking.status}
                                        </span>
                                    </div>
                                    <div class="mb-3">
                                        <strong>Hours Consumed:</strong> ${booking.hoursConsumed}
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add modal to DOM
                const modalContainer = document.createElement('div');
                modalContainer.innerHTML = modalHtml;
                document.body.appendChild(modalContainer);
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('bookingDetailsModal'));
                modal.show();
                
                // Remove modal from DOM when hidden
                document.getElementById('bookingDetailsModal').addEventListener('hidden.bs.modal', function() {
                    document.body.removeChild(modalContainer);
                });
            } catch (error) {
                console.error('Error loading booking details:', error);
                uiHelper.showAlert('Error loading booking details', 'danger');
            }
        }
        // Cancel booking
        function cancelBooking(bookingId) {
            uiHelper.confirm('Are you sure you want to cancel this booking?', async function() {
                try {
                    // Note: This would require an API endpoint to cancel bookings
                    // For now, we'll just show a success message
                    uiHelper.showAlert('Booking cancelled successfully', 'success');
                    loadBookings();
                } catch (error) {
                    console.error('Error cancelling booking:', error);
                    uiHelper.showAlert('Error cancelling booking', 'danger');
                }
            });
        }
        // Load classes
        async function loadClasses() {
            try {
                const classes = await apiService.getClasses();
                
                const tableBody = document.querySelector('#classes-table tbody');
                if (!tableBody) return;
                
                tableBody.innerHTML = '';
                
                if (classes.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="8" class="text-center">No classes found</td></tr>';
                    return;
                }
                
                classes.forEach(classObj => {
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${classObj.id}</td>
                        <td>${classObj.name}</td>
                        <td>${classObj.description}</td>
                        <td>${classObj.trainerName}</td>
                        <td>${classObj.duration} min</td>
                        <td>${classObj.maxCapacity}</td>
                        <td>${uiHelper.formatCurrency(classObj.price)}</td>
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-primary view-class-btn" data-id="${classObj.id}">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-secondary edit-class-btn" data-id="${classObj.id}">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger delete-class-btn" data-id="${classObj.id}">
                                    <i class="bi bi-trash"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-info view-schedules-btn" data-id="${classObj.id}">
                                    <i class="bi bi-calendar3"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                // Add event listeners
                document.querySelectorAll('.view-class-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const classId = this.getAttribute('data-id');
                        viewClassDetails(classId);
                    });
                });
                document.querySelectorAll('.edit-class-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const classId = this.getAttribute('data-id');
                        openClassModal(classId);
                    });
                });
                document.querySelectorAll('.delete-class-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const classId = this.getAttribute('data-id');
                        deleteClass(classId);
                    });
                });
                document.querySelectorAll('.view-schedules-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const classId = this.getAttribute('data-id');
                        viewClassSchedules(classId);
                    });
                });
            } catch (error) {
                console.error('Error loading classes:', error);
                const tableBody = document.querySelector('#classes-table tbody');
                if (tableBody) {
                    tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error loading classes</td></tr>';
                }
            }
        }
        // View class details
        async function viewClassDetails(classId) {
            try {
                const classObj = await apiService.getClassById(classId);
                
                // Create a modal to show class details
                const modalHtml = `
                    <div class="modal fade" id="classDetailsModal" tabindex="-1" aria-labelledby="classDetailsModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="classDetailsModalLabel">Class Details</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <strong>ID:</strong> ${classObj.id}
                                    </div>
                                    <div class="mb-3">
                                        <strong>Name:</strong> ${classObj.name}
                                    </div>
                                    <div class="mb-3">
                                        <strong>Description:</strong> ${classObj.description}
                                    </div>
                                    <div class="mb-3">
                                        <strong>Trainer:</strong> ${classObj.trainerName}
                                    </div>
                                    <div class="mb-3">
                                        <strong>Duration:</strong> ${classObj.duration} minutes
                                    </div>
                                    <div class="mb-3">
                                        <strong>Max Capacity:</strong> ${classObj.maxCapacity}
                                    </div>
                                    <div class="mb-3">
                                        <strong>Price:</strong> ${uiHelper.formatCurrency(classObj.price)}
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add modal to DOM
                const modalContainer = document.createElement('div');
                modalContainer.innerHTML = modalHtml;
                document.body.appendChild(modalContainer);
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('classDetailsModal'));
                modal.show();
                
                // Remove modal from DOM when hidden
                document.getElementById('classDetailsModal').addEventListener('hidden.bs.modal', function() {
                    document.body.removeChild(modalContainer);
                });
            } catch (error) {
                console.error('Error loading class details:', error);
                uiHelper.showAlert('Error loading class details', 'danger');
            }
        }
        // View class schedules
        async function viewClassSchedules(classId) {
            try {
                const classObj = await apiService.getClassById(classId);
                const schedules = await apiService.getClassSchedules(classId);
                
                // Create a modal to show class schedules
                const modalHtml = `
                    <div class="modal fade" id="classSchedulesModal" tabindex="-1" aria-labelledby="classSchedulesModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="classSchedulesModalLabel">Schedules for ${classObj.name}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="table-responsive">
                                        <table class="table table-bordered">
                                            <thead>
                                                <tr>
                                                    <th>ID</th>
                                                    <th>Start Time</th>
                                                    <th>End Time</th>
                                                    <th>Location</th>
                                                    <th>Available Slots</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${schedules.length === 0 ? 
                                                    '<tr><td colspan="6" class="text-center">No schedules found</td></tr>' :
                                                    schedules.map(schedule => `
                                                        <tr>
                                                            <td>${schedule.id}</td>
                                                            <td>${uiHelper.formatDate(schedule.startTime)}</td>
                                                            <td>${uiHelper.formatDate(schedule.endTime)}</td>
                                                            <td>${schedule.location}</td>
                                                            <td>${schedule.availableSlots} / ${schedule.maxCapacity}</td>
                                                            <td>
                                                                <div class="btn-group">
                                                                    <button class="btn btn-sm btn-outline-danger delete-schedule-btn" data-id="${schedule.id}" data-type="class">
                                                                        <i class="bi bi-trash"></i>
                                                                    </button>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    `).join('')
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add modal to DOM
                const modalContainer = document.createElement('div');
                modalContainer.innerHTML = modalHtml;
                document.body.appendChild(modalContainer);
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('classSchedulesModal'));
                modal.show();
                
                // Add event listeners to delete buttons
                modalContainer.querySelectorAll('.delete-schedule-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const scheduleId = this.getAttribute('data-id');
                        const type = this.getAttribute('data-type');
                        deleteSchedule(scheduleId, type);
                    });
                });
                
                // Remove modal from DOM when hidden
                document.getElementById('classSchedulesModal').addEventListener('hidden.bs.modal', function() {
                    document.body.removeChild(modalContainer);
                });
            } catch (error) {
                console.error('Error loading class schedules:', error);
                uiHelper.showAlert('Error loading class schedules', 'danger');
            }
        }
        // Delete class
        function deleteClass(classId) {
            uiHelper.confirm('Are you sure you want to delete this class? This action cannot be undone.', async function() {
                try {
                    await apiService.deleteClass(classId);
                    uiHelper.showAlert('Class deleted successfully', 'success');
                    loadClasses();
                } catch (error) {
                    console.error('Error deleting class:', error);
                    uiHelper.showAlert('Error deleting class', 'danger');
                }
            });
        }
        // Open class modal (create or edit)
        async function openClassModal(classId = null) {
            try {
                // Load trainers for the dropdown
                const trainers = await apiService.getTrainers();
                const trainerSelect = document.getElementById('class-trainer');
                if (!trainerSelect) return;
                
                trainerSelect.innerHTML = '<option value="">Select Trainer</option>';
                
                trainers.forEach(trainer => {
                    const option = document.createElement('option');
                    option.value = trainer.id;
                    option.textContent = trainer.name;
                    trainerSelect.appendChild(option);
                });
                
                // Reset form
                const classForm = document.getElementById('class-form');
                if (classForm) classForm.reset();
                
                const classIdInput = document.getElementById('class-id');
                if (classIdInput) classIdInput.value = '';
                
                const modalLabel = document.getElementById('classModalLabel');
                if (!modalLabel) return;
                
                if (classId) {
                    // Edit mode
                    modalLabel.textContent = 'Edit Class';
                    
                    // Load class data
                    const classObj = await apiService.getClassById(classId);
                    
                    if (classIdInput) classIdInput.value = classObj.id;
                    document.getElementById('class-name').value = classObj.name;
                    document.getElementById('class-description').value = classObj.description;
                    document.getElementById('class-trainer').value = classObj.trainerId;
                    document.getElementById('class-duration').value = classObj.duration;
                    document.getElementById('class-capacity').value = classObj.maxCapacity;
                    document.getElementById('class-price').value = classObj.price;
                } else {
                    // Create mode
                    modalLabel.textContent = 'Create New Class';
                }
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('classModal'));
                modal.show();
            } catch (error) {
                console.error('Error opening class modal:', error);
                uiHelper.showAlert('Error opening class modal', 'danger');
            }
        }
        // Save class
        async function saveClass() {
            try {
                const classIdInput = document.getElementById('class-id');
                const classId = classIdInput ? classIdInput.value : null;
                
                const classData = {
                    name: document.getElementById('class-name').value,
                    description: document.getElementById('class-description').value,
                    trainerId: parseInt(document.getElementById('class-trainer').value),
                    duration: parseInt(document.getElementById('class-duration').value),
                    maxCapacity: parseInt(document.getElementById('class-capacity').value),
                    price: parseFloat(document.getElementById('class-price').value)
                };
                
                // Validate form
                const classForm = document.getElementById('class-form');
                if (!formValidator.validateForm(classForm, {
                    'class-name': { required: true },
                    'class-description': { required: true },
                    'class-trainer': { required: true },
                    'class-duration': { required: true, min: 15 },
                    'class-capacity': { required: true, min: 1 },
                    'class-price': { required: true, min: 0 }
                })) {
                    return;
                }
                
                if (classId) {
                    // Update existing class
                    await apiService.updateClass(parseInt(classId), classData);
                    uiHelper.showAlert('Class updated successfully', 'success');
                } else {
                    // Create new class
                    await apiService.createClass(classData);
                    uiHelper.showAlert('Class created successfully', 'success');
                }
                
                // Hide modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('classModal'));
                if (modal) modal.hide();
                
                // Reload classes
                loadClasses();
            } catch (error) {
                console.error('Error saving class:', error);
                uiHelper.showAlert('Error saving class', 'danger');
            }
        }
        // Load online sessions
        async function loadSessions() {
            try {
                const sessions = await apiService.getSessions();
                
                const tableBody = document.querySelector('#sessions-table tbody');
                if (!tableBody) return;
                
                tableBody.innerHTML = '';
                
                if (sessions.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="7" class="text-center">No sessions found</td></tr>';
                    return;
                }
                
                sessions.forEach(session => {
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${session.id}</td>
                        <td>${session.name}</td>
                        <td>${session.description}</td>
                        <td>${session.trainerName}</td>
                        <td>${session.duration} min</td>
                        <td>${uiHelper.formatCurrency(session.price)}</td>
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-primary view-session-btn" data-id="${session.id}">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-secondary edit-session-btn" data-id="${session.id}">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger delete-session-btn" data-id="${session.id}">
                                    <i class="bi bi-trash"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-info view-session-schedules-btn" data-id="${session.id}">
                                    <i class="bi bi-calendar3"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                // Add event listeners
                document.querySelectorAll('.view-session-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const sessionId = this.getAttribute('data-id');
                        viewSessionDetails(sessionId);
                    });
                });
                document.querySelectorAll('.edit-session-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const sessionId = this.getAttribute('data-id');
                        openSessionModal(sessionId);
                    });
                });
                document.querySelectorAll('.delete-session-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const sessionId = this.getAttribute('data-id');
                        deleteSession(sessionId);
                    });
                });
                document.querySelectorAll('.view-session-schedules-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const sessionId = this.getAttribute('data-id');
                        viewSessionSchedules(sessionId);
                    });
                });
            } catch (error) {
                console.error('Error loading sessions:', error);
                const tableBody = document.querySelector('#sessions-table tbody');
                if (tableBody) {
                    tableBody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Error loading sessions</td></tr>';
                }
            }
        }
        // View session details
        async function viewSessionDetails(sessionId) {
            try {
                const session = await apiService.getSessionById(sessionId);
                
                // Create a modal to show session details
                const modalHtml = `
                    <div class="modal fade" id="sessionDetailsModal" tabindex="-1" aria-labelledby="sessionDetailsModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="sessionDetailsModalLabel">Online Session Details</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <strong>ID:</strong> ${session.id}
                                    </div>
                                    <div class="mb-3">
                                        <strong>Name:</strong> ${session.name}
                                    </div>
                                    <div class="mb-3">
                                        <strong>Description:</strong> ${session.description}
                                    </div>
                                    <div class="mb-3">
                                        <strong>Trainer:</strong> ${session.trainerName}
                                    </div>
                                    <div class="mb-3">
                                        <strong>Duration:</strong> ${session.duration} minutes
                                    </div>
                                    <div class="mb-3">
                                        <strong>Price:</strong> ${uiHelper.formatCurrency(session.price)}
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add modal to DOM
                const modalContainer = document.createElement('div');
                modalContainer.innerHTML = modalHtml;
                document.body.appendChild(modalContainer);
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('sessionDetailsModal'));
                modal.show();
                
                // Remove modal from DOM when hidden
                document.getElementById('sessionDetailsModal').addEventListener('hidden.bs.modal', function() {
                    document.body.removeChild(modalContainer);
                });
            } catch (error) {
                console.error('Error loading session details:', error);
                uiHelper.showAlert('Error loading session details', 'danger');
            }
        }
        // View session schedules
        async function viewSessionSchedules(sessionId) {
            try {
                const session = await apiService.getSessionById(sessionId);
                const schedules = await apiService.getSessionSchedules(sessionId);
                
                // Create a modal to show session schedules
                const modalHtml = `
                    <div class="modal fade" id="sessionSchedulesModal" tabindex="-1" aria-labelledby="sessionSchedulesModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="sessionSchedulesModalLabel">Schedules for ${session.name}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="table-responsive">
                                        <table class="table table-bordered">
                                            <thead>
                                                <tr>
                                                    <th>ID</th>
                                                    <th>Start Time</th>
                                                    <th>End Time</th>
                                                    <th>Available Slots</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${schedules.length === 0 ? 
                                                    '<tr><td colspan="5" class="text-center">No schedules found</td></tr>' :
                                                    schedules.map(schedule => `
                                                        <tr>
                                                            <td>${schedule.id}</td>
                                                            <td>${uiHelper.formatDate(schedule.startTime)}</td>
                                                            <td>${uiHelper.formatDate(schedule.endTime)}</td>
                                                            <td>${schedule.availableSlots} / ${schedule.maxSlots}</td>
                                                            <td>
                                                                <div class="btn-group">
                                                                    <button class="btn btn-sm btn-outline-danger delete-schedule-btn" data-id="${schedule.id}" data-type="session">
                                                                        <i class="bi bi-trash"></i>
                                                                    </button>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    `).join('')
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add modal to DOM
                const modalContainer = document.createElement('div');
                modalContainer.innerHTML = modalHtml;
                document.body.appendChild(modalContainer);
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('sessionSchedulesModal'));
                modal.show();
                
                // Add event listeners to delete buttons
                modalContainer.querySelectorAll('.delete-schedule-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const scheduleId = this.getAttribute('data-id');
                        const type = this.getAttribute('data-type');
                        deleteSchedule(scheduleId, type);
                    });
                });
                
                // Remove modal from DOM when hidden
                document.getElementById('sessionSchedulesModal').addEventListener('hidden.bs.modal', function() {
                    document.body.removeChild(modalContainer);
                });
            } catch (error) {
                console.error('Error loading session schedules:', error);
                uiHelper.showAlert('Error loading session schedules', 'danger');
            }
        }
        // Delete session
        function deleteSession(sessionId) {
            uiHelper.confirm('Are you sure you want to delete this session? This action cannot be undone.', async function() {
                try {
                    await apiService.deleteSession(sessionId);
                    uiHelper.showAlert('Session deleted successfully', 'success');
                    loadSessions();
                } catch (error) {
                    console.error('Error deleting session:', error);
                    uiHelper.showAlert('Error deleting session', 'danger');
                }
            });
        }
        // Delete schedule (class or session)
        function deleteSchedule(scheduleId, type) {
            uiHelper.confirm('Are you sure you want to delete this schedule? This action cannot be undone.', async function() {
                try {
                    if (type === 'class') {
                        await apiService.deleteClassSchedule(scheduleId);
                    } else {
                        await apiService.deleteSessionSchedule(scheduleId);
                    }
                    uiHelper.showAlert('Schedule deleted successfully', 'success');
                    
                    // Close the modal and reload the data
                    const modal = bootstrap.Modal.getInstance(
                        type === 'class' ? 
                        document.getElementById('classSchedulesModal') : 
                        document.getElementById('sessionSchedulesModal')
                    );
                    if (modal) modal.hide();
                    
                    if (type === 'class') {
                        loadClasses();
                    } else {
                        loadSessions();
                    }
                } catch (error) {
                    console.error('Error deleting schedule:', error);
                    uiHelper.showAlert('Error deleting schedule', 'danger');
                }
            });
        }
        // Open session modal (create or edit)
        async function openSessionModal(sessionId = null) {
            try {
                // Load trainers for the dropdown
                const trainers = await apiService.getTrainers();
                const trainerSelect = document.getElementById('session-trainer');
                if (!trainerSelect) return;
                
                trainerSelect.innerHTML = '<option value="">Select Trainer</option>';
                
                trainers.forEach(trainer => {
                    const option = document.createElement('option');
                    option.value = trainer.id;
                    option.textContent = trainer.name;
                    trainerSelect.appendChild(option);
                });
                
                // Reset form
                const sessionForm = document.getElementById('session-form');
                if (sessionForm) sessionForm.reset();
                
                const sessionIdInput = document.getElementById('session-id');
                if (sessionIdInput) sessionIdInput.value = '';
                
                const modalLabel = document.getElementById('sessionModalLabel');
                if (!modalLabel) return;
                
                if (sessionId) {
                    // Edit mode
                    modalLabel.textContent = 'Edit Online Session';
                    
                    // Load session data
                    const session = await apiService.getSessionById(sessionId);
                    
                    if (sessionIdInput) sessionIdInput.value = session.id;
                    document.getElementById('session-name').value = session.name;
                    document.getElementById('session-description').value = session.description;
                    document.getElementById('session-trainer').value = session.trainerId;
                    document.getElementById('session-duration').value = session.duration;
                    document.getElementById('session-price').value = session.price;
                } else {
                    // Create mode
                    modalLabel.textContent = 'Create New Online Session';
                }
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('sessionModal'));
                modal.show();
            } catch (error) {
                console.error('Error opening session modal:', error);
                uiHelper.showAlert('Error opening session modal', 'danger');
            }
        }
        // Save session
        async function saveSession() {
            try {
                const sessionIdInput = document.getElementById('session-id');
                const sessionId = sessionIdInput ? sessionIdInput.value : null;
                
                const sessionData = {
                    name: document.getElementById('session-name').value,
                    description: document.getElementById('session-description').value,
                    trainerId: parseInt(document.getElementById('session-trainer').value),
                    duration: parseInt(document.getElementById('session-duration').value),
                    price: parseFloat(document.getElementById('session-price').value)
                };
                
                // Validate form
                const sessionForm = document.getElementById('session-form');
                if (!formValidator.validateForm(sessionForm, {
                    'session-name': { required: true },
                    'session-description': { required: true },
                    'session-trainer': { required: true },
                    'session-duration': { required: true, min: 15 },
                    'session-price': { required: true, min: 0 }
                })) {
                    return;
                }
                
                if (sessionId) {
                    // Update existing session
                    await apiService.updateSession(parseInt(sessionId), sessionData);
                    uiHelper.showAlert('Session updated successfully', 'success');
                } else {
                    // Create new session
                    await apiService.createSession(sessionData);
                    uiHelper.showAlert('Session created successfully', 'success');
                }
                
                // Hide modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('sessionModal'));
                if (modal) modal.hide();
                
                // Reload sessions
                loadSessions();
            } catch (error) {
                console.error('Error saving session:', error);
                uiHelper.showAlert('Error saving session', 'danger');
            }
        }
        // Load trainers
        async function loadTrainers() {
            try {
                const trainers = await apiService.getTrainers();
                
                const tableBody = document.querySelector('#trainers-table tbody');
                if (!tableBody) return;
                
                tableBody.innerHTML = '';
                
                if (trainers.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="6" class="text-center">No trainers found</td></tr>';
                    return;
                }
                
                trainers.forEach(trainer => {
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${trainer.id}</td>
                        <td>${trainer.name}</td>
                        <td>${trainer.specialization}</td>
                        <td>${trainer.experienceYears} years</td>
                        <td>${trainer.certifications || 'N/A'}</td>
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-primary view-trainer-btn" data-id="${trainer.id}">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-secondary edit-trainer-btn" data-id="${trainer.id}">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger delete-trainer-btn" data-id="${trainer.id}">
                                    <i class="bi bi-trash"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-info view-trainer-classes-btn" data-id="${trainer.id}">
                                    <i class="bi bi-calendar-event"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-info view-trainer-sessions-btn" data-id="${trainer.id}">
                                    <i class="bi bi-laptop"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                // Add event listeners
                document.querySelectorAll('.view-trainer-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const trainerId = this.getAttribute('data-id');
                        viewTrainerDetails(trainerId);
                    });
                });
                document.querySelectorAll('.edit-trainer-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const trainerId = this.getAttribute('data-id');
                        openTrainerModal(trainerId);
                    });
                });
                document.querySelectorAll('.delete-trainer-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const trainerId = this.getAttribute('data-id');
                        deleteTrainer(trainerId);
                    });
                });
                document.querySelectorAll('.view-trainer-classes-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const trainerId = this.getAttribute('data-id');
                        viewTrainerClasses(trainerId);
                    });
                });
                document.querySelectorAll('.view-trainer-sessions-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const trainerId = this.getAttribute('data-id');
                        viewTrainerSessions(trainerId);
                    });
                });
            } catch (error) {
                console.error('Error loading trainers:', error);
                const tableBody = document.querySelector('#trainers-table tbody');
                if (tableBody) {
                    tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Error loading trainers</td></tr>';
                }
            }
        }
        // View trainer details
        async function viewTrainerDetails(trainerId) {
            try {
                const trainer = await apiService.getTrainerById(trainerId);
                
                // Create a modal to show trainer details
                const modalHtml = `
                    <div class="modal fade" id="trainerDetailsModal" tabindex="-1" aria-labelledby="trainerDetailsModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="trainerDetailsModalLabel">Trainer Details</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <strong>ID:</strong> ${trainer.id}
                                    </div>
                                    <div class="mb-3">
                                        <strong>Name:</strong> ${trainer.name}
                                    </div>
                                    <div class="mb-3">
                                        <strong>Specialization:</strong> ${trainer.specialization}
                                    </div>
                                    <div class="mb-3">
                                        <strong>Experience:</strong> ${trainer.experienceYears} years
                                    </div>
                                    <div class="mb-3">
                                        <strong>Certifications:</strong> ${trainer.certifications || 'N/A'}
                                    </div>
                                    <div class="mb-3">
                                        <strong>Bio:</strong> ${trainer.bio}
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add modal to DOM
                const modalContainer = document.createElement('div');
                modalContainer.innerHTML = modalHtml;
                document.body.appendChild(modalContainer);
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('trainerDetailsModal'));
                modal.show();
                
                // Remove modal from DOM when hidden
                document.getElementById('trainerDetailsModal').addEventListener('hidden.bs.modal', function() {
                    document.body.removeChild(modalContainer);
                });
            } catch (error) {
                console.error('Error loading trainer details:', error);
                uiHelper.showAlert('Error loading trainer details', 'danger');
            }
        }
        // View trainer classes
        async function viewTrainerClasses(trainerId) {
            try {
                const trainer = await apiService.getTrainerById(trainerId);
                const classes = await apiService.getTrainerClasses(trainerId);
                
                // Create a modal to show trainer classes
                const modalHtml = `
                    <div class="modal fade" id="trainerClassesModal" tabindex="-1" aria-labelledby="trainerClassesModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="trainerClassesModalLabel">Classes by ${trainer.name}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="table-responsive">
                                        <table class="table table-bordered">
                                            <thead>
                                                <tr>
                                                    <th>ID</th>
                                                    <th>Name</th>
                                                    <th>Description</th>
                                                    <th>Duration</th>
                                                    <th>Capacity</th>
                                                    <th>Price</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${classes.length === 0 ? 
                                                    '<tr><td colspan="6" class="text-center">No classes found</td></tr>' :
                                                    classes.map(classObj => `
                                                        <tr>
                                                            <td>${classObj.id}</td>
                                                            <td>${classObj.name}</td>
                                                            <td>${classObj.description}</td>
                                                            <td>${classObj.duration} min</td>
                                                            <td>${classObj.maxCapacity}</td>
                                                            <td>${uiHelper.formatCurrency(classObj.price)}</td>
                                                        </tr>
                                                    `).join('')
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add modal to DOM
                const modalContainer = document.createElement('div');
                modalContainer.innerHTML = modalHtml;
                document.body.appendChild(modalContainer);
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('trainerClassesModal'));
                modal.show();
                
                // Remove modal from DOM when hidden
                document.getElementById('trainerClassesModal').addEventListener('hidden.bs.modal', function() {
                    document.body.removeChild(modalContainer);
                });
            } catch (error) {
                console.error('Error loading trainer classes:', error);
                uiHelper.showAlert('Error loading trainer classes', 'danger');
            }
        }
        // View trainer sessions
        async function viewTrainerSessions(trainerId) {
            try {
                const trainer = await apiService.getTrainerById(trainerId);
                const sessions = await apiService.getTrainerSessions(trainerId);
                
                // Create a modal to show trainer sessions
                const modalHtml = `
                    <div class="modal fade" id="trainerSessionsModal" tabindex="-1" aria-labelledby="trainerSessionsModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="trainerSessionsModalLabel">Online Sessions by ${trainer.name}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="table-responsive">
                                        <table class="table table-bordered">
                                            <thead>
                                                <tr>
                                                    <th>ID</th>
                                                    <th>Name</th>
                                                    <th>Description</th>
                                                    <th>Duration</th>
                                                    <th>Price</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${sessions.length === 0 ? 
                                                    '<tr><td colspan="5" class="text-center">No sessions found</td></tr>' :
                                                    sessions.map(session => `
                                                        <tr>
                                                            <td>${session.id}</td>
                                                            <td>${session.name}</td>
                                                            <td>${session.description}</td>
                                                            <td>${session.duration} min</td>
                                                            <td>${uiHelper.formatCurrency(session.price)}</td>
                                                        </tr>
                                                    `).join('')
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add modal to DOM
                const modalContainer = document.createElement('div');
                modalContainer.innerHTML = modalHtml;
                document.body.appendChild(modalContainer);
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('trainerSessionsModal'));
                modal.show();
                
                // Remove modal from DOM when hidden
                document.getElementById('trainerSessionsModal').addEventListener('hidden.bs.modal', function() {
                    document.body.removeChild(modalContainer);
                });
            } catch (error) {
                console.error('Error loading trainer sessions:', error);
                uiHelper.showAlert('Error loading trainer sessions', 'danger');
            }
        }
        // Delete trainer
        function deleteTrainer(trainerId) {
            uiHelper.confirm('Are you sure you want to delete this trainer? This action cannot be undone.', async function() {
                try {
                    await apiService.deleteTrainer(trainerId);
                    uiHelper.showAlert('Trainer deleted successfully', 'success');
                    loadTrainers();
                } catch (error) {
                    console.error('Error deleting trainer:', error);
                    uiHelper.showAlert('Error deleting trainer', 'danger');
                }
            });
        }
        // Open trainer modal (create or edit)
        async function openTrainerModal(trainerId = null) {
    try {
        // Reset form
        const trainerForm = document.getElementById('trainer-form');
        if (trainerForm) trainerForm.reset();
        
        const trainerIdInput = document.getElementById('trainer-id');
        if (trainerIdInput) trainerIdInput.value = '';
        
        // Clear image preview
        const imagePreview = document.getElementById('trainer-image-preview');
        if (imagePreview) imagePreview.innerHTML = '';
        
        const modalLabel = document.getElementById('trainerModalLabel');
        if (!modalLabel) return;
        
        if (trainerId) {
            // Edit mode
            modalLabel.textContent = 'Edit Trainer';
            
            // Load trainer data
            const trainer = await apiService.getTrainerById(trainerId);
            
            if (trainerIdInput) trainerIdInput.value = trainer.id;
            document.getElementById('trainer-name').value = trainer.name;
            document.getElementById('trainer-specialization').value = trainer.specialization;
            document.getElementById('trainer-experience').value = trainer.experienceYears;
            document.getElementById('trainer-certifications').value = trainer.certifications || '';
            document.getElementById('trainer-bio').value = trainer.bio;
            
            // Show existing image if available
            if (trainer.imageUrl) {
                imagePreview.innerHTML = `<img src="${trainer.imageUrl}" class="img-thumbnail" style="max-width: 200px;">`;
            }
        } else {
            // Create mode
            modalLabel.textContent = 'Create New Trainer';
        }
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('trainerModal'));
        modal.show();
    } catch (error) {
        console.error('Error opening trainer modal:', error);
        uiHelper.showAlert('Error opening trainer modal: ' + error.message, 'danger');
    }
}

        // Save trainer
       async function saveTrainer() {
    try {
        const trainerIdInput = document.getElementById('trainer-id');
        const trainerId = trainerIdInput ? trainerIdInput.value : null;
        
        const trainerData = {
            name: document.getElementById('trainer-name').value,
            specialization: document.getElementById('trainer-specialization').value,
            experienceYears: parseInt(document.getElementById('trainer-experience').value),
            certifications: document.getElementById('trainer-certifications').value,
            bio: document.getElementById('trainer-bio').value
        };
        
        // Get the image file if provided
        const imageFileInput = document.getElementById('trainer-image-file');
        const imageFile = imageFileInput && imageFileInput.files.length > 0 ? imageFileInput.files[0] : null;

        if (trainerId) {
            // Update existing trainer
            await apiService.updateTrainer(parseInt(trainerId), trainerData, imageFile);
            uiHelper.showAlert('Trainer updated successfully', 'success');
        } else {
            // Create new trainer
            await apiService.createTrainer(trainerData, imageFile);
            uiHelper.showAlert('Trainer created successfully', 'success');
        }
        
        // Hide modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('trainerModal'));
        if (modal) modal.hide();
        
        // Reload trainers
        loadTrainers();
    } catch (error) {
        console.error('Error saving trainer:', error);
        uiHelper.showAlert('Error saving trainer: ' + error.message, 'danger');
    }
}


        // Load membership types
        async function loadMemberships() {
            try {
                const memberships = await apiService.getMembershipTypes();
                
                const tableBody = document.querySelector('#memberships-table tbody');
                if (!tableBody) return;
                
                tableBody.innerHTML = '';
                
                if (memberships.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="8" class="text-center">No membership types found</td></tr>';
                    return;
                }
                
                memberships.forEach(membership => {
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${membership.id}</td>
                        <td>${membership.name}</td>
                        <td>${membership.description}</td>
                        <td>${membership.durationMonths} months</td>
                        <td>${membership.totalHours} hours</td>
                        <td>${uiHelper.formatCurrency(membership.price)}</td>
                        <td>
                            <span class="badge ${membership.isActive ? 'bg-success' : 'bg-secondary'}">
                                ${membership.isActive ? 'Active' : 'Inactive'}
                            </span>
                        </td>
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-primary view-membership-btn" data-id="${membership.id}">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-secondary edit-membership-btn" data-id="${membership.id}">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger delete-membership-btn" data-id="${membership.id}">
                                    <i class="bi bi-trash"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-info toggle-membership-btn" data-id="${membership.id}" data-active="${membership.isActive}">
                                    <i class="bi bi-${membership.isActive ? 'toggle-on' : 'toggle-off'}"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                // Add event listeners
                document.querySelectorAll('.view-membership-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const membershipId = this.getAttribute('data-id');
                        viewMembershipDetails(membershipId);
                    });
                });
                document.querySelectorAll('.edit-membership-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const membershipId = this.getAttribute('data-id');
                        openMembershipModal(membershipId);
                    });
                });
                document.querySelectorAll('.delete-membership-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const membershipId = this.getAttribute('data-id');
                        deleteMembership(membershipId);
                    });
                });
                document.querySelectorAll('.toggle-membership-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const membershipId = this.getAttribute('data-id');
                        const isActive = this.getAttribute('data-active') === 'true';
                        toggleMembershipStatus(membershipId, !isActive);
                    });
                });
            } catch (error) {
                console.error('Error loading membership types:', error);
                const tableBody = document.querySelector('#memberships-table tbody');
                if (tableBody) {
                    tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error loading membership types</td></tr>';
                }
            }
        }
        // View membership details
        async function viewMembershipDetails(membershipId) {
            try {
                const membership = await apiService.getMembershipTypeById(membershipId);
                
                // Create a modal to show membership details
                const modalHtml = `
                    <div class="modal fade" id="membershipDetailsModal" tabindex="-1" aria-labelledby="membershipDetailsModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="membershipDetailsModalLabel">Membership Type Details</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <strong>ID:</strong> ${membership.id}
                                    </div>
                                    <div class="mb-3">
                                        <strong>Name:</strong> ${membership.name}
                                    </div>
                                    <div class="mb-3">
                                        <strong>Description:</strong> ${membership.description}
                                    </div>
                                    <div class="mb-3">
                                        <strong>Duration:</strong> ${membership.durationMonths} months
                                    </div>
                                    <div class="mb-3">
                                        <strong>Total Hours:</strong> ${membership.totalHours}
                                    </div>
                                    <div class="mb-3">
                                        <strong>Price:</strong> ${uiHelper.formatCurrency(membership.price)}
                                    </div>
                                    <div class="mb-3">
                                        <strong>Status:</strong> 
                                        <span class="badge ${membership.isActive ? 'bg-success' : 'bg-secondary'}">
                                            ${membership.isActive ? 'Active' : 'Inactive'}
                                        </span>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add modal to DOM
                const modalContainer = document.createElement('div');
                modalContainer.innerHTML = modalHtml;
                document.body.appendChild(modalContainer);
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('membershipDetailsModal'));
                modal.show();
                
                // Remove modal from DOM when hidden
                document.getElementById('membershipDetailsModal').addEventListener('hidden.bs.modal', function() {
                    document.body.removeChild(modalContainer);
                });
            } catch (error) {
                console.error('Error loading membership details:', error);
                uiHelper.showAlert('Error loading membership details', 'danger');
            }
        }
        // Delete membership type
        function deleteMembership(membershipId) {
            uiHelper.confirm('Are you sure you want to delete this membership type? This action cannot be undone.', async function() {
                try {
                    await apiService.deleteMembershipType(membershipId);
                    uiHelper.showAlert('Membership type deleted successfully', 'success');
                    loadMemberships();
                } catch (error) {
                    console.error('Error deleting membership type:', error);
                    uiHelper.showAlert('Error deleting membership type', 'danger');
                }
            });
        }
        // Toggle membership status
        async function toggleMembershipStatus(membershipId, isActive) {
            try {
                await apiService.toggleMembershipTypeStatus(membershipId, isActive);
                uiHelper.showAlert(`Membership type ${isActive ? 'activated' : 'deactivated'} successfully`, 'success');
                loadMemberships();
            } catch (error) {
                console.error('Error toggling membership status:', error);
                uiHelper.showAlert('Error toggling membership status', 'danger');
            }
        }
        // Open membership modal (create or edit)
        async function openMembershipModal(membershipId = null) {
    try {
        // Reset form
        const membershipForm = document.getElementById('membership-form');
        if (membershipForm) membershipForm.reset();
        
        const membershipIdInput = document.getElementById('membership-id');
        if (membershipIdInput) membershipIdInput.value = '';
        
        const modalLabel = document.getElementById('membershipModalLabel');
        if (!modalLabel) return;
        
        if (membershipId) {
            // Edit mode
            modalLabel.textContent = 'Edit Membership Type';
            
            try {
                // Load membership data
                const membership = await apiService.getMembershipTypeById(membershipId);
                
                if (membershipIdInput) membershipIdInput.value = membership.id;
                document.getElementById('membership-name').value = membership.name;
                document.getElementById('membership-description').value = membership.description;
                document.getElementById('membership-duration').value = membership.durationMonths;
                document.getElementById('membership-hours').value = membership.totalHours;
                document.getElementById('membership-price').value = membership.price;
                document.getElementById('membership-active').checked = membership.isActive;
            } catch (error) {
                uiHelper.showAlert('Membership type not found', 'danger');
                return;
            }
        } else {
            // Create mode
            modalLabel.textContent = 'Create New Membership Type';
        }
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('membershipModal'));
        modal.show();
    } catch (error) {
        console.error('Error opening membership modal:', error);
        uiHelper.showAlert('Error opening membership modal: ' + error.message, 'danger');
    }
}

        // Save membership type
        async function saveMembership() {
            try {
                const membershipIdInput = document.getElementById('membership-id');
                const membershipId = membershipIdInput ? membershipIdInput.value : null;
                
                const membershipData = {
                    name: document.getElementById('membership-name').value,
                    description: document.getElementById('membership-description').value,
                    durationMonths: parseInt(document.getElementById('membership-duration').value),
                    totalHours: parseFloat(document.getElementById('membership-hours').value),
                    price: parseFloat(document.getElementById('membership-price').value),
                    isActive: document.getElementById('membership-active').checked
                };
                
                // Validate form
                const membershipForm = document.getElementById('membership-form');
                if (!formValidator.validateForm(membershipForm, {
                    'membership-name': { required: true },
                    'membership-description': { required: true },
                    'membership-duration': { required: true, min: 1 },
                    'membership-hours': { required: true, min: 1 },
                    'membership-price': { required: true, min: 0 }
                })) {
                    return;
                }
                
                if (membershipId) {
                    // Update existing membership type
                    await apiService.updateMembershipType(parseInt(membershipId), membershipData);
                    uiHelper.showAlert('Membership type updated successfully', 'success');
                } else {
                    // Create new membership type
                    await apiService.createMembershipType(membershipData);
                    uiHelper.showAlert('Membership type created successfully', 'success');
                }
                
                // Hide modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('membershipModal'));
                if (modal) modal.hide();
                
                // Reload membership types
                loadMemberships();
            } catch (error) {
                console.error('Error saving membership type:', error);
                uiHelper.showAlert('Error saving membership type', 'danger');
            }
        }
        // Load products
        async function loadProducts() {
            try {
                const products = await apiService.getProducts();
                
                const tableBody = document.querySelector('#products-table tbody');
                if (!tableBody) return;
                
                tableBody.innerHTML = '';
                
                if (products.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="7" class="text-center">No products found</td></tr>';
                    return;
                }
                
                products.forEach(product => {
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${product.id}</td>
                        <td>${product.name}</td>
                        <td>${product.description}</td>
                        <td>${product.category}</td>
                        <td>${uiHelper.formatCurrency(product.price)}</td>
                        <td>
                            <span class="badge ${product.stockQuantity <= 5 ? 'bg-danger' : 'bg-success'}">
                                ${product.stockQuantity}
                            </span>
                        </td>
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-primary view-product-btn" data-id="${product.id}">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-secondary edit-product-btn" data-id="${product.id}">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger delete-product-btn" data-id="${product.id}">
                                    <i class="bi bi-trash"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-info update-product-stock-btn" data-id="${product.id}" data-stock="${product.stockQuantity}">
                                    <i class="bi bi-box-seam"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                // Add event listeners
                document.querySelectorAll('.view-product-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const productId = this.getAttribute('data-id');
                        viewProductDetails(productId);
                    });
                });
                document.querySelectorAll('.edit-product-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const productId = this.getAttribute('data-id');
                        openProductModal(productId);
                    });
                });
                document.querySelectorAll('.delete-product-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const productId = this.getAttribute('data-id');
                        deleteProduct(productId);
                    });
                });
                document.querySelectorAll('.update-product-stock-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const productId = this.getAttribute('data-id');
                        const currentStock = this.getAttribute('data-stock');
                        updateProductStockInline(productId, currentStock);
                    });
                });
            } catch (error) {
                console.error('Error loading products:', error);
                const tableBody = document.querySelector('#products-table tbody');
                if (tableBody) {
                    tableBody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Error loading products</td></tr>';
                }
            }
        }
        // View product details
        async function viewProductDetails(productId) {
            try {
                const product = await apiService.getProductById(productId);
                
                // Create a modal to show product details
                const modalHtml = `
                    <div class="modal fade" id="productDetailsModal" tabindex="-1" aria-labelledby="productDetailsModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="productDetailsModalLabel">Product Details</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <strong>ID:</strong> ${product.id}
                                    </div>
                                    <div class="mb-3">
                                        <strong>Name:</strong> ${product.name}
                                    </div>
                                    <div class="mb-3">
                                        <strong>Description:</strong> ${product.description}
                                    </div>
                                    <div class="mb-3">
                                        <strong>Category:</strong> ${product.category}
                                    </div>
                                    <div class="mb-3">
                                        <strong>Price:</strong> ${uiHelper.formatCurrency(product.price)}
                                    </div>
                                    <div class="mb-3">
                                        <strong>Stock Quantity:</strong> ${product.stockQuantity}
                                    </div>
                                    ${product.imageUrl ? `
                                        <div class="mb-3">
                                            <strong>Image:</strong><br>
                                            <img src="${product.imageUrl}" alt="${product.name}" class="img-thumbnail" style="max-width: 200px;">
                                        </div>
                                    ` : ''}
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add modal to DOM
                const modalContainer = document.createElement('div');
                modalContainer.innerHTML = modalHtml;
                document.body.appendChild(modalContainer);
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('productDetailsModal'));
                modal.show();
                
                // Remove modal from DOM when hidden
                document.getElementById('productDetailsModal').addEventListener('hidden.bs.modal', function() {
                    document.body.removeChild(modalContainer);
                });
            } catch (error) {
                console.error('Error loading product details:', error);
                uiHelper.showAlert('Error loading product details', 'danger');
            }
        }
        // Delete product
        function deleteProduct(productId) {
            uiHelper.confirm('Are you sure you want to delete this product? This action cannot be undone.', async function() {
                try {
                    await apiService.deleteProduct(productId);
                    uiHelper.showAlert('Product deleted successfully', 'success');
                    loadProducts();
                } catch (error) {
                    console.error('Error deleting product:', error);
                    uiHelper.showAlert('Error deleting product', 'danger');
                }
            });
        }
        // Update product stock inline
        function updateProductStockInline(productId, currentStock) {
            const newStock = prompt(`Enter new stock quantity (current: ${currentStock}):`);
            if (newStock !== null && !isNaN(newStock) && newStock >= 0) {
                updateProductStock(productId, parseInt(newStock));
            }
        }
        // Open product modal (create or edit)
        async function openProductModal(productId = null) {
    try {
        // Reset form
        const productForm = document.getElementById('product-form');
        if (productForm) productForm.reset();
        
        const productIdInput = document.getElementById('product-id');
        if (productIdInput) productIdInput.value = '';
        
        // Clear image preview
        const imagePreview = document.getElementById('product-image-preview');
        if (imagePreview) imagePreview.innerHTML = '';
        
        const modalLabel = document.getElementById('productModalLabel');
        if (!modalLabel) return;
        
        if (productId) {
            // Edit mode
            modalLabel.textContent = 'Edit Product';
            
            // Load product data
            const product = await apiService.getProductById(productId);
            
            if (productIdInput) productIdInput.value = product.id;
            document.getElementById('product-name').value = product.name;
            document.getElementById('product-description').value = product.description;
            document.getElementById('product-category').value = product.category;
            document.getElementById('product-price').value = product.price;
            document.getElementById('product-stock').value = product.stockQuantity;
            
            // Show existing image if available
            if (product.imageUrl) {
                imagePreview.innerHTML = `<img src="${product.imageUrl}" class="img-thumbnail" style="max-width: 200px;">`;
            }
        } else {
            // Create mode
            modalLabel.textContent = 'Create New Product';
        }
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('productModal'));
        modal.show();
    } catch (error) {
        console.error('Error opening product modal:', error);
        uiHelper.showAlert('Error opening product modal: ' + error.message, 'danger');
    }
}
        
        // Save product
        async function saveProduct() {
    try {
        const productIdInput = document.getElementById('product-id');
        const productId = productIdInput ? productIdInput.value : null;
        
        const productData = {
            name: document.getElementById('product-name').value,
            description: document.getElementById('product-description').value,
            category: document.getElementById('product-category').value,
            price: parseFloat(document.getElementById('product-price').value),
            stockQuantity: parseInt(document.getElementById('product-stock').value),
            imageUrl: document.getElementById('product-image').value
        };
        
        // Validate form
        const productForm = document.getElementById('product-form');
        if (!formValidator.validateForm(productForm, {
            'product-name': { required: true },
            'product-description': { required: true },
            'product-category': { required: true },
            'product-price': { required: true, min: 0 },
            'product-stock': { required: true, min: 0 }
        })) {
            return;
        }
        
        if (productId) {
            // Update existing product
            await apiService.updateProduct(parseInt(productId), productData);
            uiHelper.showAlert('Product updated successfully', 'success');
        } else {
            // Create new product
            await apiService.createProduct(productData);
            uiHelper.showAlert('Product created successfully', 'success');
        }
        
        // Hide modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('productModal'));
        if (modal) modal.hide();
        
        // Reload products
        loadProducts();
    } catch (error) {
        console.error('Error saving product:', error);
        uiHelper.showAlert('Error saving product: ' + error.message, 'danger');
    }
}

        // Load promotions
        async function loadPromotions() {
            try {
                const promotions = await apiService.getPromotions();
                
                const tableBody = document.querySelector('#promotions-table tbody');
                if (!tableBody) return;
                
                tableBody.innerHTML = '';
                
                if (promotions.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="8" class="text-center">No promotions found</td></tr>';
                    return;
                }
                
                promotions.forEach(promotion => {
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${promotion.id}</td>
                        <td>${promotion.code}</td>
                        <td>${promotion.description}</td>
                        <td>${promotion.discountType === 'Percentage' ? `${promotion.discountValue}%` : `$${promotion.discountValue}`}</td>
                        <td>${uiHelper.formatDate(promotion.startDate)}</td>
                        <td>${uiHelper.formatDate(promotion.endDate)}</td>
                        <td>${promotion.timesUsed} / ${promotion.usageLimit}</td>
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-primary view-promotion-btn" data-id="${promotion.id}">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-secondary edit-promotion-btn" data-id="${promotion.id}">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger delete-promotion-btn" data-id="${promotion.id}">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                // Add event listeners
                document.querySelectorAll('.view-promotion-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const promotionId = this.getAttribute('data-id');
                        viewPromotionDetails(promotionId);
                    });
                });
                document.querySelectorAll('.edit-promotion-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const promotionId = this.getAttribute('data-id');
                        openPromotionModal(promotionId);
                    });
                });
                document.querySelectorAll('.delete-promotion-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const promotionId = this.getAttribute('data-id');
                        deletePromotion(promotionId);
                    });
                });
            } catch (error) {
                console.error('Error loading promotions:', error);
                const tableBody = document.querySelector('#promotions-table tbody');
                if (tableBody) {
                    tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error loading promotions</td></tr>';
                }
            }
        }
        // View promotion details
        async function viewPromotionDetails(promotionId) {
            try {
                const promotion = await apiService.getPromotionById(promotionId);
                
                // Create a modal to show promotion details
                const modalHtml = `
                    <div class="modal fade" id="promotionDetailsModal" tabindex="-1" aria-labelledby="promotionDetailsModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="promotionDetailsModalLabel">Promotion Details</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <strong>ID:</strong> ${promotion.id}
                                    </div>
                                    <div class="mb-3">
                                        <strong>Code:</strong> ${promotion.code}
                                    </div>
                                    <div class="mb-3">
                                        <strong>Description:</strong> ${promotion.description}
                                    </div>
                                    <div class="mb-3">
                                        <strong>Discount Type:</strong> ${promotion.discountType}
                                    </div>
                                    <div class="mb-3">
                                        <strong>Discount Value:</strong> ${promotion.discountType === 'Percentage' ? `${promotion.discountValue}%` : `$${promotion.discountValue}`}
                                    </div>
                                    <div class="mb-3">
                                        <strong>Start Date:</strong> ${uiHelper.formatDate(promotion.startDate)}
                                    </div>
                                    <div class="mb-3">
                                        <strong>End Date:</strong> ${uiHelper.formatDate(promotion.endDate)}
                                    </div>
                                    <div class="mb-3">
                                        <strong>Usage Limit:</strong> ${promotion.usageLimit}
                                    </div>
                                    <div class="mb-3">
                                        <strong>Times Used:</strong> ${promotion.timesUsed}
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add modal to DOM
                const modalContainer = document.createElement('div');
                modalContainer.innerHTML = modalHtml;
                document.body.appendChild(modalContainer);
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('promotionDetailsModal'));
                modal.show();
                
                // Remove modal from DOM when hidden
                document.getElementById('promotionDetailsModal').addEventListener('hidden.bs.modal', function() {
                    document.body.removeChild(modalContainer);
                });
            } catch (error) {
                console.error('Error loading promotion details:', error);
                uiHelper.showAlert('Error loading promotion details', 'danger');
            }
        }
        // Delete promotion
        function deletePromotion(promotionId) {
            uiHelper.confirm('Are you sure you want to delete this promotion? This action cannot be undone.', async function() {
                try {
                    await apiService.deletePromotion(promotionId);
                    uiHelper.showAlert('Promotion deleted successfully', 'success');
                    loadPromotions();
                } catch (error) {
                    console.error('Error deleting promotion:', error);
                    uiHelper.showAlert('Error deleting promotion', 'danger');
                }
            });
        }
        // Open promotion modal (create or edit)
        async function openPromotionModal(promotionId = null) {
            try {
                // Reset form
                const promotionForm = document.getElementById('promotion-form');
                if (promotionForm) promotionForm.reset();
                
                const promotionIdInput = document.getElementById('promotion-id');
                if (promotionIdInput) promotionIdInput.value = '';
                
                const modalLabel = document.getElementById('promotionModalLabel');
                if (!modalLabel) return;
                
                if (promotionId) {
                    // Edit mode
                    modalLabel.textContent = 'Edit Promotion';
                    
                    // Load promotion data
                    const promotion = await apiService.getPromotionById(promotionId);
                    
                    if (promotionIdInput) promotionIdInput.value = promotion.id;
                    document.getElementById('promotion-code').value = promotion.code;
                    document.getElementById('promotion-description').value = promotion.description;
                    document.getElementById('promotion-type').value = promotion.discountType;
                    document.getElementById('promotion-value').value = promotion.discountValue;
                    document.getElementById('promotion-start').value = utils.formatDateForInput(new Date(promotion.startDate));
                    document.getElementById('promotion-end').value = utils.formatDateForInput(new Date(promotion.endDate));
                    document.getElementById('promotion-limit').value = promotion.usageLimit;
                } else {
                    // Create mode
                    modalLabel.textContent = 'Create New Promotion';
                    
                    // Set default dates
                    const today = new Date();
                    const nextMonth = new Date();
                    nextMonth.setMonth(today.getMonth() + 1);
                    
                    document.getElementById('promotion-start').value = utils.formatDateForInput(today);
                    document.getElementById('promotion-end').value = utils.formatDateForInput(nextMonth);
                }
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('promotionModal'));
                modal.show();
            } catch (error) {
                console.error('Error opening promotion modal:', error);
                uiHelper.showAlert('Error opening promotion modal', 'danger');
            }
        }
        // Save promotion
        async function savePromotion() {
            try {
                const promotionIdInput = document.getElementById('promotion-id');
                const promotionId = promotionIdInput ? promotionIdInput.value : null;
                
                const promotionData = {
                    code: document.getElementById('promotion-code').value,
                    description: document.getElementById('promotion-description').value,
                    discountType: document.getElementById('promotion-type').value,
                    discountValue: parseFloat(document.getElementById('promotion-value').value),
                    startDate: new Date(document.getElementById('promotion-start').value),
                    endDate: new Date(document.getElementById('promotion-end').value),
                    usageLimit: parseInt(document.getElementById('promotion-limit').value)
                };
                
                // Validate form
                const promotionForm = document.getElementById('promotion-form');
                if (!formValidator.validateForm(promotionForm, {
                    'promotion-code': { required: true },
                    'promotion-description': { required: true },
                    'promotion-type': { required: true },
                    'promotion-value': { required: true, min: 0 },
                    'promotion-start': { required: true },
                    'promotion-end': { required: true },
                    'promotion-limit': { required: true, min: 1 }
                })) {
                    return;
                }
                
                // Validate date range
                if (promotionData.startDate >= promotionData.endDate) {
                    uiHelper.showAlert('End date must be after start date', 'danger');
                    return;
                }
                
                if (promotionId) {
                    // Update existing promotion
                    await apiService.updatePromotion(parseInt(promotionId), promotionData);
                    uiHelper.showAlert('Promotion updated successfully', 'success');
                } else {
                    // Create new promotion
                    await apiService.createPromotion(promotionData);
                    uiHelper.showAlert('Promotion created successfully', 'success');
                }
                
                // Hide modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('promotionModal'));
                if (modal) modal.hide();
                
                // Reload promotions
                loadPromotions();
            } catch (error) {
                console.error('Error saving promotion:', error);
                uiHelper.showAlert('Error saving promotion', 'danger');
            }
        }
        // Load orders
        async function loadOrders() {
            try {
                const ordersStatusFilter = document.getElementById('orders-status-filter');
                const status = ordersStatusFilter ? ordersStatusFilter.value : null;
                
                let orders = await apiService.getAllOrders();
                
                // Filter by status if selected
                if (status) {
                    orders = orders.filter(order => order.status === status);
                }
                
                const tableBody = document.querySelector('#orders-table tbody');
                if (!tableBody) return;
                
                tableBody.innerHTML = '';
                
                if (orders.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="6" class="text-center">No orders found</td></tr>';
                    return;
                }
                
                orders.forEach(order => {
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${order.id}</td>
                        <td>${order.userName}</td>
                        <td>${uiHelper.formatDate(order.orderDate)}</td>
                        <td>${uiHelper.formatCurrency(order.totalAmount)}</td>
                        <td>
                            <span class="badge ${
                                order.status === 'Completed' ? 'bg-success' : 
                                order.status === 'Pending' ? 'bg-warning' : 'bg-danger'
                            }">
                                ${order.status}
                            </span>
                        </td>
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-primary view-order-btn" data-id="${order.id}">
                                    <i class="bi bi-eye"></i>
                                </button>
                                ${order.status !== 'Completed' && order.status !== 'Cancelled' ? `
                                    <button class="btn btn-sm btn-outline-secondary update-order-status-btn" data-id="${order.id}">
                                        <i class="bi bi-arrow-repeat"></i>
                                    </button>
                                ` : ''}
                                ${order.status !== 'Cancelled' ? `
                                    <button class="btn btn-sm btn-outline-danger cancel-order-btn" data-id="${order.id}">
                                        <i class="bi bi-x-circle"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                // Add event listeners
                document.querySelectorAll('.view-order-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const orderId = this.getAttribute('data-id');
                        viewOrderDetails(orderId);
                    });
                });
                document.querySelectorAll('.update-order-status-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const orderId = this.getAttribute('data-id');
                        updateOrderStatus(orderId);
                    });
                });
                document.querySelectorAll('.cancel-order-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const orderId = this.getAttribute('data-id');
                        cancelOrder(orderId);
                    });
                });
            } catch (error) {
                console.error('Error loading orders:', error);
                const tableBody = document.querySelector('#orders-table tbody');
                if (tableBody) {
                    tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Error loading orders</td></tr>';
                }
            }
        }
        // View order details
        async function viewOrderDetails(orderId) {
            try {
                const order = await apiService.getOrderById(orderId);
                
                // Create a modal to show order details
                let itemsHtml = '';
                order.orderItems.forEach(item => {
                    itemsHtml += `
                        <tr>
                            <td>${item.productName}</td>
                            <td>${item.quantity}</td>
                            <td>${uiHelper.formatCurrency(item.price)}</td>
                            <td>${uiHelper.formatCurrency(item.totalPrice)}</td>
                        </tr>
                    `;
                });
                
                const modalHtml = `
                    <div class="modal fade" id="orderDetailsModal" tabindex="-1" aria-labelledby="orderDetailsModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="orderDetailsModalLabel">Order Details</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <strong>Order ID:</strong> ${order.id}
                                        </div>
                                        <div class="col-md-6">
                                            <strong>Order Date:</strong> ${uiHelper.formatDate(order.orderDate)}
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <strong>Customer:</strong> ${order.userName}
                                        </div>
                                        <div class="col-md-6">
                                            <strong>Status:</strong> 
                                            <span class="badge ${
                                                order.status === 'Completed' ? 'bg-success' : 
                                                order.status === 'Pending' ? 'bg-warning' : 'bg-danger'
                                            }">
                                                ${order.status}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-md-12">
                                            <strong>Total Amount:</strong> ${uiHelper.formatCurrency(order.totalAmount)}
                                        </div>
                                    </div>
                                    <h6 class="mt-4 mb-3">Order Items</h6>
                                    <div class="table-responsive">
                                        <table class="table table-bordered">
                                            <thead>
                                                <tr>
                                                    <th>Product</th>
                                                    <th>Quantity</th>
                                                    <th>Price</th>
                                                    <th>Total</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${itemsHtml}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add modal to DOM
                const modalContainer = document.createElement('div');
                modalContainer.innerHTML = modalHtml;
                document.body.appendChild(modalContainer);
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('orderDetailsModal'));
                modal.show();
                
                // Remove modal from DOM when hidden
                document.getElementById('orderDetailsModal').addEventListener('hidden.bs.modal', function() {
                    document.body.removeChild(modalContainer);
                });
            } catch (error) {
                console.error('Error loading order details:', error);
                uiHelper.showAlert('Error loading order details', 'danger');
            }
        }
        // Update order status
        function updateOrderStatus(orderId) {
            const statuses = ['Pending', 'Completed', 'Cancelled'];
            const currentStatus = ''; // This would need to be fetched from the order
            
            // Create a simple select dropdown for status update
            const statusOptions = statuses.map(status => 
                `<option value="${status}" ${status === currentStatus ? 'selected' : ''}>${status}</option>`
            ).join('');
            
            const modalHtml = `
                <div class="modal fade" id="updateOrderStatusModal" tabindex="-1" aria-labelledby="updateOrderStatusModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="updateOrderStatusModalLabel">Update Order Status</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label for="order-status" class="form-label">Status</label>
                                    <select class="form-select" id="order-status">
                                        ${statusOptions}
                                    </select>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" id="save-order-status-btn" data-id="${orderId}">Update</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to DOM
            const modalContainer = document.createElement('div');
            modalContainer.innerHTML = modalHtml;
            document.body.appendChild(modalContainer);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('updateOrderStatusModal'));
            modal.show();
            
            // Add event listener to save button
            document.getElementById('save-order-status-btn').addEventListener('click', function() {
                const newStatus = document.getElementById('order-status').value;
                saveOrderStatus(orderId, newStatus);
            });
            
            // Remove modal from DOM when hidden
            document.getElementById('updateOrderStatusModal').addEventListener('hidden.bs.modal', function() {
                document.body.removeChild(modalContainer);
            });
        }
        // Save order status
        async function saveOrderStatus(orderId, status) {
            try {
                await apiService.updateOrderStatus(orderId, status);
                uiHelper.showAlert('Order status updated successfully', 'success');
                
                // Hide modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('updateOrderStatusModal'));
                if (modal) modal.hide();
                
                // Reload orders
                loadOrders();
            } catch (error) {
                console.error('Error updating order status:', error);
                uiHelper.showAlert('Error updating order status', 'danger');
            }
        }
        // Cancel order
        function cancelOrder(orderId) {
            uiHelper.confirm('Are you sure you want to cancel this order?', async function() {
                try {
                    await apiService.cancelOrder(orderId);
                    uiHelper.showAlert('Order cancelled successfully', 'success');
                    loadOrders();
                } catch (error) {
                    console.error('Error cancelling order:', error);
                    uiHelper.showAlert('Error cancelling order', 'danger');
                }
            });
        }
        // Generate revenue report
        async function generateRevenueReport() {
    try {
        const reportStartDate = document.getElementById('report-start-date');
        const reportEndDate = document.getElementById('report-end-date');
        
        const startDate = reportStartDate ? reportStartDate.value : null;
        const endDate = reportEndDate ? reportEndDate.value : null;
        
        if (!startDate || !endDate) {
            uiHelper.showAlert('Please select both start and end dates', 'warning');
            return;
        }
        
        if (new Date(startDate) >= new Date(endDate)) {
            uiHelper.showAlert('End date must be after start date', 'warning');
            return;
        }
        
        // Format dates as ISO strings (YYYY-MM-DD)
        const formattedStartDate = new Date(startDate).toISOString().split('T')[0];
        const formattedEndDate = new Date(endDate).toISOString().split('T')[0];
        
        const revenueData = await apiService.getRevenueReport(formattedStartDate, formattedEndDate);
        
        // Update report table
        const tableBody = document.querySelector('#report-table tbody');
        if (!tableBody) return;
        
        tableBody.innerHTML = '';
        
        if (revenueData.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="5" class="text-center">No data found for the selected period</td></tr>';
            return;
        }
        
        revenueData.forEach(item => {
            const row = document.createElement('tr');
            
            row.innerHTML = `
                <td>${uiHelper.formatDate(new Date(item.date))}</td>
                <td>${uiHelper.formatCurrency(item.membershipRevenue)}</td>
                <td>${uiHelper.formatCurrency(item.productRevenue)}</td>
                <td>${uiHelper.formatCurrency(item.totalRevenue)}</td>
                <td>${item.bookingsCount}</td>
            `;
            
            tableBody.appendChild(row);
        });
        
        // Update report chart
        updateReportChart(revenueData);
    } catch (error) {
        console.error('Error generating revenue report:', error);
        uiHelper.showAlert('Error generating revenue report: ' + error.message, 'danger');
    }
}

        
        // Update report chart
        let reportChart = null;
        function updateReportChart(revenueData) {
            const ctx = document.getElementById('reportChart');
            if (!ctx) return;
            
            const chartCtx = ctx.getContext('2d');
            
            // Destroy existing chart if it exists
            if (reportChart) {
                reportChart.destroy();
            }
            
            // Prepare data for chart
            const labels = revenueData.map(item => uiHelper.formatDate(new Date(item.date)));
            const membershipRevenue = revenueData.map(item => item.membershipRevenue);
            const productRevenue = revenueData.map(item => item.productRevenue);
            
            // Create new chart
            reportChart = new Chart(chartCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Membership Revenue',
                            data: membershipRevenue,
                            backgroundColor: 'rgba(78, 115, 223, 0.8)',
                            borderColor: 'rgba(78, 115, 223, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Product Revenue',
                            data: productRevenue,
                            backgroundColor: 'rgba(28, 200, 138, 0.8)',
                            borderColor: 'rgba(28, 200, 138, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true,
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            stacked: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            },
                            grid: {
                                color: 'rgb(234, 236, 244)'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(tooltipItem, chart) {
                                    let label = chart.datasets[tooltipItem.datasetIndex].label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += '$' + tooltipItem.yLabel.toLocaleString();
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }
        // Initialize form validation
        function initializeFormValidation() {
            // Add event listeners for form validation
            const forms = document.querySelectorAll('.modal-body form');
            forms.forEach(form => {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    // Form validation is handled in the save functions
                });
            });
        }
    </script>
</body>
</html>
// Document Ready Function
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    });
    
    // Initialize popovers
    var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'))
    var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
        return new bootstrap.Popover(popoverTriggerEl)
    });
    
    // Auto-hide alerts after 5 seconds
    setTimeout(function() {
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(function(alert) {
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        });
    }, 5000);
});

// API Service Object
const apiService = {
    // Base URL for API - change this to your actual API URL
    baseUrl: 'https://localhost:7182/api',
    
    // Generic request function
    async request(endpoint, options = {}) {
        const url = `${this.baseUrl}${endpoint}`;
        const defaultOptions = {
            headers: {
                'Content-Type': 'application/json'
            }
        };
        
        // Add authorization header if token exists
        const token = localStorage.getItem('authToken');
        if (token) {
            defaultOptions.headers.Authorization = `Bearer ${token}`;
        }
        
        const finalOptions = {
            ...defaultOptions,
            ...options,
            headers: {
                ...defaultOptions.headers,
                ...options.headers
            }
        };
        
        try {
            const response = await fetch(url, finalOptions);
            
            // Handle non-JSON responses (like 404, 500 errors)
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
            }
            
            return await response.json();
        } catch (error) {
            console.error('API request failed:', error);
            throw error;
        }
    },
    
    // Authentication methods
    async login(email, password) {
        return this.request('/auth/login', {
            method: 'POST',
            body: JSON.stringify({ email, password })
        });
    },
    
    async register(userData) {
        return this.request('/auth/register', {
            method: 'POST',
            body: JSON.stringify(userData)
        });
    },
    
    // User methods
    async getUserProfile() {
        return this.request('/users/profile');
    },
    
    // Membership methods
    async getUserMembership() {
        return this.request('/memberships');
    },
    
    async purchaseMembership(membershipData) {
        return this.request('/memberships', {
            method: 'POST',
            body: JSON.stringify(membershipData)
        });
    },
    
    // Membership Types methods
    async getMembershipTypes() {
        return this.request('/membershiptypes');
    },
    
   async getMembershipTypeById(id) {
    return this.request(`/membershiptypes/${id}`);
},
    
    async createMembershipType(membershipData) {
        return this.request('/membershiptypes', {
            method: 'POST',
            body: JSON.stringify(membershipData)
        });
    },
    
    async updateMembershipType(id, membershipData) {
        return this.request(`/membershiptypes/${id}`, {
            method: 'PUT',
            body: JSON.stringify(membershipData)
        });
    },
    
    async deleteMembershipType(id) {
        return this.request(`/membershiptypes/${id}`, {
            method: 'DELETE'
        });
    },
    
    async toggleMembershipTypeStatus(id, isActive) {
    return this.request(`/membershiptypes/${id}/toggle`, {
        method: 'PATCH',
        body: JSON.stringify(isActive)  // Send just the boolean value, not an object
    });
},
    
    // Classes methods
    async getClasses() {
        return this.request('/classes');
    },
    
    async getClassById(id) {
        return this.request(`/classes/${id}`);
    },
    
    async createClass(classData) {
        return this.request('/classes', {
            method: 'POST',
            body: JSON.stringify(classData)
        });
    },
    
    async updateClass(id, classData) {
        return this.request(`/classes/${id}`, {
            method: 'PUT',
            body: JSON.stringify(classData)
        });
    },
    
    async deleteClass(id) {
        return this.request(`/classes/${id}`, {
            method: 'DELETE'
        });
    },
    
    async getClassSchedules(classId) {
        return this.request(`/classes/${classId}/schedules`);
    },
    
    async createClassSchedule(scheduleData) {
        return this.request('/classes/schedules', {
            method: 'POST',
            body: JSON.stringify(scheduleData)
        });
    },
    
    async deleteClassSchedule(id) {
        return this.request(`/classes/schedules/${id}`, {
            method: 'DELETE'
        });
    },
    
    // Sessions methods
    async getSessions() {
        return this.request('/onlinesessions');
    },
    
    async getSessionById(id) {
        return this.request(`/onlinesessions/${id}`);
    },
    
    async createSession(sessionData) {
        return this.request('/onlinesessions', {
            method: 'POST',
            body: JSON.stringify(sessionData)
        });
    },
    
    async updateSession(id, sessionData) {
        return this.request(`/onlinesessions/${id}`, {
            method: 'PUT',
            body: JSON.stringify(sessionData)
        });
    },
    
    async deleteSession(id) {
        return this.request(`/onlinesessions/${id}`, {
            method: 'DELETE'
        });
    },
    
    async getSessionSchedules(sessionId) {
        return this.request(`/onlinesessions/${sessionId}/schedules`);
    },
    
    async createSessionSchedule(scheduleData) {
        return this.request('/onlinesessions/schedules', {
            method: 'POST',
            body: JSON.stringify(scheduleData)
        });
    },
    
    async deleteSessionSchedule(id) {
        return this.request(`/onlinesessions/schedules/${id}`, {
            method: 'DELETE'
        });
    },
    
    // Trainers methods
    async getTrainers() {
        return this.request('/trainers');
    },
    
    async getTrainerById(id) {
        return this.request(`/trainers/${id}`);
    },
    
    // Update createTrainer method
async createTrainer(trainerData, imageFile = null) {
    const formData = new FormData();
    
    // Add all trainer data fields to FormData
    for (const key in trainerData) {
        if (trainerData[key] !== null && trainerData[key] !== undefined) {
            formData.append(key, trainerData[key]);
        }
    }
    
    // Add image file if provided
    if (imageFile) {
        formData.append('ImageFile', imageFile);
    }
    
    return this.request('/trainers', {
        method: 'POST',
        body: formData,
        headers: {} // Let the browser set the Content-Type for multipart/form-data
    });
},

// Update updateTrainer method
async updateTrainer(id, trainerData, imageFile = null) {
    const formData = new FormData();
    
    // Add all trainer data fields to FormData
    for (const key in trainerData) {
        if (trainerData[key] !== null && trainerData[key] !== undefined) {
            formData.append(key, trainerData[key]);
        }
    }
    
    // Add image file if provided
    if (imageFile) {
        formData.append('ImageFile', imageFile);
    }
    
    return this.request(`/trainers/${id}`, {
        method: 'PUT',
        body: formData,
        headers: {} // Let the browser set the Content-Type for multipart/form-data
    });
},


    
    async deleteTrainer(id) {
        return this.request(`/trainers/${id}`, {
            method: 'DELETE'
        });
    },
    
    async getTrainerClasses(trainerId) {
        return this.request(`/trainers/${trainerId}/classes`);
    },
    
    async getTrainerSessions(trainerId) {
        return this.request(`/trainers/${trainerId}/sessions`);
    },
    
    // Booking methods
    async createBooking(bookingData) {
        return this.request('/bookings', {
            method: 'POST',
            body: JSON.stringify(bookingData)
        });
    },
    
    async getBookingDetails(bookingId) {
        return this.request(`/bookings/${bookingId}`);
    },
    
    async getUserBookings() {
        return this.request('/bookings');
    },
    
    async cancelBooking(bookingId) {
        return this.request(`/bookings/${bookingId}`, {
            method: 'DELETE'
        });
    },
    
    // Products methods
    async getProducts() {
        return this.request('/products');
    },
    
    async getProductById(id) {
        return this.request(`/products/${id}`);
    },
    
    async getProductsByCategory(category) {
        return this.request(`/products/category/${category}`);
    },
    
 // Update createProduct method
async createProduct(productData, imageFile = null) {
    const formData = new FormData();
    
    // Add all product data fields to FormData
    for (const key in productData) {
        if (productData[key] !== null && productData[key] !== undefined) {
            formData.append(key, productData[key]);
        }
    }
    
    // Add image file if provided
    if (imageFile) {
        formData.append('ImageFile', imageFile);
    }
    
    return this.request('/products', {
        method: 'POST',
        body: formData,
        headers: {} // Let the browser set the Content-Type for multipart/form-data
    });
},

// Update updateProduct method
async updateProduct(id, productData, imageFile = null) {
    const formData = new FormData();
    
    // Add all product data fields to FormData
    for (const key in productData) {
        if (productData[key] !== null && productData[key] !== undefined) {
            formData.append(key, productData[key]);
        }
    }
    
    // Add image file if provided
    if (imageFile) {
        formData.append('ImageFile', imageFile);
    }
    
    return this.request(`/products/${id}`, {
        method: 'PUT',
        body: formData,
        headers: {} // Let the browser set the Content-Type for multipart/form-data
    });
},
    
    async deleteProduct(id) {
        return this.request(`/products/${id}`, {
            method: 'DELETE'
        });
    },
    
  async updateProductStock(id, quantity) {
    return this.request(`/products/${id}/stock`, {
        method: 'PATCH',
        body: JSON.stringify(quantity)  // Send just the integer value, not an object
    });
},
    
    // Order methods
    async createOrder(orderData) {
        return this.request('/orders', {
            method: 'POST',
            body: JSON.stringify(orderData)
        });
    },
    
    async getUserOrders() {
        return this.request('/orders');
    },
    
    async getOrderById(id) {
        return this.request(`/orders/${id}`);
    },
    
    async updateOrderStatus(id, status) {
        return this.request(`/orders/${id}/status`, {
            method: 'PATCH',
            body: JSON.stringify({ status })
        });
    },
    
    async cancelOrder(id) {
        return this.request(`/orders/${id}`, {
            method: 'DELETE'
        });
    },
    
    // Promotions methods
    async getPromotions() {
        return this.request('/promotions');
    },
    
    async getPromotionById(id) {
        return this.request(`/promotions/${id}`);
    },
    
    async getPromotionByCode(code) {
        return this.request(`/promotions/code/${code}`);
    },
    
    async createPromotion(promotionData) {
        return this.request('/promotions', {
            method: 'POST',
            body: JSON.stringify(promotionData)
        });
    },
    
    async updatePromotion(id, promotionData) {
        return this.request(`/promotions/${id}`, {
            method: 'PUT',
            body: JSON.stringify(promotionData)
        });
    },
    
    async deletePromotion(id) {
        return this.request(`/promotions/${id}`, {
            method: 'DELETE'
        });
    },
    
    async validatePromotion(code, orderAmount) {
        return this.request('/promotions/validate', {
            method: 'POST',
            body: JSON.stringify({ code, orderAmount })
        });
    },
    
    // Admin methods
    async getDashboardStats() {
        return this.request('/admin/dashboard/stats');
    },
    
    async getAllUsers(page = 1, pageSize = 10) {
        return this.request(`/admin/users?page=${page}&pageSize=${pageSize}`);
    },
    
    async getUserDetails(userId) {
        return this.request(`/admin/users/${userId}`);
    },
    
    async getAllBookings(startDate, endDate) {
        const params = new URLSearchParams();
        if (startDate) params.append('startDate', startDate);
        if (endDate) params.append('endDate', endDate);
        
        return this.request(`/admin/bookings?${params.toString()}`);
    },
    
    async getRevenueReport(startDate, endDate) {
        return this.request(`/admin/revenue?startDate=${startDate}&endDate=${endDate}`);
    },
    
    async getAllOrders() {
        return this.request('/admin/orders');
    }
};

// Auth Service Object
const authService = {
    // Check if user is logged in
    isLoggedIn() {
        return !!localStorage.getItem('authToken');
    },
    
    // Get current user
    getCurrentUser() {
        const userJson = localStorage.getItem('currentUser');
        return userJson ? JSON.parse(userJson) : null;
    },
    
    // Check if user is admin - improved to parse JWT token correctly
    isAdmin() {
        const token = localStorage.getItem('authToken');
        if (!token) return false;
        
        try {
            // Parse the JWT token to get the claims
            const parts = token.split('.');
            if (parts.length !== 3) return false;
            
            // Get the payload part and convert base64url to base64
            const payloadBase64Url = parts[1];
            let payloadBase64 = payloadBase64Url.replace(/-/g, '+').replace(/_/g, '/');
            
            // Add padding if needed
            while (payloadBase64.length % 4) {
                payloadBase64 += '=';
            }
            
            // Parse the payload
            const payload = JSON.parse(atob(payloadBase64));
            
            // Check if the token contains an Admin role claim
            // Try different possible claim names
            const roleClaim1 = payload['http://schemas.microsoft.com/ws/2008/06/identity/claims/role'];
            const roleClaim2 = payload['role'];
            const roleClaim3 = payload['Role'];
            
            return roleClaim1 === 'Admin' || roleClaim2 === 'Admin' || roleClaim3 === 'Admin';
        } catch (e) {
            console.error('Error parsing JWT token:', e);
            return false;
        }
    },
    
    // Logout user
    logout() {
        localStorage.removeItem('authToken');
        localStorage.removeItem('currentUser');
        window.location.href = '../login.html';
    },
    
    // Save auth data
    saveAuthData(token, user) {
        localStorage.setItem('authToken', token);
        localStorage.setItem('currentUser', JSON.stringify(user));
    }
};

// UI Helper Functions
const uiHelper = {
    // Show alert message
    showAlert(message, type = 'info') {
        const alertContainer = document.getElementById('alert-container') || this.createAlertContainer();
        
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show`;
        alert.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        alertContainer.appendChild(alert);
        
        // Auto-hide after 5 seconds
        setTimeout(() => {
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        }, 5000);
    },
    
    // Create alert container if it doesn't exist
    createAlertContainer() {
        const container = document.createElement('div');
        container.id = 'alert-container';
        container.className = 'container mt-3';
        document.querySelector('main').prepend(container);
        return container;
    },
    
    // Show loading spinner
    showLoading(element) {
        const spinner = document.createElement('div');
        spinner.className = 'spinner-container';
        spinner.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>';
        
        if (element) {
            element.innerHTML = '';
            element.appendChild(spinner);
        } else {
            document.body.appendChild(spinner);
        }
        
        return spinner;
    },
    
    // Hide loading spinner
    hideLoading(spinner) {
        if (spinner && spinner.parentNode) {
            spinner.parentNode.removeChild(spinner);
        }
    },
    
    // Format date
    formatDate(dateString) {
        const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
        return new Date(dateString).toLocaleDateString(undefined, options);
    },
    
    // Format currency
    formatCurrency(amount) {
        return new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD'
        }).format(amount);
    },
    
    // Render error message
    renderError(element, message) {
        element.innerHTML = `<div class="alert alert-danger">${message}</div>`;
    },
    
    // Confirm dialog
    confirm(message, callback) {
        if (confirm(message)) {
            callback();
        }
    },
    
    // Show toast notification
    showToast(message, type = 'info') {
        // Create toast container if it doesn't exist
        let toastContainer = document.getElementById('toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.id = 'toast-container';
            toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            document.body.appendChild(toastContainer);
        }
        
        // Create toast element
        const toastEl = document.createElement('div');
        toastEl.className = `toast align-items-center text-white bg-${type} border-0`;
        toastEl.setAttribute('role', 'alert');
        toastEl.setAttribute('aria-live', 'assertive');
        toastEl.setAttribute('aria-atomic', 'true');
        
        toastEl.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        `;
        
        toastContainer.appendChild(toastEl);
        
        const toast = new bootstrap.Toast(toastEl, {
            autohide: true,
            delay: 5000
        });
        
        toast.show();
    }
};

// Form Validation Helper
const formValidator = {
    // Validate email
    isValidEmail(email) {
        const re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
        return re.test(String(email).toLowerCase());
    },
    
    // Validate password (at least 6 characters)
    isValidPassword(password) {
        return password.length >= 6;
    },
    
    // Validate required fields
    validateRequired(form) {
        const requiredFields = form.querySelectorAll('[required]');
        let isValid = true;
        
        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                field.classList.add('is-invalid');
                isValid = false;
            } else {
                field.classList.remove('is-invalid');
            }
        });
        
        return isValid;
    },
    
    // Validate form
    validateForm(form, rules) {
        let isValid = true;
        
        // First validate required fields
        if (!this.validateRequired(form)) {
            isValid = false;
        }
        
        // Then validate specific rules
        for (const [fieldName, rule] of Object.entries(rules)) {
            const field = form.querySelector(`[name="${fieldName}"]`);
            if (!field) continue;
            
            const value = field.value.trim();
            
            if (rule.email && !this.isValidEmail(value)) {
                this.setFieldError(field, 'Please enter a valid email address');
                isValid = false;
            } else if (rule.minLength && value.length < rule.minLength) {
                this.setFieldError(field, `Minimum length is ${rule.minLength} characters`);
                isValid = false;
            } else if (rule.match && value !== form.querySelector(`[name="${rule.match}"]`).value) {
                this.setFieldError(field, 'Fields do not match');
                isValid = false;
            } else {
                this.clearFieldError(field);
            }
        }
        
        return isValid;
    },
    
    // Set field error
    setFieldError(field, message) {
        field.classList.add('is-invalid');
        
        let feedback = field.nextElementSibling;
        if (!feedback || !feedback.classList.contains('invalid-feedback')) {
            feedback = document.createElement('div');
            feedback.className = 'invalid-feedback';
            field.parentNode.insertBefore(feedback, field.nextSibling);
        }
        
        feedback.textContent = message;
    },
    
    // Clear field error
    clearFieldError(field) {
        field.classList.remove('is-invalid');
        const feedback = field.nextElementSibling;
        if (feedback && feedback.classList.contains('invalid-feedback')) {
            feedback.textContent = '';
        }
    }
};

// Utility Functions
const utils = {
    // Get query parameter from URL
    getQueryParam(param) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param);
    },
    
    // Format date for input fields (YYYY-MM-DD)
    formatDateForInput(date) {
        const d = new Date(date);
        let month = (d.getMonth() + 1).toString();
        let day = d.getDate().toString();
        const year = d.getFullYear();
        
        if (month.length < 2) month = '0' + month;
        if (day.length < 2) day = '0' + day;
        
        return [year, month, day].join('-');
    },
    
    // Calculate days between two dates
    daysBetween(date1, date2) {
        const oneDay = 24 * 60 * 60 * 1000; // hours*minutes*seconds*milliseconds
        const diffDays = Math.round(Math.abs((date1 - date2) / oneDay));
        return diffDays;
    },
    
    // Debounce function to limit how often a function can be called
    debounce(func, wait, immediate) {
        let timeout;
        return function() {
            const context = this, args = arguments;
            const later = function() {
                timeout = null;
                if (!immediate) func.apply(context, args);
            };
            const callNow = immediate && !timeout;
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
            if (callNow) func.apply(context, args);
        };
    },
    
    // Generate a unique ID
    generateUniqueId() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }
};
