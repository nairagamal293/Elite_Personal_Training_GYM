using elite.Data;
using elite.Interfaces;
using elite.Models;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;

namespace elite.Controllers
{
    // Controllers/AdminController.cs
    [ApiController]
    [Route("api/admin")]
    [Authorize(Roles = "Admin")]
    public class AdminController : ControllerBase
    {
        private readonly IAdminService _adminService;
        private readonly ILogger<AdminController> _logger;

        public AdminController(IAdminService adminService, ILogger<AdminController> logger)
        {
            _adminService = adminService;
            _logger = logger;
        }

        [HttpGet("users")]
        public async Task<IActionResult> GetAllUsers([FromQuery] int page = 1, [FromQuery] int pageSize = 10)
        {
            try
            {
                var users = await _adminService.GetAllUsersAsync(page, pageSize);
                return Ok(users);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting all users");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpGet("users/{id}")]
        public async Task<IActionResult> GetUserDetails(int id)
        {
            try
            {
                var user = await _adminService.GetUserDetailsAsync(id);
                return Ok(user);
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting user details");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpGet("dashboard/stats")]
        public async Task<IActionResult> GetDashboardStats()
        {
            try
            {
                var stats = await _adminService.GetDashboardStatsAsync();
                return Ok(stats);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting dashboard stats");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpGet("bookings")]
        public async Task<IActionResult> GetAllBookings([FromQuery] DateTime? startDate, [FromQuery] DateTime? endDate)
        {
            try
            {
                var bookings = await _adminService.GetAllBookingsAsync(startDate, endDate);
                return Ok(bookings);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting all bookings");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }
        [HttpGet("orders")]
        public async Task<IActionResult> GetAllOrders()
        {
            try
            {
                var orders = await _adminService.GetAllOrdersAsync();
                return Ok(orders);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting all orders");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        // Controllers/AdminController.cs
        [HttpGet("bookings/{id}")]
        public async Task<IActionResult> GetBookingDetails(int id)
        {
            try
            {
                var booking = await _adminService.GetBookingDetailsAsync(id);
                return Ok(booking);
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting booking details");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }


        [HttpGet("revenue")]
        public async Task<IActionResult> GetRevenueReport([FromQuery] DateTime startDate, [FromQuery] DateTime endDate)
        {
            try
            {
                var revenue = await _adminService.GetRevenueReportAsync(startDate, endDate);
                return Ok(revenue);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting revenue report");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }
    }
}


// Controllers/AuthController.cs
using elite.DTOs;
using elite.Interfaces;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using System.Security.Claims;

namespace elite.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    public class AuthController : ControllerBase
    {
        private readonly IAuthService _authService;
        private readonly ILogger<AuthController> _logger;

        public AuthController(IAuthService authService, ILogger<AuthController> logger)
        {
            _authService = authService;
            _logger = logger;
        }

        [HttpPost("register")]
        public async Task<ActionResult<AuthResponseDto>> Register([FromBody] UserRegisterDto registerDto)
        {
            try
            {
                var result = await _authService.RegisterAsync(registerDto);
                return Ok(result);
            }
            catch (ArgumentException ex)
            {
                return BadRequest(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error during registration");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpPost("login")]
        public async Task<ActionResult<AuthResponseDto>> Login([FromBody] UserLoginDto loginDto)
        {
            try
            {
                var result = await _authService.LoginAsync(loginDto);
                return Ok(result);
            }
            catch (UnauthorizedAccessException ex)
            {
                return Unauthorized(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error during login");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        // Add to AuthController.cs
        [HttpGet("profile")]
        [Authorize]
        public async Task<ActionResult<UserResponseDto>> GetProfile()
        {
            try
            {
                var userId = int.Parse(User.FindFirst(ClaimTypes.NameIdentifier)?.Value);
                var result = await _authService.GetUserProfileAsync(userId);
                return Ok(result);
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting user profile");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpPut("profile")]
        [Authorize]
        public async Task<ActionResult> UpdateProfile([FromBody] UserUpdateDto updateDto)
        {
            try
            {
                var userId = int.Parse(User.FindFirst(ClaimTypes.NameIdentifier)?.Value);
                var result = await _authService.UpdateUserProfileAsync(userId, updateDto);
                return Ok(new { message = "Profile updated successfully" });
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error updating user profile");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

        [HttpPost("change-password")]
        [Authorize]
        public async Task<ActionResult> ChangePassword([FromBody] ChangePasswordDto changePasswordDto)
        {
            try
            {
                var userId = int.Parse(User.FindFirst(ClaimTypes.NameIdentifier)?.Value);
                var result = await _authService.ChangePasswordAsync(userId, changePasswordDto.CurrentPassword, changePasswordDto.NewPassword);
                return Ok(new { message = "Password changed successfully" });
            }
            catch (ArgumentException ex)
            {
                return NotFound(new { message = ex.Message });
            }
            catch (UnauthorizedAccessException ex)
            {
                return BadRequest(new { message = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error changing password");
                return StatusCode(500, new { message = "Internal server error" });
            }
        }

    }
}

using elite.Models;

namespace elite.Data
{
    // Data/DataSeeder.cs
    public class DataSeeder
    {
        private readonly GymDbContext _context;

        public DataSeeder(GymDbContext context)
        {
            _context = context;
        }

        public async Task SeedDataAsync()
        {
            // Seed trainers if none exist
            if (!_context.Trainers.Any())
            {
                var trainers = new List<Trainer>
            {
                new Trainer
    {
        Name = "Sarah Johnson",
        Specialization = "Yoga",
        ExperienceYears = 5,
        Certifications = "RYT 500",
        Bio = "Experienced yoga instructor with 5 years of teaching experience",
        ImageUrl = null // Set to null since we're not seeding images
    },
                new Trainer
                {
                    Name = "Emily Davis",
                    Specialization = "Pilates",
                    ExperienceYears = 7,
                    Certifications = "Pilates Method Alliance",
                    Bio = "Pilates expert with international certification",
                     ImageUrl = null
                },
                new Trainer
                {
                    Name = "Jessica Wilson",
                    Specialization = "HIIT",
                    ExperienceYears = 4,
                    Certifications = "ACE Certified",
                    Bio = "High-intensity interval training specialist",
                     ImageUrl = null
                }
            };

                _context.Trainers.AddRange(trainers);
                await _context.SaveChangesAsync();
            }

            // Seed admin user if none exists
            if (!_context.Admins.Any())
            {
                var admin = new Admin
                {
                    Username = "admin",
                    PasswordHash = BCrypt.Net.BCrypt.HashPassword("admin123"),
                    Email = "admin@gym.com",
                    Role = "Admin"
                };

                _context.Admins.Add(admin);
                await _context.SaveChangesAsync();
            }

            // Seed membership types if none exist
            if (!_context.MembershipTypes.Any())
            {
                var membershipTypes = new List<MembershipType>
{
    new MembershipType
    {
        Name = "Basic",
        Description = "Basic membership with 10 hours",
        DurationMonths = 1,
        TotalHours = 10.0m,      // Use decimal notation
        Price = 49.99m,
        IsActive = true
    },
    new MembershipType
    {
        Name = "Medium",
        Description = "Medium membership with 25 hours",
        DurationMonths = 3,
        TotalHours = 25.0m,      // Use decimal notation
        Price = 99.99m,
        IsActive = true
    },
    new MembershipType
    {
        Name = "VIP",
        Description = "VIP membership with 50 hours",
        DurationMonths = 6,
        TotalHours = 50.0m,      // Use decimal notation
        Price = 199.99m,
        IsActive = true
    }
};

                _context.MembershipTypes.AddRange(membershipTypes);
                await _context.SaveChangesAsync();
            }

            // Seed sample products if none exist
            if (!_context.Products.Any())
            {
                var products = new List<Product>
            {
                new Product
                {
                    Name = "Yoga Mat",
                    Description = "High-quality non-slip yoga mat",
                    Price = 29.99m,
                    ImageUrl = "/images/products/yoga-mat.jpg",
                    Category = "Apparel",
                    StockQuantity = 50
                },
                new Product
                {
                    Name = "Protein Powder",
                    Description = "Whey protein powder for muscle recovery",
                    Price = 39.99m,
                    ImageUrl = "/images/products/protein-powder.jpg",
                    Category = "Supplements",
                    StockQuantity = 30
                },
                new Product
                {
                    Name = "Workout Gloves",
                    Description = "Comfortable gloves for weight training",
                    Price = 19.99m,
                    ImageUrl = "/images/products/workout-gloves.jpg",
                    Category = "Apparel",
                    StockQuantity = 25
                }
            };

                _context.Products.AddRange(products);
                await _context.SaveChangesAsync();
            }
        }
    }
}


using elite.Models;
using Microsoft.EntityFrameworkCore;
using System.Collections.Generic;
using System.Reflection.Emit;

namespace elite.Data
{
    // Data/GymDbContext.cs
    public class GymDbContext : DbContext
    {
        public GymDbContext(DbContextOptions<GymDbContext> options) : base(options) { }

        public DbSet<User> Users { get; set; }
        public DbSet<Membership> Memberships { get; set; }
        public DbSet<Class> Classes { get; set; }
        public DbSet<ClassSchedule> ClassSchedules { get; set; }
        public DbSet<OnlineSession> OnlineSessions { get; set; }
        public DbSet<OnlineSessionSchedule> OnlineSessionSchedules { get; set; }
        public DbSet<Trainer> Trainers { get; set; }
        public DbSet<Booking> Bookings { get; set; }
        public DbSet<Product> Products { get; set; }
        public DbSet<Order> Orders { get; set; }
        public DbSet<OrderItem> OrderItems { get; set; }
        public DbSet<Promotion> Promotions { get; set; }
        public DbSet<Admin> Admins { get; set; }
        public DbSet<MembershipType> MembershipTypes { get; set; }
        public DbSet<PromotionUsage> PromotionUsages { get; set; }

        protected override void OnModelCreating(ModelBuilder modelBuilder)
        {
            // Configure relationships and constraints
            modelBuilder.Entity<User>()
                .HasIndex(u => u.Email)
                .IsUnique();

            modelBuilder.Entity<Membership>()
                .HasOne(m => m.User)
                .WithOne(u => u.Membership)
                .HasForeignKey<Membership>(m => m.UserId)
                .OnDelete(DeleteBehavior.Cascade);

            modelBuilder.Entity<ClassSchedule>()
                .HasCheckConstraint("CK_ClassSchedule_AvailableSlots", "[AvailableSlots] >= 0");

            // Configure PromotionUsage relationships
            modelBuilder.Entity<PromotionUsage>()
                .HasOne(pu => pu.Promotion)
                .WithMany(p => p.PromotionUsages)
                .HasForeignKey(pu => pu.PromotionId)
                .OnDelete(DeleteBehavior.Cascade);

            modelBuilder.Entity<PromotionUsage>()
                .HasOne(pu => pu.User)
                .WithMany()
                .HasForeignKey(pu => pu.UserId)
                .OnDelete(DeleteBehavior.Cascade);

            // Ensure a user can only use a promotion once
            modelBuilder.Entity<PromotionUsage>()
                .HasIndex(pu => new { pu.PromotionId, pu.UserId })
                .IsUnique();

            // Seed data
            modelBuilder.Entity<Trainer>().HasData(
                new Trainer { Id = 1, Name = "Sarah Johnson", Specialization = "Yoga", ExperienceYears = 5, Certifications = "RYT 500", Bio = "Experienced yoga instructor", ImageUrl = "/images/trainers/sarah.jpg" },
                new Trainer { Id = 2, Name = "Emily Davis", Specialization = "Pilates", ExperienceYears = 7, Certifications = "Pilates Method Alliance", Bio = "Pilates expert", ImageUrl = "/images/trainers/emily.jpg" }
            );
            modelBuilder.Entity<MembershipType>().HasData(
                new MembershipType
                {
                    Id = 1,
                    Name = "Basic",
                    Description = "Basic membership with 10 hours",
                    DurationMonths = 1,
                    TotalHours = 10,
                    Price = 49.99m,
                    IsActive = true
                },
                new MembershipType
                {
                    Id = 2,
                    Name = "Medium",
                    Description = "Medium membership with 25 hours",
                    DurationMonths = 3,
                    TotalHours = 25,
                    Price = 99.99m,
                    IsActive = true
                },
                new MembershipType
                {
                    Id = 3,
                    Name = "VIP",
                    Description = "VIP membership with 50 hours",
                    DurationMonths = 6,
                    TotalHours = 50,
                    Price = 199.99m,
                    IsActive = true
                }
            );

            base.OnModelCreating(modelBuilder);
        }
    }
}


// Data/GymDbContextFactory.cs
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Design;
using Microsoft.Extensions.Configuration;
using System.IO;

namespace elite.Data
{
    public class GymDbContextFactory : IDesignTimeDbContextFactory<GymDbContext>
    {
        public GymDbContext CreateDbContext(string[] args)
        {
            var configuration = new ConfigurationBuilder()
                .SetBasePath(Directory.GetCurrentDirectory())
                .AddJsonFile("appsettings.json")
                .Build();

            var optionsBuilder = new DbContextOptionsBuilder<GymDbContext>();
            var connectionString = configuration.GetConnectionString("DefaultConnection");

            optionsBuilder.UseSqlServer(connectionString);

            return new GymDbContext(optionsBuilder.Options);
        }
    }
}

namespace elite.DTOs
{
    public class DashboardStatsDto
    {
        public int TotalUsers { get; set; }
        public int ActiveMemberships { get; set; }
        public int TotalBookingsToday { get; set; }
        public decimal RevenueThisMonth { get; set; }
        public int LowStockProducts { get; set; }
    }

    public class RevenueReportDto
    {
        public DateTime Date { get; set; }
        public decimal MembershipRevenue { get; set; }
        public decimal ProductRevenue { get; set; }
        public decimal TotalRevenue { get; set; }
        public int BookingsCount { get; set; }
    }
}


namespace elite.DTOs
{
    public class AuthResponseDto
    {
        public string Token { get; set; }
        public UserResponseDto User { get; set; }
    }

}


using System.ComponentModel.DataAnnotations;

namespace elite.DTOs
{
    public class UserRegisterDto
    {
        [Required, MaxLength(100)]
        public string Name { get; set; }

        [Required, EmailAddress, MaxLength(100)]
        public string Email { get; set; }

        [Required, MinLength(6)]
        public string Password { get; set; }

        [Phone, MaxLength(20)]
        public string Phone { get; set; }
    }

    public class UserLoginDto
    {
        [Required, EmailAddress]
        public string Email { get; set; }

        [Required]
        public string Password { get; set; }
    }

    public class UserResponseDto
    {
        public int Id { get; set; }
        public string Name { get; set; }
        public string Email { get; set; }
        public string Phone { get; set; }
        public DateTime CreatedAt { get; set; }
        public MembershipDto Membership { get; set; }
    }

    public class UserUpdateDto
    {
        [MaxLength(100)]
        public string Name { get; set; }

        [Phone, MaxLength(20)]
        public string Phone { get; set; }
    }


    public class ChangePasswordDto
    {
        [Required]
        public string CurrentPassword { get; set; }

        [Required, MinLength(6)]
        public string NewPassword { get; set; }
    }
}


using elite.DTOs;

namespace elite.Interfaces
{
    public interface IAdminService
    {
        Task<IEnumerable<UserResponseDto>> GetAllUsersAsync(int page, int pageSize);
        Task<UserResponseDto> GetUserDetailsAsync(int userId);
        Task<bool> UpdateUserStatusAsync(int userId, bool isActive);
        Task<DashboardStatsDto> GetDashboardStatsAsync();
        Task<IEnumerable<BookingResponseDto>> GetAllBookingsAsync(DateTime? startDate, DateTime? endDate);
        Task<IEnumerable<RevenueReportDto>> GetRevenueReportAsync(DateTime startDate, DateTime endDate);
        // In IAdminService.cs
        Task<IEnumerable<OrderDto>> GetAllOrdersAsync();
        // Interfaces/IAdminService.cs
        Task<BookingResponseDto> GetBookingDetailsAsync(int bookingId);

    }
}


using elite.DTOs;

namespace elite.Interfaces
{
    public interface IAuthService
    {
        Task<AuthResponseDto> RegisterAsync(UserRegisterDto registerDto);
        Task<AuthResponseDto> LoginAsync(UserLoginDto loginDto);
        Task<UserResponseDto> GetUserProfileAsync(int userId);
        Task<bool> UpdateUserProfileAsync(int userId, UserUpdateDto updateDto);
        Task<bool> ChangePasswordAsync(int userId, string currentPassword, string newPassword);
    }
}


namespace elite.Middleware
{
    public class RequestLoggingMiddleware
    {
        private readonly RequestDelegate _next;
        private readonly ILogger<RequestLoggingMiddleware> _logger;

        public RequestLoggingMiddleware(RequestDelegate next, ILogger<RequestLoggingMiddleware> logger)
        {
            _next = next;
            _logger = logger;
        }

        public async Task InvokeAsync(HttpContext context)
        {
            var startTime = DateTime.UtcNow;

            _logger.LogInformation("Request started: {Method} {Path}",
                context.Request.Method, context.Request.Path);

            await _next(context);

            var duration = DateTime.UtcNow - startTime;
            _logger.LogInformation("Request completed: {Method} {Path} - {StatusCode} in {Duration}ms",
                context.Request.Method, context.Request.Path, context.Response.StatusCode, duration.TotalMilliseconds);
        }
    }
}

namespace elite.Middleware
{
    public class PerformanceMiddleware
    {
        private readonly RequestDelegate _next;
        private readonly ILogger<PerformanceMiddleware> _logger;

        public PerformanceMiddleware(RequestDelegate next, ILogger<PerformanceMiddleware> logger)
        {
            _next = next;
            _logger = logger;
        }

        public async Task InvokeAsync(HttpContext context)
        {
            var stopwatch = System.Diagnostics.Stopwatch.StartNew();

            await _next(context);

            stopwatch.Stop();

            if (stopwatch.ElapsedMilliseconds > 1000) // Log slow requests
            {
                _logger.LogWarning("Slow request: {Method} {Path} took {ElapsedMs}ms",
                    context.Request.Method, context.Request.Path, stopwatch.ElapsedMilliseconds);
            }
        }
    }
}

using System.Text.Json;

namespace elite.Middleware
{
    public class ExceptionMiddleware
    {
        private readonly RequestDelegate _next;
        private readonly ILogger<ExceptionMiddleware> _logger;

        public ExceptionMiddleware(RequestDelegate next, ILogger<ExceptionMiddleware> logger)
        {
            _next = next;
            _logger = logger;
        }

        public async Task InvokeAsync(HttpContext httpContext)
        {
            try
            {
                await _next(httpContext);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "An unhandled exception occurred");
                await HandleExceptionAsync(httpContext, ex);
            }
        }

        private static Task HandleExceptionAsync(HttpContext context, Exception exception)
        {
            context.Response.ContentType = "application/json";
            context.Response.StatusCode = exception switch
            {
                ArgumentException => StatusCodes.Status400BadRequest,
                UnauthorizedAccessException => StatusCodes.Status401Unauthorized,
                InvalidOperationException => StatusCodes.Status400BadRequest,
                _ => StatusCodes.Status500InternalServerError
            };

            return context.Response.WriteAsync(new ErrorDetails
            {
                StatusCode = context.Response.StatusCode,
                Message = exception.Message
            }.ToString());
        }
    }

    public class ErrorDetails
    {
        public int StatusCode { get; set; }
        public string Message { get; set; }

        public override string ToString()
        {
            return JsonSerializer.Serialize(this);
        }
    }
}


namespace elite.Middleware
{
    public class CorrelationMiddleware
    {
        private readonly RequestDelegate _next;

        public CorrelationMiddleware(RequestDelegate next)
        {
            _next = next;
        }

        public async Task InvokeAsync(HttpContext context)
        {
            var correlationId = context.Request.Headers["X-Correlation-ID"].FirstOrDefault()
                              ?? Guid.NewGuid().ToString();

            context.Response.Headers["X-Correlation-ID"] = correlationId;
            context.Items["CorrelationId"] = correlationId;

            await _next(context);
        }
    }
}

namespace elite.Models
{
    public class Admin
    {
        public int Id { get; set; }
        public string Username { get; set; }
        public string PasswordHash { get; set; }
        public string Email { get; set; }
        public string Role { get; set; } = "Admin";
    }
}


using System.ComponentModel.DataAnnotations;

namespace elite.Models
{
    public class User
    {
        public int Id { get; set; }

        [Required, MaxLength(100)]
        public string Name { get; set; }

        [Required, EmailAddress, MaxLength(100)]
        public string Email { get; set; }

        [Required, MaxLength(255)]
        public string PasswordHash { get; set; }

        [Phone, MaxLength(20)]
        public string Phone { get; set; }

        public int? MembershipId { get; set; }
        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
        public DateTime? UpdatedAt { get; set; }

        // Navigation properties
        public virtual Membership Membership { get; set; }
        public virtual ICollection<Booking> Bookings { get; set; }
        public virtual ICollection<Order> Orders { get; set; }
    }
}



using elite.Data;
using elite.DTOs;
using elite.Interfaces;
using Microsoft.EntityFrameworkCore;

namespace elite.Services
{
    // Services/AdminService.cs
    public class AdminService : IAdminService
    {
        private readonly GymDbContext _context;
        private readonly ILogger<AdminService> _logger;

        public AdminService(GymDbContext context, ILogger<AdminService> logger)
        {
            _context = context;
            _logger = logger;
        }

        public async Task<IEnumerable<UserResponseDto>> GetAllUsersAsync(int page, int pageSize)
        {
            return await _context.Users
                .Include(u => u.Membership)
                .Include(u => u.Bookings)
                .OrderBy(u => u.Id)
                .Skip((page - 1) * pageSize)
                .Take(pageSize)
                .Select(u => new UserResponseDto
                {
                    Id = u.Id,
                    Name = u.Name,
                    Email = u.Email,
                    Phone = u.Phone,
                    CreatedAt = u.CreatedAt,
                    Membership = u.Membership != null ? new MembershipDto
                    {
                        Id = u.Membership.Id,
                        Type = u.Membership.Type,
                        StartDate = u.Membership.StartDate,
                        EndDate = u.Membership.EndDate,
                        TotalHours = u.Membership.TotalHours,
                        RemainingHours = u.Membership.RemainingHours,
                        Status = u.Membership.Status
                    } : null
                })
                .ToListAsync();
        }

        public async Task<UserResponseDto> GetUserDetailsAsync(int userId)
        {
            var user = await _context.Users
                .Include(u => u.Membership)
                .Include(u => u.Bookings)
                .Include(u => u.Orders)
                .ThenInclude(o => o.OrderItems)
                .FirstOrDefaultAsync(u => u.Id == userId);

            if (user == null) throw new ArgumentException("User not found");

            return new UserResponseDto
            {
                Id = user.Id,
                Name = user.Name,
                Email = user.Email,
                Phone = user.Phone,
                CreatedAt = user.CreatedAt,
                Membership = user.Membership != null ? new MembershipDto
                {
                    Id = user.Membership.Id,
                    Type = user.Membership.Type,
                    StartDate = user.Membership.StartDate,
                    EndDate = user.Membership.EndDate,
                    TotalHours = user.Membership.TotalHours,
                    RemainingHours = user.Membership.RemainingHours,
                    Status = user.Membership.Status
                } : null
            };
        }

        public async Task<bool> UpdateUserStatusAsync(int userId, bool isActive)
        {
            // For this implementation, we'll assume users are always active
            // In a real system, you might have an IsActive property on the User model
            return await Task.FromResult(true);
        }

        public async Task<DashboardStatsDto> GetDashboardStatsAsync()
        {
            var totalUsers = await _context.Users.CountAsync();
            var activeMemberships = await _context.Memberships
                .CountAsync(m => m.Status == "Active" && m.EndDate >= DateTime.UtcNow);

            var totalBookingsToday = await _context.Bookings
                .CountAsync(b => b.BookingDate.Date == DateTime.UtcNow.Date && b.Status == "Confirmed");

            var revenueThisMonth = await _context.Orders
                .Where(o => o.OrderDate.Month == DateTime.UtcNow.Month &&
                           o.OrderDate.Year == DateTime.UtcNow.Year &&
                           o.Status == "Completed")
                .SumAsync(o => o.TotalAmount);

            var lowStockProducts = await _context.Products
                .CountAsync(p => p.StockQuantity <= 5);

            return new DashboardStatsDto
            {
                TotalUsers = totalUsers,
                ActiveMemberships = activeMemberships,
                TotalBookingsToday = totalBookingsToday,
                RevenueThisMonth = revenueThisMonth,
                LowStockProducts = lowStockProducts
            };
        }

        public async Task<IEnumerable<BookingResponseDto>> GetAllBookingsAsync(DateTime? startDate, DateTime? endDate)
        {
            var query = _context.Bookings
                .Include(b => b.User) // Ensure User is included
                .AsQueryable();

            if (startDate.HasValue)
                query = query.Where(b => b.BookingDate >= startDate.Value);

            if (endDate.HasValue)
                query = query.Where(b => b.BookingDate <= endDate.Value);

            return await query
                .OrderByDescending(b => b.BookingDate)
                .Select(b => new BookingResponseDto
                {
                    Id = b.Id,
                    Type = b.Type,
                    ScheduleId = b.ScheduleId,
                    BookingDate = b.BookingDate,
                    Status = b.Status,
                    HoursConsumed = b.HoursConsumed,
                    UserId = b.UserId,
                    UserName = b.User.Name, // Ensure this is set
                    ClassName = b.Type == "Class"
                        ? _context.ClassSchedules
                            .Where(cs => cs.Id == b.ScheduleId)
                            .Select(cs => cs.Class.Name)
                            .FirstOrDefault()
                        : _context.OnlineSessionSchedules
                            .Where(oss => oss.Id == b.ScheduleId)
                            .Select(oss => oss.OnlineSession.Name)
                            .FirstOrDefault(),
                    TrainerName = b.Type == "Class"
                        ? _context.ClassSchedules
                            .Where(cs => cs.Id == b.ScheduleId)
                            .Select(cs => cs.Class.Trainer.Name)
                            .FirstOrDefault()
                        : _context.OnlineSessionSchedules
                            .Where(oss => oss.Id == b.ScheduleId)
                            .Select(oss => oss.OnlineSession.Trainer.Name)
                            .FirstOrDefault(),
                    StartTime = b.Type == "Class"
                        ? _context.ClassSchedules
                            .Where(cs => cs.Id == b.ScheduleId)
                            .Select(cs => cs.StartTime)
                            .FirstOrDefault()
                        : _context.OnlineSessionSchedules
                            .Where(oss => oss.Id == b.ScheduleId)
                            .Select(oss => oss.StartTime)
                            .FirstOrDefault(),
                    EndTime = b.Type == "Class"
                        ? _context.ClassSchedules
                            .Where(cs => cs.Id == b.ScheduleId)
                            .Select(cs => cs.EndTime)
                            .FirstOrDefault()
                        : _context.OnlineSessionSchedules
                            .Where(oss => oss.Id == b.ScheduleId)
                            .Select(oss => oss.EndTime)
                            .FirstOrDefault(),
                    Location = b.Type == "Class"
                        ? _context.ClassSchedules
                            .Where(cs => cs.Id == b.ScheduleId)
                            .Select(cs => cs.Location)
                            .FirstOrDefault()
                        : "Online"
                })
                .ToListAsync();
        }



        // In AdminService.cs
        public async Task<IEnumerable<OrderDto>> GetAllOrdersAsync()
        {
            return await _context.Orders
                .Include(o => o.User)
                .Include(o => o.OrderItems)
                .ThenInclude(oi => oi.Product)
                .OrderByDescending(o => o.OrderDate)
                .Select(o => new OrderDto
                {
                    Id = o.Id,
                    UserId = o.UserId,
                    UserName = o.User.Name,
                    OrderDate = o.OrderDate,
                    TotalAmount = o.TotalAmount,
                    Status = o.Status,
                    OrderItems = o.OrderItems.Select(oi => new OrderItemDto
                    {
                        Id = oi.Id,
                        ProductId = oi.ProductId,
                        ProductName = oi.Product.Name,
                        Quantity = oi.Quantity,
                        Price = oi.Price
                    }).ToList()
                })
                .ToListAsync();
        }

        public async Task<BookingResponseDto> GetBookingDetailsAsync(int bookingId)
        {
            var booking = await _context.Bookings
                .Include(b => b.User) // Include the User navigation property
                .Where(b => b.Id == bookingId)
                .Select(b => new BookingResponseDto
                {
                    Id = b.Id,
                    Type = b.Type,
                    ScheduleId = b.ScheduleId,
                    BookingDate = b.BookingDate,
                    Status = b.Status,
                    HoursConsumed = b.HoursConsumed,
                    UserId = b.UserId,
                    UserName = b.User.Name, // Ensure this is set
                    UserEmail = b.User.Email, // Add this
                    ClassName = b.Type == "Class"
                        ? _context.ClassSchedules
                            .Where(cs => cs.Id == b.ScheduleId)
                            .Select(cs => cs.Class.Name)
                            .FirstOrDefault()
                        : _context.OnlineSessionSchedules
                            .Where(oss => oss.Id == b.ScheduleId)
                            .Select(oss => oss.OnlineSession.Name)
                            .FirstOrDefault(),
                    TrainerName = b.Type == "Class"
                        ? _context.ClassSchedules
                            .Where(cs => cs.Id == b.ScheduleId)
                            .Select(cs => cs.Class.Trainer.Name)
                            .FirstOrDefault()
                        : _context.OnlineSessionSchedules
                            .Where(oss => oss.Id == b.ScheduleId)
                            .Select(oss => oss.OnlineSession.Trainer.Name)
                            .FirstOrDefault(),
                    StartTime = b.Type == "Class"
                        ? _context.ClassSchedules
                            .Where(cs => cs.Id == b.ScheduleId)
                            .Select(cs => cs.StartTime)
                            .FirstOrDefault()
                        : _context.OnlineSessionSchedules
                            .Where(oss => oss.Id == b.ScheduleId)
                            .Select(oss => oss.StartTime)
                            .FirstOrDefault(),
                    EndTime = b.Type == "Class"
                        ? _context.ClassSchedules
                            .Where(cs => cs.Id == b.ScheduleId)
                            .Select(cs => cs.EndTime)
                            .FirstOrDefault()
                        : _context.OnlineSessionSchedules
                            .Where(oss => oss.Id == b.ScheduleId)
                            .Select(oss => oss.EndTime)
                            .FirstOrDefault(),
                    Location = b.Type == "Class"
                        ? _context.ClassSchedules
                            .Where(cs => cs.Id == b.ScheduleId)
                            .Select(cs => cs.Location)
                            .FirstOrDefault()
                        : "Online"
                })
                .FirstOrDefaultAsync();

            if (booking == null) throw new ArgumentException("Booking not found");
            return booking;
        }

        public async Task<IEnumerable<RevenueReportDto>> GetRevenueReportAsync(DateTime startDate, DateTime endDate)
        {
            var orders = await _context.Orders
                .Where(o => o.OrderDate >= startDate && o.OrderDate <= endDate && o.Status == "Completed")
                .ToListAsync();

            var memberships = await _context.Memberships
                .Where(m => m.StartDate >= startDate && m.StartDate <= endDate && m.Status == "Active")
                .ToListAsync();

            var revenueByDate = new Dictionary<DateTime, RevenueReportDto>();

            // Initialize all dates in range
            for (var date = startDate.Date; date <= endDate.Date; date = date.AddDays(1))
            {
                revenueByDate[date] = new RevenueReportDto
                {
                    Date = date,
                    MembershipRevenue = 0,
                    ProductRevenue = 0,
                    TotalRevenue = 0,
                    BookingsCount = 0
                };
            }

            // Calculate product revenue from orders
            foreach (var order in orders)
            {
                var date = order.OrderDate.Date;
                if (revenueByDate.ContainsKey(date))
                {
                    revenueByDate[date].ProductRevenue += order.TotalAmount;
                    revenueByDate[date].TotalRevenue += order.TotalAmount;
                }
            }

            // Calculate membership revenue (simplified - assuming fixed prices)
            foreach (var membership in memberships)
            {
                var date = membership.StartDate.Date;
                if (revenueByDate.ContainsKey(date))
                {
                    decimal membershipPrice = membership.Type switch
                    {
                        "Basic" => 49.99m,
                        "Medium" => 99.99m,
                        "VIP" => 199.99m,
                        _ => 0
                    };

                    revenueByDate[date].MembershipRevenue += membershipPrice;
                    revenueByDate[date].TotalRevenue += membershipPrice;
                }
            }

            // Calculate bookings count
            var bookings = await _context.Bookings
                .Where(b => b.BookingDate >= startDate && b.BookingDate <= endDate && b.Status == "Confirmed")
                .ToListAsync();

            foreach (var booking in bookings)
            {
                var date = booking.BookingDate.Date;
                if (revenueByDate.ContainsKey(date))
                {
                    revenueByDate[date].BookingsCount++;
                }
            }

            return revenueByDate.Values.OrderBy(r => r.Date).ToList();
        }
    }
}

using elite.Data;
using elite.DTOs;
using elite.Interfaces;
using elite.Models;
using elite.Utilities;
using Microsoft.EntityFrameworkCore;

namespace elite.Services
{


    public class AuthService : IAuthService
    {
        private readonly GymDbContext _context;
        private readonly IJwtService _jwtService;
        private readonly ILogger<AuthService> _logger;

        public AuthService(GymDbContext context, IJwtService jwtService, ILogger<AuthService> logger)
        {
            _context = context;
            _jwtService = jwtService;
            _logger = logger;
        }

        public async Task<AuthResponseDto> RegisterAsync(UserRegisterDto registerDto)
        {
            if (await _context.Users.AnyAsync(u => u.Email == registerDto.Email))
                throw new ArgumentException("Email already exists");

            var passwordHash = BCrypt.Net.BCrypt.HashPassword(registerDto.Password);

            var user = new User
            {
                Name = registerDto.Name,
                Email = registerDto.Email,
                PasswordHash = passwordHash,
                Phone = registerDto.Phone,
                CreatedAt = DateTime.UtcNow
            };

            _context.Users.Add(user);
            await _context.SaveChangesAsync();

            var token = _jwtService.GenerateToken(user);

            return new AuthResponseDto
            {
                Token = token,
                User = new UserResponseDto
                {
                    Id = user.Id,
                    Name = user.Name,
                    Email = user.Email,
                    Phone = user.Phone,
                    CreatedAt = user.CreatedAt
                }
            };
        }

        public async Task<AuthResponseDto> LoginAsync(UserLoginDto loginDto)
        {
            // First try to find a user
            var user = await _context.Users
                .Include(u => u.Membership)
                .FirstOrDefaultAsync(u => u.Email == loginDto.Email);

            // If not found, try to find an admin
            if (user == null)
            {
                var admin = await _context.Admins
                    .FirstOrDefaultAsync(a => a.Email == loginDto.Email);

                if (admin != null && BCrypt.Net.BCrypt.Verify(loginDto.Password, admin.PasswordHash))
                {
                    // Generate token for admin
                    var token = _jwtService.GenerateAdminToken(admin);

                    return new AuthResponseDto
                    {
                        Token = token,
                        User = new UserResponseDto
                        {
                            Id = admin.Id,
                            Name = admin.Username,
                            Email = admin.Email,
                            CreatedAt = DateTime.UtcNow,
                            // Admins don't have memberships
                            Membership = null
                        }
                    };
                }
            }

            // Original user login logic
            if (user == null || !BCrypt.Net.BCrypt.Verify(loginDto.Password, user.PasswordHash))
                throw new UnauthorizedAccessException("Invalid credentials");

            var userToken = _jwtService.GenerateToken(user);

            return new AuthResponseDto
            {
                Token = userToken,
                User = new UserResponseDto
                {
                    Id = user.Id,
                    Name = user.Name,
                    Email = user.Email,
                    Phone = user.Phone,
                    CreatedAt = user.CreatedAt,
                    Membership = user.Membership != null ? new MembershipDto
                    {
                        Id = user.Membership.Id,
                        Type = user.Membership.Type,
                        StartDate = user.Membership.StartDate,
                        EndDate = user.Membership.EndDate,
                        TotalHours = user.Membership.TotalHours,
                        RemainingHours = user.Membership.RemainingHours,
                        Status = user.Membership.Status
                    } : null
                }
            };
        }

        public async Task<UserResponseDto> GetUserProfileAsync(int userId)
        {
            var user = await _context.Users
                .Include(u => u.Membership)
                .FirstOrDefaultAsync(u => u.Id == userId);

            if (user == null) throw new ArgumentException("User not found");

            return new UserResponseDto
            {
                Id = user.Id,
                Name = user.Name,
                Email = user.Email,
                Phone = user.Phone,
                CreatedAt = user.CreatedAt,
                Membership = user.Membership != null ? new MembershipDto
                {
                    Id = user.Membership.Id,
                    Type = user.Membership.Type,
                    StartDate = user.Membership.StartDate,
                    EndDate = user.Membership.EndDate,
                    TotalHours = user.Membership.TotalHours,
                    RemainingHours = user.Membership.RemainingHours,
                    Status = user.Membership.Status
                } : null
            };
        }

        public async Task<bool> UpdateUserProfileAsync(int userId, UserUpdateDto updateDto)
        {
            var user = await _context.Users.FindAsync(userId);
            if (user == null) throw new ArgumentException("User not found");

            if (!string.IsNullOrEmpty(updateDto.Name))
                user.Name = updateDto.Name;

            if (!string.IsNullOrEmpty(updateDto.Phone))
                user.Phone = updateDto.Phone;

            user.UpdatedAt = DateTime.UtcNow;

            _context.Users.Update(user);
            return await _context.SaveChangesAsync() > 0;
        }

        public async Task<bool> ChangePasswordAsync(int userId, string currentPassword, string newPassword)
        {
            var user = await _context.Users.FindAsync(userId);
            if (user == null) throw new ArgumentException("User not found");

            if (!BCrypt.Net.BCrypt.Verify(currentPassword, user.PasswordHash))
                throw new UnauthorizedAccessException("Current password is incorrect");

            user.PasswordHash = BCrypt.Net.BCrypt.HashPassword(newPassword);
            user.UpdatedAt = DateTime.UtcNow;

            _context.Users.Update(user);
            return await _context.SaveChangesAsync() > 0;
        }
    }

}


using elite.Models;
using Microsoft.IdentityModel.Tokens;
using System.IdentityModel.Tokens.Jwt;
using System.Security.Claims;
using System.Text;

namespace elite.Utilities
{
    public interface IJwtService
    {
        string GenerateToken(User user);
        string GenerateAdminToken(Admin admin);
    }

    public class JwtService : IJwtService
    {
        private readonly IConfiguration _configuration;

        public JwtService(IConfiguration configuration)
        {
            _configuration = configuration;
        }
        // In elite/Utilities/JwtService.cs
        public string GenerateAdminToken(Admin admin)
        {
            var tokenHandler = new JwtSecurityTokenHandler();
            var key = Encoding.ASCII.GetBytes(_configuration["Jwt:Secret"]);
            var issuer = _configuration["Jwt:Issuer"]; // Add this line

            var tokenDescriptor = new SecurityTokenDescriptor
            {
                Subject = new ClaimsIdentity(new[]
                {
            new Claim(ClaimTypes.NameIdentifier, admin.Id.ToString()),
            new Claim(ClaimTypes.Email, admin.Email),
            new Claim(ClaimTypes.Name, admin.Username),
            new Claim(ClaimTypes.Role, "Admin")
        }),
                Expires = DateTime.UtcNow.AddDays(7),
                Issuer = issuer, // Add this line
                SigningCredentials = new SigningCredentials(new SymmetricSecurityKey(key), SecurityAlgorithms.HmacSha256Signature)
            };
            var token = tokenHandler.CreateToken(tokenDescriptor);
            return tokenHandler.WriteToken(token);
        }

        public string GenerateToken(User user)
        {
            var tokenHandler = new JwtSecurityTokenHandler();
            var key = Encoding.ASCII.GetBytes(_configuration["Jwt:Secret"]);
            var issuer = _configuration["Jwt:Issuer"];
            var audience = _configuration["Jwt:Audience"];

            var tokenDescriptor = new SecurityTokenDescriptor
            {
                Subject = new ClaimsIdentity(new[]
                {
            new Claim(ClaimTypes.NameIdentifier, user.Id.ToString()),
            new Claim(ClaimTypes.Email, user.Email),
            new Claim(ClaimTypes.Name, user.Name),
            new Claim(ClaimTypes.Role, "User")
        }),
                Expires = DateTime.UtcNow.AddDays(7),
                Issuer = issuer,
                Audience = audience,
                SigningCredentials = new SigningCredentials(new SymmetricSecurityKey(key), SecurityAlgorithms.HmacSha256Signature)
            };

            var token = tokenHandler.CreateToken(tokenDescriptor);
            return tokenHandler.WriteToken(token);
        }
    }
}


using elite.Data;
using elite.Interfaces;
using elite.Middleware;
using elite.Services;
using elite.Utilities;
using Microsoft.AspNetCore.Authentication.JwtBearer;
using Microsoft.EntityFrameworkCore;
using Microsoft.IdentityModel.Tokens;
using Microsoft.OpenApi.Models;
using System.Text;

var builder = WebApplication.CreateBuilder(new WebApplicationOptions
{
    Args = args,
    WebRootPath = "wwwroot" // Set web root path here
});

// Add services to the container.
builder.Services.AddControllers();

// Add DbContext
builder.Services.AddDbContext<GymDbContext>(options =>
    options.UseSqlServer(builder.Configuration.GetConnectionString("DefaultConnection")));

// Add AutoMapper
builder.Services.AddAutoMapper(AppDomain.CurrentDomain.GetAssemblies());

// Add services
builder.Services.AddScoped<IAuthService, AuthService>();
builder.Services.AddScoped<IAdminService, AdminService>();
builder.Services.AddScoped<IBookingService, BookingService>();
builder.Services.AddScoped<IClassService, ClassService>();
builder.Services.AddScoped<IMembershipService, MembershipService>();
builder.Services.AddScoped<IOnlineSessionService, OnlineSessionService>();
builder.Services.AddScoped<IOrderService, OrderService>();
builder.Services.AddScoped<IProductService, ProductService>();
builder.Services.AddScoped<IPromotionService, PromotionService>();
builder.Services.AddScoped<ITrainerService, TrainerService>();
builder.Services.AddScoped<IJwtService, JwtService>();
builder.Services.AddScoped<IPasswordHasher, PasswordHasher>();
builder.Services.AddScoped<IMembershipTypeService, MembershipTypeService>();
builder.Services.AddScoped<IImageService, ImageService>();

// Configure JWT Authentication
var jwtSettings = builder.Configuration.GetSection("Jwt");
var key = Encoding.ASCII.GetBytes(jwtSettings["Secret"]);
builder.Services.AddAuthentication(options =>
{
    options.DefaultAuthenticateScheme = JwtBearerDefaults.AuthenticationScheme;
    options.DefaultChallengeScheme = JwtBearerDefaults.AuthenticationScheme;
})
.AddJwtBearer(options =>
{
    options.TokenValidationParameters = new TokenValidationParameters
    {
        ValidateIssuerSigningKey = true,
        IssuerSigningKey = new SymmetricSecurityKey(key),
        ValidateIssuer = true,
        ValidateAudience = false,
        ValidIssuer = jwtSettings["Issuer"],
        ValidateLifetime = true
    };
});

// Add Authorization
builder.Services.AddAuthorization();

// Configure Swagger/OpenAPI
builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen(options =>
{
    options.SwaggerDoc("v1", new OpenApiInfo
    {
        Title = "Gym Booking API",
        Version = "v1",
        Description = "Women's Gym Booking System API",
        Contact = new OpenApiContact
        {
            Name = "API Support",
            Email = "support@gymbooking.com",
            Url = new Uri("https://gymbooking.com/support")
        },
        License = new OpenApiLicense
        {
            Name = "Use under LICX",
            Url = new Uri("https://example.com/license")
        }
    });

    // Use full name as Schema ID to avoid naming conflicts
    options.CustomSchemaIds(type => type.FullName);

    // Add JWT authentication
    options.AddSecurityDefinition("Bearer", new OpenApiSecurityScheme
    {
        Description = "JWT Authorization header using the Bearer scheme. Example: \"Authorization: Bearer {token}\"",
        Name = "Authorization",
        In = ParameterLocation.Header,
        Type = SecuritySchemeType.ApiKey,
        Scheme = "Bearer"
    });

    options.AddSecurityRequirement(new OpenApiSecurityRequirement
    {
        {
            new OpenApiSecurityScheme
            {
                Reference = new OpenApiReference
                {
                    Type = ReferenceType.SecurityScheme,
                    Id = "Bearer"
                }
            },
            new string[] {}
        }
    });

    // Include XML comments if they exist
    var xmlFile = $"{System.Reflection.Assembly.GetExecutingAssembly().GetName().Name}.xml";
    var xmlPath = Path.Combine(AppContext.BaseDirectory, xmlFile);
    if (File.Exists(xmlPath))
    {
        options.IncludeXmlComments(xmlPath);
    }
});

// Add CORS
builder.Services.AddCors(options =>
{
    options.AddPolicy("AllowAll", builder =>
    {
        builder.AllowAnyOrigin()
               .AllowAnyMethod()
               .AllowAnyHeader();
    });
});

// Add detailed logging
builder.Services.AddLogging(loggingBuilder =>
{
    loggingBuilder.AddConsole();
    loggingBuilder.AddDebug();
});

var app = builder.Build();

// Configure the HTTP request pipeline.
if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI(c =>
    {
        c.SwaggerEndpoint("/swagger/v1/swagger.json", "Gym Booking API v1");
        c.RoutePrefix = "swagger";
    });
}

// Serve static files (including uploaded images)
app.UseStaticFiles();

app.UseHttpsRedirection();

app.UseCors("AllowAll");
app.UseAuthentication();
app.UseAuthorization();

// Use custom exception middleware
app.UseMiddleware<ExceptionMiddleware>();

// Check database connectivity
using (var scope = app.Services.CreateScope())
{
    var context = scope.ServiceProvider.GetRequiredService<GymDbContext>();
    var logger = scope.ServiceProvider.GetRequiredService<ILogger<Program>>();

    try
    {
        // Try to connect to the database
        await context.Database.CanConnectAsync();
        logger.LogInformation("Database connection successful");

        // Ensure database is created
        context.Database.EnsureCreated();

        // Apply any pending migrations
        await context.Database.MigrateAsync();

        // Seed data
        var seeder = new DataSeeder(context);
        await seeder.SeedDataAsync();
    }
    catch (Exception ex)
    {
        logger.LogError(ex, "Database connection or migration failed");
    }
}

app.MapControllers();

app.Run();  


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Elite Gym</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <!-- Custom CSS -->
    <style>
        /* Global Styles */
        :root {
            --primary-color: #5E60CE;      /* Modern Indigo */
            --secondary-color: #5390D9;    /* Lighter Blue */
            --accent-color: #48BFE3;       /* Teal Accent */
            --dark-color: #0B132B;         /* Deep Dark Blue */
            --light-color: #F8F9FA;
            --text-dark: #0B132B;
            --text-light: #5E6472;
            --card-bg: #ffffff;
            --section-bg: #F8F9FA;
            --gradient-1: linear-gradient(135deg, #5E60CE 0%, #5390D9 100%);
            --gradient-2: linear-gradient(135deg, #48BFE3 0%, #5E60CE 100%);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Montserrat', sans-serif;
            color: var(--text-dark);
            background-color: var(--section-bg);
            overflow-x: hidden;
        }
        
        /* Navbar Styles */
        .navbar {
            background-color: rgba(255, 255, 255, 0.95) !important;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.08);
            padding: 15px 0;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .navbar-brand {
            font-weight: 700;
            font-size: 1.8rem;
            color: var(--primary-color) !important;
            font-family: 'Playfair Display', serif;
        }
        
        .navbar-nav .nav-link {
            color: var(--text-dark) !important;
            font-weight: 500;
            margin: 0 10px;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .navbar-nav .nav-link:hover, .navbar-nav .nav-link.active {
            color: var(--primary-color) !important;
        }
        
        .navbar-nav .nav-link:after {
            content: '';
            position: absolute;
            width: 0;
            height: 2px;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            background: var(--gradient-1);
            transition: all 0.3s ease;
        }
        
        .navbar-nav .nav-link:hover:after, .navbar-nav .nav-link.active:after {
            width: 70%;
        }
        
        /* Page Header */
        .page-header {
            background: var(--gradient-1);
            color: white;
            padding: 100px 0;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .page-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            opacity: 0.2;
            z-index: 0;
        }
        
        .page-title {
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: 15px;
            position: relative;
            z-index: 1;
            font-family: 'Playfair Display', serif;
        }
        
        .page-subtitle {
            font-size: 1.2rem;
            max-width: 700px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
            opacity: 0.9;
        }
        
        /* Main Content */
        .login-section {
            padding: 80px 0;
            min-height: calc(100vh - 300px);
            display: flex;
            align-items: center;
        }
        
        .login-card {
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border: none;
            max-width: 500px;
            width: 100%;
            margin: 0 auto;
            background-color: white;
        }
        
        .login-header {
            background: var(--gradient-1);
            color: white;
            padding: 40px 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .login-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            opacity: 0.1;
            z-index: 0;
        }
        
        .login-header h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
            font-family: 'Playfair Display', serif;
        }
        
        .login-header p {
            opacity: 0.9;
            margin-bottom: 0;
            position: relative;
            z-index: 1;
        }
        
        .login-body {
            padding: 40px;
        }
        
        .form-label {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 8px;
        }
        
        .input-group {
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            border: 1px solid rgba(94, 96, 206, 0.1);
        }
        
        .input-group:focus-within {
            box-shadow: 0 8px 25px rgba(94, 96, 206, 0.15);
            border-color: var(--primary-color);
        }
        
        .input-group-text {
            background: var(--gradient-1);
            border: none;
            color: white;
            font-weight: 500;
            width: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .form-control {
            border: none;
            padding: 15px;
            font-family: 'Montserrat', sans-serif;
        }
        
        .form-control:focus {
            box-shadow: none;
        }
        
        .toggle-password {
            background-color: transparent;
            border: none;
            color: var(--text-light);
        }
        
        .toggle-password:hover {
            color: var(--primary-color);
        }
        
        .form-check-input:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-login {
            background: var(--gradient-2);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 30px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(72, 191, 227, 0.2);
        }
        
        .btn-login:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(72, 191, 227, 0.3);
            color: white;
        }
        
        .forgot-password {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .forgot-password:hover {
            color: var(--secondary-color);
        }
        
        .divider {
            position: relative;
            text-align: center;
            margin: 30px 0;
        }
        
        .divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background-color: rgba(94, 96, 206, 0.1);
        }
        
        .divider span {
            background-color: white;
            padding: 0 15px;
            position: relative;
            color: var(--text-light);
            font-size: 0.9rem;
        }
        
        .btn-social {
            border-radius: 30px;
            padding: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
            border: 1px solid rgba(94, 96, 206, 0.1);
            color: var(--text-dark);
            background-color: white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .btn-social:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }
        
        .btn-facebook {
            color: #4267B2;
        }
        
        .btn-facebook:hover {
            background-color: #4267B2;
            color: white;
        }
        
        .btn-google {
            color: #DB4437;
        }
        
        .btn-google:hover {
            background-color: #DB4437;
            color: white;
        }
        
        .register-link {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .register-link:hover {
            color: var(--secondary-color);
        }
        
        /* Alert Styles */
        .alert {
            border: none;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .alert-success {
            background-color: rgba(25, 135, 84, 0.1);
            color: #198754;
            border-left: 4px solid #198754;
        }
        
        .alert-danger {
            background-color: rgba(220, 53, 69, 0.1);
            color: #dc3545;
            border-left: 4px solid #dc3545;
        }
        
        /* Footer */
        footer {
            background: linear-gradient(135deg, #0B132B 0%, #1C2541 100%);
            color: white;
            padding: 70px 0 20px;
            margin-top: 80px;
            position: relative;
            overflow: hidden;
        }
        
        footer::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            opacity: 0.5;
            pointer-events: none;
        }
        
        .footer-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 20px;
            color: white;
            position: relative;
            z-index: 1;
        }
        
        .footer-text {
            margin-bottom: 20px;
            color: #cccccc;
            position: relative;
            z-index: 1;
        }
        
        .social-icons a {
            display: inline-block;
            width: 40px;
            height: 40px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            text-align: center;
            line-height: 40px;
            margin-right: 10px;
            color: white;
            transition: all 0.3s ease;
            position: relative;
            z-index: 1;
        }
        
        .social-icons a:hover {
            background: var(--gradient-1);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(94, 96, 206, 0.4);
        }
        
        .footer-links {
            list-style: none;
            padding: 0;
            position: relative;
            z-index: 1;
        }
        
        .footer-links li {
            margin-bottom: 10px;
        }
        
        .footer-links a {
            color: #cccccc;
            text-decoration: none;
            transition: all 0.3s ease;
            display: inline-block;
        }
        
        .footer-links a:hover {
            color: white;
            padding-left: 5px;
        }
        
        .contact-info i {
            color: var(--accent-color);
            margin-right: 10px;
            font-size: 1.1rem;
        }
        
        .copyright {
            text-align: center;
            padding-top: 30px;
            margin-top: 30px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: #999999;
            position: relative;
            z-index: 1;
        }
        
        /* Responsive Adjustments */
        @media (max-width: 992px) {
            .page-header {
                padding: 80px 0;
            }
            
            .page-title {
                font-size: 2.2rem;
            }
            
            .login-section {
                padding: 60px 0;
            }
        }
        
        @media (max-width: 768px) {
            .page-header {
                padding: 60px 0;
            }
            
            .page-title {
                font-size: 2rem;
            }
            
            .login-card {
                margin: 0 20px;
            }
            
            .login-header, .login-body {
                padding: 25px;
            }
        }
        
        @media (max-width: 576px) {
            .page-title {
                font-size: 1.8rem;
            }
            
            .login-header, .login-body {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light sticky-top">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="bi bi-lightning-charge-fill"></i> Elite Gym
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="register.html">Register</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    
 
    
    <!-- Main Content -->
    <main class="login-section">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-md-6 col-lg-5">
                    <div class="card login-card">
                        <div class="login-header">
                            <h1>Welcome Back</h1>
                            <p>Sign in to continue your fitness journey</p>
                        </div>
                        <div class="login-body">
                            <!-- Alert Container -->
                            <div id="alert-container"></div>
                            
                            <form id="login-form">
                                <div class="mb-4">
                                    <label for="email" class="form-label">Email address</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="bi bi-envelope"></i></span>
                                        <input type="email" class="form-control" id="email" name="email" placeholder="name@example.com" required>
                                    </div>
                                    <div class="invalid-feedback"></div>
                                </div>
                                
                                <div class="mb-4">
                                    <label for="password" class="form-label">Password</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="bi bi-lock"></i></span>
                                        <input type="password" class="form-control" id="password" name="password" placeholder="Password" required>
                                        <button class="btn btn-outline-secondary toggle-password" type="button">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                    </div>
                                    <div class="invalid-feedback"></div>
                                </div>
                                
                                <div class="mb-4 form-check">
                                    <input type="checkbox" class="form-check-input" id="rememberMe">
                                    <label class="form-check-label" for="rememberMe">Remember me</label>
                                </div>
                                
                                <div class="d-grid gap-2">
                                    <button type="submit" class="btn btn-login">Login</button>
                                </div>
                                
                                <div class="text-center mt-3">
                                    <a href="forgot-password.html" class="forgot-password">Forgot password?</a>
                                </div>
                            </form>
                            
                            <div class="text-center mt-4">
                                <p>Don't have an account? <a href="register.html" class="register-link">Register here</a></p>
                            </div>
                            
                            <div class="divider">
                                <span>OR</span>
                            </div>
                            
                            <div class="d-grid gap-2">
                                <button class="btn btn-social btn-facebook">
                                    <i class="bi bi-facebook me-2"></i> Login with Facebook
                                </button>
                                <button class="btn btn-social btn-google">
                                    <i class="bi bi-google me-2"></i> Login with Google
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-md-4">
                    <h5 class="footer-title">Elite Gym</h5>
                    <p class="footer-text">Empowering women through fitness and wellness.</p>
                    <div class="social-icons">
                        <a href="#"><i class="bi bi-facebook"></i></a>
                        <a href="#"><i class="bi bi-twitter"></i></a>
                        <a href="#"><i class="bi bi-instagram"></i></a>
                        <a href="#"><i class="bi bi-youtube"></i></a>
                    </div>
                </div>
                <div class="col-md-4">
                    <h5 class="footer-title">Quick Links</h5>
                    <ul class="footer-links">
                        <li><a href="classes.html">Classes</a></li>
                        <li><a href="sessions.html">Online Sessions</a></li>
                        <li><a href="trainers.html">Trainers</a></li>
                        <li><a href="pricing.html">Membership Plans</a></li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <h5 class="footer-title">Contact Us</h5>
                    <div class="contact-info">
                        <p><i class="bi bi-geo-alt"></i> 123 Fitness Street, Health City, HC 12345</p>
                        <p><i class="bi bi-telephone"></i> (123) 456-7890</p>
                        <p><i class="bi bi-envelope"></i> info@elitegym.com</p>
                    </div>
                </div>
            </div>
            <div class="copyright">
                <p>&copy; 2023 Elite Gym. All rights reserved.</p>
            </div>
        </div>
    </footer>
    
    <!-- Bootstrap 5 JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Custom JS -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Toggle password visibility
            const togglePassword = document.querySelector('.toggle-password');
            const passwordInput = document.getElementById('password');
            
            togglePassword.addEventListener('click', function() {
                const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordInput.setAttribute('type', type);
                
                // Toggle icon
                const icon = this.querySelector('i');
                icon.classList.toggle('bi-eye');
                icon.classList.toggle('bi-eye-slash');
            });
            
            // Handle form submission
            const loginForm = document.getElementById('login-form');
            
            loginForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                
                // Validate form
                let isValid = true;
                
                // Validate email
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    document.getElementById('email').classList.add('is-invalid');
                    isValid = false;
                } else {
                    document.getElementById('email').classList.remove('is-invalid');
                }
                
                // Validate password
                if (password.length < 6) {
                    document.getElementById('password').classList.add('is-invalid');
                    isValid = false;
                } else {
                    document.getElementById('password').classList.remove('is-invalid');
                }
                
                if (!isValid) {
                    return;
                }
                
                // Show loading
                const submitBtn = loginForm.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Logging in...';
                submitBtn.disabled = true;
                
                try {
                    // Simulate API call
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    
                    // Show success message
                    const alertContainer = document.getElementById('alert-container');
                    alertContainer.innerHTML = `
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle-fill me-2"></i>
                            Login successful! Redirecting...
                        </div>
                    `;
                    
                    // Redirect to dashboard
                    setTimeout(() => {
                        window.location.href = 'dashboard.html';
                    }, 1500);
                    
                } catch (error) {
                    // Show error message
                    const alertContainer = document.getElementById('alert-container');
                    alertContainer.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            Login failed. Please check your credentials.
                        </div>
                    `;
                    
                    // Reset button
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }
            });
        });
    </script>
</body>
</html>



POST
/api/Auth/login


Parameters
Cancel
Reset
No parameters

Request body

application/json
{
  "email": "tasnem@gmail.com",
  "password": "123456789Tasnem"
}
Execute
Clear
Responses
Curl

curl -X 'POST' \
  'https://localhost:7182/api/Auth/login' \
  -H 'accept: text/plain' \
  -H 'Content-Type: application/json' \
  -d '{
  "email": "tasnem@gmail.com",
  "password": "123456789Tasnem"
}'
Request URL
https://localhost:7182/api/Auth/login
Server response
Code	Details
200	
Response body
Download
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJuYW1laWQiOiI4IiwiZW1haWwiOiJ0YXNuZW1AZ21haWwuY29tIiwidW5pcXVlX25hbWUiOiJUYXNuZW0gQXltYW4iLCJyb2xlIjoiVXNlciIsIm5iZiI6MTc2NDE0NDAzMSwiZXhwIjoxNzY0NzQ4ODMxLCJpYXQiOjE3NjQxNDQwMzEsImlzcyI6Ikd5bUJvb2tpbmdBUEkiLCJhdWQiOiJHeW1Cb29raW5nQ2xpZW50cyJ9.Wtcu3Sg4N0BLT65vt9ubMyBIMIk7TwB8PE5QYoStf1E",
  "user": {
    "id": 8,
    "name": "Tasnem Ayman",
    "email": "tasnem@gmail.com",
    "phone": "01287135598",
    "createdAt": "2025-11-25T07:25:04.8546594",
    "membership": {
      "id": 7,
      "type": "Premium Yearly Plan",
      "startDate": "2025-11-25T07:27:31.1356775",
      "endDate": "2026-11-25T07:27:31.1357575",
      "totalHours": 40,
      "remainingHours": 39,
      "status": "Active",
      "pricePaid": 0
    }
  }
}
Response headers
 access-control-allow-origin: * 
 content-type: application/json; charset=utf-8 
 date: Wed,26 Nov 2025 08:00:31 GMT 
 server: Kestrel 
Responses
Code	Description	Links
200	
OK

Media type

text/plain
Controls Accept header.
Example Value
Schema
{
  "token": "string",
  "user": {
    "id": 0,
    "name": "string",
    "email": "string",
    "phone": "string",
    "createdAt": "2025-11-26T08:00:31.768Z",
    "membership": {
      "id": 0,
      "type": "string",
      "startDate": "2025-11-26T08:00:31.768Z",
      "endDate": "2025-11-26T08:00:31.768Z",
      "totalHours": 0,
      "remainingHours": 0,
      "status": "string",
      "pricePaid": 0
    }
  }
}   




/// the login page doesn't work even that it works in backend , but in the frontend it doesn't work whatever i logged in with it says login successfully and doesn't redirect to user dashboard
